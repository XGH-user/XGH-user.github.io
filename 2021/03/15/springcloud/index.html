<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xgh-user.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="SpringCloud微服务1、微服务架构概述微服务架构是一种架构模式，它提倡将单一应用程序划分成一组小的服务。 服务之间互相协调、互相配合，为用户提供最终价值。每个服务运行在其独 立的进程中，服务与服务间采用轻量级的通信机制互相协作(通常是基于 HTTP协议的RESTful API)。每个服务都围绕着具体业务进行构建，并且能够 被独立的部署到生产环境、类生产环境等。另外，应当尽量避免统一的、集">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://xgh-user.github.io/2021/03/15/springcloud/index.html">
<meta property="og:site_name" content="_little-star_">
<meta property="og:description" content="SpringCloud微服务1、微服务架构概述微服务架构是一种架构模式，它提倡将单一应用程序划分成一组小的服务。 服务之间互相协调、互相配合，为用户提供最终价值。每个服务运行在其独 立的进程中，服务与服务间采用轻量级的通信机制互相协作(通常是基于 HTTP协议的RESTful API)。每个服务都围绕着具体业务进行构建，并且能够 被独立的部署到生产环境、类生产环境等。另外，应当尽量避免统一的、集">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/1.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/2.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/206.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/207.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/3.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/4.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/5.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C6.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/7.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/8.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/9.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/10.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/11.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C12.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/13.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/14.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/15.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/16.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/19.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/17.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/18.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/20.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/21.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/22.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/23.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/24.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/25.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/26.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/27.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/28.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/29.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/30.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/31.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/32.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C211.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/33.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/34.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/35.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/36.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/37.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/38.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/39.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/40.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/41.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/42.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/43.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/44.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/45.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/Users/风间&琉璃/AppData/Local/Temp/mindmaster/1223393c341/bin/DF646587-C4E1-40BF-9FFD-7D10773D9637.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/46.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/47.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/48.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/49.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/50.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/51.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/52.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/53.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/54.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/55.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/56.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/Users/风间&琉璃/AppData/Local/Temp/mindmaster/1223393c341/bin/3008859F-0E2E-4542-92C5-A049333E2AC6.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/57.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/58.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/59.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/209.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/60.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/61.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/62.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/63.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/64.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/69.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/70.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/71.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/72.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/73.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/65.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/66.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/67.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/68.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/74.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/75.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/76.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/77.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/78.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/79.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/80.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/81.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/82.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/83.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/84.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/85.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C86.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/87.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/88.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/3.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/89.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/90.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/91.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/92.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/96.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/97.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/98.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/93.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/94.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/95.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/99.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/100.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/101.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/102.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/103.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/104.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/105.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/106.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/107.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/108.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/109.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/110.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/111.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/112.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/113.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/114.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/115.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/116.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/117.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/118.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/119.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/120.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/121.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/122.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/123.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/124.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/126.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/127.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/128.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/129.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/130.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/131.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/132.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/133.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/134.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/135.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/136.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/137.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/138.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/139.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/140.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/141.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C142.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/143.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/144.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/145.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/147.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/146.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/210.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/148.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/150.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/149.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/springcloud%5C151.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/152.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/153.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/154.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/155.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/156.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/157.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/158.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/159.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/160.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/164.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/161.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/162.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/163.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/文件/java/我/java后台学习笔记/springcloud/springcloud/165.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/167.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/168.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/169.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/170.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/171.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/172.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/168.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/173.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/174.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/175.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/166.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/176.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/177.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/178.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/179.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/180.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/181.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/182.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/183.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/184.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/185.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/186.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/187.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/188.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/189.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/190.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/191.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/192.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/193.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/194.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/195.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/196.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/197.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/198.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/199.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/200.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/201.gif">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/202.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/203.gif">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/204.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/03/15/springcloud/205.gif">
<meta property="article:published_time" content="2021-03-14T16:30:19.000Z">
<meta property="article:modified_time" content="2021-03-14T17:13:19.752Z">
<meta property="article:author" content="_little-star_">
<meta property="article:tag" content="springcloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xgh-user.github.io/2021/03/15/springcloud/1.jpg">

<link rel="canonical" href="http://xgh-user.github.io/2021/03/15/springcloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud | _little-star_</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="_little-star_" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">_little-star_</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xgh-user.github.io/2021/03/15/springcloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="_little-star_">
      <meta itemprop="description" content="记录个人在平时学习的过程中的一些笔记、感受与遇到的坑,例如：java、计算机考研四件套等等。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_little-star_">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-15 00:30:19 / 修改时间：01:13:19" itemprop="dateCreated datePublished" datetime="2021-03-15T00:30:19+08:00">2021-03-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%90%8E%E5%8F%B0%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">java后台学习笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%90%8E%E5%8F%B0%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><h3 id="1、微服务架构概述"><a href="#1、微服务架构概述" class="headerlink" title="1、微服务架构概述"></a>1、微服务架构概述</h3><p>微服务架构是一种架构模式，它提倡将单一应用程序划分成一组小的服务。</p>
<p>服务之间互相协调、互相配合，为用户提供最终价值。每个服务运行在其独</p>
<p>立的进程中，服务与服务间采用轻量级的通信机制互相协作(通常是基于</p>
<p>HTTP协议的RESTful API)。每个服务都围绕着具体业务进行构建，并且能够</p>
<p>被独立的部署到生产环境、类生产环境等。另外，应当尽量避免统一的、集</p>
<p>中式的服务管理机制，对具体的一个服务而言，应根据业务上下文，选择合</p>
<p>适的语言、工具对其进行构建。</p>
<h3 id="2、微服务架构编码构建"><a href="#2、微服务架构编码构建" class="headerlink" title="2、微服务架构编码构建"></a>2、微服务架构编码构建</h3><p>Rest微服务工程搭建：</p>
<ol>
<li><p>约定&gt;配置&gt;编码</p>
</li>
<li><p>IDEA新建project工作空间</p>
<ul>
<li>微服务cloud整体聚合工程<ul>
<li>父工程步骤<ul>
<li>New Project</li>
<li>聚合总父工程名字</li>
<li>Maven选版本</li>
<li>工程名字</li>
<li>字符编码</li>
<li>注解生效激活</li>
<li>java编译版本选8</li>
<li>File Type过滤</li>
</ul>
</li>
<li>父工程POM<ul>
<li>DependencyManagement(版本统一管理)</li>
<li>maven中跳过单元测试</li>
</ul>
</li>
<li>父工程创建完成执行mvn:insall将父工程发布到仓库方便子工程继承</li>
</ul>
</li>
</ul>
</li>
<li><p>Rest微服务工程搭建</p>
<ul>
<li><p>创建公共的模块</p>
<ul>
<li>实体类emtities<ul>
<li>主实体</li>
<li>Json封装体</li>
</ul>
</li>
<li>常量类</li>
<li>枚举类</li>
<li>创建步骤<ul>
<li>建module</li>
<li>改pom</li>
<li>编写</li>
<li>执行mvn:insall将公共工程发布到仓库方便需要的工程继承</li>
</ul>
</li>
</ul>
</li>
<li><p>微服务提供者Module模块</p>
<ul>
<li>建module</li>
<li>改POM</li>
<li>写YML</li>
<li>主启动</li>
<li>业务类<ul>
<li>建表sql</li>
<li>dao<ul>
<li>接口</li>
<li>mybatis的映射文件(src\main\resources\mapper\XxxxxMapper.xml)</li>
</ul>
</li>
<li>service<ul>
<li>接口</li>
<li>实现类</li>
</ul>
</li>
<li>controller</li>
</ul>
</li>
<li>测试（postman）</li>
</ul>
</li>
<li><p>热部署Devtools</p>
</li>
<li><p>微服务消费者订单Module模块</p>
<ul>
<li>建module</li>
<li>改POM</li>
<li>写YML</li>
<li>主启动</li>
<li>业务类<ul>
<li>config配置类</li>
<li>controller</li>
</ul>
</li>
<li>测试</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="3、SpringCloud简介"><a href="#3、SpringCloud简介" class="headerlink" title="3、SpringCloud简介"></a>3、SpringCloud简介</h3><p>SpringCloud：分布式微服务架构的一站式解决方案，是多种微服务架构落</p>
<p>地技术的集合体，俗称微服务全家桶。</p>
<p><img src="/2021/03/15/springcloud/1.jpg" alt="1"></p>
<p><img src="/2021/03/15/springcloud/2.jpg" alt="2"></p>
<h3 id="4、SpringCloud技术栈"><a href="#4、SpringCloud技术栈" class="headerlink" title="4、SpringCloud技术栈"></a>4、SpringCloud技术栈</h3><p><img src="/2021/03/15/springcloud/206.png" alt="image-20210305205540848"></p>
<p><img src="/2021/03/15/springcloud/207.png" alt="image-20210305205647548"></p>
<p><img src="/2021/03/15/springcloud/3.jpg" alt="3"></p>
<h3 id="5、版本选择"><a href="#5、版本选择" class="headerlink" title="5、版本选择"></a>5、版本选择</h3><p>springboot：2.2.RELEASE</p>
<p>springcloud：Hoxton.SR1</p>
<p>springcloud Alibaba：2.1.0.RELEASE</p>
<p>java：8</p>
<p>Maven：3.5及以上</p>
<p>Mysql：5.7及以上</p>
<h3 id="6、访问方式"><a href="#6、访问方式" class="headerlink" title="6、访问方式"></a>6、访问方式</h3><ul>
<li>网页</li>
<li>postman</li>
<li>dos窗口 + crul<ul>
<li>加入curl返回中文乱码（<a target="_blank" rel="noopener" href="https://blog.csdn.net/leedee/article/details/82685636%EF%BC%89">https://blog.csdn.net/leedee/article/details/82685636）</a></li>
</ul>
</li>
</ul>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><h3 id="7、Eureka注册中心"><a href="#7、Eureka注册中心" class="headerlink" title="7、Eureka注册中心"></a>7、Eureka注册中心</h3><h4 id="7-1、Eureka基础知识："><a href="#7-1、Eureka基础知识：" class="headerlink" title="7.1、Eureka基础知识："></a>7.1、Eureka基础知识：</h4><ul>
<li><p>服务治理：SpringCloud封装了Netflix公司开发的Eureka模块来实现服</p>
<p>务治理。</p>
<p>在传统的rpc远程调用框架中，管理每个服务与服务之间的依赖关系比</p>
<p>较复杂，管理比较复杂，所以需要使用服务治理，管理服务与服务之间</p>
<p>的依赖关系，可以实现服务调用、负载均衡、容错等，实现服务的发现</p>
<p>与注册。</p>
</li>
<li><p>服务发现与注册：Eureka采用了CS的设计架构，Eureka Server作为服</p>
<p>务注册功能的服务器，它是服务注册中心。而系统中的其他微服务，使</p>
<p>用Eureka的客户端连接到Eureka Server并维持心跳连接。这样系统的</p>
<p>维护人员就可以通过Eureka Server来监控系统中各个微服务是否正常</p>
<p>运行。</p>
<p>在服务注册与发现中，有一个注册中心。但服务器启动的时候，会把当</p>
<p>前自己的服务的信息。比如：服务地址、通讯地址等以别名方式注册到</p>
<p>注册中心上。另一方（消费者|服务提供者），以该别名的方式去注册</p>
<p>中心上获取到实际的服务通讯地址，然后在实现本地的RPC调用。远程</p>
<p>RPC调用的框架核心设计思想：在于注册中心，因为使用注册中心管理</p>
<p>每个服务与服务之间的一个依赖关系（服务治理概念）。在任何远程</p>
<p>RPC框架中，都会有一个注册中心（存放服务地址相关信息（接口地</p>
<p>址））</p>
</li>
<li><p>Eureka系统架构与Dubbo架构的对比</p>
<p><img src="/2021/03/15/springcloud/4.png" alt="image-20210309193119872"></p>
<p><img src="/2021/03/15/springcloud/5.png" alt="image-20210309193236970"></p>
</li>
<li><p>Eureka的两大组件</p>
<ul>
<li><p>Eureka Server：提供服务注册服务</p>
<p>各个微服务结点通过配置启动后，会在Eureka Server中进行注</p>
<p>册，这样Eureka Server中的服务注册表中将会存储所有可用服务</p>
<p>注册节点的信息，服务节点的信息可以在界面中直观看到。</p>
<p>主启动加注解：@EnableEurekaServer</p>
<p>pom:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Eureka Client：通过注册中心进行访问</p>
<p>是一个java客户端，用于简化Eureka Server的交互，客户端同时也</p>
<p>具备一个内置的，使用轮询（round-robin）负载算法的负载均衡</p>
<p>器。在启动应用后，将会向Eureka Server发送心跳（默认周期</p>
<p>30s）。如果Eureka Server在多个心跳周期内没有接收到某个节点</p>
<p>的心跳，Eureka Server将会从访问注册表中把这个服务节点移除</p>
<p>（默认90s）</p>
<p>主启动加注解：@EnableEurekaClient</p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="7-2、工作流程："><a href="#7-2、工作流程：" class="headerlink" title="7.2、工作流程："></a>7.2、工作流程：</h4><p><img src="/2021/03/15/springcloud/springcloud%5C6.png" alt="img"></p>
<p> 解决办法: 搭建Eureka注册中心集群,实现负载均衡+故障容错</p>
<h4 id="7-3、集群搭建"><a href="#7-3、集群搭建" class="headerlink" title="7.3、集群搭建"></a>7.3、集群搭建</h4><p>相互依赖，相互守望（在application.yml中配置文件互相配置）</p>
<h4 id="7-4、eureka自我保护"><a href="#7-4、eureka自我保护" class="headerlink" title="7.4、eureka自我保护"></a>7.4、eureka自我保护</h4><p>概述：保护模式主要用于一组客户端和Eureka Server之间存在网络分区场</p>
<p>景下的保护。一旦进入保护模式，Eureka Server将会尝试保护其服务注册</p>
<p>表中的信息，不在删除服务注册表中的数据，也就是不会注销任何微服务。</p>
<p><img src="/2021/03/15/springcloud/7.png" alt="image-20210309203401792"></p>
<p>导致原因：</p>
<p><img src="/2021/03/15/springcloud/8.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/9.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/10.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/11.png" alt="img"> </p>
<p>一句话总结:某时刻 一个微服务不可用了,Eureka不会立刻清理,依旧会对该</p>
<p>服务的信息进行保存。属于CAP里面的AP分支</p>
<p>如何禁用Eureka的保护模式：</p>
<p>在Eureka服务端（Eureka Server）：</p>
<p>使用eureka.server.enable-self-preservation=false 可以禁用自我保护模式</p>
<p>在Eureka客户端（Eureka Client）（修改时间）：</p>
<ul>
<li><p>eureka.instance.lease-renewal-interval-in-seconds=1</p>
<p>Eureka客户端向服务端发送心跳的时间间隔,单位为秒。默认是30秒</p>
</li>
<li><p>eureka.instance.lease-expiration-duration-in-seconds=90</p>
<p>Eureka服务端在收到最后一次心跳后等待时间上限 ,单位为秒(默认是90</p>
<p>秒),超时删除服务</p>
</li>
</ul>
<h3 id="8、Zookeeper注册中心"><a href="#8、Zookeeper注册中心" class="headerlink" title="8、Zookeeper注册中心"></a>8、Zookeeper注册中心</h3><p>Zookeeper是一个分布式协调工具,可以实现注册中心功能。</p>
<p>依赖导入：</p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>思考：</p>
<p>服务节点是临时节点还是持久节点？</p>
<p>临时节点。所以Zookeeper属于CAP中里的CP分支。</p>
<p><img src="/2021/03/15/springcloud/springcloud%5C12.png" alt="img"> </p>
<h3 id="9、Consul注册中心"><a href="#9、Consul注册中心" class="headerlink" title="9、Consul注册中心"></a>9、Consul注册中心</h3><h4 id="9-1、什么是consul"><a href="#9-1、什么是consul" class="headerlink" title="9.1、什么是consul"></a>9.1、什么是consul</h4><p>Consul是一套开源的分布式服务发现和配置管理系统，由HashiCorp公司用</p>
<p>Go语言开发。Consul提供了微服务系统中的服务治理、配置中心、控制总</p>
<p>线等功能。这些功能中的每一个都可以根据需要单独使用，也可以一起使用</p>
<p>以构建全方位的服务网络，总之Consul提供了一种完整服务网络解决方</p>
<p>案。</p>
<p>优点：</p>
<ul>
<li>基于raft协议，比较简洁</li>
<li>支持健康检查，同时支持HTTP和DNS协议支持跨数据中心的WAN集群</li>
<li>提供图形界面</li>
<li>跨平台</li>
<li>支持Linux、Mac、Windows</li>
</ul>
<p><img src="/2021/03/15/springcloud/13.png" alt="image-20210309210438031">  </p>
<h4 id="9-2、功能"><a href="#9-2、功能" class="headerlink" title="9.2、功能"></a>9.2、功能</h4><ul>
<li>服务发现：提供HTTP/DNS两种发现方式</li>
<li>健康检测：支持多种方式,HTTP、TCP、Docker、shell脚本定制化</li>
<li>KV存储：Key、Value的存储方式</li>
<li>多数据中心：Consul支持多数据中心</li>
<li>可视化界面</li>
</ul>
<h4 id="9-3、依赖导入"><a href="#9-3、依赖导入" class="headerlink" title="9.3、依赖导入"></a>9.3、依赖导入</h4><p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="10、三个注册中心异同点"><a href="#10、三个注册中心异同点" class="headerlink" title="10、三个注册中心异同点"></a>10、三个注册中心异同点</h3><p><img src="/2021/03/15/springcloud/14.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/15.png" alt="img"> </p>
<p>CP(Zookeeper/Consul)：</p>
<p>当网络分区出现后,为了保证一致性,就必须拒绝请求,否则无法保证一致性</p>
<p>结论:违背了可用性A的要求,只满足一致性和分区容错,即CP。</p>
<p><img src="/2021/03/15/springcloud/16.png" alt="image-20210307031636572"></p>
<p>AP(Eureka):</p>
<p><img src="/2021/03/15/springcloud/19.png" alt="img"> </p>
<p>CAP（分区容错性要保证,所以要么是CP,要么是AP）：</p>
<ul>
<li>C: Consistency(强一致性)</li>
<li>A: Availability(可用性)</li>
<li>P: Parttition tolerance(分区容错性)</li>
</ul>
<p>CAP理论关注粒度是否是数据,而不是整体系统设计的策略</p>
<p>经典CAP图：</p>
<p><img src="/2021/03/15/springcloud/17.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/18.png" alt="img"> </p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><h3 id="11、Ribbon负载均衡调用"><a href="#11、Ribbon负载均衡调用" class="headerlink" title="11、Ribbon负载均衡调用"></a>11、Ribbon负载均衡调用</h3><h4 id="11-1、是什么"><a href="#11-1、是什么" class="headerlink" title="11.1、是什么"></a>11.1、是什么</h4><p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端负载均衡的</p>
<p>工具。</p>
<p>简单的说，Ribbon是Netflix发布的开源项目，主要功能是提供客户端的软</p>
<p>件负载均衡算法和服务调用。Ribbon客户端组件提供一系列完善的配置项</p>
<p>如连接超时，重试等。简单的说，就是在配置文件中列出Load </p>
<p>Balancer（LB）后面所有机器，Ribbon会自动的帮助你基于某种规则(如简</p>
<p>单轮询，随机连接等)去连接这些机器。我们很容易使用Ribbon实现自定义</p>
<p>的负载均衡算法。 </p>
<p>总结: Ribbon其实就是一个软负载均衡的客户端组件,  他可以和其他所需请</p>
<p>求的客户端结合使用,和eureka结合只是其中一个实例.</p>
<h4 id="11-2、作用（负载均衡-RestTemplate调用）"><a href="#11-2、作用（负载均衡-RestTemplate调用）" class="headerlink" title="11.2、作用（负载均衡+RestTemplate调用）"></a>11.2、作用（负载均衡+RestTemplate调用）</h4><p>LB(负载均衡)：</p>
<p>简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的</p>
<p>HA（高可用）。</p>
<p>常见的负载均衡有软件Nginx，LVS，硬件F5等。</p>
<p>Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡的区别：</p>
<ul>
<li><p>Nginx是服务器负载均衡，客户端所有请求都会交给nginx，然后由</p>
<p>nginx实现转发请求。即负载均衡是由服务端实的。</p>
</li>
<li><p>Ribbon本地负载均衡，在调用微服务接口的时候，会在注册中心上获</p>
<p>取注册信息服务列表之后缓存到JVM本地，从而在本地实现RPC远程服务调用技术。 </p>
</li>
</ul>
<p>LB(负载均衡)可分为：</p>
<ul>
<li><p>集中式LB</p>
<p>即在服务的消费方和提供方之间提供独立的LB设施(可以是硬件如F5，</p>
<p>也可以是软件，如nginx)，由该设施负责把访问请求通过某种策略转发</p>
<p>至服务的提供方。</p>
</li>
<li><p>进程内LB</p>
<p>将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，</p>
<p>然后自己再从这些地址中选择出一台合适的服务器。Ribbon就属于进</p>
<p>程内LB，它只是一个类库，集成与消费方进程，消费方通过它来获取服</p>
<p>务提供方的地址。 </p>
</li>
</ul>
<h4 id="11-3、框架说明"><a href="#11-3、框架说明" class="headerlink" title="11.3、框架说明"></a>11.3、框架说明</h4><p><img src="/2021/03/15/springcloud/20.png" alt="img"> </p>
<p>Ribbon在工作时分成两步：</p>
<ul>
<li><p>第一步：</p>
<p>先选择Eureka Server，它优先选择在同一区域内负载较少的server</p>
</li>
<li><p>第二步：</p>
<p>再根据用户指定的策略，再从server取到的服务注册列表中选择一个地</p>
<p>址。其中Ribbon提供了多种策略:比如轮询、随机和根据响应时间加</p>
<p>权。</p>
</li>
</ul>
<p>RestTemplate的使用：</p>
<ul>
<li><p>getForObject(String url,class)方法:返回对象为响应体中数据转化成的</p>
<p>对象，基本上可以理解成Json</p>
</li>
<li><p>getForEntity(String url,class)方法：返回对象为ResponseEntity对象，</p>
<p>包含响应中的一些重要信息，比如响应头、响应状态码、响应体等。  </p>
</li>
</ul>
<h4 id="11-4、Ribbon核心组件IRule"><a href="#11-4、Ribbon核心组件IRule" class="headerlink" title="11.4、Ribbon核心组件IRule"></a>11.4、Ribbon核心组件IRule</h4><h5 id="11-4-1、IRule是什么"><a href="#11-4-1、IRule是什么" class="headerlink" title="11.4.1、IRule是什么"></a>11.4.1、IRule是什么</h5><p>IRule:根据特定算法从服务列表中选取一个要访问的服务</p>
<p><img src="/2021/03/15/springcloud/21.png" alt="img"> </p>
<ul>
<li><p>com.netflix.loadbalancer.RoundRobinRule：轮询（默认）</p>
</li>
<li><p>com.netflix.loadbalancer.RandomRule：随机</p>
</li>
<li><p>com.netflix.loadbalancer.RetryRule：先按照RoundRobinRule的策略</p>
<p>获取服务,如果获取服务失败则在指定时间内进行重试,获取可用的服务</p>
</li>
<li><p>WeightedResponseTimeRule：对RoundRobinRule的扩展,响应速度</p>
<p>越快的实例选择权重越多大,越容易被选择</p>
</li>
<li><p>BestAvailableRule：会先过滤掉由于多次访问故障而处于断路器跳闸</p>
<p>状态的服务,然后选择一个并发量最小的服务</p>
</li>
<li><p>AvailabilityFilteringRule：先过滤掉故障实例,再选择并发较小的实例</p>
</li>
<li><p>ZoneAvoidanceRule：默认规则,复合判断server所在区域的性能和</p>
<p>server的可用性选择服务器</p>
</li>
</ul>
<h5 id="11-4-2、替换："><a href="#11-4-2、替换：" class="headerlink" title="11.4.2、替换："></a>11.4.2、替换：</h5><p>注意配置细节</p>
<p>官方文档明确给出了警告：</p>
<p>这个自定义配置类不能放在@ComponentScan所扫描的当前包以及子包</p>
<p>下，否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达</p>
<p>不到特殊化定制的目的了。 </p>
<p><img src="/2021/03/15/springcloud/22.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/23.png" alt="img"> </p>
<p>@ComponentScan所扫描的当前包以及子包：因为</p>
<p>@SpringBootApplication注解包含了@ComponentScan注解，所以该自定</p>
<p>义配置类不能放在当前包（springcloud）下。</p>
<p>新建package：com.atguigu.myrule</p>
<p>上面包下新建MySelfRule规则类</p>
<p>主启动类添加@RibbonClient</p>
<h5 id="11-4-3、Ribbon负载均衡算法"><a href="#11-4-3、Ribbon负载均衡算法" class="headerlink" title="11.4.3、Ribbon负载均衡算法"></a>11.4.3、Ribbon负载均衡算法</h5><p>RoundRobinRule：轮询的算法思想</p>
<p><img src="/2021/03/15/springcloud/24.png" alt="img"> </p>
<h3 id="12、OenFeign"><a href="#12、OenFeign" class="headerlink" title="12、OenFeign"></a>12、OenFeign</h3><h4 id="12-1、是什么？"><a href="#12-1、是什么？" class="headerlink" title="12.1、是什么？"></a>12.1、是什么？</h4><p>官方解释：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign">https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign</a></p>
<p>Feign是一个声明式WebService客户端。使用Feign能让编写Web Service客</p>
<p>户端更加简单。它的使用方法是<strong>定义一个服务接口然后在上面添加注解</strong>。</p>
<p>Feign也支持可拔插式的编码器和解码器。Spring Cloud对Feign进行了封</p>
<p>装，使其支持了Spring MVC标准注解和HTTPMessageConverters。Feign</p>
<p>可以与Eureka和Ribbon组合使用以支持负载均衡。</p>
<h4 id="12-2、作用："><a href="#12-2、作用：" class="headerlink" title="12.2、作用："></a>12.2、作用：</h4><p>Feign旨在使编写Java Http客户端变得更容易。</p>
<p>前面在使用Ribbon+RestTemplate时，利用RestTemplate对http请求的封装处</p>
<p>理，形成了一套模版化的调用方法。但是在实际开发中，由于对服务依赖的调用</p>
<p>可能不止一处，<strong>往往一个接口会被多处调用，所以通常都会针对每个微服务自行</strong></p>
<p><strong>封装一些客户端类来包装这些依赖服务的调用</strong>。所以，Feign在此基础上做了进</p>
<p>一步封装，由他来帮助我们定义和实现依赖服务接口的定义。在Feign的实现下</p>
<p><strong>我们只需创建一个接口并使用注解的方式来配置它(以前是Dao接口上面标</strong></p>
<p><strong>注Mapper注解，现在是一个微服务接口上面标注一个Feign注解即可)，即可完</strong></p>
<p>成对服务提供方的接口绑定，简化了使用Spring cloud Ribbon时，自动封装服</p>
<p>务调用客户端的开发量。</p>
<p>Feign集成了Ribbon</p>
<p>利用Ribbon维护了Payment的服务列表信息，并且通过轮询实现了客户端的负</p>
<p>载均衡。而与Ribbon不同的是，<strong>通过feign只需要定义服务绑定接口且以声明式</strong></p>
<p><strong>的方法</strong>，优雅而简单的实现了服务调用。</p>
<h4 id="12-3、Feign和OpenFeign两者区别"><a href="#12-3、Feign和OpenFeign两者区别" class="headerlink" title="12.3、Feign和OpenFeign两者区别"></a>12.3、Feign和OpenFeign两者区别</h4><p><img src="/2021/03/15/springcloud/25.png" alt="img"> </p>
<h4 id="12-4、使用步骤"><a href="#12-4、使用步骤" class="headerlink" title="12.4、使用步骤"></a>12.4、使用步骤</h4><ul>
<li><p>接口+注解：微服务调用接口+@FeignClient</p>
</li>
<li><p>Feign在消费端使用</p>
</li>
<li><p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动加上@EnableFeignClients注解开启Feign</p>
</li>
<li><p>业务逻辑接口+@FeignClient配置调用provider服务</p>
<p>@FeignClient(value = “xxx-xxx-xxx”)value的值要写服务提供方在Eureka注册的名称</p>
</li>
<li><p>控制层Controller</p>
</li>
</ul>
<p><img src="/2021/03/15/springcloud/26.png" alt="img"> </p>
<h4 id="12-5、OpenFeign超时控制"><a href="#12-5、OpenFeign超时控制" class="headerlink" title="12.5、OpenFeign超时控制"></a>12.5、OpenFeign超时控制</h4><h5 id="12-5-1、是什么？"><a href="#12-5-1、是什么？" class="headerlink" title="12.5.1、是什么？"></a>12.5.1、是什么？</h5><p>默认Feign客户端<strong>只等待1秒钟</strong>，但是服务端处理需要超过1秒钟，导致Feign客</p>
<p>户端不想等待了，直接返回报错。</p>
<h5 id="12-5-2、解决方法-OpenFeign默认支持Ribbon"><a href="#12-5-2、解决方法-OpenFeign默认支持Ribbon" class="headerlink" title="12.5.2、解决方法(OpenFeign默认支持Ribbon)"></a>12.5.2、解决方法(OpenFeign默认支持Ribbon)</h5><p>为了避免这样的情况，有时候我们需要设置Feign客户端的超时控制。</p>
<p>yml文件中开启配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置feign客户端超时时间(OpenFeign默认支持ribbon)</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="comment">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4 id="12-6、OpenFeign日志打印功能"><a href="#12-6、OpenFeign日志打印功能" class="headerlink" title="12.6、OpenFeign日志打印功能"></a>12.6、OpenFeign日志打印功能</h4><h5 id="12-6-1、是什么？"><a href="#12-6-1、是什么？" class="headerlink" title="12.6.1、是什么？"></a>12.6.1、是什么？</h5><p>Feign提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解</p>
<p>Feign中Http请求的细节。说白了就是<strong>对Feign接口的调用情况进行监控和</strong></p>
<p><strong>输出。</strong></p>
<h2 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a>熔断器</h2><h3 id="13、Hystrix熔断器（豪猪哥）"><a href="#13、Hystrix熔断器（豪猪哥）" class="headerlink" title="13、Hystrix熔断器（豪猪哥）"></a>13、Hystrix熔断器（豪猪哥）</h3><h4 id="13-1、分布式系统面临的问题"><a href="#13-1、分布式系统面临的问题" class="headerlink" title="13.1、分布式系统面临的问题"></a>13.1、分布式系统面临的问题</h4><p><strong>复杂分布式体系结构中的应用程序 ，有数10个依赖关系，每个依赖关系在某些时候将不可避免地失败。</strong></p>
<p><img src="/2021/03/15/springcloud/27.png" alt="img"></p>
<p>服务雪崩：</p>
<p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和</p>
<p>微服务C又调用其它的微服务，这就是所谓的“<strong>扇出</strong>”。如果扇出的链路上某个微</p>
<p>服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系</p>
<p>统资源，进而引起系统崩溃，所谓的“雪崩效应”。</p>
<p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都</p>
<p>在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟</p>
<p>增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故</p>
<p>障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，</p>
<p>不能取消整个应用程序或系统。所以，通常当你发现一个模块下的某个实例失败</p>
<p>后，这时候这个模块依然还会接收流量，然后这个有问题的模块还调用了其他的</p>
<p>模块，这样就会发生级联故障，或者叫雪崩。</p>
<h4 id="13-2、Hystrix是什么"><a href="#13-2、Hystrix是什么" class="headerlink" title="13.2、Hystrix是什么"></a>13.2、Hystrix是什么</h4><p>Hystrix是一个用于处理分布式系统的<strong>延迟</strong>和<strong>容错</strong>的开源库，在分布式系统里，</p>
<p>许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个</p>
<p>依赖出问题的情况下，<strong>不会导致整体服务失败，避免级联故障，以提高分布式系</strong></p>
<p><strong>统的弹性</strong>。</p>
<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故</p>
<p>障监控(类似熔断保险丝)，<strong>向调用方返回一个符合预期的、可处理的备选响应</strong></p>
<p><strong>(FallBack)，而不是长时间的等待或者抛出调用方无法处理的异常</strong>，这样就保证</p>
<p>了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系</p>
<p>统中的蔓延，乃至雪崩。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://github.com/Netflix/hystrix/wiki">https://github.com/Netflix/hystrix/wiki</a></p>
<h4 id="13-3、作用"><a href="#13-3、作用" class="headerlink" title="13.3、作用"></a>13.3、作用</h4><ul>
<li>服务降级</li>
<li>服务熔断</li>
<li>接近实时的监控</li>
</ul>
<h4 id="13-4、HyStrix重要概念"><a href="#13-4、HyStrix重要概念" class="headerlink" title="13.4、HyStrix重要概念"></a>13.4、HyStrix重要概念</h4><h5 id="13-4-1、服务降级"><a href="#13-4-1、服务降级" class="headerlink" title="13.4.1、服务降级"></a>13.4.1、服务降级</h5><p>服务器忙,请稍后再试,不让客户端等待并立刻返回一个友好提示,fallback</p>
<p>哪些情况会发出降级：</p>
<ul>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断触发服务降级</li>
<li>线程池/信号量也会导致服务降级</li>
</ul>
<h5 id="13-4-2、服务熔断"><a href="#13-4-2、服务熔断" class="headerlink" title="13.4.2、服务熔断"></a>13.4.2、服务熔断</h5><p>类比保险丝达到最大服务访问后,直接拒绝访问,拉闸限电,然后调用服务降级的方</p>
<p>法并返回友好提示</p>
<p>服务熔断的过程：</p>
<p>服务的降级-&gt;进而熔断-&gt;恢复调用链路</p>
<h5 id="12-4-3、服务限流"><a href="#12-4-3、服务限流" class="headerlink" title="12.4.3、服务限流"></a>12.4.3、服务限流</h5><p>秒杀高并发等操作,严禁一窝蜂的过来拥挤,大家排队,一秒钟N个,有序进行</p>
<h4 id="13-5、依赖"><a href="#13-5、依赖" class="headerlink" title="13.5、依赖"></a>13.5、依赖</h4><p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="13-6、高压访问的解决方法"><a href="#13-6、高压访问的解决方法" class="headerlink" title="13.6、高压访问的解决方法"></a>13.6、高压访问的解决方法</h4><p>超时导致服务器变慢(转圈)：超时不再等待</p>
<p>出错(宕机或程序运行出错)：出错要有兜底</p>
<h4 id="13-7、访问降级"><a href="#13-7、访问降级" class="headerlink" title="13.7、访问降级"></a>13.7、访问降级</h4><p>降级配置@HystrixCommand</p>
<h5 id="13-7-1、对于服务提供方："><a href="#13-7-1、对于服务提供方：" class="headerlink" title="13.7.1、对于服务提供方："></a>13.7.1、对于服务提供方：</h5><p>设置自身调用超时时间的峰值,峰值内可以正常运行,  超过了需要有兜底的方法处</p>
<p>理,做服务降级fallback</p>
<p>一旦调用服务方法失败并抛出了错误信息后,会自动调用@HystrixCommand标‘</p>
<p>注好的fallbckMethod调用类中的指定方法</p>
<p>主启动类激活@EnableCircuitBreaker</p>
<p>下图故意制造两个异常：</p>
<ul>
<li>int age = 10/0;计算异常</li>
<li>我们能接受3秒钟，它运行5秒钟，超时异常。</li>
</ul>
<p>当前服务不可用了，做服务降级，兜底的方案都是paymentInfo_TimeOutHandler</p>
<p><img src="/2021/03/15/springcloud/28.png" alt="img"></p>
<h5 id="13-7-2、对于服务消费方："><a href="#13-7-2、对于服务消费方：" class="headerlink" title="13.7.2、对于服务消费方："></a>13.7.2、对于服务消费方：</h5><p>主启动类激活@EnableHystrix</p>
<p>业务类</p>
<p><img src="/2021/03/15/springcloud/29.png" alt="img"></p>
<h5 id="13-7-3、目前问题"><a href="#13-7-3、目前问题" class="headerlink" title="13.7.3、目前问题"></a>13.7.3、目前问题</h5><ul>
<li>每个业务方法对应一个兜底的方法,代码膨胀</li>
<li>统一和自定义的分开</li>
</ul>
<p>解决方法：</p>
<ul>
<li><p>解决第一个问题：代码膨胀</p>
<p>feign接口系列</p>
<p>@DefaultProperties(defaultFallback=””)</p>
<p>每个方法配置一个服务降级方法，技术上可以，实际上导致代码膨胀。</p>
<p>除了个别重要核心业务有专属，其它普通的可以通过</p>
<p>@DefaultProperties(defaultFallback =”)统一跳转到统一处理结果页面</p>
<p><strong>通用的和独享的各自分开，避免了代码膨胀，合理减少了代码量</strong>。</p>
<p><img src="/2021/03/15/springcloud/30.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/31.png" alt="img"> </p>
</li>
<li><p>解决第二个问题：和业务逻辑混在一起</p>
<p>服务降级,客户端去调用服务端,碰上服务端宕机或关闭。只需要为Feign客户</p>
<p>端定义的接口添加一个服务降级处理的实现类即可实现解耦。</p>
<p>我们可能面临的异常：</p>
<ul>
<li>运行</li>
<li>超时</li>
<li>宕机</li>
</ul>
<p>重新新建一个类(PaymentFallbackService)实现PaymentHystrixService接</p>
<p>口（OpenFeign的服务接口）,<strong>统一为接口里面的方法进行异常处理</strong></p>
<p><img src="/2021/03/15/springcloud/32.png" alt="img"> </p>
<p>PaymentHystrixService接口:</p>
<p><img src="/2021/03/15/springcloud/springcloud%5C211.png" alt="image-20210315011150047"></p>
</li>
</ul>
<h4 id="13-8、服务熔断"><a href="#13-8、服务熔断" class="headerlink" title="13.8、服务熔断"></a>13.8、服务熔断</h4><h5 id="13-8-1、是什么？"><a href="#13-8-1、是什么？" class="headerlink" title="13.8.1、是什么？"></a>13.8.1、是什么？</h5><p><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">https://martinfowler.com/bliki/CircuitBreaker.html</a></p>
<p>熔断机制概述</p>
<p>熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务</p>
<p>出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的</p>
<p>调用，快速返回错误的响应信息。</p>
<p>当<strong>检测到该节点微服务调用响应正常后，恢复调用链路</strong>。</p>
<p>在Spring Cloud框架里，熔断机制通过Hystrix实现。Hystrix会监控微服务间调</p>
<p>用的状况，当失败的调用到一定國值，缺省是5秒内20次调用失败，就会启动熔</p>
<p>断机制。熔断机制的注解是@HystrixCommand。</p>
<h5 id="12-8-2、服务熔断的注解-HystrixCommand-Service层"><a href="#12-8-2、服务熔断的注解-HystrixCommand-Service层" class="headerlink" title="12.8.2、服务熔断的注解@HystrixCommand(Service层)"></a>12.8.2、服务熔断的注解@HystrixCommand(Service层)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),// 是否开启断路器</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),// 请求次数</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;), // 时间窗口期</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;),// 失败率达到多少后跳闸</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br></pre></td></tr></table></figure>

<h5 id="12-8-3、大神结论"><a href="#12-8-3、大神结论" class="headerlink" title="12.8.3、大神结论"></a>12.8.3、大神结论</h5><p><img src="/2021/03/15/springcloud/33.png" alt="img"> </p>
<p>熔断类型：</p>
<ul>
<li><p>熔断打开（Open）：</p>
<p>请求不再调用当前服务,内部设置一般为MTTR(平均故障处理时间),当打开长达导所设时钟则进入半熔断状态</p>
</li>
<li><p>熔断关闭（Closed）：</p>
<p>熔断关闭后不会对服务进行熔断</p>
</li>
<li><p>熔断半开（Half Open）：</p>
<p>部分请求根据规则调用当前服务,如果请求成功且符合规则则认为当前服务恢复正常,关闭熔断</p>
</li>
</ul>
<h5 id="12-8-4、断路流程图"><a href="#12-8-4、断路流程图" class="headerlink" title="12.8.4、断路流程图"></a>12.8.4、断路流程图</h5><p><img src="/2021/03/15/springcloud/34.png" alt="img"> </p>
<p>步骤：</p>
<p><img src="/2021/03/15/springcloud/35.png" alt="img"> </p>
<p>断路器在什么情况下开始起作用 </p>
<p><img src="/2021/03/15/springcloud/36.png" alt="image-20210310003224243"></p>
<p>涉及到断路器的三个重要参数：<strong>快照时间窗、请求总数阀值、错误百分比</strong></p>
<p><strong>阀值</strong></p>
<ul>
<li><p>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统</p>
<p>计的时间范围就是快照时间窗，默认为最近的10秒。</p>
</li>
<li><p>请求总数阀值：在快照时间窗内，必须满足请求总数阀值才有资格熔</p>
<p>断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足</p>
<p>20次，即使所有的请求都超时或其他原因失败，断路器都不会打开。</p>
</li>
<li><p>错误百分比阀值：当请求总数在快照时间窗内超过了阀值，比如发生了</p>
<p>30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超</p>
<p>过50%的错误百分比，在默认设定50%阀值情况下，这时候就会将断路</p>
<p>器打开。</p>
</li>
</ul>
<p>断路器开启或者关闭的条件:</p>
<ol>
<li><p>当满足一定的阈值的时候(默认10秒钟超过20个请求次数)</p>
</li>
<li><p>当失败率达到一定的时候(默认10秒内超过50%的请求次数)</p>
</li>
<li><p>到达以上阈值,断路器将会开启</p>
</li>
<li><p>当开启的时候,所有请求都不会进行转发</p>
</li>
<li><p>一段时间之后(默认5秒),这个时候断路器是半开状态,会让其他一个请求</p>
<p>进行转发. 如果成功,断路器会关闭,若失败,继续开启.重复4和5</p>
</li>
</ol>
<p>断路器打开之后:</p>
<ol>
<li><p>再有请求调用的时候，将不会调用主逻辑，而是直接调用降级</p>
<p>fallback。通过断路器，实现了自动地发现错误并将降级逻辑切换为主</p>
<p>逻辑，减少响应延迟的效果。</p>
</li>
<li><p>原来的主逻辑要如何恢复呢？</p>
<p>对于这一问题，hystrix也为我们实现了自动恢复功能。</p>
<p>当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间</p>
<p>窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到</p>
<p>期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此</p>
<p>次请求正常返回，那么断路器将继续闭合，主逻辑恢复，如果这次请求</p>
<p>依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。 </p>
</li>
</ol>
<p>ALL配置：</p>
<p><img src="/2021/03/15/springcloud/37.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/38.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/39.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/40.png" alt="img"> </p>
<h4 id="13-9、服务限流"><a href="#13-9、服务限流" class="headerlink" title="13.9、服务限流"></a>13.9、服务限流</h4><p>alibaba的Sentinel说明</p>
<h4 id="13-10、Hystrix的工作流程"><a href="#13-10、Hystrix的工作流程" class="headerlink" title="13.10、Hystrix的工作流程"></a>13.10、Hystrix的工作流程</h4><p><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">https://github.com/Netflix/Hystrix/wiki/How-it-Works</a></p>
<p>官网图例</p>
<p><img src="/2021/03/15/springcloud/41.png" alt="img"> </p>
<p>步骤说明</p>
<p><img src="/2021/03/15/springcloud/42.png" alt="img"> </p>
<h4 id="13-11、服务监控hystrixDashboard"><a href="#13-11、服务监控hystrixDashboard" class="headerlink" title="13.11、服务监控hystrixDashboard"></a>13.11、服务监控hystrixDashboard</h4><h5 id="13-11-1、概述"><a href="#13-11-1、概述" class="headerlink" title="13.11.1、概述"></a>13.11.1、概述</h5><p> 除了隔离依赖服务的调用以外，Hystrix还提供了<strong>准实时的调用监控</strong></p>
<p>**(Hystrix Dashboard)**，Hystrix会持续地记录所有通过Hystrix发起的请求</p>
<p>的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少</p>
<p>请求多少成功，多少失败等。Netflix通过hystrix-metrics-event-stream项</p>
<p>目实现了对以上指标的监控。Spring Cloud也提供了Hystrix Dashboard的</p>
<p>整合，对监控内容转化成可视化界面。</p>
<h5 id="13-11-2、依赖"><a href="#13-11-2、依赖" class="headerlink" title="13.11.2、依赖"></a>13.11.2、依赖</h5><p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="13-11-3、步骤"><a href="#13-11-3、步骤" class="headerlink" title="13.11.3、步骤"></a>13.11.3、步骤</h5><ol>
<li><p>主启动类加注解激活@EnableHystrixDashboard</p>
</li>
<li><p>所有Provider微服务提供类都需要监控依赖部署</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p>访问网址<a target="_blank" rel="noopener" href="http://localhost:9001/hystrix%EF%BC%889001%E4%B8%BA%E7%AB%AF%E5%8F%A3%E5%90%8D%EF%BC%89">http://localhost:9001/hystrix（9001为端口名）</a></p>
</li>
</ol>
<h5 id="13-11-4、断路器演示-服务监控hystrixDashboard"><a href="#13-11-4、断路器演示-服务监控hystrixDashboard" class="headerlink" title="13.11.4、断路器演示(服务监控hystrixDashboard)"></a>13.11.4、断路器演示(服务监控hystrixDashboard)</h5><p>新版本Hystrix需要在主启动MainAppHystrix8001（微服务提供方）中指</p>
<p>定监控路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrixMain8001</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑</span></span><br><span class="line"><span class="comment">     *ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;，</span></span><br><span class="line"><span class="comment">     *只要在自己的项目里配置上下面的servlet就可以了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">        ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">&quot;/hystrix.stream&quot;</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">&quot;HystrixMetricsStreamServlet&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动一个eureka或者3个eureka集群进行监控测试</p>
<p>填写监控地址<a target="_blank" rel="noopener" href="http://localhost:8001/hystrix.stream">http://localhost:8001/hystrix.stream</a></p>
<p><img src="/2021/03/15/springcloud/43.png" alt="img"> </p>
<h5 id="13-11-5、如何看hystrixDashboard服务监控图"><a href="#13-11-5、如何看hystrixDashboard服务监控图" class="headerlink" title="13.11.5、如何看hystrixDashboard服务监控图"></a>13.11.5、如何看hystrixDashboard服务监控图</h5><ul>
<li><p>七色</p>
<p><img src="/2021/03/15/springcloud/44.png" alt="img"> </p>
</li>
<li><p>一圈：</p>
<p>实心圆：共有两种含义。它通过颜色的变化代表了实例的健康程度，它</p>
<p>的健康度从绿色&lt;黄色&lt;橙色&lt;红色递减。</p>
<p>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生</p>
<p>变化，流量越大该实心圆就越大。所以通过该实心圆的展示，就可以在</p>
<p>大量的实例中快速的发现<strong>故障实例和高压力实例</strong>。 </p>
</li>
<li><p>一线：</p>
<p>曲线：用来记录2分钟内流量的相对变化，可以通过它来观察到流量的上升与下降趋势 </p>
</li>
<li><p>整图说明：</p>
<p><img src="/2021/03/15/springcloud/45.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/Users/风间&琉璃/AppData/Local/Temp/mindmaster/1223393c341/bin/DF646587-C4E1-40BF-9FFD-7D10773D9637.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/46.png" alt="img"> </p>
</li>
<li><p>搞懂一个才能看懂复杂的</p>
<p><img src="/2021/03/15/springcloud/47.png" alt="img"> </p>
</li>
</ul>
<h2 id="路由网关"><a href="#路由网关" class="headerlink" title="路由网关"></a>路由网关</h2><h3 id="14、Gateway新一代网关"><a href="#14、Gateway新一代网关" class="headerlink" title="14、Gateway新一代网关"></a>14、Gateway新一代网关</h3><h4 id="14-1、是什么？"><a href="#14-1、是什么？" class="headerlink" title="14.1、是什么？"></a>14.1、是什么？</h4><p>一句话：</p>
<p>SpringCloud Gateway使用的是Webflux中的reactor-netty响应式编程组</p>
<p>件,底层使用了Netty通讯框架。</p>
<p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</a></p>
<p>Cloud全家桶中有个很重要的组件就是网关，在1.x版本中都是采用的Zuul</p>
<p>网关；但在2.x版本中，zuul的升级一直跳票，SpringCloud最后自己研发</p>
<p>了一个网关替代Zuul，那就是SpringCloud Gateway一句话：</p>
<p><strong>gateway是原zuul1.x版的替代</strong> </p>
<p><img src="/2021/03/15/springcloud/48.png" alt="img"> </p>
<p>Gateway是在Spring生态系统之上构建的API网关服务，基于Spring </p>
<p>5,Spring Boot 2和Project Reactor等技术。</p>
<p>Gateway旨在提供一种简单而有效的方式来对API进行路由，以及提供一些</p>
<p>强大的过滤器功能，例如：熔断、限流、重试等</p>
<p><img src="/2021/03/15/springcloud/49.png" alt="image-20210310010754927"></p>
<p>SpringCloud Gateway 是 Spring Cloud 的一个全新项目，基于 Spring </p>
<p>5.0+Spring Boot 2.0 和 Project Reactor 等技术开发的网关，它旨在为微</p>
<p>服务架构提供一种简单有效的统一的API路由管理方式。 </p>
<p>SpringCloud Gateway 作为 Spring Cloud 生态系统中的网关，目标是替代 </p>
<p>Zuul，在Spring Cloud 2.0以上版本中，没有对新版本的Zuul 2.0以上最新</p>
<p>高性能版本进行集成，仍然还是使用的Zuul 1.x非Reactor模式的老版本。</p>
<p>而为了提升网关的性能，SpringCloud Gateway是基于WebFlux框架实现</p>
<p>的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty。</p>
<p>Spring Cloud Gateway的目标提供统一的路由方式且基于 Filter 链的方式</p>
<p>提供了网关基本的功能，例如：安全，监控/指标，和限流。</p>
<p> 源码架构：</p>
<p><img src="/2021/03/15/springcloud/50.png" alt="img"> </p>
<h4 id="14-2、作用"><a href="#14-2、作用" class="headerlink" title="14.2、作用"></a>14.2、作用</h4><ul>
<li>反向代理</li>
<li>鉴权</li>
<li>流量控制</li>
<li>熔断</li>
<li>日志监控</li>
<li>……</li>
</ul>
<h4 id="14-3、微服务架构中网关在哪里"><a href="#14-3、微服务架构中网关在哪里" class="headerlink" title="14.3、微服务架构中网关在哪里"></a>14.3、微服务架构中网关在哪里</h4><p><img src="/2021/03/15/springcloud/51.png" alt="img"> </p>
<h4 id="14-4、Zool与Gateway"><a href="#14-4、Zool与Gateway" class="headerlink" title="14.4、Zool与Gateway"></a>14.4、Zool与Gateway</h4><ol>
<li><p>一方面因为Zuul1.0已经进入了维护阶段，而且Gateway是</p>
<p>Spring Cloud团队研发的，是亲儿子产品，值得信赖。而且很多功能</p>
<p>Zuul都没有用起来也非常的简单便捷。</p>
</li>
</ol>
<p>   Gateway是基于异步非阻塞模型上进行开发的，性能方面不需要担</p>
<p>   心。虽然Netfix早就发布了最新的Zuul 2.x，但 Spring Cloud貌似没有</p>
<p>   整合计划。而且Netflix相关组件都宣布进入维护期；不知前景如何？</p>
<p>   多方面综合考虑Gateway是很理想的网关选择。</p>
<ol start="2">
<li><p>Spring Cloud Gateway 具有如下特性：</p>
<p><strong>基于Spring Framework 5,Project Reactor和 Spring Boot 2.0 进行构建</strong>； </p>
<ul>
<li>动态路由：能够匹配任何请求属性；</li>
<li>可以对路由指定 Predicate (断言)和 Filter (过滤器)；</li>
<li>集成Hystrix的断路器功能；</li>
<li>集成 Spring Cloud 服务发现功能；</li>
<li>易于编写的Predicate (断言)和Filter (过滤器)；</li>
<li>请求限流功能；</li>
<li>支持路径重写。</li>
</ul>
</li>
<li><p>Spring Cloud Gateway 与 Zuul的区别:</p>
<p>在SpringCloud <strong>F</strong>inchley正式版之前，Spring Cloud 推荐的网关是 </p>
<p>Netflix 提供的Zuul:</p>
<ul>
<li><p>Zuul 1.x，是一个基于阻塞I/O的API Gateway</p>
</li>
<li><p>Zuul 1.x 基于<strong>Servlet 2.5</strong>使用阻塞架构，它不支持任何长连接(如 </p>
<p>WebSocket)。 Zuul 的设计模式和Nginx较像，每次I/ O 操作都</p>
<p>是<strong>从工作线程中选择一个执行</strong>，请求线程<strong>被阻塞到工作线程完成</strong>，</p>
<p>但是差别是:Nginx 用C++ 实现，Zuul 用 Java 实现，而 JVM 本身</p>
<p>会有第一次加载较慢的情况，使得Zuul的性能相对较差。</p>
</li>
<li><p>Zuul 2.x理念更先进，想<strong>基于Netty非阻塞和支持长连接</strong>，但</p>
<p>SpringCloud目前还没有整合。Zuul 2.x的性能较 Zuul 1.x有较大提升。在性能方面，根据官方提供的基准测试，Spring Cloud Gateway的RPS(每秒请求数)是Zuul的1.6倍。</p>
</li>
<li><p>Spring Cloud Gateway 建立在 <strong>Spring Framework 5、Project</strong> </p>
<p><strong>Reactor和 Spring Boot 2</strong>之上，使用<strong>非阻塞API</strong>。</p>
</li>
<li><p>Spring Cloud Gateway 还支持WebSocket，并且与Spring紧密集</p>
<p>成拥有更好的开发体验。</p>
</li>
</ul>
</li>
<li><p>springcloud中所集成的Zuul版本，采用的是Tomcat容器，使用的是传</p>
<p>统的Servlet IO处理模型。</p>
<p>Servlet的生命周期：servlet由servlet container进行生命周期管理。</p>
<ul>
<li><p>container启动时构造servlet对象并调用servlet init()进行初始化；</p>
</li>
<li><p>container运行时接受请求，并为每个请求分配一个线程(一般从线</p>
<p>程池中获取空闲线程)然后调用service();</p>
</li>
<li><p>container关闭时调用servlet destory()销毁servlet;</p>
</li>
</ul>
<p><img src="/2021/03/15/springcloud/52.png" alt="image-20210310012934921"></p>
</li>
<li><p>上述模式的缺点：</p>
<p>servlet是一个<strong>简单的网络IO模型</strong>，当请求进入servlet container时，</p>
<p>servlet container就会为其绑定一个线程，在<strong>并发不高的场景</strong>下这种模</p>
<p>型是适用的。但是一旦高并发(比如抽风用jemeter压)，线程数量就会</p>
<p>上涨，而线程资源代价是昂贵的(<strong>上线文切换，内存消耗大</strong>)严重影响请</p>
<p>求的处理时间。在一些简单业务场景下，不希望为每个request分配一</p>
<p>个线程，只需要1个或几个线程就能应对极大并发的请求，这种业务场</p>
<p>景下servlet模型没有优势。</p>
<p>而Zuul 1.X是<strong>基于servlet之上的一个阻塞式处理模型</strong>，即spring实现</p>
<p>了处理所有request请求的一个servlet(DispatcherServlet)并由该</p>
<p>servlet阻塞式处理处理。所以Springcloud Zuul无法摆脱servlet模型</p>
<p>的弊端。</p>
</li>
<li><p>WebFlux：</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux">https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux</a></p>
<p><img src="/2021/03/15/springcloud/53.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/54.png" alt="img"> </p>
<p>传统的Web框架，此如说：struts2，springmvc等都是基于Servlet </p>
<p>API与Servlet容器基础之上运行的。</p>
<p>但是，<strong>在Servlet3.1之后有了异步非阻赛的支持</strong>。而WebFlux是一个典</p>
<p>型非阻塞异步的框架，它的核心是基于Reactor的相关API实现的。相</p>
<p>对于传统的web框架来说，它可以运行在诸如Netty，Undertow及支</p>
<p>持Servlet3.1的容器上。非阻塞式+函数式编程(Spring5必须让你使用</p>
<p>java8)</p>
<p>Spring WebFlux 是Spring 5.0 引入的新的响应式框架，区别于 Spring </p>
<p>MVC，它不需要依赖Servlet API，它是<strong>完全异步非阻塞的</strong>，并且<strong>基于</strong> </p>
<p><strong>Reactor 来实现响应式流规范</strong>。</p>
<h4 id="14-5、三大核心概念"><a href="#14-5、三大核心概念" class="headerlink" title="14.5、三大核心概念"></a>14.5、三大核心概念</h4></li>
</ol>
<ul>
<li><p>Route(路由)：</p>
<p>路由是构建网关的基本模块,它由ID,目标URI,一系列的断言和过滤器组</p>
<p>成,如断言为true则匹配该路由。</p>
</li>
<li><p>Predicate(断言)：</p>
<p>参考的是Java8的java.util.function.Predicate</p>
<p>开发人员可以匹配HTTP请求中的所有内容(例如请求头或请求参数),如</p>
<p>果请求与断言相匹配则进行路由。</p>
</li>
<li><p>Filter(过滤)：</p>
<p>指的是Spring框架中GatewayFilter的实例,使用过滤器,可以在请求被路</p>
<p>由前或者之后对请求进行修改。</p>
</li>
</ul>
<p>web请求，通过一些匹配条件，定位到真正的服务节点。并在这个转发过</p>
<p>程的前后，进行一些精细化控制。</p>
<p>predicate就是我们的匹配条件；而filter，就可以理解为一个无所不能的拦截器。有了这两个元素，再加上目标uri，就可以实现一个具体的路由了。</p>
<p><img src="/2021/03/15/springcloud/55.png" alt="image-20210310014051292"> </p>
<h4 id="14-6、Gateway工作流程（路由转发-执行过滤器链）"><a href="#14-6、Gateway工作流程（路由转发-执行过滤器链）" class="headerlink" title="14.6、Gateway工作流程（路由转发+执行过滤器链）"></a>14.6、Gateway工作流程（路由转发+执行过滤器链）</h4><p>官网总结</p>
<p><img src="/2021/03/15/springcloud/56.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/Users/风间&琉璃/AppData/Local/Temp/mindmaster/1223393c341/bin/3008859F-0E2E-4542-92C5-A049333E2AC6.png" alt="img"> </p>
<p>客户端向Spring Cloud Gateway发出请求。然后在Gateway Handler </p>
<p>Mapping中找到与请求相匹配的路由，将其发送到Gateway Web </p>
<p>Handler。</p>
<p>Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务</p>
<p>逻辑，然后返回。</p>
<p>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前(“pre”)或之</p>
<p>后(“post”)执行业务逻辑。</p>
<p>Filter在“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输</p>
<p>出、协议转换等，</p>
<p>在“post”类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流</p>
<p>量监控等有着非常重要的作用。</p>
<h4 id="14-7、依赖"><a href="#14-7、依赖" class="headerlink" title="14.7、依赖"></a>14.7、依赖</h4><p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml配置：</p>
<p><img src="/2021/03/15/springcloud/57.png" alt="img"></p>
<p>访问：</p>
<p>添加网关前：<a target="_blank" rel="noopener" href="http://localhost:8001/payment/get/31">http://localhost:8001/payment/get/31</a></p>
<p>添加网关后：<a target="_blank" rel="noopener" href="http://localhost:9527/payment/get/31">http://localhost:9527/payment/get/31</a></p>
<h4 id="14-8、Gateway网关路由有两种配置方式"><a href="#14-8、Gateway网关路由有两种配置方式" class="headerlink" title="14.8、Gateway网关路由有两种配置方式"></a>14.8、Gateway网关路由有两种配置方式</h4><p>1、在配置文件yml中配置</p>
<p>2、代码中注入RouteLocator的Bean</p>
<p>示例：</p>
<p>百度国内新闻网站,需要外网<a target="_blank" rel="noopener" href="https://news.baidu.com/guonei">https://news.baidu.com/guonei</a></p>
<p>业务需求：通过9527网关访问到外网的百度新闻网址</p>
<p>实现：在cloud-gateway-gateway9527编写配置类</p>
<p><img src="/2021/03/15/springcloud/58.png" alt="img"> </p>
<p><img src="/2021/03/15/springcloud/59.png" alt="img"> </p>
<h4 id="14-9、通过服务名实现动态"><a href="#14-9、通过服务名实现动态" class="headerlink" title="14.9、通过服务名实现动态"></a>14.9、通过服务名实现动态</h4><p>默认情况下Gatway会根据注册中心注册的服务列表,  以注册中心上微服务</p>
<p>名为路径<strong>创建动态路由进行转发,从而实现动态路由的功能</strong>。</p>
<p>启动：一个eureka+两个服务提供者</p>
<p>application.yml配置：</p>
<p>需要注意的是uri的协议lb,表示启用Gateway的负载均衡功能。</p>
<p>lb://serverName是spring cloud  gatway在微服务中自动为我们创建的负载均衡uri</p>
<p><img src="/2021/03/15/springcloud/209.png" alt="img"> </p>
<h4 id="14-10、Predicate（断言）"><a href="#14-10、Predicate（断言）" class="headerlink" title="14.10、Predicate（断言）"></a>14.10、Predicate（断言）</h4><p>说白了,Predicate就是为了实现一组匹配规则,  让请求过来找到对应的</p>
<p>Route进行处理。</p>
<p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping</p>
<p>基础架构的一部分。</p>
<p>Spring Cloud Gateway包括许多内置的Route PredicateI工厂。所有这些</p>
<p>Predicate都与HTTP请求的不同属性匹配。多个RoutePredicate工厂可以</p>
<p>进行组合。</p>
<p>Spring Cloud Gateway 创建 Route 对象时，使用 RoutePredicateFactory</p>
<p>创建 Predicate 对象，Predicate 对象可以赋值给Route。Spring Cloud </p>
<p>Gateway 包含许多内置的Route Predicate Factories。</p>
<p>所有这些谓词都匹配HTTP请求的不同属性。多种谓词工厂可以组合，并通</p>
<p>过逻辑and。</p>
<p><img src="/2021/03/15/springcloud/60.png" alt="img">  </p>
<p>常用的Route Predicate</p>
<p><img src="/2021/03/15/springcloud/61.png" alt="img"> </p>
<ul>
<li><p>After Route Predicate：在设置时间之后</p>
</li>
<li><p>Before Route Predicate：在设置时间之前</p>
</li>
<li><p>Between Route Predicate：在设置时间中间</p>
</li>
<li><p>Cookie Route Predicate：请求要带有cookie</p>
</li>
<li><p>Header Route Predicate：请求要带有请求头，且请求头的值要符合要求</p>
</li>
<li><p>Host Route Predicate：要使用符合要求的主机进行访问</p>
</li>
<li><p>Method Route Predicate：请求方式要是符合要求</p>
</li>
<li><p>Path Route Predicate：路径相匹配的进行路由</p>
</li>
<li><p>Query Route Predicate：要有参数名并且值还要是符合要求的才能路由</p>
</li>
<li><p>RemoteAddr Route Predicate：通过无类别域间路由(IPv4 or IPv6)列</p>
<p>表匹配路由（- RemoteAddr=192.168.1.1/24）(不常用)</p>
</li>
<li><p>Weight Route Predicate：接收一个[组名,权重], 然后对于同一个组内</p>
<p>的路由按照权重转发（-Weight= group3, 9）（不常用）</p>
</li>
</ul>
<p>application.yml配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span> <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span> <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line">            <span class="comment">#- After=2021-03-09T01:19:24.226+08:00[Asia/Shanghai]</span></span><br><span class="line">            <span class="comment">#- Before=2021-03-09T01:19:24.226+08:00[Asia/Shanghai]</span></span><br><span class="line">            <span class="comment">#- Between=2021-03-09T01:19:24.226+08:00[Asia/Shanghai],2022-03-09T01:19:24.226+08:00[Asia/Shanghai]</span></span><br><span class="line">            <span class="comment">#- Cookie=username,xgh #请求要带有cookie（URL + -- cookie &quot;username=xgh&quot;）</span></span><br><span class="line">            <span class="comment">#- Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式（URL + --H &quot;X-Request-Id:123&quot;）</span></span><br><span class="line">            <span class="comment">#- Host=**.atguigu.com #主机要带有atguigu.com</span></span><br><span class="line">            <span class="comment">#- Method=GET #请求方式要是get</span></span><br><span class="line">            <span class="comment">#- Query=username,\d+ #要有参数名并且值还要是整数的才能路由</span></span><br><span class="line">          <span class="comment">#filters:</span></span><br><span class="line">            <span class="comment">#- AddRequestHeader=X-Request-Id,1024 #过滤器工厂会在匹配的请求头上加上一对请求头，名称为X-Request-Id，值为1024</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">gateway9527</span></span><br><span class="line">    <span class="comment">#访问路径可以显示IP地址</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册进EurekaServer默认为true。</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">      <span class="comment"># 集群版</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="14-11、Filter（过滤器）"><a href="#14-11、Filter（过滤器）" class="headerlink" title="14.11、Filter（过滤器）"></a>14.11、Filter（过滤器）</h4><h5 id="14-11-1、是什么？"><a href="#14-11-1、是什么？" class="headerlink" title="14.11.1、是什么？"></a>14.11.1、是什么？</h5><p>路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器</p>
<p>只能指定路由进行使用。</p>
<p>Spring Cloud Gateway内置了多种路由过滤器，他们都由GatewayFilter的</p>
<p>工厂类来产生。</p>
<p><img src="/2021/03/15/springcloud/62.png" alt="image-20210310021404546"> </p>
<h5 id="14-11-2、生命周期"><a href="#14-11-2、生命周期" class="headerlink" title="14.11.2、生命周期"></a>14.11.2、生命周期</h5><ul>
<li>post</li>
<li>pre</li>
</ul>
<h5 id="14-11-3、种类"><a href="#14-11-3、种类" class="headerlink" title="14.11.3、种类"></a>14.11.3、种类</h5><ul>
<li>GatewayFilter（31种）：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories</a></li>
<li>GlobalFilter（10种）：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#global-filters">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#global-filters</a></li>
</ul>
<p>常用的GatewayFilter：</p>
<p>在yml里面配置：</p>
<p><img src="/2021/03/15/springcloud/63.png" alt="img"> </p>
<p>自定义过滤器：</p>
<p>自定义全局GlobalFilter</p>
<p>两个主要接口</p>
<ul>
<li><p>GlobalFilter</p>
</li>
<li><p>Ordered</p>
</li>
</ul>
<p>作用：</p>
<ul>
<li>全局日志记录</li>
<li>统一网关鉴权</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGateWayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;**************come in MylogGateWayGilter:  &quot;</span> + <span class="keyword">new</span> Date());</span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (uname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;********用户名为空，非法用户。&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截的级别，值越小，级别越大</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="分布式配置中心"><a href="#分布式配置中心" class="headerlink" title="分布式配置中心"></a>分布式配置中心</h2><h3 id="15、SpringCloud-config"><a href="#15、SpringCloud-config" class="headerlink" title="15、SpringCloud config"></a>15、SpringCloud config</h3><h4 id="15-1、分布式系统面临的问题"><a href="#15-1、分布式系统面临的问题" class="headerlink" title="15.1、分布式系统面临的问题"></a>15.1、分布式系统面临的问题</h4><p>配置问题：</p>
<p>到目前为止，我们对 Eureka、Robbin、OpenFeign、Hystrix、Gateway</p>
<p>等有了相应的了解，每个微服务都是单独一个模块，微服务彼此还支持集群</p>
<p>环境。</p>
<p>但是在微服务项目的开发中，还面临着一个严重的配置问题。每一个微服务</p>
<p>都需要一个配置文件，如果有几个微服务需要连接数据库，name就需要进</p>
<p>行 4 次数据库的配置。当数据库发生改变，那么就需要同时修改 4 个微服</p>
<p>务的配置文件才可以。那么如果有40台呢？如果是集群模式呢？？</p>
<p>如果能够做到：一处修改、处处生效，这样就可以减轻修改配置压力，从而</p>
<p>增强配置管理方面的功能，此时就需要 Spring Cloud Config 和 Spring </p>
<p>Cloud Bus 上场了。</p>
<p>使用 Config + Bus，可以实现 ：</p>
<ul>
<li><p>一处修改、处处生效</p>
</li>
<li><p>灵活的对版本(dev/test/prod)进行切换，这样就足够方便了</p>
</li>
</ul>
<p><img src="/2021/03/15/springcloud/64.png" alt="img"></p>
<h4 id="15-2、是什么："><a href="#15-2、是什么：" class="headerlink" title="15.2、是什么："></a>15.2、是什么：</h4><p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/</a></p>
<p>Springcloud config为微服务架构中的微服务提供集中化的外部配置支持，</p>
<p>配置服务器为各个不同微服务应用的所有环境提供一个中心化的外部配</p>
<p>置。各个不同微服务应用 Springcloud config为微服务架构中的微服务提</p>
<p>供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环境</p>
<p>提供一个中心化的外部配置。中心化的外部配置。</p>
<h4 id="15-3、怎么用："><a href="#15-3、怎么用：" class="headerlink" title="15.3、怎么用："></a>15.3、怎么用：</h4><p>Springcloud Config分为<strong>服务端</strong>和<strong>客户端</strong>两部分。</p>
<ul>
<li><p>服务端（Config Server）：也称分布式配置中心，它是一个独立的微服</p>
<p>务应用，用来连接配置服务器并未客户端提供获取配置信息，加密、解</p>
<p>密信息等访问接口。</p>
</li>
<li><p>客户端：通过指定的 <strong>配置中心(Config Server)</strong> 来管理应用资源，以及与业务相关的配置内容，并在启动的时候从 <strong>配置中心</strong> 获取和加载配置信息。</p>
</li>
</ul>
<h4 id="15-4、作用"><a href="#15-4、作用" class="headerlink" title="15.4、作用"></a>15.4、作用</h4><ul>
<li><p>集中管理配置文件</p>
</li>
<li><p>不同环境不同配置，动态化的配置更新，分环境部署比如</p>
<p>dev/test/prod/beta/release</p>
</li>
<li><p>运行期间动态调整配置，不再需要字啊每个服务器的机器上编写配置文</p>
<p>件，服务会向配置中心同意拉去配置自己的信息</p>
</li>
<li><p>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的</p>
<p>配置</p>
</li>
<li><p>将配置信息以REST接口的形式暴露</p>
<ul>
<li>post,curl访问刷新均可</li>
</ul>
</li>
</ul>
<h4 id="15-5、与GitHub整合配置"><a href="#15-5、与GitHub整合配置" class="headerlink" title="15.5、与GitHub整合配置"></a>15.5、与GitHub整合配置</h4><p>由于SpringCloud Config默认使用Git来存储配置文件（也有其他方式，比</p>
<p>如注册SVN和本地文件），但最推荐的还是Git，而且使用的是http/https服</p>
<p>务的形式。</p>
<p>步骤：</p>
<ol>
<li><p>创建存储 Config 的新 Repository</p>
</li>
<li><p>将新建的GitHub远程仓库克隆到本地</p>
<p>Repository 创建成功，即可获取自己的仓库地址，将项目克隆到本</p>
<p>地，方便对数据的修改。（GitHub 也支持直接修改，你也可以不克</p>
<p>隆，此处克隆只是为了更方便处理数据。）</p>
</li>
<li><p>进入克隆目录，新建三个配置文件，分别是 <strong><code>config-dev.yml</code>**、</strong><code>config-test.yml</code><strong>、</strong><code>config-prod.yml</code>**。然后通过命令将其推送到远程GitHub仓库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add *.yml(将提交的文件加入暂存区，为git commit做准备)</span><br><span class="line">git commit -m “first commit” (完成对文件内容提交至Git版本库)</span><br><span class="line">git push -u origin master(将本地仓库内容，推送至GitHub远程仓库)</span><br></pre></td></tr></table></figure>
</li>
<li><p>对配置修改后，通过以上三个命令，便可以再次将修改后的内容推送至 GitHub。你也可以使用 IDEA 等工具进行</p>
<p><img src="/2021/03/15/springcloud/69.png" alt="在这里插入图片描述"></p>
</li>
<li><p>Github 远程仓库内容</p>
<p><img src="/2021/03/15/springcloud/70.png" alt="在这里插入图片描述"></p>
</li>
<li><p><strong>服务端</strong>配置测试 (Config 结构图中的 <strong>Config Server</strong>)</p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入spring-cloud-config-server依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件 application.yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span>   <span class="comment">#端口号</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-center</span>  <span class="comment">#注册进Eureka 服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/Liuzebiao/springcloud-config.git</span>  <span class="comment">#GitHub远程仓库地址</span></span><br><span class="line">          <span class="comment"># 搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">      <span class="comment">#读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span>  <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p>主启动类 配置**@EnableConfigServer**注解</p>
<p>启动测试：<a target="_blank" rel="noopener" href="http://localhost:3344/master/config-dev.yml">http://localhost:3344/master/config-dev.yml</a></p>
</li>
<li><p>GitHub配置文件<strong>读取规则</strong>：</p>
<p>远程 GitHub 仓库，配置文件的命名也是有具体规则的。Spring Cloud </p>
<p>Config 官方共支持 5 种方式的配置（<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/#_quick_start">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/#_quick_start</a></p>
<p>参数说明：</p>
<ol>
<li><code>label</code>：GitHub 分支(branch)名称</li>
<li><code>application</code>：服务名</li>
<li><code>profile</code>：环境(<code>dev/test/prod</code>)</li>
</ol>
<ul>
<li><p>/{application}/{profile}/{label}：</p>
<p>返回的是 Json 对象，需要自己解析所要的内容</p>
<p><img src="/2021/03/15/springcloud/71.png" alt="在这里插入图片描述"></p>
</li>
<li><p>/{application}-{profile}.yml：</p>
<p>(这种不带label方式，默认使用application.yml 配置)因为 </p>
<p>applicaiton.yml 文件已经有配置过 label，不带label 方式，默认走</p>
<p>的就是 yml 配置的 label，返回的是配置内容</p>
<p><img src="/2021/03/15/springcloud/72.png" alt="在这里插入图片描述"></p>
</li>
<li><p>/{label}/{application}-{profile}.yml：</p>
<p>(推荐使用第三种)这种方式简明扼要，条理清晰，返回的是配置内</p>
<p>容</p>
<p><img src="/2021/03/15/springcloud/73.png" alt="在这里插入图片描述"></p>
</li>
<li><p>/{application}-{profile}.properties：</p>
<p>同第2种</p>
</li>
<li><p>/{label}/{application}-{profile}.properties：</p>
<p>同第3种</p>
</li>
</ul>
</li>
<li><p><strong>客户端</strong>配置测试 (Config 结构图中的 Client A、Client B、Client C)</p>
<p>依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入spring-cloud-starter-config依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件 bootstrap.yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span> <span class="comment">#端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span> <span class="comment">#名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#config客户端配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>  <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span>  <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>   <span class="comment"># 读取后缀名称   上述3个综合：master分支上config-dev.yml 的配置文件被读取(http://config-3344.com:3344/master/fongig-dev.yml)</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span>   <span class="comment">#配置中心地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p>主启动类 配置**@EnableConfigServer**注解</p>
<p>controller业务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span> <span class="comment">//通过这种方式，可以直接读取ConfigServer中的配置信息</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试：<a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a></p>
<h4 id="15-6、bootstrap-yml与application-yml"><a href="#15-6、bootstrap-yml与application-yml" class="headerlink" title="15.6、bootstrap.yml与application.yml"></a>15.6、bootstrap.yml与application.yml</h4></li>
</ol>
<p>applicaiton.yml是用户级的资源配置项</p>
<p>bootstrap.yml是系统级的，<strong>优先级更加高</strong></p>
<p>Spring Cloud会创建一个“Bootstrap Context”，作为Spring应用</p>
<p>的<code>Application Context</code>的<strong>父上下文</strong>。初始化的时候，</p>
<p><code>BootstrapContext</code>负责从<strong>外部源</strong>加载配置属性并解析配置。这两个上下</p>
<p>文共享一个从外部获取的<code>Environment</code>。</p>
<p>“Bootstrap”属性有<strong>高优先级</strong>，默认情况下，它们不会被本地配置覆</p>
<p>盖。<code>Bootstrap context</code>和<code>Application Context</code>有着不同的约定，所</p>
<p>以新增了一个bootstrap.yml’文件，保证<code>Bootstrap Context</code>和</p>
<p><code>Application Context</code>配置的分离。</p>
<p><strong>要将Client模块下的application.yml文件改为bootstrap.yml,这是很关</strong></p>
<p><strong>键的</strong>，因为bootstrap.yml是比application.yml先加载的。bootstrap.yml</p>
<p>优先级高于application.yml。 </p>
<h4 id="15-7、分布式配置的动态刷新问题"><a href="#15-7、分布式配置的动态刷新问题" class="headerlink" title="15.7、分布式配置的动态刷新问题"></a>15.7、分布式配置的动态刷新问题</h4><ol>
<li><p>POM引入actuator监控</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入actuator监控--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改YML,暴露监控接口</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span> </span><br><span class="line">	<span class="attr">endpoints:</span> </span><br><span class="line">		<span class="attr">web:</span> </span><br><span class="line">			<span class="attr">exposure:</span> </span><br><span class="line">				<span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>@RefreshScope业务类Controller修改</p>
</li>
<li><p>需要运维人员发送Post请求刷新3355客户端</p>
<ul>
<li>必须是POST请求</li>
<li>curl  -X POST “<a target="_blank" rel="noopener" href="http://localhost:3355/actuator/refresh&quot;">http://localhost:3355/actuator/refresh&quot;</a></li>
</ul>
</li>
</ol>
<h4 id="15-8、残留问题"><a href="#15-8、残留问题" class="headerlink" title="15.8、残留问题"></a>15.8、残留问题</h4><ul>
<li><p>假如有 N 多个台，就需要 N 多次的curl的手动刷新</p>
<p>解决想法：</p>
<p>大规模 <strong><code>微服务/集群模式</code>**，</strong>我们可以采用广播的方式，一次通知，处处生效。<strong>类似于 **<code>消息队列的 Topic</code></strong> ，**<code>微信公众号</code>** 的概念，一次订阅，所有订阅者都能接收到新消息。</p>
</li>
<li><p>无法实现精确通知,只通知集群中的某些服务(精确通知，比如有100台机器，只通知前98台)</p>
</li>
</ul>
<p>解决以上两个问题的方法：bus消息总线</p>
<h2 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线"></a>消息总线</h2><h3 id="16、SpringCloud-Bus"><a href="#16、SpringCloud-Bus" class="headerlink" title="16、SpringCloud Bus"></a>16、SpringCloud Bus</h3><h4 id="16-1、是什么"><a href="#16-1、是什么" class="headerlink" title="16.1、是什么"></a>16.1、是什么</h4><p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-bus/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-bus/2.2.1.RELEASE/reference/html/</a></p>
<p>在微服务架构的系统中，通常会使用<strong>轻量级的消息代理</strong>来构建一个<strong>共用的消</strong></p>
<p><strong>息主题</strong>，并让系统中所有的微服务实例都连接上来。由于<strong>该主题中产生的消</strong></p>
<p><strong>息会被所有实例监听和消费，所以称它为消息总线</strong>在总线上的各个实例，都</p>
<p>可以方便的广播一些需要让其他链接在该主题上的实例都知道的消息。</p>
<p>Spring Cloud Bus 是用来将 <strong>分布式系统的节点</strong>与 <strong>轻量级消息系统</strong>连接起来</p>
<p>的框架，它整合了 Java 的<strong>事件处理机制</strong>和<strong>消息中间件</strong>的功能。Spring </p>
<p>Cloud Bus 目前仅支持<code>RabbitMQ</code>和<code>Kafka</code>。</p>
<h4 id="16-2、作用"><a href="#16-2、作用" class="headerlink" title="16.2、作用"></a>16.2、作用</h4><p>Spring Cloud Bus能管理和传播分布式系统间的消息，就像一个分布式执行</p>
<p>器，可用于广播状态更改，事件推送等，也可以作为微服务的通信通道。</p>
<p><img src="/2021/03/15/springcloud/65.png" alt="img"></p>
<h4 id="16-3、基本原理与执行流程"><a href="#16-3、基本原理与执行流程" class="headerlink" title="16.3、基本原理与执行流程"></a>16.3、基本原理与执行流程</h4><p>ConfigClient实例都监听MQ中的同一个topic(默认是<strong>SpringcloudBus</strong>)。</p>
<p>当一个服务刷新数据的时候，它会把这个信息放入到topic中，这样其它监</p>
<p>听同一个topic的服务就能得到通知，然后去更新自身的配置。其实就是<strong>通</strong></p>
<p><strong>过 MQ 消息队列的 Topic 机制，达到广播的效果。</strong></p>
<p><img src="/2021/03/15/springcloud/66.png" alt="img"></p>
<h4 id="16-4、Bus的两种设计思想"><a href="#16-4、Bus的两种设计思想" class="headerlink" title="16.4、Bus的两种设计思想"></a>16.4、Bus的两种设计思想</h4><ol>
<li><p>触发<strong>客户端</strong>：</p>
<p>利用消息总线触发一个<strong>客户端</strong>的<code>/bus/refresh</code>,而刷新所有客户端的配置</p>
<p><img src="/2021/03/15/springcloud/67.png" alt="img"></p>
</li>
<li><p>触发<strong>服务端</strong>：</p>
<p>利用消息总线触发一个<strong>服务端</strong>ConfigServer的<code>/bus/refresh</code>端点，而</p>
<p>刷新所有客户端的配置</p>
<p><img src="/2021/03/15/springcloud/68.png" alt="img"></p>
</li>
</ol>
<p>如何选型：</p>
<p>根据架构图显然<strong>第二种</strong>更加合适，所以推荐使用<strong>触发服务端 Config Server</strong> </p>
<p>的方式。第一种触发客户端方式 不适合的原因如下：</p>
<ol>
<li><p>利用消息总线触发客户端方式，<strong>打破了微服务的职责单一性</strong>，因为微服</p>
<p>务本身是业务模块，它本不应该承担配置刷新的职责；</p>
</li>
<li><p>触发客户端方式，<strong>破坏了微服务各个节点之间的对等性</strong>（比如说：</p>
<p>3355/3366/3377 集群方式提供服务，此时 3355 还需要消息通知，影</p>
<p>响节点的对等性）</p>
</li>
<li><p><strong>有一定的局限性</strong>。当微服务迁移时，网络地址会经常发生变化，如果此</p>
<p>时需要做到自动刷新，则会增加更多的修改。</p>
</li>
</ol>
<h4 id="16-5、Bus-动态刷新全局广播配置"><a href="#16-5、Bus-动态刷新全局广播配置" class="headerlink" title="16.5、Bus 动态刷新全局广播配置"></a>16.5、Bus 动态刷新全局广播配置</h4><ul>
<li><p>集群版客户端组建（搭建两个或多个客户端）</p>
</li>
<li><p><strong>服务端</strong>配置中心/<strong>客户端</strong> pom 引入Bus总线依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端配置中心 application.yml 修改 (添加 rabbitmq 相关配置)</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加rabbitmq相关支持（新加）</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rabbitmq相关配置，暴露bus舒心配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span>  <span class="comment">#为什么配置 bus-refresh，看传染病那张图</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端 application.yml 修改 (同样添加 rabbitmq 相关配置)</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加rabbitmq相关支持</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#暴露监控端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span>  <span class="comment">#此处有很多选项可以配置，为了省事 ,直接配置 *</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动模块，开始测试</p>
<p>启动：服务端配置中心 Config Server (3344)、客户端集群</p>
<p>(3355/3366)、Eureka Server(7001)。修改 GitHub 参数配置，然后向 </p>
<p>服务端 发送 Post 请求，命令：<code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</code>，</p>
<p>当向 Config Server 发送 Post 请求后，总线上的各个实例(客户端 </p>
<p>3355/3366 )都能够及时 <strong><code>监听和消费</code></strong> 配置的变更。使用广播的方式，真</p>
<p>正的实现 **<code>一处通知，处处生效</code>**。</p>
<p>使用 MQ 广播的方式，实现<code>一处通知，处处生效</code>的效果。此时我们登陆 </p>
<p>Rabbit MQ 客户端，在<code>Exchanges</code>模块，就能够看到一个叫做 </p>
<p><code>springCloudBus</code>的<code>Topic</code>。</p>
<p>与本文 2.2 Bus 原理 中介绍吻合：<strong>Config 客户端示例，都去监听 MQ</strong> </p>
<p><strong>中的同一个 topic（默认是 springCloudBus）。当一个服务刷新数据</strong></p>
<p>**的时候，它会把这个消息放入到 Topic 中，这样其他监听同一 Topic **</p>
<p><strong>的服务就能够得到通知，然后去更新自身的配置</strong>。</p>
</li>
</ul>
<h4 id="16-6、Bus-动态刷新定点通知配置"><a href="#16-6、Bus-动态刷新定点通知配置" class="headerlink" title="16.6、Bus 动态刷新定点通知配置"></a>16.6、Bus 动态刷新定点通知配置</h4><p>如果需要<strong>差异化通知</strong>，并不想进行全局广播，此时就用到了 Bus 的<strong>定点通</strong></p>
<p><strong>知</strong>功能。</p>
<p>此次我们通过客户端集群(3344/3355)演示。GitHub 远程配置修改后 ，进</p>
<p>行差异化定点通知，只通知 3355，不通知 3366。此处命令和全局广播有点</p>
<p>不同，命令为：http://配置中心IP:配置中心的端口号/actuator/bus-</p>
<p>refresh/{destination}</p>
<p>通过指定 /bus/refresh请求不再发送到具体的服务实例上，而是发给 </p>
<p>Config Server 并通过 <strong>{destination} 参数</strong>来指定需要更新配置的服务或实</p>
<p>例。</p>
<p><strong>{destination} 参数</strong> = 微服务名 ：端口号。3355 微服务名为：config-</p>
<p>client。此处最终发送的 Post 请求命令为：curl -X POST <a target="_blank" rel="noopener" href="http://localhost:3/">http://localhost:3</a></p>
<p>344/actuator/bus-refresh/config-client:3355，真正的实现<strong>精确通知</strong>功</p>
<p>能。</p>
<h2 id="消息驱动"><a href="#消息驱动" class="headerlink" title="消息驱动"></a>消息驱动</h2><h3 id="17、Spring-Cloud-Stream消息驱动"><a href="#17、Spring-Cloud-Stream消息驱动" class="headerlink" title="17、Spring Cloud Stream消息驱动"></a>17、Spring Cloud Stream消息驱动</h3><h4 id="17-1、目前微服务面临的问题"><a href="#17-1、目前微服务面临的问题" class="headerlink" title="17.1、目前微服务面临的问题"></a>17.1、目前微服务面临的问题</h4><p>在项目开发中，常用的四种消息中间件：<code>ActiveMQ</code>、<code>RabbitMQ</code>、</p>
<p><code>RocketMQ</code>、<code>Kafka</code>。由于每个项目需求的不同，在消息中间件的选型</p>
<p>上也就会不同。</p>
<p>在项目开发中，你会遇到以下一些问题：</p>
<ul>
<li><p>自己学的是 RabbitMQ，公司用的却是 Kafka 。再学 Kafka？学习成本</p>
<p>太高，负担太重；</p>
</li>
<li><p>多部门配合，MQ差异化带来的联调问题。A部门使用 RabbitMQ 进行</p>
<p>消息发送，大数据部门却用 Kafka， MQ 选型的不同，MQ 切换、维</p>
<p>护、开发等困难随之而来。</p>
</li>
</ul>
<p>有没有一种技术，可以让我们不再关注 MQ 的细节，只需要用一种<strong>适配绑</strong></p>
<p><strong>定</strong>的方式，就可以帮助我们自动的在各种 MQ 之间切换呢？答案就是</p>
<p>Spring Cloud Stream 消息驱动。</p>
<p>Spring Cloud Stream 消息驱动，它可以<strong>屏蔽底层 MQ 之间的细节差异</strong>。我</p>
<p>们只需要操作Spring Cloud Stream 就可以操作底层多种多样的MQ。从而</p>
<p>解决我们在 MQ 切换、维护、开发方面的难度问题。</p>
<h4 id="17-2、是什么"><a href="#17-2、是什么" class="headerlink" title="17.2、是什么"></a>17.2、是什么</h4><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-stream#overview">https://spring.io/projects/spring-cloud-stream#overview</a></p>
<p>Spring Cloud Stream 是一个<strong>构建消息驱动</strong>微服务的框架。应用程序通过 </p>
<p><strong>inputs</strong>或者<strong>outputs</strong>来与 Spring Cloud Stream 中的 <strong>binder</strong> 对象交互。通</p>
<p>过我们的配置来进行 binding(绑定)， 然后 Spring Cloud Stream <strong>通过</strong> </p>
<p><strong>binder 对象与消息中间件交互</strong>。所以，我们只需要搞清楚如何与 Spring </p>
<p>Cloud Stream 交互，就可以方便使用消息驱动的方式。</p>
<p>Spring Cloud Stream 通过使用 <strong>Spring Integration</strong> 来连接消息代理中间</p>
<p>件，以实现消息时间驱动。Spring Cloud Stream 为一些供应商的消息中间</p>
<p>件产品提供了个性化的自动配置发现，引用了<code>发布-订阅</code>、<code>消费组</code>、<code>分区 </code>三</p>
<p>个核心概念。目前仅支持<code>RabbitMQ</code>、<code>Kafka</code>。</p>
<p>一句话总结： Spring Cloud Stream 屏蔽了底层消息中间件的差异，降低</p>
<p>MQ 切换成本，统一消息的编程模型。开发中使用的就是各种<strong>xxxBinder</strong></p>
<p><img src="/2021/03/15/springcloud/74.png" alt="img"></p>
<h4 id="17-3、设计思想"><a href="#17-3、设计思想" class="headerlink" title="17.3、设计思想"></a>17.3、设计思想</h4><h5 id="17-3-1、标志MQ"><a href="#17-3-1、标志MQ" class="headerlink" title="17.3.1、标志MQ"></a>17.3.1、标志MQ</h5><p><strong><code>生产者/消费者</code></strong> 之间通过 <strong><code>消息媒介</code></strong> 传递消息内容</p>
<p>生产者/消费者之间靠消息媒介传递信息内容：Message</p>
<p>消息必须走特定的通道：MessageChannel</p>
<p>消息通道MessageChannel的子接口SubscribeChannel，由</p>
<p>MessageHandler消息处理器所订阅</p>
<p>结构图：</p>
<p><img src="/2021/03/15/springcloud/75.png" alt="在这里插入图片描述"></p>
<h5 id="17-3-2、Spring-Cloud-Stream"><a href="#17-3-2、Spring-Cloud-Stream" class="headerlink" title="17.3.2、Spring Cloud Stream"></a>17.3.2、Spring Cloud Stream</h5><p>比如说我们用到了RabbitMQ和 Kafka，由于这两个消息中间件的架构上的</p>
<p>不同。像RabbitMQ 有<code>exchange</code>、Kafka有<code>Topic</code>和<code>Partions</code>分区的概念。</p>
<p>这些中间件的差异性，给我们实际项目的开发造成了一定的困扰。我们如果</p>
<p>用了两个消息队列中的其中一个，后面的业务需求如果向往另外一种消息队</p>
<p>列进行迁移，这需求简直是灾难性的。<strong>因为它们之间的耦合性过高，导致一</strong></p>
<p><strong>大堆东西都要重新推到来做</strong>，这时候 Spring Cloud Stream 无疑是一个好的</p>
<p>选择，它为我们提供了一种解耦合的方式。</p>
<p>结构图：</p>
<p><img src="/2021/03/15/springcloud/76.png" alt="在这里插入图片描述"></p>
<h4 id="17-4、Spring-Cloud-Stream如何统一底层差异"><a href="#17-4、Spring-Cloud-Stream如何统一底层差异" class="headerlink" title="17.4、Spring Cloud Stream如何统一底层差异"></a>17.4、Spring Cloud Stream如何统一底层差异</h4><p>在没有绑定器这个概念的情况下，我们的 Spring Boot 应用直接与消息中间</p>
<p>件进行信息交互时，由于个消息中间件构建的初衷不同，它们的实现细节上</p>
<p>会有较大的差异性。</p>
<p><strong>通过定义绑定器(Binder)作为中间层，就可以完美的实现应用程序与消息中</strong></p>
<p><strong>间件细节的隔离</strong>。 通过向应用程序暴露统一的 Channel 通道，使得应用程</p>
<p>序不需要在考虑各种不同的消息中间件的实现。</p>
<h4 id="17-5、Binder"><a href="#17-5、Binder" class="headerlink" title="17.5、Binder"></a>17.5、Binder</h4><p>在没有绑定器这个概念的情况下，我们的SpringBoot应用要直接与消息中</p>
<p>间件进行信息交互的时候，由于各消息中间件构建的初衷不同，它们的实现</p>
<p>细节上会有较大的差异性，<strong>通过定义绑定器作为中间层，完美地实现了应用</strong></p>
<p><strong>程序与消息中间件细节之间的隔离</strong>。Stream对消息中间件的进一步封装，</p>
<p>可以做到代码层面对中间件的无感知，甚至于动态的切换中间件(rabbitmq</p>
<p>切换为kafka)，使得微服务开发的高度解耦，服务可以关注更多自己的业务</p>
<p>流程。</p>
<p><img src="/2021/03/15/springcloud/77.png" alt="img"></p>
<ul>
<li>INPUT：适用于消费者</li>
<li>OUTPUT：适用于生产者</li>
</ul>
<p>默认情况下，RabbitMQ Binder实现<strong>将每个目标映射到TopicExchange</strong>。 </p>
<p>对于每个使用者组，队列都绑定到该 TopicExchange。 每个使用者实例在</p>
<p>其组的队列中都有一个对应的 RabbitMQ使用者实例。 对于分区的生产者</p>
<p>和使用者，队列以分区索引为后缀，并使用分区索引作为路由键。 对于匿</p>
<p>名使用者（没有组属性的使用者），将使用自动删除队列（具有随机的唯一</p>
<p>名称）。</p>
<h4 id="17-6、Spring-Cloud-Stream-执行流程"><a href="#17-6、Spring-Cloud-Stream-执行流程" class="headerlink" title="17.6、Spring Cloud Stream 执行流程"></a>17.6、Spring Cloud Stream 执行流程</h4><p><img src="/2021/03/15/springcloud/78.png" alt="在这里插入图片描述"></p>
<p>说明：</p>
<ol>
<li><code>Source/Sink</code>：Source 输入消息，Sink 输出消息</li>
<li><code>Channel</code>：通道，是队列 Queue 的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel 对队列进行配置；</li>
<li><code>Binder</code>：很方便的 **<code>连接中间件</code>**，屏蔽 MQ 之间的差异</li>
</ol>
<h4 id="17-7、编码API和常用注解"><a href="#17-7、编码API和常用注解" class="headerlink" title="17.7、编码API和常用注解"></a>17.7、编码API和常用注解</h4><p><img src="/2021/03/15/springcloud/79.png" alt="在这里插入图片描述"></p>
<h4 id="17-8、详细配置与代码"><a href="#17-8、详细配置与代码" class="headerlink" title="17.8、详细配置与代码"></a>17.8、详细配置与代码</h4><p>选用 RabbitMQ，在不需要任何 RabbitMQ 包依赖的基础上，使用 Spring </p>
<p>Cloud Stream 消息驱动来实现消息的发送&amp;接收。</p>
<p>步骤：</p>
<ol>
<li><p>生产者配置</p>
<p>依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入stream-rabbit依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>applicaiton.yml 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于binding整合(可以自定义名称)</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">default-binder:</span> <span class="string">defaultRabbit</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>  <span class="comment"># 设置要绑定的消息服务的具体设置(需与自定义名称一致)(飘红：Settings-&gt;Editor-&gt;Inspections-&gt;Spring-&gt;Spring Boot-&gt;Spring Boot application.yml 对勾去掉)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<p>业务类：</p>
<ul>
<li><p><strong>controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageProvider messageProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sendMessage&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageProvider.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>interface 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMessageProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>service</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@EnableBinding 指信道channel和exchange绑定在一起</span></span><br><span class="line"><span class="comment">//@EnableBinding(Source.class) 就是将 Source(源) 放到 Channel 的意思</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span>  <span class="comment">//定义消息的推送管道</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProviderImpl</span> <span class="keyword">implements</span> <span class="title">IMessageProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output; <span class="comment">// 消息发送管道</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String serial = UUID.randomUUID().toString();</span><br><span class="line">        output.send(MessageBuilder.withPayload(serial).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;发送消息: &quot;</span>+serial);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>测试启动：<a target="_blank" rel="noopener" href="http://localhost:8801/sendMessage">http://localhost:8801/sendMessage</a></p>
<p>可以看到后台有显示发送消息，进入 RabbitMQ 可视化界面，可以看到</p>
<p>有发送消息波峰出现。</p>
</li>
<li><p>消费者配置</p>
<p>依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入stream-rabbit依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>applicaiton.yml 配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合(可以自定义名称)</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>  <span class="comment"># 设置要绑定的消息服务的具体设置(需与自定义名称一致)(飘红：Settings-&gt;Editor-&gt;Inspections-&gt;Spring-&gt;Spring Boot-&gt;Spring Boot application.yml 对勾去掉)</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">receive-8802.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<p>业务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveMessageListenerController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">input</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1号消费者，接收：&quot;</span>+message.getPayload()+<span class="string">&quot;\t port:&quot;</span>+serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试：启动 RabbitMQ，调用<a target="_blank" rel="noopener" href="http://localhost:880/sendMessage">http://localhost:880/sendMessage</a></p>
<p>进行消息发送，可以看到消费者后台在实时接收消息。</p>
</li>
</ol>
<p>这样，我们并没有引入任何相关 RabbitMQ 包，也并不了解 Rabbit MQ。</p>
<p>便能够使用 Rabbit MQ 进行 **<code>消息发送 &amp; 接收</code>**。这就是Spring Cloud </p>
<p>Stream 消息驱动的优越之处。</p>
<h4 id="17-9、Stream-重复消费-持久化问题"><a href="#17-9、Stream-重复消费-持久化问题" class="headerlink" title="17.9、Stream 重复消费/持久化问题"></a>17.9、Stream 重复消费/持久化问题</h4><h5 id="17-9-1、重复消费问题"><a href="#17-9-1、重复消费问题" class="headerlink" title="17.9.1、重复消费问题"></a>17.9.1、重复消费问题</h5><p>当集群方式进行消息消费时，就会存在消息的重复消费问题。比如支付微服</p>
<p>务，购物支付完成后，消息重复消费就会导致支付多次的问题出现，这显然</p>
<p>是不能接受的。</p>
<p>这是因为<strong>没有进行分组的原因，不同组就会出现重复消费</strong>；<strong>同一组</strong>内会发生</p>
<p><strong>竞争关系</strong>，<strong>只有一个可以消费</strong>。 如果我们不指定(8802、8803)集群分组信</p>
<p>息，它会默认将其当做两个分组来对待。这个时候，如果发送一条消息到 </p>
<p>MQ，不同的组就都会收到消息，就会造成消息的重复消费。</p>
<p><strong>解决方法：</strong></p>
<p>只需要用到 Stream 当中 group 属性对消息进行分组即可。将8802、8803</p>
<p>分到一个组即可。<strong>（项目中，是否分组就视业务情况而定吧）</strong></p>
<p><img src="/2021/03/15/springcloud/80.png" alt="在这里插入图片描述"></p>
<h5 id="17-9-2、持久化问题"><a href="#17-9-2、持久化问题" class="headerlink" title="17.9.2、持久化问题"></a>17.9.2、持久化问题</h5><p>服务端发送消息时，此时客户端断开服务（宕机）：若客户端没有分组，此</p>
<p>时客户端不会接收到服务端发送的消息，导致<strong>消息丢失</strong>。</p>
<p>解决方法：</p>
<p>加一个 group 分组属性就行了。如果有客户端有进行分组，重启之后则可</p>
<p>以消费待消费的消息。特别的，但多个客户端都为同一组时，既使其中有一</p>
<p>个客户端宕机，其同组的<strong>一个客户端</strong>也可以接收到消息，不会导致消息丢失</p>
<p>（无需重启）。</p>
<h2 id="分布式链路追踪"><a href="#分布式链路追踪" class="headerlink" title="分布式链路追踪"></a>分布式链路追踪</h2><h3 id="18、Spring-Cloud-Sleuth-Zipkin-分布式链路追踪"><a href="#18、Spring-Cloud-Sleuth-Zipkin-分布式链路追踪" class="headerlink" title="18、Spring Cloud Sleuth + Zipkin 分布式链路追踪"></a>18、Spring Cloud Sleuth + Zipkin 分布式链路追踪</h3><h4 id="18-1、目前微服务面临的问题"><a href="#18-1、目前微服务面临的问题" class="headerlink" title="18.1、目前微服务面临的问题"></a>18.1、目前微服务面临的问题</h4><p>在微服务框架中，一个由客户端发起的请求，在后端系统中会经过多个不同</p>
<p>的微服务节点调用，协同操作产生最后的请求结果。每一个前端请求都会形</p>
<p>成一条复杂的分布式服务调用链路，链路中的任何一环出现<code>高延时</code>或者<code>错</code></p>
<p><code>误</code>，都会引起整个请求最后的失败。</p>
<h4 id="18-2、是什么？"><a href="#18-2、是什么？" class="headerlink" title="18.2、是什么？"></a>18.2、是什么？</h4><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-sleuth#overview">https://spring.io/projects/spring-cloud-sleuth#overview</a></p>
<p>Spring Cloud Sleuth 提供了分布式系统中一套完整的服务跟踪的解决方</p>
<p>案，并且兼容支持了zipkin，完美的解决了多个微服务之间链路调用的问</p>
<p>题。</p>
<p>一句话总结： 就是用来处理服务之间调用关系的。</p>
<h4 id="18-3、调用结构图"><a href="#18-3、调用结构图" class="headerlink" title="18.3、调用结构图"></a>18.3、调用结构图</h4><p><img src="/2021/03/15/springcloud/81.png" alt="在这里插入图片描述"></p>
<h4 id="18-4、搭建链路监控步骤"><a href="#18-4、搭建链路监控步骤" class="headerlink" title="18.4、搭建链路监控步骤"></a>18.4、搭建链路监控步骤</h4><h5 id="18-4-1、环境准备"><a href="#18-4-1、环境准备" class="headerlink" title="18.4.1、环境准备"></a>18.4.1、环境准备</h5><p>Zipkin 是 Twitter 的一个开源项目，允许开发者收集 Twitter 各个服务上的</p>
<p>监控数据，并提供查询接口。</p>
<p>我们需要先准备一个 Zipkin 环境。<strong>Spring Cloud 从F版起已不需要自己构</strong></p>
<p><strong>建Zipkin server了</strong>，只需要调用jar包即可。当前使用版本为 H版。我们只</p>
<p>需要下载 Zipkin jar包，在安装目录的路径下使用 java -jar xxx的方式启动</p>
<p>即可。点击链接：<a target="_blank" rel="noopener" href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server</a> ，下载 zipkin-server-2.12.9-exec.jar 。启动就OK了，如</p>
<p>图所示。</p>
<p><img src="/2021/03/15/springcloud/82.png" alt="在这里插入图片描述"></p>
<p>通过 <a target="_blank" rel="noopener" href="http://loclahost:9411/">http://loclahost:9411</a> 就能进入到 Zipkin 为我们提供的可视化界面（中文）</p>
<p><img src="/2021/03/15/springcloud/83.png" alt="在这里插入图片描述"></p>
<p>一次请求完整的调用链路：</p>
<p><img src="/2021/03/15/springcloud/84.png" alt="img"></p>
<p>简单概述上图：</p>
<p><img src="/2021/03/15/springcloud/85.png" alt="img"></p>
<p>术词：</p>
<ul>
<li>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识</li>
<li>span:表示调用链路来源，通俗的理解span就是一次请求信息</li>
</ul>
<h5 id="18-4-2、Sleuth测试环境搭建"><a href="#18-4-2、Sleuth测试环境搭建" class="headerlink" title="18.4.2、Sleuth测试环境搭建"></a>18.4.2、Sleuth测试环境搭建</h5><ol>
<li><p>服务端/客户端 进行相同配置</p>
<p>引入 zipkin + sleuth pom 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入sleuth+zipkin依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 applicaiton.yml 添加 zipkin、sleuth 相同配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 应用名</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span> <span class="comment">#监控数据要打到9411zipkin上</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">    <span class="attr">probability:</span> <span class="number">1</span>  <span class="comment">#采样率值介于0到1，1则表示全部采集</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用测试：</p>
<p>通过<code>http://localhost/consumer/payment/get/31</code>进行服务调用，</p>
<p>调用成功后，我们打开 <code>http://localhost:9411</code> Zipkin 控制台就可</p>
<p>以看到具体服务调用情况。</p>
<p>点击相对应请求，还可以看到 <strong><code>模块间调用情况</code>**、</strong><code>调用耗时</code>** 等更详细的</p>
<p>信息。点击导航栏中的 <strong><code>依赖</code></strong> 项，还可以查看模块(调用、被调用)的依</p>
<p>赖关系等，<strong>链路调用关系一目了然。</strong></p>
<p><img src="/2021/03/15/springcloud/springcloud%5C86.png" alt="image-20210311024420119"></p>
<p>点进每个具体的请求：</p>
<p><img src="/2021/03/15/springcloud/87.png" alt="image-20210311024741448"></p>
<p>点进依赖：（查看微服务间的依赖关系）</p>
<p><img src="/2021/03/15/springcloud/88.png" alt="image-20210311024859419"></p>
</li>
</ol>
<h2 id="Spring-Cloud-Alibaba"><a href="#Spring-Cloud-Alibaba" class="headerlink" title="Spring Cloud Alibaba"></a>Spring Cloud Alibaba</h2><h4 id="1、什么是维护模式"><a href="#1、什么是维护模式" class="headerlink" title="1、什么是维护模式"></a>1、什么是维护模式</h4><p>随着 Spring Cloud Netflix 项目进入维护模式（Maintenance Mode），Eureka、Hystrix、Ribbon、Zuul 等项目都进入了维护模式。</p>
<p>将模块置于<code>维护模式</code>意味着 Spring Cloud 团队将不再向该模块添加新功能。我们将修复<code>block</code>级别的<code>bug</code>和安全性问题，还将考虑并审查社区中的小请求。自 Spring Cloud Greenwich 版本发行(2018.12.12)以来，Spring Cloud 打算继续为这些模块提供至少一年的支持。（摘自：官网）</p>
<p>现在针对 Spring Cloud Netflix 相关模块已经不再提供支持。我们都知道 Spring Cloud 版本迭代算是比较快的，因而出现了很多重大ISSUE都还来不及Fix就又推出另一个 Release 版本了。进入维护模式意味着：以后一段时间 Spring Cloud Netflix 提供的服务和功能就这么多了，不再开发新的组件和功能了，这显然无法满足接下来微服务的开发要求。</p>
<p>伴随着 Spring Cloud Netflix 倒下，停更的组件自然就需要寻找替代者来继续下去。Alibaba 为了能够在微服务领域占据一定的话语权，此时便趁虚而入，将其代替，于2018.10.31 Spring Cloud Alibaba 正式入驻 Spring Cloud 官方孵化器，并在 Maven Spring Cloud for Alibaba 0.2.0 released。（附：Spring Cloud Alibaba 官方介绍）</p>
<p><img src="/2021/03/15/springcloud/3.jpg" alt="3"></p>
<h4 id="2、Spring-Cloud-Alibaba"><a href="#2、Spring-Cloud-Alibaba" class="headerlink" title="2、Spring Cloud Alibaba"></a>2、Spring Cloud Alibaba</h4><p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用微服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里微服务解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
<h5 id="2-1、Spring-Cloud-Alibaba包含的组件"><a href="#2-1、Spring-Cloud-Alibaba包含的组件" class="headerlink" title="2.1、Spring Cloud Alibaba包含的组件"></a>2.1、Spring Cloud Alibaba包含的组件</h5><ol>
<li>**<code>Sentinel</code>**：阿里巴巴开源产品，把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</li>
<li>**<code>Nacos</code>**：阿里巴巴开源产品，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</li>
<li>**<code>RocketMQ</code>**：Apache RocketMQ™ 基于 Java 的高性能、高吞吐量的分布式消息和流计算平台。</li>
<li>**<code>Dubbo</code>**：Apache Dubbo™ 是一款高性能 Java RPC 框架。</li>
<li>**<code>Seata</code>**：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。</li>
<li>**<code>Alibaba Cloud OSS</code>**：阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li>**<code>Alibaba Cloud SchedulerX</code>**：阿里中间件团队开发的一款分布式任务调度产品，支持周期性的任务与固定时间点触发任务。</li>
<li>**<code>Alibaba Cloud SMS</code>**：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ol>
<h5 id="2-2、主要功能"><a href="#2-2、主要功能" class="headerlink" title="2.2、主要功能"></a>2.2、主要功能</h5><ol>
<li>**<code>服务限流降级</code>**： 默认支持 WebServlet、WebFlux, OpenFeign、RestTemplate、Spring Cloud Gateway, Zuul, Dubbo 和 RocketMQ 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</li>
<li>**<code>服务注册与发现</code>**： 适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li>**<code>分布式配置管理</code>**： 支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li>**<code>消息驱动能力</code>**： 基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li>**<code>分布式事务</code>**： 使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。。</li>
<li>**<code>阿里云对象存储</code>**： 阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li>**<code>分布式任务调度</code>**： 提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</li>
<li>**<code>阿里云短信服务</code>**： 覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ol>
<h4 id="3、学习组件"><a href="#3、学习组件" class="headerlink" title="3、学习组件"></a>3、学习组件</h4><p><strong><code>Alibaba Cloud OSS</code>**、</strong><code>Alibaba Cloud SchedulerX</code><strong>、</strong><code>Alibaba Cloud SMS</code>** 是阿里云相关的付费业务。接下来，我们主要介绍 Nacos、Sentinel、Seata 这三个模块。</p>
<h4 id="4、官网资料"><a href="#4、官网资料" class="headerlink" title="4、官网资料"></a>4、官网资料</h4><ol>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-alibaba#overview">Spring Cloud Alibaba官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba">Github英文文档</a></li>
<li><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">Spring英文文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">Github中文文档</a></li>
</ol>
<h3 id="19、Spring-Cloud-Alibaba-Nacos服务注册中心与配置中心"><a href="#19、Spring-Cloud-Alibaba-Nacos服务注册中心与配置中心" class="headerlink" title="19、Spring Cloud Alibaba Nacos服务注册中心与配置中心"></a>19、Spring Cloud Alibaba Nacos服务注册中心与配置中心</h3><h4 id="19-1、什么是-Nacos"><a href="#19-1、什么是-Nacos" class="headerlink" title="19.1、什么是 Nacos"></a>19.1、什么是 Nacos</h4><p>Nacos（Dynamic <strong>Na</strong>ming and <strong>Co</strong>nfiguration <strong>S</strong>ervice）：一个更易于构建云原生应用的动态服务发现，配置管理和服务管理中心。</p>
<p>我们可以理解为：<strong>Nacos = 服务注册中心 + 配置中心</strong>；等价于 Nacos = Eureka + Spring Cloud Config + Spring Cloud Bus。</p>
<h4 id="19-2、能干嘛"><a href="#19-2、能干嘛" class="headerlink" title="19.2、能干嘛"></a>19.2、能干嘛</h4><p>Nacos 可以替代 Eureka 来实现<code>服务注册中心</code>、可以替代 Spring Cloud Config 来实现<code>服务配置中心</code>、可以替代 Spring Cloud Bus 来实现<code>配置的全局广播</code>。Nacos 是更强调云原生时代支持 “<strong>服务治理、服务沉淀、共享、持续发展</strong>” 理念的注册中心和配置中心。(附：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/index.html">Nacos 官网</a>与<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html">官方文档</a>)</p>
<p>与各种注册中心比较（粗劣）：</p>
<p><img src="/2021/03/15/springcloud/89.png" alt="img"></p>
<h4 id="19-3、Nacos-安装运行"><a href="#19-3、Nacos-安装运行" class="headerlink" title="19.3、Nacos 安装运行"></a>19.3、Nacos 安装运行</h4><p>本地环境：java8+maven环境</p>
<p>从<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">官网</a>下载，你也可以选择指定版本下载：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/tags">选择指定版本下载</a>。此处以 window 版进行演示，后续 Nacos 集群环境会在 Linux 环境配置。</p>
<p>下载完成后，解压缩，直接运行 bin 目录下的<code>startup.cmd</code>，<strong>此处需注意</strong>：若你下载的nacos为<strong>较新版本</strong>，nacos默认是集群方式开启，会出现：<code>nacos is starting with cluster</code>，无法正常启动（此时nacos并未集群）。</p>
<p><img src="/2021/03/15/springcloud/90.png" alt="img"></p>
<p>此时需以单机方式启动，执行以下命令<code>startup.cmd -m standalone</code>即可启动Nacos服务，我们可以看到它使用的是 8848 端口，启动结果如图所示：</p>
<p><img src="/2021/03/15/springcloud/91.png" alt="在这里插入图片描述"></p>
<p>运行成功后，直接访问 <a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a> 就可以进入 Nacos 的为我们提供的 web 控制台。**<code>用户名、密码默认为 nacos</code>**(1.2.0 版本不需要输入密码)，控制台还是挺清新的哈，还提供中文支持。</p>
<p><img src="/2021/03/15/springcloud/92.png" alt="在这里插入图片描述"></p>
<h4 id="19-4、Nacos与其他注册中心对比"><a href="#19-4、Nacos与其他注册中心对比" class="headerlink" title="19.4、Nacos与其他注册中心对比"></a>19.4、Nacos与其他注册中心对比</h4><p>Nacos和CAP：</p>
<p><img src="/2021/03/15/springcloud/96.png" alt="在这里插入图片描述"></p>
<p>CAP：</p>
<p><code>C</code>一致性<code>A</code>高可用<code>P</code>容错性。参考：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/CAP%E5%8E%9F%E5%88%99/5712863?fr=aladdin">CAP原则</a>，主流选用的都是 AP 模式，保证系统的高可用。</p>
<p>何时选择使用何种模式？</p>
<p>一般来说，如果<strong>不需要存储服务级别的信息</strong>，且服务实例是通过<code>Nacos-client</code>注册，并能够<strong>保证心跳上报</strong>，那么就可以选择 AP 模式。当前主流的服务如 Spring Cloud 和 Dubbo 服务，都适用于 AP 模式，**AP模式为了服务的可用行而减弱了一致性，因此 AP 模式下只支持注册<code>临时实例</code>**。</p>
<p>如果需要在服务级别<strong>编辑或者存储配置信息</strong>，那么 CP 是必须的，<code>K8S服务</code>和<code>DNS服务</code>则适用于 CP 模式。CP模式下则支持注册**<code>持久化实例</code><strong>，此时则是以<code>Raft协议</code>为集群运行模式，</strong>该模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误。**</p>
<p>而Nacos支持AP和CP模式的切换：</p>
<p><img src="/2021/03/15/springcloud/97.png" alt="在这里插入图片描述"></p>
<p>Nacos的全景图：</p>
<p><img src="/2021/03/15/springcloud/98.png" alt="img"></p>
<p>Nacos AP/CP模式切换：</p>
<p>Nacos 集群默认支持的是CAP原则中的 AP原则，但是也可切换为CP原则，切换命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT &#x27;$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP&#x27;</span><br></pre></td></tr></table></figure>

<p>同时微服务的 bootstrap.yml需配置如下选项指明注册为临时/永久实例，<code>AP模式</code>不支持数据一致性，所以只支持服务注册的<code>临时实例</code>，<code>CP模式</code>支持服务注册的<code>永久实例</code>，满足配置文件的一致性。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#false为永久实例，true表示临时实例开启，注册为临时实例</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">	  <span class="attr">discovery:</span> </span><br><span class="line">		<span class="attr">ephemeral:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="19-5、Nacos用作服务注册中心"><a href="#19-5、Nacos用作服务注册中心" class="headerlink" title="19.5、Nacos用作服务注册中心"></a>19.5、Nacos用作服务注册中心</h4><p>Nacos 可以替代 Eureka 来作为 **<code>服务注册中心</code>**。附：<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html#_spring_cloud_alibaba_nacos_discovery">Nacos 服务注册中心官方文档</a></p>
<ul>
<li><p><strong>基于Nacos的服务提供者(provider)</strong></p>
<ol>
<li><p>父pom引入spring-cloud-alibaba 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当前模块pom引入 nacos-discovery 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!--引入 nacos-discovery 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>applicaiton.yml 文件配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9021</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动加上@EnableDiscoveryClient</p>
</li>
<li><p>业务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Alibaba Nacos registry,server &quot;</span>+ serverPort+<span class="string">&quot;----- id:&quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务模块，查看服务是否注册到 Nacos</p>
<p>启动服务模块，进入 Nacos 控制台，在 <strong><code>服务管理 → 服务列表</code></strong> 中可以看到，我们定义的服务名 <code>nacos-payment-provider</code> 已经成功注册到 Nacos 注册中心。</p>
<p><img src="/2021/03/15/springcloud/93.png" alt="在这里插入图片描述"></p>
</li>
</ol>
</li>
<li><p>可以多来个服务端，与 9021 组成集群（9022、9023等等，做法与上一致）</p>
<p><strong>提示：</strong>9022 和 9023 除端口外，其他配置都相同。在<strong>测试环境</strong>（只能在测试环境里用，可能出现未知的bug）使用时，此处还有个取巧的方法，**<code>可以通过直接拷贝虚拟端口映射，来创建 9002 模块</code>**。我们使用 9021 来创建9022/9023，（实质端口为9021）如下图所示：</p>
<p><img src="/2021/03/15/springcloud/94.png" alt="在这里插入图片描述"></p>
</li>
<li><p><strong>基于Nacos的服务消费者（consumer）</strong></p>
<ol>
<li><p>当前模块pom引入 nacos-discovery 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Nacos 默认支持负载均衡</p>
<p>spring-cloud-starter-alibaba-nacos-discovery包里就整合有ribbon</p>
<p><img src="/2021/03/15/springcloud/95.png" alt="在这里插入图片描述"></p>
<p>也就是说：我们可以使用ribbon的负载均衡与RestTemplate</p>
</li>
<li><p>applicaiton.yml 文件配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-nacos-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称</span></span><br><span class="line"><span class="attr">server-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动加注解@EnableDiscoveryClient</p>
</li>
<li><p>业务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serverURL+<span class="string">&quot;/payment/nacos/&quot;</span>+id,String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RestTemplate配置类（注意加上@LoadBalanced实现负载均衡）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务消费者，查看服务是否注册到 Nacos</p>
</li>
<li><p>服务调用测试，是否实现负载均衡。通过服务端对客户端服务进行调用：<a target="_blank" rel="noopener" href="http://localhost:83/consumer/payment/nacos/31%E3%80%82%E9%87%87%E7%94%A8%E8%BD%AE%E8%AF%A2%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E3%80%82">http://localhost:83/consumer/payment/nacos/31。采用轮询的方式，实现了负载均衡。</a></p>
</li>
</ol>
</li>
<li><p><strong>也可以用OpenFeign+Nacos实现服务消费者（consumer）</strong></p>
<ol>
<li><p>引入 spring-cloud-openfeign 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入 spring-cloud-openfeign 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml配置同上（改端口也行）</p>
</li>
<li><p>主启动类加上@EnableDiscoveryClient与@EnableFeignClients两个注解。</p>
</li>
<li><p>编写OpenFeign的服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderNacosService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>此处注意：</strong>注解@FeignClient里的服务名”nacos-payment-provider”必须和服务提供端的yml配置一致,大小写敏感(Eureka 大小写不敏感,Nacos 不同,大小写会导致调用失败)</p>
<p>具体可参考<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/issues/2188">ISSUE</a></p>
</li>
<li><p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderNacosService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> service.getPayment(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试</p>
</li>
</ol>
</li>
</ul>
<h4 id="19-6、Nacos用作服务配置中心"><a href="#19-6、Nacos用作服务配置中心" class="headerlink" title="19.6、Nacos用作服务配置中心"></a>19.6、Nacos用作服务配置中心</h4><h5 id="19-6-1、Nacos作为配置中心–基础配置"><a href="#19-6-1、Nacos作为配置中心–基础配置" class="headerlink" title="19.6.1、Nacos作为配置中心–基础配置"></a>19.6.1、Nacos作为配置中心–基础配置</h5><ol>
<li><p>当前模块 pom 引入 nacos-config 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入nacos-config配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--注册到 Nacos，需引入nacos-discovery配置--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入nacos-discovery配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进行yml配置：</p>
<p>此处需要配置<code>bootstrap.yml</code>和<code>application.yml</code>两个文件<code>bootstrap.yml</code>用作系统级资源配置项，<code>application.yml</code>用作用户级的资源配置项。在项目中两者配合共同生效，<code>bootstrap.yml</code>优先级更高。<br>bootstrap.yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br><span class="line"><span class="comment"># nacos-config-client-dev.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nacos-config-client-test.yaml   ----&gt; config.info</span></span><br></pre></td></tr></table></figure>

<p>application.yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 表示开发环境</span></span><br><span class="line">    <span class="comment">#active: test # 表示测试环境</span></span><br><span class="line">    <span class="comment">#active: info</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类添加 @EnableDiscoveryClient 注解</p>
</li>
<li><p>业务类：(添加 @RefreshScope 实现配置自动更新)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span><span class="comment">//支持Nacos的动态刷新功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nacos中添加配置项：</p>
<p>进入 <strong><code>Nacos → 配置管理 → 配置列表 → + 号</code></strong> 添加配置项。Data ID 按规则编写，Group 在接下来的 <strong><code>分类配置</code></strong> 会有介绍。</p>
<p><img src="/2021/03/15/springcloud/99.png" alt="在这里插入图片描述"></p>
<p><img src="/2021/03/15/springcloud/100.png" alt="在这里插入图片描述"></p>
</li>
<li><p>启动测试，是否能够获取Nacos配置：</p>
<p>通过 <a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a> 测试，发现可以正确获取 Nacos 配置中心的配置信息</p>
<p><img src="/2021/03/15/springcloud/101.png" alt="在这里插入图片描述"></p>
</li>
<li><p>Nacos 自带动态刷新：</p>
<p>在使用 Spring Cloud Config 时，需要配合 Spring Cloud Bus + RabbitMQ 中间件，用<code>curl</code>进行广播方式才能 <strong><code>实现动态刷新</code>**。</strong><code>Nacos则自带动态刷新,修改下Nacos中的yaml配置文件，再次调用查看配置的接口，就会发现配置已经刷新。</code>**</p>
</li>
</ol>
<h5 id="19-6-2、dataId-命名规则"><a href="#19-6-2、dataId-命名规则" class="headerlink" title="19.6.2、dataId 命名规则"></a>19.6.2、dataId 命名规则</h5><p>在 Nacos Spring Cloud 中， <code>dataId</code> 有明确的配置规则，官方也有说明。进入链接查看：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html">官网链接</a>。</p>
<p><code>dataId</code> 的完整格式如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;prefix&#125;-$&#123;spring.profile.active&#125;.$&#123;file-extension&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>prefix 默认为 spring.application.name 的值，也可以通过配置项 spring.cloud.nacos.config.prefix来配置。</li>
<li>spring.profile.active 即为当前环境对应的 profile。注意：当 spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}（建议：不要让 spring.profile.active 为空，或许会有一些意外的问题,未知的bug）</li>
<li>file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型。</li>
</ul>
<p><img src="/2021/03/15/springcloud/102.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/103.png" alt="img"></p>
<p><strong>此处注意：</strong>在Nacos网页中进行添加配置项时，在填写<code>Data ID</code>需要注意,若你采用的是yaml格式的话，如<code>nacos-config-dev.yaml</code>中的yaml不能省略成yml，即<code>nacos-config-dev.yml</code>。若省略，程序启动会报错（找不到配置项config.info）。这是Nacos的一个小坑（bug）。</p>
<h5 id="19-6-3、Nacos作为配置中心–分类配置"><a href="#19-6-3、Nacos作为配置中心–分类配置" class="headerlink" title="19.6.3、Nacos作为配置中心–分类配置"></a>19.6.3、Nacos作为配置中心–分类配置</h5><p>项目开发中，一定会遇到<code>多环境</code>、<code>多项目管理</code>问题。遇到下面问题时，Nacos 基础配置显然无法解决这些问题，接下来就对<code>Nacos 命名空间</code>及<code>Group</code>相关概念的了解。</p>
<ul>
<li>问题1： 实际开发中，通常一个系统会准备<code>dev开发环境</code>、<code>test测试环境</code>、<code>prod生产环境</code>，如何保证指定环境启动时服务能够正确读取到 Nacos 上相应环境的配置文件？</li>
<li>问题2： 一个大型的分布式微服务系统会有很多个微服务<code>子项目</code>，每个微服务项目又都会有相应的<code>dev开发环境</code>、<code>test测试环境</code>、<code>prod生产环境 </code>等，那怎么对这些微服务配置进行管理呢？</li>
</ul>
<p>这是就可以用到Nacos的分类功能了。</p>
<h6 id="19-6-3-1、Nacos的命名规则说明"><a href="#19-6-3-1、Nacos的命名规则说明" class="headerlink" title="19.6.3.1、Nacos的命名规则说明"></a>19.6.3.1、Nacos的命名规则说明</h6><p>Nacos 命名由<code>Namespace(命名空间) </code>+ <code>Group(分组)</code> + <code>Data ID(实例ID)</code> 三部分组成，类似于 Java 中的 package(报名) + class(类名) 方式。最外层 <strong>Namespace 用于区分部署环境</strong>；<strong>Group 和 Data ID 逻辑上用于区分两个目标对象</strong>。</p>
<p><img src="/2021/03/15/springcloud/104.png" alt="在这里插入图片描述"></p>
<p>默认情况下：</p>
<p><strong>Namespace = public，Group = DEFAULT_GROUP，Cluster=DEFAULT</strong></p>
<p><strong><code>Namespace</code>**主要用来实现</strong>隔离**，Nacos 默认的命名空间是<code>public</code>。比方说我们现在有三个环境：开发、测试、生产环境，我们就可以创建三个 Namespace，不同的 Namespace 之间是隔离的；</p>
<p><strong><code>Group</code>**是一组</strong>配置集<strong>，是组织配置的维度之一。默认是<code>DEFAULT_GROUP</code>。通过一个有意义的<code>名称</code>对配置集进行分组，从而区分 Data ID 相同的配置集。</strong>配置分组的常见场景：不同的应用或组件使用了相同的配置类型，就可以把不同的微服务划分到同一个分组里面去，从而解决问题2；如 database_url 配置和 MQ_topic 配置。**</p>
<p><strong><code>Service</code>**微服务；一个 Service 可以包含多个<code>Cluster(集群)</code>，Nacos 默认 Cluster 是<code>DEFAULT</code>，Cluster 是对指定微服务的一个</strong>虚拟划分<strong>。</strong>比方说为了容灾，将 Service 微服务分别部署在了杭州机房和广州机房，这是就可以给杭州机房的 Service 微服务起一个集群名称(HZ)，给广州机房的 Service 微服务起一个集群名称(GZ)，还可以尽量让同一个机房的微服务互相调用，以提升性能。**</p>
<p><strong><code>Instance</code>**，就是一个个</strong>微服务实例**。</p>
<p><img src="/2021/03/15/springcloud/105.png" alt="img"></p>
<p>保留空间public是不能被删除的。。</p>
<p><img src="/2021/03/15/springcloud/106.png" alt="img"></p>
<h6 id="19-6-3-2、新建Namespace"><a href="#19-6-3-2、新建Namespace" class="headerlink" title="19.6.3.2、新建Namespace"></a>19.6.3.2、新建Namespace</h6><p>选择 <strong><code>命名空间 → 新建命名空间</code>**，进行命名空间的设置。在 Nacos 1.1.4 版本，还<code>不支持自定义命名空间ID</code>，Nacos 1.2.0 版本后开始支持自定义命名空间ID 了。</strong>更推荐你使用自定义命名空间**。</p>
<p><img src="/2021/03/15/springcloud/107.png" alt="在这里插入图片描述"></p>
<p><img src="/2021/03/15/springcloud/108.png" alt="在这里插入图片描述"></p>
<h6 id="19-6-3-3、新建-Group"><a href="#19-6-3-3、新建-Group" class="headerlink" title="19.6.3.3、新建 Group"></a>19.6.3.3、新建 Group</h6><p>新建配置自定义Group名称。<strong>Group 就是根据需求的不同，将微服务划分到同一个分组里面去，来解决问题2</strong></p>
<p><img src="/2021/03/15/springcloud/109.png" alt="在这里插入图片描述"></p>
<h6 id="19-6-3-4、将-namespace-和-Group-应用到项目中"><a href="#19-6-3-4、将-namespace-和-Group-应用到项目中" class="headerlink" title="19.6.3.4、将 namespace 和 Group 应用到项目中"></a>19.6.3.4、将 namespace 和 Group 应用到项目中</h6><p>只需要在<code>bootstrap.yml</code>中添加 <code>namespace</code> 和 <code>group</code> 两个属性即可。**<code>namespace</code>** 属性：此处配置为 namespace **<code>命名空间 ID</code>**，自定义namespace时，推荐还是自定义名称，否则就是一串很长的字符串流水号，而且还语意不明。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line">        <span class="comment"># 指定 namespace 和 group </span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev-nsid</span> <span class="comment">#指定Namespace命名空间</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">Group_A</span> <span class="comment">#指定Group分组</span></span><br></pre></td></tr></table></figure>

<h6 id="19-6-3-5、指定-namespace-和-group-后，读取的便是对应配置内容"><a href="#19-6-3-5、指定-namespace-和-group-后，读取的便是对应配置内容" class="headerlink" title="19.6.3.5、指定 namespace 和 group 后，读取的便是对应配置内容"></a>19.6.3.5、指定 namespace 和 group 后，读取的便是对应配置内容</h6><p><img src="/2021/03/15/springcloud/110.png" alt="在这里插入图片描述"></p>
<h4 id="19-7、Nacos-集群搭建和持久化配置-Linux-Mysql"><a href="#19-7、Nacos-集群搭建和持久化配置-Linux-Mysql" class="headerlink" title="19.7、Nacos 集群搭建和持久化配置(Linux + Mysql)"></a>19.7、Nacos 集群搭建和持久化配置(Linux + Mysql)</h4><h5 id="19-7-1、Nacos集群官方架构图"><a href="#19-7-1、Nacos集群官方架构图" class="headerlink" title="19.7.1、Nacos集群官方架构图"></a>19.7.1、Nacos集群官方架构图</h5><p><img src="/2021/03/15/springcloud/111.png" alt="在这里插入图片描述"></p>
<p><strong>VIP</strong>：此处的 VIP 指代的是 <code>Virtual IP</code>（虚拟IP）的意思，通常情况下指代的是<code>Nginx</code>。</p>
<p>说明： 开源时，推荐用户把所有服务列表放到一个vip下面，然后挂到一个域名下面：</p>
<p><a href="http://ip1:port/openAPI">http://ip1:port/openAPI</a> 直连ip模式，机器挂则需要修改ip才可以使用。<br><a href="http://VIP:port/openAPI">http://VIP:port/openAPI</a> 挂载VIP模式，直连vip即可，下面挂server真实ip，可读性不好。<br><strong><a href="http://nacos.com:port/openAPI">http://nacos.com:port/openAPI</a> 域名 + VIP模式，可读性好，而且换ip方便，推荐模式。</strong></p>
<h5 id="19-7-2、Nacos集群真实架构图"><a href="#19-7-2、Nacos集群真实架构图" class="headerlink" title="19.7.2、Nacos集群真实架构图"></a>19.7.2、Nacos集群真实架构图</h5><p><img src="/2021/03/15/springcloud/112.png" alt="在这里插入图片描述"></p>
<h5 id="19-7-3、Nacos在linux下安装下载"><a href="#19-7-3、Nacos在linux下安装下载" class="headerlink" title="19.7.3、Nacos在linux下安装下载"></a>19.7.3、Nacos在linux下安装下载</h5><p>1、在<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">官网</a>下载xxx.tar.gz文件，并转移进Linux服务器。</p>
<p>2、<strong>nacos 安装目录：<code>/usr/local/nacos/</code></strong></p>
<p>3、使用tar -zxvf 命令解压</p>
<h5 id="19-7-4、Nacos数据库支持（derby-）"><a href="#19-7-4、Nacos数据库支持（derby-）" class="headerlink" title="19.7.4、Nacos数据库支持（derby ）"></a>19.7.4、Nacos数据库支持（derby ）</h5><p>手动将Nacos服务关闭再启动。存储在Nacos中的配置信息并不会丢失。这是因为 Nacos 默认内置<code>DerBy</code>数据库。 嵌入式数据库，nacos pom.xml 有引入<code>derby</code>依赖。以下摘自Nacos的<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/blob/develop/config/pom.xml">github源码</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Nacos的derby数据库记录的数据放在nacos安装目录下的/conf/nacos-mysql.sql的sql文件里。</p>
<p>在<code>Nacos 0.7</code>版本之前，在单机模式时nacos使用嵌入式数据库(<code>derby</code>)实现数据的存储，不方便观察数据存储的基本情况。<strong>0.7 版本增加了支持 mysql 数据源能力</strong>。 具体的操作步骤：</p>
<ol>
<li>安装数据库，版本要求：5.6.5+</li>
<li>初始化mysql数据库，数据库初始化文件：<code>nacos-mysql.sql</code></li>
<li>修改<code>conf/application.properties</code>文件，增加支持mysql数据源配置（<strong>目前只支持mysql</strong>），添加mysql数据源的url、用户名和密码。</li>
<li>再启动nacos，nacos所有写嵌入式数据库的数据都写到了mysql。</li>
</ol>
<h5 id="19-7-5、Nacos-集群部署搭建"><a href="#19-7-5、Nacos-集群部署搭建" class="headerlink" title="19.7.5、Nacos 集群部署搭建"></a>19.7.5、Nacos 集群部署搭建</h5><p>Nacos支持三种部署模式</p>
<ul>
<li>单机模式 - 用于测试和单机试用。</li>
<li><strong><code>集群模式 - 用于生产环境，确保高可用。</code></strong></li>
<li>多集群模式 - 用于多数据中心场景。</li>
</ul>
<p>  此处附：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">Nacos集群模式部署官方文档</a></p>
<p>若单机要集群Nacos的话要删除其中的<code>data</code>文件夹。<a target="_blank" rel="noopener" href="https://www.cnblogs.com/to-make-life-better/p/14534539.html">资料</a></p>
<h6 id="19-7-5-1、节点部署情况"><a href="#19-7-5-1、节点部署情况" class="headerlink" title="19.7.5.1、节点部署情况"></a>19.7.5.1、节点部署情况</h6><table>
<thead>
<tr>
<th align="center">服务器IP</th>
<th align="center">部署服务</th>
<th align="center">端口</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.204.202</td>
<td align="center">MySQL 5.7.28</td>
<td align="center">3306</td>
<td align="center">测试，使用单机 MySQL，高可用参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lzb348110175/article/details/103081631">MySQL 5.7.28 主从复制实现</a></td>
</tr>
<tr>
<td align="center">192.168.204.202</td>
<td align="center">Nginx 1.4.1</td>
<td align="center">8807</td>
<td align="center">测试，使用单机 Nginx，Nginx集群搭建请自行了解(Nginx默认端口为80，此处负载均衡使用8087端口)</td>
</tr>
<tr>
<td align="center">192.168.204.202</td>
<td align="center">nacos</td>
<td align="center">8848</td>
<td align="center">集群节点01：nacos 01</td>
</tr>
<tr>
<td align="center">192.168.204.203</td>
<td align="center">nacos</td>
<td align="center">8848</td>
<td align="center">集群节点02：nacos 02</td>
</tr>
<tr>
<td align="center">192.168.204.204</td>
<td align="center">nacos</td>
<td align="center">8848</td>
<td align="center">集群节点03：nacos 03</td>
</tr>
</tbody></table>
<p>提示： 三台机器配置相同，此处对一台进行配置。使用命令 scp 发送到其他两台机器即可，此处以<code>192.168.204.202</code>为例说明。</p>
<h6 id="19-7-5-2、derby-切换-mysql-数据库配置"><a href="#19-7-5-2、derby-切换-mysql-数据库配置" class="headerlink" title="19.7.5.2、derby 切换 mysql 数据库配置"></a>19.7.5.2、derby 切换 mysql 数据库配置</h6><ol>
<li><p>执行nacos-mysql.sql脚本：</p>
<p>进入 nacos 安装目录 conf 文件下，找到 <code>nacos-mysql.sql 脚本</code>。</p>
<p>创建 nacos_config 数据库，并执行 nacos-mysql.sql 脚本。</p>
<p><img src="/2021/03/15/springcloud/113.png" alt="在这里插入图片描述"></p>
<p><img src="/2021/03/15/springcloud/114.png" alt="在这里插入图片描述"></p>
</li>
<li><p>修改application.properties，添加mysql支持：</p>
<p>进入nacos安装目录 conf 文件下，<code>application.properties</code> 配置文件添加 mysql 支持。</p>
<p>其中：</p>
<ul>
<li><p>在修改所有文件之前建议保存副本</p>
<p><img src="/2021/03/15/springcloud/115.png" alt="img"></p>
</li>
<li><p>db.user与db.password填写本机的用户名与密码</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://192.168.204.202:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/15/springcloud/116.png" alt="img"></p>
</li>
<li><p>cluster.conf 配置:</p>
<p>进入 conf 目录，使用命令：<code>cp cluster.conf.example cluster.conf</code>拷贝一份，重命名为<code>cluster.conf</code>，在 cluster.conf 中进行配置，说明哪几台机器组成集群（填写的是 nacos 集群3个节点所在 IP:端口号，不要写<code>127.0.0.1</code>，必须是Linux的<strong>真实IP</strong>）,可以通过命令<code>hostname -i</code>查看Linux的真实IP。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.204.202:8848</span><br><span class="line">192.168.204.203:8848</span><br><span class="line">192.168.204.204:8848</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 nacos 启动堆栈大小：</p>
<p>（nacos 启动时，默认 <code>-Xms2g -Xmx2g</code>。如果你是在多台虚拟机测试，配置紧张，这一步就比较重要了。如果服务器配置很优秀，这一步可以绕过。）</p>
<p><strong>配置紧张会导致以下情况的出现：</strong></p>
<ol>
<li><strong>nacos 服务启动很慢很慢的情况；</strong></li>
<li><strong>nacos 服务注册中心，有3个提供服务，你可能只能看到 2个、1个、0个服务节点，还会来回跳动的问题。</strong></li>
<li><strong>反正还是会出现一些意想不到的问题，视情况而配置。</strong></li>
</ol>
<blockquote>
<p><code>Xms 是指设定程序启动时占用内存大小。</code>一般来讲，大点，程序会启动的快一点，但是也可能会导致机器暂时间变慢。<br><code>Xmx 是指设定程序运行期间最大可占用的内存大小。</code>如果程序运行需要占用更多的内存，超出了这个设置值，就会抛出OutOfMemory异常。</p>
</blockquote>
<p>我们进入 bin 目录，使用 <code>vim startup.sh</code> 对其进行修改，将其按照配置修改到指定大小即可。（好像可以通过启动时添加 Xms 参数方式修改，我忘了怎么搞了，此处就直接修改 <code>.sh</code> 启动脚本了）（建议修改之前进行备份）</p>
<p><img src="/2021/03/15/springcloud/117.png" alt="在这里插入图片描述"></p>
</li>
<li><p>使用scp命令，进行nacos配置分发：</p>
<p>192.168.204.202 一台 nacos 集群环境配置完成，使用 scp 命令，将 nacos 目录分发到 203/204两台机器。scp 命令的使用如下：(scp命令使用介绍，请参考：Linux命令—scp)，不使用 scp 命令，你也可以 rz、sz 以打包的方式进行上传。</p>
<blockquote>
<p>scp -r /usr/local/env/nacos <a href="mailto:&#114;&#x6f;&#111;&#x74;&#x40;&#x31;&#57;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#50;&#48;&#x34;&#x2e;&#50;&#x30;&#x33;">&#114;&#x6f;&#111;&#x74;&#x40;&#x31;&#57;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#50;&#48;&#x34;&#x2e;&#50;&#x30;&#x33;</a>:/usr/local/nacos/<br>scp -r /usr/local/env/nacos <a href="mailto:&#114;&#111;&#111;&#116;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x32;&#48;&#52;&#46;&#50;&#48;&#52;">&#114;&#111;&#111;&#116;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x32;&#48;&#52;&#46;&#50;&#48;&#52;</a>:/usr/local/nacos/</p>
</blockquote>
</li>
<li><p>以上第5步也可以通过编辑Nacos的启动脚本<code>startup.sh</code>,使他能够接受不同的启动端口（建议备份）：</p>
<p><img src="/2021/03/15/springcloud/118.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/119.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/120.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/121.png" alt="img"></p>
<p>之后就可以通过<code>./startup.sh -p 端口号</code>执行：</p>
<p><img src="/2021/03/15/springcloud/122.png" alt="img"></p>
</li>
</ol>
<h6 id="19-7-5-2、Nginx的配置，由他作为负载均衡器"><a href="#19-7-5-2、Nginx的配置，由他作为负载均衡器" class="headerlink" title="19.7.5.2、Nginx的配置，由他作为负载均衡器"></a>19.7.5.2、Nginx的配置，由他作为负载均衡器</h6><p>在此处，已经默认 Nginx 服务已经OK，Nginx 服务跑在<code>192.168.204.202</code>。如需 Nginx 的搭建过程，请自行。</p>
<p>进入<code>nginx/conf</code> 目录，对 <code>nginx.conf</code>添加 nacos 集群配置，配置如下图所示：</p>
<p><img src="/2021/03/15/springcloud/123.png" alt="在这里插入图片描述"></p>
<p>配置完成，进入 sbin 目录，使用<code>./nginx -c /usr/local/nginx/nginx-1.16.0/conf/nginx.conf</code>启动 nginx，使用<code>-c</code>加载指定配置文件，路径为 nginx.conf 所在路径。启动完成，通过命令：<code>ps aux | grep nginx</code>查看 nginx 是否启动。如图已经启动成功。</p>
<p><img src="/2021/03/15/springcloud/124.png" alt="在这里插入图片描述"></p>
<h6 id="19-7-5-3、启动nacos集群"><a href="#19-7-5-3、启动nacos集群" class="headerlink" title="19.7.5.3、启动nacos集群"></a>19.7.5.3、启动nacos集群</h6><p>启动集群中的3台nacos。可以通过命令<code>ps -ef|grep nacos|grep -v grep grep |wc -l</code>查看nacos集群启用的端口数量，也可以通过nacos安装路径logs目录，使用 <code>tail -f nacos.log</code> 查看日志。</p>
<p><strong>启动成功提示：</strong></p>
<p><strong><code>如果虚拟机资源紧张，此处会一直很长时间在 nacos is starting... 状态,一定注意自己服务器的配置。</code></strong></p>
<p><img src="/2021/03/15/springcloud/126.png" alt="在这里插入图片描述"></p>
<h6 id="19-7-5-4、进入Nacos控制台"><a href="#19-7-5-4、进入Nacos控制台" class="headerlink" title="19.7.5.4、进入Nacos控制台"></a>19.7.5.4、进入Nacos控制台</h6><p>已经配置 Nginx 负载均衡，所以我们使用 Nginx 8087 端口进入Nacos 控制台：**<code>http://192.168.204.202:8087/nacos/</code>**</p>
<p><img src="/2021/03/15/springcloud/127.png" alt="在这里插入图片描述"></p>
<h6 id="19-7-5-5、查看集群节点启动情况"><a href="#19-7-5-5、查看集群节点启动情况" class="headerlink" title="19.7.5.5、查看集群节点启动情况"></a>19.7.5.5、查看集群节点启动情况</h6><p><img src="/2021/03/15/springcloud/128.png" alt="在这里插入图片描述"></p>
<h6 id="19-7-5-6、Nacos集群环境，项目application-yml中nacos地址需写-Nginx-地址"><a href="#19-7-5-6、Nacos集群环境，项目application-yml中nacos地址需写-Nginx-地址" class="headerlink" title="19.7.5.6、Nacos集群环境，项目application.yml中nacos地址需写 Nginx 地址"></a>19.7.5.6、Nacos集群环境，项目application.yml中nacos地址需写 Nginx 地址</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.204</span><span class="number">.202</span><span class="string">:8087</span> <span class="comment">#配置Nacos地址(集群使用Nginx，此处需配置Nginx地址)</span></span><br></pre></td></tr></table></figure>

<p>通过访问8087端口（Ngnix）来实际访问三个nacos端口。</p>
<p><img src="/2021/03/15/springcloud/129.png" alt="在这里插入图片描述"></p>
<h3 id="20、Sentinel实现服务降级、服务熔断、服务限流"><a href="#20、Sentinel实现服务降级、服务熔断、服务限流" class="headerlink" title="20、Sentinel实现服务降级、服务熔断、服务限流"></a>20、Sentinel实现服务降级、服务熔断、服务限流</h3><p>资料查询：</p>
<p>  附官网：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel GitHub 官网</a></p>
<p>  中文介绍文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">Sentinel Wiki中文介绍文档</a></p>
<p>  Sentinel 使用介绍：<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html#_spring_cloud_alibaba_sentinel">Spring Cloud 关于 Sentinel 使用文档</a></p>
<h4 id="20-1、是什么"><a href="#20-1、是什么" class="headerlink" title="20.1、是什么"></a>20.1、是什么</h4><p>(本段内容摘自：Sentinel Wiki 中文文档，一句话解释Sentinel，就是之前介绍过的：Hystrix 实现服务降级、服务熔断、服务限流，Sentinel 后起之秀，更优秀)</p>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从<strong>流量控制</strong>、<strong>熔断降级</strong>、<strong>系统负载保护</strong>等多个维度保护服务的稳定性。</p>
<p><img src="/2021/03/15/springcloud/130.png" alt="img"></p>
<h4 id="20-2、Sentinel的特征"><a href="#20-2、Sentinel的特征" class="headerlink" title="20.2、Sentinel的特征"></a>20.2、Sentinel的特征</h4><ul>
<li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li>
</ul>
<h4 id="20-3、Sentinel的作用"><a href="#20-3、Sentinel的作用" class="headerlink" title="20.3、Sentinel的作用"></a>20.3、Sentinel的作用</h4><p><img src="/2021/03/15/springcloud/131.png" alt="在这里插入图片描述"></p>
<p><strong>Sentinel 的开源生态：</strong></p>
<p><img src="/2021/03/15/springcloud/132.png" alt="在这里插入图片描述"></p>
<p>Sentinel 分为两个部分:</p>
<ul>
<li>核心库（Java 客户端）：不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li>
<li>控制台（Dashboard）：基于 Spring Boot 开发，打包后使用 java -jar xxx.jar 方式可以直接运行，不需要额外的 Tomcat 等应用容器。</li>
</ul>
<h4 id="20-4、安装Sentinel控制台-Dashboard"><a href="#20-4、安装Sentinel控制台-Dashboard" class="headerlink" title="20.4、安装Sentinel控制台(Dashboard)"></a>20.4、安装Sentinel控制台(Dashboard)</h4><ol>
<li><p>Sentinel Dashboard 下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">Sentinel Dashboard 下载地址</a></p>
</li>
<li><p>环境：JDK 8，端口：<strong>8080 不被占用。</strong></p>
</li>
<li><p>在安装目录进入 cmd 控制台，使用 <strong><code>java -jar sentinel-dashboard-1.7.2.jar</code></strong> 方式直接运行。</p>
<p><img src="/2021/03/15/springcloud/133.png" alt="image-20210313024314111"></p>
</li>
<li><p>使用 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> 访问 Sentinel 图形管理界面。</p>
<p>登陆账号、密码均为：**<code>sentinel</code>**</p>
<p><img src="/2021/03/15/springcloud/134.png" alt="image-20210313024508488"></p>
</li>
<li><p>至此，Sentinel控制台(Dashboard)安装成功。</p>
</li>
</ol>
<h4 id="20-5、微服务项目整合Sentinel"><a href="#20-5、微服务项目整合Sentinel" class="headerlink" title="20.5、微服务项目整合Sentinel"></a>20.5、微服务项目整合Sentinel</h4><p>使用 <code>Sentinel</code> 最好配好 <code>Nacos</code> 一起使用。</p>
<p>启动Sentinel与Nacos的微服务，并通过<a href="http://localhost:8080与http://localhost:8848/nacos/#/login进行访问。">http://localhost:8080与http://localhost:8848/nacos/#/login进行访问。</a></p>
<p>新建微服务模块：</p>
<ol>
<li><p>添加pom依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入 sentinel 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--nacos服务注册依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--sentinel持久化需要的依赖(后续持久化会用到,此处可有可无)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="comment"># 添加sentinel相关配置</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span> <span class="comment">#sentinel默认8719，假如被占用了会自动从8719开始依次+1扫描。直至找到未被占用的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#暴露，用于监控等</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类添加 <strong>@EnableDiscoveryClient</strong> 注解</p>
</li>
<li><p>业务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动项目，查看Sentinel是否成功监控：</p>
<p>此时进入 Sentinel 图形管理界面，并没有看到关于微服务任何信息。这是因为 <strong>Sentinel 采用的<code>懒加载机制</code>，只有执行一次方法调用，才能被Sentinel监控到</strong>。 然后多次调用 /testA 接口，在实时监控便能够看到接口 调用时间、QPS、响应时间 等内容。 说明：<strong>Sentinel 8080 已经在监控微服务 8401，监控会有一丁点的延迟。服务一段时间不调用，实时监控会消失。</strong></p>
</li>
</ol>
<h4 id="20-6、Spring-Cloud-Alibaba-Sentinel-流控、降级、热点、系统规则"><a href="#20-6、Spring-Cloud-Alibaba-Sentinel-流控、降级、热点、系统规则" class="headerlink" title="20.6、Spring Cloud Alibaba Sentinel 流控、降级、热点、系统规则"></a>20.6、Spring Cloud Alibaba Sentinel 流控、降级、热点、系统规则</h4><p><img src="/2021/03/15/springcloud/135.png" alt="image-20210313190605946"></p>
<h5 id="20-6-1、流控规则"><a href="#20-6-1、流控规则" class="headerlink" title="20.6.1、流控规则"></a>20.6.1、流控规则</h5><p>流控规则，即：流量控制规则。可自行参考官网介绍：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">GitHub 流量控制</a>。具体配置有 <strong><code>资源名</code>**、</strong><code>针对来源</code><strong>、</strong><code>阈值类型</code><strong>、</strong><code>是否集群</code><strong>、</strong><code>流控模式</code><strong>、</strong><code>单机阈值</code><strong>、</strong><code>流控效果</code>** 这几项，它们配合进行使用。</p>
<p>可以通过<code>簇点链路</code>的方式添加，也可以通过<code>流控规则</code>方式添加。</p>
<p><img src="/2021/03/15/springcloud/136.png" alt="image-20210313190901838"></p>
<blockquote>
<p>**<code>资源名</code>**：唯一路径，默认为请求路径（也可以是后续介绍的 @SentinelResource 注解的 value 属性值）<br>**<code>针对来源</code>**：Sentinel 可以针对调用者进行限流，填写微服务名。默认为 default（不区分来源）<br>**<code>是否集群</code>**：本文为单机测试，是否集群不选</p>
</blockquote>
<h6 id="20-6-1-1、阈值类型：QPS"><a href="#20-6-1-1、阈值类型：QPS" class="headerlink" title="20.6.1.1、阈值类型：QPS"></a>20.6.1.1、阈值类型：QPS</h6><p><strong>QPS（每秒钟的请求数量）</strong>：当调用该 API 的 <strong><code>QPS</code></strong> 达到阈值的时候，进行限流。</p>
<p><strong>配置(默认流控模式为<code>直接</code>，流控效果为<code>快速失败</code>)：</strong></p>
<p><img src="/2021/03/15/springcloud/137.png" alt="在这里插入图片描述"></p>
<p><strong>效果</strong>：/testA 服务，每秒只允许调用 1 次，超出阈值后，直接失败（流控 Sentinel 默认提示：**<code>Blocked by Sentinel(flow limiting)</code>**）</p>
<h6 id="20-6-1-2、阈值类型：线程数"><a href="#20-6-1-2、阈值类型：线程数" class="headerlink" title="20.6.1.2、阈值类型：线程数"></a>20.6.1.2、阈值类型：线程数</h6><p><strong>线程数</strong>：当调用该 API 的 <strong><code>线程数</code></strong> 达到阈值的时候，进行限流。</p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/138.png" alt="在这里插入图片描述"></p>
<p><strong>效果</strong>：</p>
<p>/testA 服务，单个线程只允许调用 1 次，超出阈值后，直接失败（流控 Sentinel 默认提示：**<code>Blocked by Sentinel(flow limiting)</code>**）</p>
<h6 id="20-6-1-3、流控模式：直接"><a href="#20-6-1-3、流控模式：直接" class="headerlink" title="20.6.1.3、流控模式：直接"></a>20.6.1.3、流控模式：直接</h6><p><strong>效果</strong>：超出阈值后，直接失败。</p>
<h6 id="20-6-1-4、流控模式：关联"><a href="#20-6-1-4、流控模式：关联" class="headerlink" title="20.6.1.4、流控模式：关联"></a>20.6.1.4、流控模式：关联</h6><p><strong>关联</strong>：当关联的资源达到阈值时，就限流自己。**<code>当与 A 资源关联的 B 资源达到阈值时，就限流自己(A)</code>**，即：B惹事，A挂了</p>
<p><strong>应用场景：</strong></p>
<p>双十一，<code>支付接口</code>和<code>下单接口</code>关联。当支付接口达到阈值，就限流下单接口。</p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/139.png" alt="在这里插入图片描述"></p>
<p><strong>效果</strong>：</p>
<p><code>/testA</code> 服务关联<code>/testB</code> 服务，1s 调用 1次，服务正常。当狂点刷新调用 <code>/testB</code> 服务，超出阈值 QPS = 1 后，此时 /testA 被限流了，这就是 **<code>B惹事，A挂了</code>**。</p>
<h6 id="20-6-1-5、流控模式：链路"><a href="#20-6-1-5、流控模式：链路" class="headerlink" title="20.6.1.5、流控模式：链路"></a>20.6.1.5、流控模式：链路</h6><p>链路：当链路中的资源达到阈值时，就会对使用到该资源的链路进行流控。当A01 资源达到设定阈值时，所有调用该服务的链路，都会被限流，即：A01 挂了，用到我的链路都得挂。</p>
<p>此处会用到 @SentinelResource 注解 value 属性值 作为资源名。此处只是使用一下。</p>
<p>模拟两条请求链路：</p>
<p>A链路： A → A01 → A04 → A05<br>B链路： B → A01 → A02 → A03</p>
<p><img src="/2021/03/15/springcloud/140.png" alt="在这里插入图片描述"></p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/141.png" alt="在这里插入图片描述"></p>
<p><strong>效果</strong>：</p>
<p>对 <strong><code>testA01</code></strong> 服务进行 <strong><code>链路</code></strong> 流控，该服务关联有 A 和 B 两条链路。当 A 链路1s 调用 1次，服务正常。当该链路调用 **<code>超出阈值 QPS = 1 后，此时A链路都会被限流，同时因为B链路也调用 testA01，所以B链路也会同时被限流调用</code>**。</p>
<h6 id="20-6-1-6、用postman进行循环访问"><a href="#20-6-1-6、用postman进行循环访问" class="headerlink" title="20.6.1.6、用postman进行循环访问"></a>20.6.1.6、用postman进行循环访问</h6><ol>
<li><p>postman里新建多线程集合组：</p>
<p><img src="/2021/03/15/springcloud/springcloud%5C142.png" alt="img"></p>
</li>
<li><p>访问地址添加进新线程组：</p>
<p><img src="/2021/03/15/springcloud/143.png" alt="img"></p>
</li>
<li><p>run：</p>
<p><img src="/2021/03/15/springcloud/144.png" alt="img"></p>
</li>
</ol>
<h6 id="20-6-1-7、流控效果：快速失败"><a href="#20-6-1-7、流控效果：快速失败" class="headerlink" title="20.6.1.7、流控效果：快速失败"></a>20.6.1.7、流控效果：快速失败</h6><p>效果：</p>
<p>直接失败。（流控 Sentinel 默认提示：**<code>Blocked by Sentinel(flow limiting)</code>**）</p>
<h6 id="20-6-1-8、流控效果：Warm-Up"><a href="#20-6-1-8、流控效果：Warm-Up" class="headerlink" title="20.6.1.8、流控效果：Warm Up"></a>20.6.1.8、流控效果：Warm Up</h6><p><strong>Warm Up</strong>：某个服务，日常访问量很少，基本为 0，突然1s访问量 10w，这种极端情况，会直接将服务击垮。所以通过配置 <strong><code>流控效果：Warm Up</code>**，允许系统慢慢呼呼的进行</strong>预热**，经<code>预热时长</code>逐渐升至设定的QPS阈值。以下图片来自<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">官网</a>。</p>
<p><img src="/2021/03/15/springcloud/145.png" alt="image">限限流 冷启动：（以下来自<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">官网</a>）</p>
<p>当流量突然增大的时候，我们常常会希望系统从空闲状态到繁忙状态的切换的时间长一些。即如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值。Warm Up（冷启动，预热）模式就是为了实现这个目的的。</p>
<p>这个场景主要用于启动需要额外开销的场景，例如建立数据库连接等。</p>
<p>它的实现是在 <a target="_blank" rel="noopener" href="https://github.com/google/guava/blob/master/guava/src/com/google/common/util/concurrent/SmoothRateLimiter.java">Guava</a> 的算法的基础上实现的。然而，和 Guava 的场景不同，Guava 的场景主要用于调节请求的间隔，即 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Leaky_bucket">Leaky Bucket</a>，而 Sentinel 则主要用于控制每秒的 QPS，即我们满足每秒通过的 QPS 即可，我们不需要关注每个请求的间隔，换言之，我们更像一个 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Token_bucket">Token Bucket</a>。</p>
<p>默认 <code>coldFactor</code> 为 3，即请求 QPS 从 <code>threshold / 3</code> 开始，经预热时长逐渐升至设定的 QPS 阈值。</p>
<blockquote>
<p><strong>公式：</strong>阈值/coldFactor（默认值为3）</p>
</blockquote>
<p>源码：</p>
<p><img src="/2021/03/15/springcloud/147.png" alt="img"></p>
<p><strong>应用场景：</strong></p>
<p>秒杀系统。秒杀系统在开启的瞬间，会有很多的流量上来，很有可能将系统打死。预热方式就是为了保护系统，可以慢慢的将流量放进来，最终将阈值增长到指定的数值。</p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/146.png" alt="在这里插入图片描述"></p>
<p>效果：</p>
<p><code>/testA</code> 服务，设置 QPS 单机阈值为 10，采用 Warm Up 预热的方式，预热时长为 5s。根据计算公式 **<code>10 / 3 = 3</code>**，前 5s 的阈值为 3，预热 5s 后阈值增长到 10。</p>
<p>即：前5s内，<strong>访问超过 3 次便会被限流；5s 后，阈值增长到 10，此时访问超过 3 次也不会被限流</strong>，<strong>这就是 Warm Up 预热效果。</strong></p>
<h6 id="20-6-1-9、流控效果：排队等待"><a href="#20-6-1-9、流控效果：排队等待" class="headerlink" title="20.6.1.9、流控效果：排队等待"></a>20.6.1.9、流控效果：排队等待</h6><p><strong>排队等待</strong>：让请求以均匀的速度通过，对应的是<code>漏桶算法</code>。这种方式主要用于处理间隔性突发的流量，例如消息队列。</p>
<p><strong>应用场景：</strong></p>
<p>在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态。我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。**<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">官网</a>**</p>
<blockquote>
<p>注意：匀速排队模式暂时不支持 QPS &gt; 1000 的场景。</p>
</blockquote>
<p><img src="/2021/03/15/springcloud/210.png" alt="image"></p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/148.png" alt="在这里插入图片描述"></p>
<p><strong>效果</strong>：</p>
<p><code>/testA</code> 服务，设置 QPS 单机阈值为 2，每秒只接收 2 个请求。设置超时时间 5s。采用漏斗算法，让后台匀速的处理请求，而不是直接拒绝更多的请求。超时的请求则被抛弃，返回错误信息。（流控 Sentinel 默认提示：**<code>Blocked by Sentinel(flow limiting)</code>**）</p>
<h5 id="20-6-2、降级规则"><a href="#20-6-2、降级规则" class="headerlink" title="20.6.2、降级规则"></a>20.6.2、降级规则</h5><p>降级规则。可自行参考官网介绍：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">GitHub 熔断降级</a>。降级策略有 <strong><code>慢调用比例</code>**、</strong><code>异常比例</code><strong>、</strong><code>异常数</code>** 三种。</p>
<p>熔断状态:</p>
<p>熔断有三种状态，分别为<code>OPEN</code>、<code>HALF_OPEN</code>、<code>CLOSED</code></p>
<p><img src="/2021/03/15/springcloud/150.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/149.png" alt="image-20210313202500145"></p>
<blockquote>
<p>**<code>资源名</code>**：唯一路径，默认为请求路径（也可以是后续介绍的 @SentinelResource 注解的 value 属性值）</p>
</blockquote>
<h6 id="20-6-2-1、慢调用比例"><a href="#20-6-2-1、慢调用比例" class="headerlink" title="20.6.2.1、慢调用比例"></a>20.6.2.1、慢调用比例</h6><p>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以<code>慢调用比例作为阈值</code>，需要设置允许的慢调用<code>RT（即最大的响应时间）</code>，请求的响应时间<code>大于</code>该值则统计为慢调用。当单位<code>统计时长</code>（<code>statIntervalMs</code>）内请求数目<code>大于</code>设置的<code>最小请求数目</code>，<strong>并且</strong>慢调用的比例<code>大于</code>阈值，则接下来的熔断时长内请求会<strong>自动被熔断</strong>。经过熔断时长后熔断器会进入<strong>探测恢复状态</strong>（<code>HALF-OPEN</code>状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。（以上来自<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">官网</a>）</p>
<p><img src="/2021/03/15/springcloud/springcloud%5C151.png" alt="img"></p>
<p><strong>执行逻辑</strong>：</p>
<ul>
<li><p><strong>熔断（OPEN）：请求数大于最小请求数并且慢调用的比率大于比例阈值则发生熔断</strong>，熔断时长为用户自定义设置。</p>
</li>
<li><p><strong>探测（HALFOPEN）</strong>：当熔断过了定义的熔断时长，状态由熔断（OPEN）变为探测（HALFOPEN）。</p>
</li>
<li><p>如果接下来的一个请求小于最大RT，说明慢调用已经恢复，结束熔断，状态由探测（HALF_OPEN）变更为关闭（CLOSED）</p>
</li>
<li><p>如果接下来的一个请求大于最大RT，说明慢调用未恢复，继续熔断，熔断时长保持一致</p>
</li>
</ul>
<p>注意Sentinel默认统计的RT上限是<code>4900ms</code>，超出此阈值的都会算作4900ms，若需要变更此上限可以通过启动配置项<code>-Dcsp.sentinel.statistic.max.rt=xxx</code>来配置。</p>
<h6 id="20-6-2-2、异常比例"><a href="#20-6-2-2、异常比例" class="headerlink" title="20.6.2.2、异常比例"></a>20.6.2.2、异常比例</h6><p><strong>异常比例</strong>：<code>QPS &gt;= 5</code> &amp;&amp; <code>异常比例超过设定的阈值</code>，便会发生服务降级 。</p>
<p>异常比例为 0.0~1.0 范围内值。**<code>时间窗口就是断路器开启时间长短(降级时间)</code>** 。要看官网介绍来这里：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5">异常比例介绍</a></p>
<p><strong>图示：</strong></p>
<p><img src="/2021/03/15/springcloud/152.png" alt="在这里插入图片描述"></p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/153.png" alt="在这里插入图片描述"></p>
<p><strong>效果：</strong></p>
<p><code>/testA</code> 服务，设置 降级策略为 **<code>异常比例</code>**，异常比例设为 **<code>0.5</code>**，时间窗口为 **<code>5s</code>**。即：1s 发送6个请求，异常比例超过 50%，就会被熔断，断路器打开5s，5s后自动关闭，继续提供服务。</p>
<p>如果1s发送6次请求，前3次网页报错，因为第4次访问后，异常比例 &gt; 50%，第4次便会被熔断，报 **<code>Blocked by Sentinel(flow limiting)</code>**。5s后继续提供服务哦。</p>
<h6 id="20-6-2-3、异常数"><a href="#20-6-2-3、异常数" class="headerlink" title="20.6.2.3、异常数"></a>20.6.2.3、异常数</h6><p><strong>异常数</strong>：指的是资源 <strong><code>近1分钟</code></strong> 的异常数目，超过阈值之后会进行熔断。<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5">官网</a></p>
<p><strong>重点注意：</strong>异常数，统计时间窗口是分钟级别，若 timeWindow 小于 60s，则结束熔断状态后仍可能再次进入熔断状态。推荐 <strong><code>时间窗口一定要&gt;=60s</code></strong></p>
<p><strong>图示：</strong></p>
<p><img src="/2021/03/15/springcloud/154.png" alt="在这里插入图片描述"></p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/155.png" alt="在这里插入图片描述"></p>
<p><strong>效果：</strong></p>
<p><code>/testA</code> 服务，设置 降级策略为 **<code>异常数</code>**，异常数设为 **<code>5</code>**，时间窗口为 **<code>60s</code>**。即：调用服务，当异常数超过5个时，开启断路器，执行熔断操作。60s 后，断路器关闭，服务恢复正常。</p>
<p>执行 /testA 服务请求，因为每个请求都是异常，前5次调用正常返回，只是报异常到前台(错误页面)；第6次服务调用时，便会被降级熔断。报 **<code>Blocked by Sentinel(flow limiting)</code>**。60s后继续提供服务哦。</p>
<h5 id="20-6-3、热点规则"><a href="#20-6-3、热点规则" class="headerlink" title="20.6.3、热点规则"></a>20.6.3、热点规则</h5><p>(本段内容摘自：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81">Github 热点规则官方介绍</a>)</p>
<h6 id="20-6-3-1、何为热点？"><a href="#20-6-3-1、何为热点？" class="headerlink" title="20.6.3.1、何为热点？"></a>20.6.3.1、何为热点？</h6><p>热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p>
<blockquote>
<p>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制<br>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</p>
</blockquote>
<p><code>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流</code>。 <strong>热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</strong></p>
<p>Sentinel 利用<code>LRU 策略</code>统计最近最常访问的热点参数，结合<code>令牌桶算法</code>来进行参数级别的流控。热点参数限流支持集群模式。</p>
<p><img src="/2021/03/15/springcloud/156.png" alt="在这里插入图片描述"></p>
<h6 id="20-6-3-2、何为热点限流"><a href="#20-6-3-2、何为热点限流" class="headerlink" title="20.6.3.2、何为热点限流"></a>20.6.3.2、何为热点限流</h6><p>一句话解释：根据 url 传递进来的参数进行限流。<strong>带这个参数就限流，不带就不限流</strong>。</p>
<h6 id="20-6-3-3、热点规则"><a href="#20-6-3-3、热点规则" class="headerlink" title="20.6.3.3、热点规则"></a>20.6.3.3、热点规则</h6><p>共有 <strong><code>资源名</code>**、</strong><code>限流模式(只支持QPS模式)</code><strong>、</strong><code>参数索引</code><strong>、</strong><code>单机阈值</code><strong>、</strong><code>统计窗口时长</code><strong>、</strong><code>是否集群</code>** 六种参数；高级选项还有额外一些参数。</p>
<p><img src="/2021/03/15/springcloud/157.png" alt="在这里插入图片描述"></p>
<blockquote>
<p><strong><code>资源名</code>**：唯一路径，默认为请求路径。</strong>此处必须是 @SentinelResource 注解的 value 属性值，配置@GetMapping 的请求路径无效）**<br><strong><code>参数索引</code>**：参数索引（从</strong><code>0</code>**开始，0表示第一个参数、1表示第二个参数）</p>
</blockquote>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/158.png" alt="在这里插入图片描述"></p>
<p><strong>效果：</strong></p>
<p>对 <code>/testC</code> 服务，配置热点key限流。当 1.第<code>二</code>个参数存在   2.一秒内调用 <code>/testC</code> 服务 &gt; 5次，满足限流规则。服务将被熔断。断路器打开，5s 后服务恢复正常。</p>
<p><strong>参数例外项配置：</strong></p>
<p><strong>需求</strong>(当请求参数name的值为Wade时，改变其限流阈值)：</p>
<p>当 name 参数值为 Wade 时，限流阈值变更为 100。此时就需要对 参数例外项 进行配置了。</p>
<p><code>参数类型</code>支持：int、double、String、long、float、char、byte 7种类型，参数值 指 name 参数的值，<code>限流阈值</code>指该参数值允许的阈值。</p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/159.png" alt="在这里插入图片描述"></p>
<p><strong>测试：</strong></p>
<p>调用 URL：</p>
<p><code>http://localhost:8401/testC?id=1&amp;name=Wade</code>，阈值为200；</p>
<p><code>http://localhost:8401/testC?id=1&amp;name=Jhon</code>，阈值为200；</p>
<h5 id="20-6-4、系统规则（不常用）"><a href="#20-6-4、系统规则（不常用）" class="headerlink" title="20.6.4、系统规则（不常用）"></a>20.6.4、系统规则（不常用）</h5><h6 id="20-6-4-1、是什么"><a href="#20-6-4-1、是什么" class="headerlink" title="20.6.4.1、是什么"></a>20.6.4.1、是什么</h6><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的<code>load</code>、<code>CPU 使用率</code>、<code>平均 RT</code>、<code>入口 QPS</code>和<code>并发线程数</code>等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量生效。入口流量指的是进入应用的流量（EntryType.IN），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p>
<p>Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">官网</a></p>
<h6 id="20-6-4-2、系统规则支持的模式"><a href="#20-6-4-2、系统规则支持的模式" class="headerlink" title="20.6.4.2、系统规则支持的模式"></a>20.6.4.2、系统规则支持的模式</h6><ul>
<li>Load 自适应（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。</li>
<li>CPU usage（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li>平均 RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li>并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li>入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<h6 id="20-6-4-3、入口QPS配置"><a href="#20-6-4-3、入口QPS配置" class="headerlink" title="20.6.4.3、入口QPS配置"></a>20.6.4.3、入口QPS配置</h6><p>入口QPS，实用性还是比较危险的。 如果 sentinel 密码被修改，将你的整个系统 <strong><code>入口QPS</code></strong> 配置很小，那么整个系统就瘫痪了。</p>
<p>但是 入口QPS 有总控的功能。最终选择是否使用，还是视情况而定吧</p>
<p><strong>配置：</strong></p>
<p><img src="/2021/03/15/springcloud/160.png" alt="在这里插入图片描述"></p>
<p><strong>效果：</strong></p>
<p>整个系统，每个请求 QPS = 1 正常访问，当该请求 QPS &gt;1 就会被限流。</p>
<h5 id="20-6-5、-SentinelResource"><a href="#20-6-5、-SentinelResource" class="headerlink" title="20.6.5、@SentinelResource"></a>20.6.5、@SentinelResource</h5><p><code>@SentinelResource</code>可以说是 Sentinel 学习的突破口，搞懂了这个注解的应用，基本上就搞清楚了 Sentinel 的大部分应用场景。Sentinel 提供了 <strong>@SentinelResource 注解用于定义资源，并提供了AspectJ的扩展用于自动定义资源、处理BlockException等。</strong></p>
<h6 id="20-6-5-1、-SentinelResource-属性介绍"><a href="#20-6-5-1、-SentinelResource-属性介绍" class="headerlink" title="20.6.5.1、@SentinelResource 属性介绍"></a>20.6.5.1、@SentinelResource 属性介绍</h6><table>
<thead>
<tr>
<th align="center">属性名</th>
<th align="center">是否必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>value</strong></td>
<td align="center">是</td>
<td align="left">资源名称（必填项，需要通过 <code>value</code> 值找到对应的规则进行配置）</td>
</tr>
<tr>
<td align="center">entryType</td>
<td align="center">否</td>
<td align="left">entry类型，标记流量的方向，取值IN/OUT，默认是OUT</td>
</tr>
<tr>
<td align="center"><strong>blockHandler</strong></td>
<td align="center">否</td>
<td align="left">**处理<code>BlockException</code>的函数名称(可以理解为对Sentinel的配置进行方法兜底)**。函数要求：<br>1.必须是<code>public</code>修饰<br>2.<code>返回类型</code>与<code>原方法</code>一致<br>3. <code>参数类型</code>需要和<code>原方法</code>相匹配，并在最后加 <code>BlockException</code>类型的参数。<br>4. 默认需和原方法在同一个类中(耦合度高)。若希望使用其他类的函数，可配置<code>blockHandlerClass</code>，并<code>指定</code>blockHandlerClass里面的方法。<br></td>
</tr>
<tr>
<td align="center"><strong>blockHandlerClass</strong></td>
<td align="center">否</td>
<td align="left"><strong>存放blockHandler的类</strong>。<br>对应的处理函数必须<code>public static</code>修饰，否则无法解析，其他要求：同blockHandler。</td>
</tr>
<tr>
<td align="center"><strong>fallback</strong></td>
<td align="center">否</td>
<td align="left">**用于在抛出异常的时候提供fallback处理逻辑(可以理解为对<code>java异常</code>情况方法兜底)**。<br>fallback函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code>里面排除掉的异常类型）进行处理。函数要求：<br>1.<code>返回类型</code>与<code>原方法</code>一致<br>2.<code>参数类型</code>需要和<code>原方法</code>相匹配，Sentinel 1.6开始，也可在方法最后加<code>Throwable</code>类型的参数。<br>3.默认需和原方法在同一个类中(耦合度高)。若希望使用其他类的函数，可配置<code>fallbackClass</code> ，并<code>指定</code>fallbackClass里面的方法。<br></td>
</tr>
<tr>
<td align="center"><strong>fallbackClass</strong></td>
<td align="center">否</td>
<td align="left"><strong>存放fallback的类</strong>。<br>对应的处理函数必须<code>static</code>修饰，否则无法解析，其他要求：同fallback。</td>
</tr>
<tr>
<td align="center"><strong>defaultFallback</strong></td>
<td align="center">否</td>
<td align="left"><strong>用于通用的 fallback 逻辑</strong>。<br>默认 fallback 函数可以针对所有类型的异常（除了<code>exceptionsToIgnore</code>里面排除掉的异常类型）进行处理。<strong>若同时配置了 fallback 和 defaultFallback，以fallback为准</strong>。函数要求：<br>1.<code>返回类型</code>与<code>原方法</code>一致<br>2.方法参数列表为<code>空</code>，或者有一个<code>Throwable </code>类型的参数。<br>3.默认需要和原方法在同一个类中(耦合度高)。若希望使用其他类的函数，可配置<code>fallbackClass</code> ，并<code>指定</code>fallbackClass 里面的方法。<br></td>
</tr>
<tr>
<td align="center"><strong>exceptionsToIgnore</strong></td>
<td align="center">否</td>
<td align="left"><strong>指定排除掉哪些异常。</strong><br>排除的异常不会计入异常统计，也不会进入fallback逻辑，而是原样抛出。</td>
</tr>
<tr>
<td align="center">exceptionsToTrace</td>
<td align="center">否</td>
<td align="left">需要trace的异常</td>
</tr>
</tbody></table>
<p>（加深标注属性为常用属性）</p>
<p><img src="/2021/03/15/springcloud/164.png" alt="img"></p>
<h6 id="20-6-5-2、fallback-指定java异常兜底方法"><a href="#20-6-5-2、fallback-指定java异常兜底方法" class="headerlink" title="20.6.5.2、fallback 指定java异常兜底方法"></a>20.6.5.2、fallback 指定java异常兜底方法</h6><p>**<code>fallback只用来处理与Java逻辑异常相关的兜底</code>**。比如：NullPointerException、ArrayIndexOutOfBoundsException 等java代码中的异常，fallback 指定的兜底方法便会生效。</p>
<p><strong>兜底方法与业务方法耦合</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testA&quot;, fallback = &quot;fallbackMethod&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-----testA&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">fallbackMethod</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;限流请求连接(Java类异常)的兜底方法：&quot;</span> + e.getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用 fallbackClass 将兜底方法与业务解耦合</strong>：</p>
<p><img src="/2021/03/15/springcloud/161.png" alt="在这里插入图片描述"></p>
<h6 id="20-6-5-3、blockHandler-指定-Sentinel-配置兜底方法"><a href="#20-6-5-3、blockHandler-指定-Sentinel-配置兜底方法" class="headerlink" title="20.6.5.3、blockHandler 指定 Sentinel 配置兜底方法"></a>20.6.5.3、blockHandler 指定 Sentinel 配置兜底方法</h6><p>**<code>blockHandler 只用来处理 与 Sentinel 配置有关的兜底</code>**。比如：配置某资源 QPS =1，当 QPS &gt;1 时，blockHandler 指定的兜底方法便会生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 业务逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testB&quot;,blockHandler = &quot;exceptionMethod&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-----testB&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">exceptionMethod</span><span class="params">(BlockException exception)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;限流@SentinelResource value 属性的兜底方法:&quot;</span> + exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用 fallbackClass 将兜底方法与业务解耦合</strong></p>
<p><img src="/2021/03/15/springcloud/162.png" alt="在这里插入图片描述"></p>
<h6 id="20-6-5-4、exceptionsToIgnore-用于指定异常不走兜底方法"><a href="#20-6-5-4、exceptionsToIgnore-用于指定异常不走兜底方法" class="headerlink" title="20.6.5.4、exceptionsToIgnore 用于指定异常不走兜底方法"></a>20.6.5.4、exceptionsToIgnore 用于指定异常不走兜底方法</h6><p>使用<code>exceptionsTolgnore</code>属性，来<code>指定某些异常不执行兜底方法，直接显示错误信息</code>。配置 ArithmeticException 异常不走兜底方法。java.lang.ArithmeticException: / by zero ，便不会再执行兜底方法，直接显示错误信息给前台页面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testA&quot;, </span></span><br><span class="line"><span class="meta">					fallback = &quot;fallbackMethod&quot;,</span></span><br><span class="line"><span class="meta">					fallbackClass = CustomerFallback.class, </span></span><br><span class="line"><span class="meta">					exceptionsToIgnore = ArithmeticException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-----testA&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="20-6-5-5、defaultFallback-用于指定通用的-fallback-兜底方法"><a href="#20-6-5-5、defaultFallback-用于指定通用的-fallback-兜底方法" class="headerlink" title="20.6.5.5、defaultFallback 用于指定通用的 fallback 兜底方法"></a>20.6.5.5、defaultFallback 用于指定通用的 fallback 兜底方法</h6><p>使用 defaultFallback 来指定通用的 fallback 兜底方法。</p>
<ul>
<li>如果当前业务配置有 defaultFallback 和 fallback 两个属性，则优先执行 fallback 指定的方法。</li>
<li>如果 fallback 指定的方法不存在，还会执行 defaultFallback 指定的方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 业务逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testA&quot;,</span></span><br><span class="line"><span class="meta">        fallback = &quot;fallbackMethod&quot;,</span></span><br><span class="line"><span class="meta">        fallbackClass = CustomerFallback.class,</span></span><br><span class="line"><span class="meta">        defaultFallback = &quot;defaultFallbackMethod&quot; //直接指定即可，使用比较简单</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-----testA&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 单独一个类，存放兜底方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerFallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">defaultFallbackMethod</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;通用的fallback兜底方法&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">fallbackMethod</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;限流请求连接(Java类异常)的兜底方法：&quot;</span> + e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面兜底方案面临的问题：</p>
<ol>
<li>系统默认的，没有体现我们自己的业务要求。</li>
<li>依照现有条件，我们自定义的处理方法又和业务代码耦合在一块，不直观。</li>
<li>每个业务方法都添加一个兜底的，那代码膨胀加剧。</li>
<li>全局统一的处理方法没有体现。</li>
</ol>
<p>客户自定义限流处理逻辑：</p>
<ol>
<li><p>创建CustomerBlockHandler类用于自定义限流处理逻辑：</p>
</li>
<li><p>自定义限流处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerBlockHandler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title">handlerException</span><span class="params">(BlockException exception)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">4444</span>,<span class="string">&quot;按客戶自定义,global handlerException----1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title">handlerException2</span><span class="params">(BlockException exception)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">4444</span>,<span class="string">&quot;按客戶自定义,global handlerException----2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RateLimitController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byResource&quot;,blockHandler = &quot;handleException&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">byResource</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按资源名称限流测试OK&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">handleException</span><span class="params">(BlockException exception)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,exception.getClass().getCanonicalName()+<span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rateLimit/byUrl&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byUrl&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">byUrl</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按url限流测试OK&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial002&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;customerBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">            blockHandlerClass = CustomerBlockHandler.class,</span></span><br><span class="line"><span class="meta">            blockHandler = &quot;handlerException2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">customerBlockHandler</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按客戶自定义&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial003&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/15/springcloud/163.png" alt="img"></p>
</li>
</ol>
<p>Sentinel的三个核心API：</p>
<p><img src="/2021/03/15/springcloud/文件/java/我/java后台学习笔记/springcloud/springcloud/165.png" alt="image-20210314010417987"></p>
<p>注意异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效。为了统计异常比例或异常数，需要通过 <code>Tracer.trace(ex)</code> 记录业务异常。示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Entry entry = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  entry = SphU.entry(key, EntryType.IN, key);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write your biz code here.</span></span><br><span class="line">  <span class="comment">// &lt;&lt;BIZ CODE&gt;&gt;</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!BlockException.isBlockException(t)) &#123;</span><br><span class="line">    Tracer.trace(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">    entry.exit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="20-7、服务熔断"><a href="#20-7、服务熔断" class="headerlink" title="20.7、服务熔断"></a>20.7、服务熔断</h4><p>sentinel整合ribbon+openFeign+fallback</p>
<p>公共：</p>
<ol>
<li><p>启动nacos和启动sentinel服务</p>
</li>
<li><p>新建两个服务提供端（实现负载均衡）（详情看上面微服务项目整合Sentinel）</p>
</li>
<li><p>服务提供端的业务类PaymentController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Long,Payment&gt; hashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 模拟数据库</span></span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        hashMap.put(<span class="number">1L</span>,<span class="keyword">new</span> Payment(<span class="number">1L</span>,<span class="string">&quot;28a8c1e3bc2742d8848569891fb42181&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">2L</span>,<span class="keyword">new</span> Payment(<span class="number">2L</span>,<span class="string">&quot;bba8c1e3bc2742d8848569891ac32182&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">3L</span>,<span class="keyword">new</span> Payment(<span class="number">3L</span>,<span class="string">&quot;6ua8c1e3bc2742d8848569891xt92183&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入1、2、3得到数据，输入4报空指针异常</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Payment payment = hashMap.get(id);</span><br><span class="line">        CommonResult&lt;Payment&gt; result = <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;from mysql,serverPort:  &quot;</span>+serverPort,payment);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建服务消费端</p>
</li>
<li><p>业务类CircleBreakerController</p>
</li>
</ol>
<h5 id="20-7-1、Ribbon系列"><a href="#20-7-1、Ribbon系列" class="headerlink" title="20.7.1、Ribbon系列"></a>20.7.1、Ribbon系列</h5><ol>
<li><p>添加sentinel依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动添加@EnableDiscoveryClient</p>
</li>
<li><p>添加RestTemplate配置类ApplicationContextConfig(<strong>添加@LoadBalanced</strong>)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="20-7-2、OpenFeign系列（Feign组件一般是在消费者侧）"><a href="#20-7-2、OpenFeign系列（Feign组件一般是在消费者侧）" class="headerlink" title="20.7.2、OpenFeign系列（Feign组件一般是在消费者侧）"></a>20.7.2、OpenFeign系列（Feign组件一般是在消费者侧）</h5><ol>
<li><p>添加OpenFeign依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud openfeign --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml配置文件（激活Sentinel对Feign的支持）：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活Sentinel对Feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类添加注解：@EnableFeignClients</p>
</li>
<li><p>service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-provider&quot;,fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局fallback实现service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title">PaymentService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(Long id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">44444</span>,<span class="string">&quot;服务降级返回,---PaymentFallbackService&quot;</span>,<span class="keyword">new</span> Payment(id,<span class="string">&quot;errorSerial&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>业务类CircleBreakerController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleBreakerController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_URL = <span class="string">&quot;http://nacos-payment-provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;) //没有配置</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;) //fallback只负责业务异常</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;,blockHandler = &quot;blockHandler&quot;) //blockHandler只负责sentinel控制台配置违规</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;,blockHandler = &quot;blockHandler&quot;,</span></span><br><span class="line"><span class="meta">            exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span>+id,CommonResult.class,id);</span><br><span class="line">空指针异常</span><br><span class="line">        <span class="comment">// 输入4报非法参数异常，输入其他报空指针异常</span></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException (<span class="string">&quot;IllegalArgumentException,非法参数异常，输入其他报....&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException (<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本例是fallback</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> </span>&#123;</span><br><span class="line">        Payment payment = <span class="keyword">new</span> Payment(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本例是blockHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,BlockException blockException)</span> </span>&#123;</span><br><span class="line">        Payment payment = <span class="keyword">new</span> Payment(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span>+blockException.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//==================OpenFeign</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.paymentSQL(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>没有配置：@SentinelResource(value = “fallback”) （不友好）</p>
<ul>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/2">http://lcaolhost:84/consumer/fallback/2</a></p>
<p><img src="/2021/03/15/springcloud/167.png" alt="image-20210314020226329"></p>
</li>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/4">http://lcaolhost:84/consumer/fallback/4</a></p>
<p><img src="/2021/03/15/springcloud/168.png" alt="image-20210314020528745"></p>
</li>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/5">http://lcaolhost:84/consumer/fallback/5</a></p>
<p><img src="/2021/03/15/springcloud/169.png" alt="image-20210314020917296"></p>
</li>
</ul>
</li>
<li><p>只配置fallback（只负责运行异常）：@SentinelResource(value = “fallback”,fallback = “handlerFallback”)</p>
<ul>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/4">http://lcaolhost:84/consumer/fallback/4</a></p>
<p><img src="/2021/03/15/springcloud/170.png" alt="image-20210314021545779"></p>
</li>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/5">http://lcaolhost:84/consumer/fallback/5</a></p>
<p><img src="/2021/03/15/springcloud/171.png" alt="image-20210314021737234"></p>
</li>
</ul>
</li>
<li><p>只配置blockHandler（只负责sentinel控制台配置违规）：@SentinelResource(value = “fallback”,blockHandler = “blockHandler”)</p>
<p>配置sentinel控制台：</p>
<p><img src="/2021/03/15/springcloud/172.png" alt="image-20210314022142172"></p>
<ul>
<li><p>测试：<a target="_blank" rel="noopener" href="http://lcaolhost:84/consumer/fallback/4%E7%82%B9%E5%87%BB%E4%B8%80%E6%AC%A1">http://lcaolhost:84/consumer/fallback/4点击一次</a></p>
<p><img src="/2021/03/15/springcloud/168.png" alt="image-20210314020528745"></p>
<p>连续点击：</p>
<p><img src="/2021/03/15/springcloud/173.png" alt="image-20210314022337780"></p>
</li>
</ul>
</li>
<li><p>fallback和blockHandler都配置：</p>
<p>若blockHandler和fallback都进行了配置，则被限流降级而抛出BlockException时<strong>只会进入blockHandler处理逻辑</strong>。</p>
</li>
</ul>
<h5 id="20-7-3、熔断框架比较"><a href="#20-7-3、熔断框架比较" class="headerlink" title="20.7.3、熔断框架比较"></a>20.7.3、熔断框架比较</h5><p><img src="/2021/03/15/springcloud/174.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/175.png" alt="img"></p>
<h4 id="20-8、Sentinel-控制台规则持久化（持久化到Nacos比较鸡肋）"><a href="#20-8、Sentinel-控制台规则持久化（持久化到Nacos比较鸡肋）" class="headerlink" title="20.8、Sentinel 控制台规则持久化（持久化到Nacos比较鸡肋）"></a>20.8、Sentinel 控制台规则持久化（持久化到Nacos比较鸡肋）</h4><p>Sentinel 控制台规则持久化问题：</p>
<p>在 Sentinel 中，我们会为多个服务进行 流控、限流、热点 等规则 的配置，但是当服务重启后再进入 Sentinel 后，发现之前配置过的规则都不在了，这样子的体验显然不友好，此时就需要我们对 Sentinel 中配置的规则规则进行持久化操作。</p>
<p>目前控制台的规则推送也是通过<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E6%9F%A5%E8%AF%A2%E6%9B%B4%E6%94%B9%E8%A7%84%E5%88%99">规则查询更改 HTTP API</a>来更改规则。这也意味着这些规则 仅在内存态生效，应用重启之后，该规则会丢失。</p>
<p>以上是原始模式。当了解了原始模式之后，我们非常鼓励您通过<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">动态规则</a> 并结合各种外部存储来定制自己的规则源。我们推荐通过动态配置源的控制台来进行规则写入和推送，而不是通过 Sentinel 客户端直接写入到动态配置源中。在生产环境中，我们推荐 push 模式，具体可以参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel">在生产环境使用 Sentinel</a>。也可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42437633/article/details/106443342">博客</a></p>
<p>规则管理及推送：</p>
<p><img src="/2021/03/15/springcloud/166.png" alt="在这里插入图片描述"></p>
<h5 id="20-8-1、持久化配置（鸡肋）"><a href="#20-8-1、持久化配置（鸡肋）" class="headerlink" title="20.8.1、持久化配置（鸡肋）"></a>20.8.1、持久化配置（鸡肋）</h5><p><strong>将限流配置规则持久化进Nacos保存</strong>，只要刷新8401某个rest地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，针对8401上sentinel上的流控规则持续有效。</p>
<p>步骤：</p>
<ol>
<li><p>添加依赖pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改添加application.yml（主要是datasource）：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line">      <span class="comment">#添加nacos数据源配置</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">ds1:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 激活Sentinel对Feign的支持</span></span><br></pre></td></tr></table></figure>

<p>其中dataId的值为${spring.application.name}。</p>
</li>
<li><p>添加nacos业务配置规则</p>
<p><img src="/2021/03/15/springcloud/176.png" alt="img"></p>
<p>其中Data ID的值为${spring.application.name}的值。</p>
</li>
<li><p>在配置中的选择json，并添加内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;resource&quot;</span>:<span class="string">&quot;/rateLimit/byUrl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;limitApp&quot;</span>:<span class="string">&quot;default&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;grade&quot;</span>:<span class="number">1</span>,</span><br><span class="line">		<span class="attr">&quot;count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">&quot;strategy&quot;</span>:<span class="number">0</span>,</span><br><span class="line">		<span class="attr">&quot;controlBehavior&quot;</span>:<span class="number">0</span>,</span><br><span class="line">		&quot;clusterMode&quot;; false</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>resource：资源名称；</li>
<li>limitApp：来源应用；</li>
<li>grade：國值类型，0表示线程数，1表示QPS；</li>
<li>count：单机國值；</li>
<li>strategy：流控模式，0表示直接，1表示关联，2表示链路；</li>
<li>controlBehavior：流控效果，0表示快速失败，1表示Warm Up，2表示排队等待；</li>
<li>clusterMode：是否集群。</li>
</ul>
</li>
<li><p>重启微服务，刷新sentinel。</p>
<p>发现业务规则有了</p>
<p><img src="/2021/03/15/springcloud/177.png" alt="img"></p>
</li>
<li><p>快速访问测试接口：配置成功。</p>
<p><img src="/2021/03/15/springcloud/178.png" alt="image-20210314025406567"></p>
</li>
<li><p>关闭微服务再看sentinel：</p>
<p><img src="/2021/03/15/springcloud/179.png" alt="img"></p>
</li>
<li><p>重启微服务再看sentinel：（鸡肋）</p>
<p><img src="/2021/03/15/springcloud/180.png" alt="image-20210314025455716"></p>
</li>
</ol>
<h5 id="20-8-2、Alibaba-AHAS-与-Alibaba-Sentinel"><a href="#20-8-2、Alibaba-AHAS-与-Alibaba-Sentinel" class="headerlink" title="20.8.2、Alibaba AHAS 与 Alibaba Sentinel"></a>20.8.2、Alibaba AHAS 与 Alibaba Sentinel</h5><h6 id="20-8-2-1、AHAS是什么："><a href="#20-8-2-1、AHAS是什么：" class="headerlink" title="20.8.2.1、AHAS是什么："></a>20.8.2.1、AHAS是什么：</h6><p>应用高可用服务AHAS是一款专注于提高应用高可用能力的SaaS产品，提供应用架构自动探测、故障注入式高可用能力演练、一键应用防护和增加功能开关等功能，可以快速低成本地提升应用可用性。</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/87450.html">官网</a></p>
<p>Alibaba AHAS是<code>商业化</code>的（说白了就是要用钱买）</p>
<p>Alibaba Sentinel是<code>开源</code>的，任何人都能用</p>
<p>Alibaba AHAS完成了对配置信息持久化的更深一层的包装。</p>
<p>更多资料：</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/167568.html">Alibaba AHAS 与 Alibaba Sentinel的对比</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lettuce_/article/details/102799028">springcloud（11）Alibaba-AHAS 限流方式</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hosaos/article/details/91413895">Sentinel-集成阿里云AHAS控制台实现集群流控</a></p>
<h3 id="21、SpringCloud-Alibaba-Seata处理分布式事务"><a href="#21、SpringCloud-Alibaba-Seata处理分布式事务" class="headerlink" title="21、SpringCloud Alibaba Seata处理分布式事务"></a>21、SpringCloud Alibaba Seata处理分布式事务</h3><h4 id="21-1、目前微服务面临的问题"><a href="#21-1、目前微服务面临的问题" class="headerlink" title="21.1、目前微服务面临的问题"></a>21.1、目前微服务面临的问题</h4><p>在之前 <strong><code>单机单库</code></strong> 环境下，针对事务的处理还是比较简单的。尤其是结合 Spring 框架，可以说是一个@Transaction 注解走天下。事务 &amp; Spring 事务相关内容，点击链接去了解吧：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lzb348110175/article/details/104854696">事务 &amp; Spring 事务内容介绍</a></p>
<p>在如今 Spring Cloud 分布式微服务架构体系中，按业务模块划分，一个模块使用一个数据库。多个模块配合来完成一个业务，我们就从 <a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/user/quickstart.html">官网</a> 的一个微服务实例开始吧。</p>
<h5 id="21-1-1、-用例"><a href="#21-1-1、-用例" class="headerlink" title="21.1.1、 用例"></a>21.1.1、 用例</h5><p><strong>用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：</strong></p>
<ul>
<li>仓储服务：对给定的商品扣除仓储数量。</li>
<li>订单服务：根据采购需求创建订单。</li>
<li>帐户服务：从用户帐户中扣除余额。</li>
</ul>
<h5 id="21-1-2、架构图"><a href="#21-1-2、架构图" class="headerlink" title="21.1.2、架构图"></a>21.1.2、架构图</h5><p><img src="/2021/03/15/springcloud/181.png" alt="在这里插入图片描述"></p>
<h5 id="21-1-3、分布式事务解决方案"><a href="#21-1-3、分布式事务解决方案" class="headerlink" title="21.1.3、分布式事务解决方案"></a>21.1.3、分布式事务解决方案</h5><p>单体应用被拆分成微服务应用，原来的三个模块被拆分成三个独立的应用，分别使用三个<code>独立的数据源</code>，业务操作需要调用三个服务来完成。此时<strong>每个服务内部的数据一致性由<code>本地事务</code>来保证</strong>，但是<strong>全局数据一致性问题是无法保证的</strong>。所以，Alibaba Seata来处理分布式事务</p>
<h4 id="21-2、是什么"><a href="#21-2、是什么" class="headerlink" title="21.2、是什么"></a>21.2、是什么</h4><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。 Seata 将为用户提供了**<code>AT</code>**、<code>TCC</code>、<code>SAGA</code>和<code>XA</code>事务模式，为用户打造一站式的分布式解决方案。</p>
<p>在 Seata 开源之前，Seata 对应的内部版本在阿里经济体内部一直扮演着<code>分布式一致性中间件</code>的角色，帮助经济体平稳的度过历年的双11，对各部门业务进行了有力的支撑。经过多年沉淀与积累，商业化产品先后在阿里云、金融云进行售卖。2019.1 为了打造更加完善的技术生态和普惠技术成果，Seata 正式宣布对外开源，未来 Seata 将以社区共建的形式帮助其技术更加可靠与完备。</p>
<p>此处重点介绍 **<code>AT模式</code>**，在工作中也最常用，用起来也比较简单。</p>
<p>Seata的四个模式<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html">官网</a>、<a target="_blank" rel="noopener" href="https://my.oschina.net/sofastack/blog/3092880">资料</a>：</p>
<ul>
<li><p><strong>AT 模式：</strong></p>
<p>提供无侵入自动补偿的事务模式，目前已支持 MySQL、 Oracle 、PostgreSQL和 TiDB的AT模式，H2 开发中</p>
</li>
<li><p>TCC 模式<a target="_blank" rel="noopener" href="https://blog.csdn.net/huaishu/article/details/89880971">资料</a>：</p>
<p>支持 TCC 模式并可与 AT 混用，灵活度更高</p>
</li>
<li><p>SAGA 模式<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38308374/article/details/108907413">资料</a>：</p>
<p>为长事务提供有效的解决方案</p>
</li>
<li><p>XA 模式<a target="_blank" rel="noopener" href="https://blog.csdn.net/yyl2733291216/article/details/106149336/">资料</a>：</p>
<p>支持已实现 XA 接口的数据库的 XA 模式</p>
</li>
</ul>
<h4 id="21-3、Seata-术语表"><a href="#21-3、Seata-术语表" class="headerlink" title="21.3、Seata 术语表"></a>21.3、Seata 术语表</h4><p>（术语即：名词介绍，以下内容摘自：Seata 官方文档 <a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/overview/terminology.html%EF%BC%89">http://seata.io/zh-cn/docs/overview/terminology.html）</a></p>
<ul>
<li><strong>TC (Transaction Coordinator) - 事务协调者</strong><br>维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
<li><strong>TM (Transaction Manager) - 事务管理器</strong><br>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li>
<li><strong>RM (Resource Manager) - 资源管理器</strong><br>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
<p>其中，TC 为单独部署的 <strong>Server</strong> 服务端，TM 和 RM 为嵌入到应用中的 <strong>Client</strong> 客户端。</p>
<p><img src="/2021/03/15/springcloud/182.png" alt="在这里插入图片描述"></p>
<p>Seata管理的分布式事务的典型生命周期（执行过程）：</p>
<ol>
<li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID；</li>
<li>XID 在微服务调用链路的上下文中传播；</li>
<li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖；</li>
<li>TM 向 TC 发起针对 XID 的全局提交或回滚决议；</li>
<li>TC 调度 XID 下管辖的全局分支事务，完成分支提交或回滚请求。</li>
</ol>
<h4 id="21-4、AT模式"><a href="#21-4、AT模式" class="headerlink" title="21.4、AT模式"></a>21.4、AT模式</h4><h5 id="21-4-1、AT-前提"><a href="#21-4-1、AT-前提" class="headerlink" title="21.4.1、AT 前提"></a>21.4.1、AT 前提</h5><ul>
<li>基于支持本地 ACID 事务的关系型数据库。</li>
<li>Java 应用，通过 JDBC 访问数据库。</li>
</ul>
<h5 id="21-4-2、AT-整体机制"><a href="#21-4-2、AT-整体机制" class="headerlink" title="21.4.2、AT 整体机制"></a>21.4.2、AT 整体机制</h5><p>两阶段提交协议的演变：</p>
<ul>
<li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li>
<li>二阶段：<ul>
<li>提交异步化，非常快速地完成。</li>
<li>回滚通过一阶段的回滚日志进行<code>反向补偿</code>。</li>
</ul>
</li>
</ul>
<h5 id="21-4-3、写隔离"><a href="#21-4-3、写隔离" class="headerlink" title="21.4.3、写隔离"></a>21.4.3、写隔离</h5><ul>
<li>一阶段本地事务提交前，需要确保先拿到 <strong>全局锁</strong> 。</li>
<li>拿不到 <strong>全局锁</strong> ，不能提交本地事务。</li>
<li>拿 <strong>全局锁</strong> 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。</li>
</ul>
<p>以一个示例来说明：</p>
<p>两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000。</p>
<p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 <strong>全局锁</strong> ，本地提交释放本地锁。 tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 <strong>全局锁</strong> ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 <strong>全局锁</strong> 。</p>
<p><img src="/2021/03/15/springcloud/183.png" alt="img"></p>
<p>tx1 二阶段全局提交，释放 <strong>全局锁</strong> 。tx2 拿到 <strong>全局锁</strong> 提交本地事务。</p>
<p><img src="/2021/03/15/springcloud/184.png" alt="img"></p>
<p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。</p>
<p>此时，如果 tx2 仍在等待该数据的 <strong>全局锁</strong>，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 <strong>全局锁</strong> 等锁超时，放弃 <strong>全局锁</strong> 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p>
<p>因为整个过程 <strong>全局锁</strong> 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 <strong>脏写</strong> 的问题。</p>
<h5 id="21-4-4、读隔离"><a href="#21-4-4、读隔离" class="headerlink" title="21.4.4、读隔离"></a>21.4.4、读隔离</h5><p>在数据库本地事务隔离级别 <strong>读已提交（Read Committed）</strong> 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>读未提交（Read Uncommitted）</strong> 。</p>
<p>如果应用在特定场景下，必需要求全局的 <strong>读已提交</strong> ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。</p>
<p><img src="/2021/03/15/springcloud/185.png" alt="img"></p>
<p>SELECT FOR UPDATE 语句的执行会申请 <strong>全局锁</strong> ，如果 <strong>全局锁</strong> 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>全局锁</strong> 拿到，即读取的相关数据是 <strong>已提交</strong> 的，才返回。</p>
<p>出于总体性能上的考虑，Seata 目前的方案<strong>并没有对所有 SELECT 语句都进行代理</strong>，仅针对 FOR UPDATE 的 SELECT 语句。</p>
<h5 id="21-4-5、工作机制"><a href="#21-4-5、工作机制" class="headerlink" title="21.4.5、工作机制"></a>21.4.5、工作机制</h5><p>以一个示例来说明整个 AT 分支的工作过程。</p>
<p>业务表：<code>product</code></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Key</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint(20)</td>
<td>PRI</td>
</tr>
<tr>
<td>name</td>
<td>varchar(100)</td>
<td></td>
</tr>
<tr>
<td>since</td>
<td>varchar(100)</td>
<td></td>
</tr>
</tbody></table>
<p><strong>AT 分支事务的业务逻辑：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">&#x27;GTS&#x27;</span> <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">&#x27;TXC&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h6 id="21-4-5-1、一阶段"><a href="#21-4-5-1、一阶段" class="headerlink" title="21.4.5.1、一阶段"></a>21.4.5.1、一阶段</h6><p>过程：</p>
<ol>
<li>解析 SQL：得到 SQL 的类型（UPDATE），表（product），条件（where name = ‘TXC’）等相关的信息。</li>
<li>查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span>, since <span class="keyword">from</span> product <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">&#x27;TXC&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>得到前镜像：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>since</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>TXC</td>
<td>2021</td>
</tr>
</tbody></table>
<ol>
<li>执行业务 SQL：更新这条记录的 name 为 ‘GTS’。</li>
<li>查询后镜像：根据前镜像的结果，通过 <strong>主键</strong> 定位数据。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span>, since <span class="keyword">from</span> product <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span><span class="string">`;</span></span><br></pre></td></tr></table></figure>

<p>得到后镜像：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>since</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>GTS</td>
<td>2021</td>
</tr>
</tbody></table>
<p>插入回滚日志：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;branchId&quot;</span>: <span class="number">641789253</span>,</span><br><span class="line">	<span class="attr">&quot;undoItems&quot;</span>: [&#123;</span><br><span class="line">		<span class="attr">&quot;afterImage&quot;</span>: &#123;</span><br><span class="line">			<span class="attr">&quot;rows&quot;</span>: [&#123;</span><br><span class="line">				<span class="attr">&quot;fields&quot;</span>: [&#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">4</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">				&#125;, &#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="string">&quot;GTS&quot;</span></span><br><span class="line">				&#125;, &#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;since&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="string">&quot;2021&quot;</span></span><br><span class="line">				&#125;]</span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="attr">&quot;tableName&quot;</span>: <span class="string">&quot;product&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">&quot;beforeImage&quot;</span>: &#123;</span><br><span class="line">			<span class="attr">&quot;rows&quot;</span>: [&#123;</span><br><span class="line">				<span class="attr">&quot;fields&quot;</span>: [&#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">4</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">				&#125;, &#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="string">&quot;TXC&quot;</span></span><br><span class="line">				&#125;, &#123;</span><br><span class="line">					<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;since&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;type&quot;</span>: <span class="number">12</span>,</span><br><span class="line">					<span class="attr">&quot;value&quot;</span>: <span class="string">&quot;2021&quot;</span></span><br><span class="line">				&#125;]</span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="attr">&quot;tableName&quot;</span>: <span class="string">&quot;product&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">&quot;sqlType&quot;</span>: <span class="string">&quot;UPDATE&quot;</span></span><br><span class="line">	&#125;],</span><br><span class="line">	<span class="attr">&quot;xid&quot;</span>: <span class="string">&quot;xid:xxx&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>提交前，向 TC注册分支：申请 <code>product</code> 表中，主键值等于 1 的记录的<strong>全局锁</strong>.</li>
<li>本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。</li>
<li>将本地事务提交的结果上报给 TC。</li>
</ol>
<h6 id="21-4-5-2、二阶段-回滚"><a href="#21-4-5-2、二阶段-回滚" class="headerlink" title="21.4.5.2、二阶段-回滚"></a>21.4.5.2、二阶段-回滚</h6><ol>
<li><p>收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</p>
</li>
<li><p>通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</p>
</li>
<li><p>数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改（脏写）。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。</p>
</li>
<li><p>根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">&#x27;TXC&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</p>
</li>
</ol>
<h6 id="21-4-5-3、二阶段-提交"><a href="#21-4-5-3、二阶段-提交" class="headerlink" title="21.4.5.3、二阶段-提交"></a>21.4.5.3、二阶段-提交</h6><ol>
<li>收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li>
<li>异步任务阶段的分支提交请求将异步和批量地删除相应<code>UNDO LOG</code>记录。</li>
</ol>
<p>回滚事务表：</p>
<p>UNDO_LOG Table：不同数据库在类型上会略有差别。</p>
<p>以 MySQL 为例：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>branch_id</td>
<td>bigint PK</td>
</tr>
<tr>
<td>xid</td>
<td>varchar(100)</td>
</tr>
<tr>
<td>context</td>
<td>varchar(128)</td>
</tr>
<tr>
<td>rollback_info</td>
<td>longblob</td>
</tr>
<tr>
<td>log_status</td>
<td>tinyint</td>
</tr>
<tr>
<td>log_created</td>
<td>datetime</td>
</tr>
<tr>
<td>log_modified</td>
<td>datetime</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意此处0.7.0+ 增加字段 context</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`undo_log`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`branch_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`xid`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`context`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`rollback_info`</span> longblob <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`log_status`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`log_created`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`log_modified`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>,<span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h6 id="21-4-5-4、总结"><a href="#21-4-5-4、总结" class="headerlink" title="21.4.5.4、总结"></a>21.4.5.4、总结</h6><ul>
<li>是什么</li>
</ul>
<p><img src="/2021/03/15/springcloud/186.png" alt="img"></p>
<ul>
<li>一阶段加载：</li>
</ul>
<p><img src="/2021/03/15/springcloud/187.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/188.png" alt="img"></p>
<ul>
<li>二阶段提交：</li>
</ul>
<p><img src="/2021/03/15/springcloud/189.png" alt="img"></p>
<ul>
<li>二阶段回滚：</li>
</ul>
<p><img src="/2021/03/15/springcloud/190.png" alt="img"></p>
<p><img src="/2021/03/15/springcloud/191.png" alt="img"></p>
<h4 id="21-5、Spring-Cloud-整合-Nacos-1-3-1-Seata-1-2-0-集群部署-Windows版"><a href="#21-5、Spring-Cloud-整合-Nacos-1-3-1-Seata-1-2-0-集群部署-Windows版" class="headerlink" title="21.5、Spring Cloud 整合 Nacos 1.3.1 + Seata 1.2.0 集群部署(Windows版)"></a>21.5、Spring Cloud 整合 Nacos 1.3.1 + Seata 1.2.0 集群部署(Windows版)</h4><h5 id="21-5-1、环境说明"><a href="#21-5-1、环境说明" class="headerlink" title="21.5.1、环境说明"></a>21.5.1、环境说明</h5><p><strong>部署环境+版本：</strong> <strong><code>MySQL 5.7.x</code></strong> + <strong><code>Nacos 1.3.1</code></strong> + <strong><code>Seata 1.2.0</code></strong> + **<code>Windows 环境演示</code>**，Linux 部署类似。</p>
<h5 id="21-5-2、Seata-1-2-0-下载"><a href="#21-5-2、Seata-1-2-0-下载" class="headerlink" title="21.5.2、Seata 1.2.0 下载"></a>21.5.2、Seata 1.2.0 下载</h5><p>进入 <a target="_blank" rel="noopener" href="http://seata.io/zh-cn/blog/download.html">Seata 官网下载地址</a> 或者 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases/tag/v1.2.0">Seata Github下载地址</a>，选择 Seata 1.2.0 版本下载。</p>
<h5 id="21-5-3、官网新人文档中的资源目录介绍"><a href="#21-5-3、官网新人文档中的资源目录介绍" class="headerlink" title="21.5.3、官网新人文档中的资源目录介绍"></a>21.5.3、官网新人文档中的资源目录介绍</h5><p><img src="/2021/03/15/springcloud/192.png" alt="在这里插入图片描述"></p>
<p><strong>详细说明</strong></p>
<p><img src="/2021/03/15/springcloud/193.png" alt="在这里插入图片描述"></p>
<h5 id="21-5-4、Seata-Server-端配置"><a href="#21-5-4、Seata-Server-端配置" class="headerlink" title="21.5.4、Seata Server 端配置"></a>21.5.4、Seata Server 端配置</h5><h6 id="21-5-4-1、解压"><a href="#21-5-4-1、解压" class="headerlink" title="21.5.4.1、解压"></a>21.5.4.1、解压</h6><p>将下载的 <strong><code>seata-server-1.2.0.zip</code></strong> 解压到某个路径下（注意该路径不要有中文或空格）。</p>
<h6 id="21-5-4-2、MySQL-数据库配置"><a href="#21-5-4-2、MySQL-数据库配置" class="headerlink" title="21.5.4.2、MySQL 数据库配置"></a>21.5.4.2、MySQL 数据库配置</h6><p>1、执行MySQL数据库操作前，需要我们手动创建一个名称为 <strong><code>seata</code></strong> 的数据库，然后在该数据库下建表。建库命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/15/springcloud/194.png" alt="image-20210314232019841"></p>
<p>进入 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/1.2.0/script">资源目录</a> <strong><code>seata/script/server/db/mysql.sql</code></strong> ，执行SQL语句。建表语句如下，你也可以点击链接获取。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`global_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`xid`</span>                       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`transaction_id`</span>            <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`status`</span>                    <span class="built_in">TINYINT</span>      <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`application_id`</span>            <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    <span class="string">`transaction_service_group`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    <span class="string">`transaction_name`</span>          <span class="built_in">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    <span class="string">`timeout`</span>                   <span class="built_in">INT</span>,</span><br><span class="line">    <span class="string">`begin_time`</span>                <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`application_data`</span>          <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    <span class="string">`gmt_create`</span>                DATETIME,</span><br><span class="line">    <span class="string">`gmt_modified`</span>              DATETIME,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`xid`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_gmt_modified_status`</span> (<span class="string">`gmt_modified`</span>, <span class="string">`status`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_transaction_id`</span> (<span class="string">`transaction_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`branch_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`branch_id`</span>         <span class="built_in">BIGINT</span>       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`xid`</span>               <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`transaction_id`</span>    <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`resource_group_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    <span class="string">`resource_id`</span>       <span class="built_in">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    <span class="string">`branch_type`</span>       <span class="built_in">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    <span class="string">`status`</span>            <span class="built_in">TINYINT</span>,</span><br><span class="line">    <span class="string">`client_id`</span>         <span class="built_in">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="string">`application_data`</span>  <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    <span class="string">`gmt_create`</span>        DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="string">`gmt_modified`</span>      DATETIME(<span class="number">6</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`branch_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_xid`</span> (<span class="string">`xid`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`lock_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`row_key`</span>        <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`xid`</span>            <span class="built_in">VARCHAR</span>(<span class="number">96</span>),</span><br><span class="line">    <span class="string">`transaction_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`branch_id`</span>      <span class="built_in">BIGINT</span>       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`resource_id`</span>    <span class="built_in">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    <span class="string">`table_name`</span>     <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    <span class="string">`pk`</span>             <span class="built_in">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    <span class="string">`gmt_create`</span>     DATETIME,</span><br><span class="line">    <span class="string">`gmt_modified`</span>   DATETIME,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`row_key`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_branch_id`</span> (<span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/15/springcloud/195.png" alt="在这里插入图片描述"></p>
<h6 id="21-5-4-3、Server端参数项配置"><a href="#21-5-4-3、Server端参数项配置" class="headerlink" title="21.5.4.3、Server端参数项配置"></a>21.5.4.3、Server端参数项配置</h6><p>解压后，进入 <strong><code>conf</code></strong> 目录开始参数的配置。我们修改 <strong><code>file.conf</code></strong> 和 <strong><code>registry.conf</code></strong> 这两个文件。</p>
<p><img src="/2021/03/15/springcloud/196.png" alt="在这里插入图片描述"></p>
<ol>
<li><p><strong>对 file.conf 配置：</strong></p>
<p><img src="/2021/03/15/springcloud/197.png" alt="在这里插入图片描述"></p>
</li>
<li><p><strong>对 registry.conf 配置：</strong></p>
<p><img src="/2021/03/15/springcloud/198.png" alt="在这里插入图片描述"></p>
</li>
</ol>
<h6 id="21-5-4-4、启动Seata-Server端"><a href="#21-5-4-4、启动Seata-Server端" class="headerlink" title="21.5.4.4、启动Seata Server端"></a>21.5.4.4、启动Seata Server端</h6><p>进入 bin 目录，双击 <strong><code>seata-server.bat</code></strong> 启动。（Linux环境请选择 seata-server.sh 启动）</p>
<p><img src="/2021/03/15/springcloud/199.png" alt="在这里插入图片描述"></p>
<p>到此为止，Seata Server 端启动完成。</p>
<h4 id="21-5-5、config-center-配置中心配置"><a href="#21-5-5、config-center-配置中心配置" class="headerlink" title="21.5.5、config-center 配置中心配置"></a>21.5.5、config-center 配置中心配置</h4><p>配置中心的配置，本文使用 nacos 作为配置中心。</p>
<h6 id="21-5-5-1、获取要配置的参数信息"><a href="#21-5-5-1、获取要配置的参数信息" class="headerlink" title="21.5.5.1、获取要配置的参数信息"></a>21.5.5.1、获取要配置的参数信息</h6><p>进入 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/1.2.0/script">资源目录</a> <strong><code>seata/script/config-center/config.txt</code></strong> ，展示的是 Seata 1.2.0 版本所有配置中心的内容，全部配置点击链接查看。本文使用db方式，故选择db相关配置，需要用到的配置如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service.vgroupMapping.my_test_tx_group=default  </span><br><span class="line">service.default.grouplist=127.0.0.1:8091</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disableGlobalTransaction=false</span><br><span class="line">store.mode=db  /*此处修改为db*/</span><br><span class="line">store.db.datasource=druid</span><br><span class="line">store.db.dbType=mysql</span><br><span class="line">store.db.driverClassName=com.mysql.jdbc.Driver  /*自定义修改*/</span><br><span class="line">store.db.url=jdbc:mysql://192.168.204.201:3306/seata?useUnicode=true /*自定义修改*/</span><br><span class="line">store.db.user=root  /*自定义修改*/</span><br><span class="line">store.db.password=root  /*自定义修改*/</span><br><span class="line">store.db.minConn=5</span><br><span class="line">store.db.maxConn=30</span><br><span class="line">store.db.globalTable=global_table</span><br><span class="line">store.db.branchTable=branch_table</span><br><span class="line">store.db.queryLimit=100</span><br><span class="line">store.db.lockTable=lock_table</span><br><span class="line">store.db.maxWait=5000</span><br></pre></td></tr></table></figure>

<h6 id="21-5-5-2、将参数配置到Nacos配置中心"><a href="#21-5-5-2、将参数配置到Nacos配置中心" class="headerlink" title="21.5.5.2、将参数配置到Nacos配置中心"></a>21.5.5.2、将参数配置到Nacos配置中心</h6><p>进入 资源目录 seata/script/config-center/nacos/nacos-config.sh ，该配置会将 seata 相关配置批量添加到 nacos 服务器。</p>
<p>该脚本可以随便放在某个位置，只要脚本 nacos-config.sh 能够读取到 config.txt 文件即可。本文放在如下为止</p>
<p><img src="/2021/03/15/springcloud/200.png" alt="在这里插入图片描述"></p>
<p>你自己打开<code>nacos-config.sh</code>脚本 看看它查找 config.txt 的逻辑就可以了，只要能够读取到 config.txt 文件即可。nacos-config.sh 脚本支持传入<code>四个参数</code>：</p>
<ul>
<li>-h nacos 所在服务器的IP地址，默认为 localhost</li>
<li>-p nacos 端口号，默认为 8848</li>
<li>-g nacos 配置所属 group 名称，默认为 SEATA_GROUP</li>
<li>-t 将 nacos 配置保存到指定的命名空间，默认为 “”，代表 public 命名空间（注意：-t 参数值接收的是 命名空间ID，不是 命名空间名称） </li>
</ul>
<p>使用 <strong>git 命令框</strong> 执行 <strong><code>sh nacos-config.sh</code></strong> ，就可以将配置批量保存到 nacos 服务器。如下图所示：</p>
<p><img src="/2021/03/15/springcloud/201.gif" alt="在这里插入图片描述"></p>
<p>到此为止，Config Center 配置中心参数，配置完成。</p>
<h4 id="21-5-6、client-客户端配置"><a href="#21-5-6、client-客户端配置" class="headerlink" title="21.5.6、client 客户端配置"></a>21.5.6、client 客户端配置</h4><h5 id="21-5-6-1、业务场景"><a href="#21-5-6-1、业务场景" class="headerlink" title="21.5.6.1、业务场景"></a>21.5.6.1、业务场景</h5><p>用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：</p>
<ul>
<li>订单服务A：根据采购需求创建订单。</li>
<li>仓储服务B：对给定的商品扣除仓储数量。</li>
<li>帐户服务C：从用户帐户中扣除余额。</li>
</ul>
<p>用户A购买商品，调用<code>A服务</code>创建订单完成，调用<code>B服务</code>扣减库存，然后调用<code>C服务</code>扣减账户余额。<strong>每个服务内部的数据一致性由本地事务来保证，多个服务调用来完成业务，全局事务数据一致性则由 Seata 来保证。</strong></p>
<h5 id="21-5-6-2、业务数据库准备"><a href="#21-5-6-2、业务数据库准备" class="headerlink" title="21.5.6.2、业务数据库准备"></a>21.5.6.2、业务数据库准备</h5><p>配置三个业务分别对应各自的数据库。</p>
<ul>
<li>A服务 对应数据库：seata_order ；表：t_order</li>
<li>B服务 对应数据库：seata_storage ；表：t_storage</li>
<li>C服务 对应数据库：seata_account ；表：t_account</li>
</ul>
<p><strong>建库，建表语句如下：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建seata_order数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_order;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建t_order表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seata_order.t_order(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    <span class="string">`product_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">    <span class="string">`count`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">    <span class="string">`money`</span> <span class="built_in">DECIMAL</span>(<span class="number">11</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">INT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;订单状态：0：创建中; 1：已完结&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">7</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建seata_storage数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_storage;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建t_storage表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seata_storage.t_storage(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="string">`product_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">    <span class="string">`total`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;总库存&#x27;</span>,</span><br><span class="line">    <span class="string">`used`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;已用库存&#x27;</span>,</span><br><span class="line">    <span class="string">`residue`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;剩余库存&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入一条数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_storage.t_storage(<span class="string">`id`</span>,<span class="string">`product_id`</span>,<span class="string">`total`</span>,<span class="string">`used`</span>,<span class="string">`residue`</span>)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;100&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建seata_account数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_account;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建t_account表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seata_account.t_account(</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    <span class="string">`total`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;总额度&#x27;</span>,</span><br><span class="line">    <span class="string">`used`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;已用余额&#x27;</span>,</span><br><span class="line">    <span class="string">`residue`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;剩余可用额度&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入一条数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_account.t_account(<span class="string">`id`</span>,<span class="string">`user_id`</span>,<span class="string">`total`</span>,<span class="string">`used`</span>,<span class="string">`residue`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1000&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="21-5-6-3、创建-undo-log-表"><a href="#21-5-6-3、创建-undo-log-表" class="headerlink" title="21.5.6.3、创建 undo_log 表"></a>21.5.6.3、创建 undo_log 表</h5><p>进入 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/1.2.0/script">资源目录</a> <strong><code>seata/script/client/at/db/mysql.sql</code></strong> ，展示的就是 undo_log 表的建表语句，该表需要在涉及到事务处理的每个库中都添加以下。undo_log 表建表语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`undo_log`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>            <span class="built_in">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;increment id&#x27;</span>,</span><br><span class="line">    <span class="string">`branch_id`</span>     <span class="built_in">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;branch transaction id&#x27;</span>,</span><br><span class="line">    <span class="string">`xid`</span>           <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;global transaction id&#x27;</span>,</span><br><span class="line">    <span class="string">`context`</span>       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;undo_log context,such as serialization&#x27;</span>,</span><br><span class="line">    <span class="string">`rollback_info`</span> LONGBLOB     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;rollback info&#x27;</span>,</span><br><span class="line">    <span class="string">`log_status`</span>    <span class="built_in">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:normal status,1:defense status&#x27;</span>,</span><br><span class="line">    <span class="string">`log_created`</span>   DATETIME     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;create datetime&#x27;</span>,</span><br><span class="line">    <span class="string">`log_modified`</span>  DATETIME     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;modify datetime&#x27;</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>, <span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  AUTO_INCREMENT = <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> =<span class="string">&#x27;AT transaction mode undo table&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="21-5-6-4、库表创建完成图示"><a href="#21-5-6-4、库表创建完成图示" class="headerlink" title="21.5.6.4、库表创建完成图示"></a>21.5.6.4、库表创建完成图示</h5><p><img src="/2021/03/15/springcloud/202.png" alt="在这里插入图片描述"></p>
<h5 id="21-5-6-5、添加-pom-依赖"><a href="#21-5-6-5、添加-pom-依赖" class="headerlink" title="21.5.6.5、添加 pom 依赖"></a>21.5.6.5、添加 pom 依赖</h5><p>pom.xml 部分的注意事项，可参考：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html">部署指南-注意事项</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="21-5-6-7、application-yml-针对-seata-进行配置"><a href="#21-5-6-7、application-yml-针对-seata-进行配置" class="headerlink" title="21.5.6.7、application.yml 针对 seata 进行配置"></a>21.5.6.7、application.yml 针对 seata 进行配置</h5><p>进入<a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/1.2.0/script">资源目录</a><code>seata/script/client/spring/</code>，展示的就是 seata 整合 Spring 的全部配置内容，提供了<code>.properties</code>、<code>.yml</code>两种格式的配置。详细的配置项还挺多，此处就不粘贴了，你可以点击 资源目录 查看。此处挑选了本案例需要的部分内容进行配置，配置如下所示：（项目application.yml完整配置，请参考文末项目完整代码）</p>
<p><code>该配置在每个服务模块都需要配置一份</code>，你也可以通过 nacos 配置中心的方式配置使用。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">my_test_tx_group</span></span><br><span class="line">  <span class="attr">enable-auto-data-source-proxy:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="attr">my_test_tx_group:</span> <span class="string">default</span>  <span class="comment"># 此处key需要与tx-service-group的value一致，否则会报 no available service &#x27;null&#x27; found, please make sure registry config correct 异常</span></span><br><span class="line">    <span class="attr">grouplist:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.113</span><span class="string">:8091</span></span><br><span class="line">    <span class="attr">enable-degrade:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">disable-global-transaction:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">serverAddr:</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.113</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">userName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span>  <span class="comment"># 此处名称需和 seata server 服务端 application一致,否则会报 no available service &#x27;null&#x27; found, please make sure registry config correct 异常</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.113</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">userName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>业务代码略</p>
<h4 id="21-5-7、Seata-高可用集群部署"><a href="#21-5-7、Seata-高可用集群部署" class="headerlink" title="21.5.7、Seata 高可用集群部署"></a>21.5.7、Seata 高可用集群部署</h4><h5 id="21-5-7-1、集群部署"><a href="#21-5-7-1、集群部署" class="headerlink" title="21.5.7.1、集群部署"></a>21.5.7.1、集群部署</h5><p>Seata 集群部署比较简单，只需将已配置好的 seata-server 再启动一个即可。seata 默认使用 8091 端口，此次我在 Windows 部署，所以 seata-server 第二个节点选用 8092 端口，进入 cmd 命令行，使用命令：<code>seata-server.bat -p 8092</code>启动seata-server 第二台节点。(Linux 正式环境，多机器的话，只需要 scp 到另一台机器，启动即可)</p>
<p>通过 nacos 服务列表，seata-server 实例数由 1 变为 2。端口分别为 8091、8092 。集群搭建完成，挺简单的。想要几个节点就来几个节点，so easy。<br><img src="/2021/03/15/springcloud/203.gif" alt="在这里插入图片描述"></p>
<h5 id="21-5-7-2、服务注册成功"><a href="#21-5-7-2、服务注册成功" class="headerlink" title="21.5.7.2、服务注册成功"></a>21.5.7.2、服务注册成功</h5><p>3个服务启动成功后，均会通过 RPC 的方式注册到 Seata 集群的两个节点上来，如下图所示：</p>
<p><img src="/2021/03/15/springcloud/204.png" alt="在这里插入图片描述"></p>
<h5 id="21-5-7-3、Seata集群测试"><a href="#21-5-7-3、Seata集群测试" class="headerlink" title="21.5.7.3、Seata集群测试"></a>21.5.7.3、Seata集群测试</h5><p>使用 postman 发送 50 个请求，中途关闭 8091 节点。由于集群之间通过 Nacos 通信原因，一个节点的突然宕机，会导致部分请求失败，但是服务很快便会恢复正常。</p>
<p>当再次将 8091 节点启动后，服务还是能够正常请求，8091 节点也有事务相应的日志显示，说明Seata 集群能够正常提供服务。测试如图所示：<br><img src="/2021/03/15/springcloud/205.gif" alt="在这里插入图片描述"></p>
<h4 id="21-5-8、全局事务服务-GTS-阿里云"><a href="#21-5-8、全局事务服务-GTS-阿里云" class="headerlink" title="21.5.8、全局事务服务 GTS-阿里云"></a>21.5.8、全局事务服务 GTS-阿里云</h4><h5 id="21-5-8-1、是什么"><a href="#21-5-8-1、是什么" class="headerlink" title="21.5.8.1、是什么"></a>21.5.8.1、是什么</h5><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/48444.html">官网</a></p>
<p>全局事务服务（Global Transaction Service，简称 GTS）是一款高性能、高可靠、接入简单的分布式事务中间件，用于解决分布式环境下的事务一致性问题。 在单机数据库下很容易维持事务的 ACID（Atomicity、Consistency、Isolation、Durability）特性，但在分布式系统中并不容易，GTS 可以保证分布式系统中的分布式事务的 ACID 特性。 GTS 支持 DRDS、RDS、MySQL 等多种数据源，可以配合 EDAS 和 Dubbo 等微服务框架使用， 兼容 MQ 实现事务消息。通过各种组合，可以轻松实现分布式数据库事务、多库事务、消息事务、服务链路级事务等多种业务需求。</p>
<h5 id="21-5-8-2、GTS与Seata"><a href="#21-5-8-2、GTS与Seata" class="headerlink" title="21.5.8.2、GTS与Seata"></a>21.5.8.2、GTS与Seata</h5><ul>
<li>Seata：开源框架</li>
<li>GTS：付费的商用框架</li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>XGH_little-star
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://xgh-user.github.io/2021/03/15/springcloud/" title="SpringCloud">http://xgh-user.github.io/2021/03/15/springcloud/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/springcloud/" rel="tag"># springcloud</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/11/23/springboot%E9%A1%B9%E7%9B%AE%E6%89%93%E6%88%90jar%E5%8C%85%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E5%9C%A8linux%E4%B8%8A/" rel="prev" title="springboot项目打成jar包后台运行在linux上">
      <i class="fa fa-chevron-left"></i> springboot项目打成jar包后台运行在linux上
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/05/%E6%A6%82%E7%8E%87%E8%AE%BA%E4%B8%8E%E6%95%B0%E7%90%86%E9%80%BB%E8%BE%91/" rel="next" title="">
       <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud"><span class="nav-number">1.</span> <span class="nav-text">SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.</span> <span class="nav-text">微服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">1、微服务架构概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%BC%96%E7%A0%81%E6%9E%84%E5%BB%BA"><span class="nav-number">1.1.2.</span> <span class="nav-text">2、微服务架构编码构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81SpringCloud%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.3.</span> <span class="nav-text">3、SpringCloud简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81SpringCloud%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">1.1.4.</span> <span class="nav-text">4、SpringCloud技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="nav-number">1.1.5.</span> <span class="nav-text">5、版本选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.6.</span> <span class="nav-text">6、访问方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.2.</span> <span class="nav-text">注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E3%80%81Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.2.1.</span> <span class="nav-text">7、Eureka注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1%E3%80%81Eureka%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">7.1、Eureka基础知识：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2%E3%80%81%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">7.2、工作流程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">7.3、集群搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4%E3%80%81eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">7.4、eureka自我保护</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8%E3%80%81Zookeeper%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.2.2.</span> <span class="nav-text">8、Zookeeper注册中心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9%E3%80%81Consul%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.2.3.</span> <span class="nav-text">9、Consul注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFconsul"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">9.1、什么是consul</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2%E3%80%81%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">9.2、功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-3%E3%80%81%E4%BE%9D%E8%B5%96%E5%AF%BC%E5%85%A5"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">9.3、依赖导入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10%E3%80%81%E4%B8%89%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%BC%82%E5%90%8C%E7%82%B9"><span class="nav-number">1.2.4.</span> <span class="nav-text">10、三个注册中心异同点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11%E3%80%81Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E7%94%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">11、Ribbon负载均衡调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">11.1、是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2%E3%80%81%E4%BD%9C%E7%94%A8%EF%BC%88%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-RestTemplate%E8%B0%83%E7%94%A8%EF%BC%89"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">11.2、作用（负载均衡+RestTemplate调用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-3%E3%80%81%E6%A1%86%E6%9E%B6%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">11.3、框架说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4%E3%80%81Ribbon%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6IRule"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">11.4、Ribbon核心组件IRule</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#11-4-1%E3%80%81IRule%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.3.1.4.1.</span> <span class="nav-text">11.4.1、IRule是什么</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#11-4-2%E3%80%81%E6%9B%BF%E6%8D%A2%EF%BC%9A"><span class="nav-number">1.3.1.4.2.</span> <span class="nav-text">11.4.2、替换：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#11-4-3%E3%80%81Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.1.4.3.</span> <span class="nav-text">11.4.3、Ribbon负载均衡算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12%E3%80%81OenFeign"><span class="nav-number">1.3.2.</span> <span class="nav-text">12、OenFeign</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">12.1、是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-2%E3%80%81%E4%BD%9C%E7%94%A8%EF%BC%9A"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">12.2、作用：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-3%E3%80%81Feign%E5%92%8COpenFeign%E4%B8%A4%E8%80%85%E5%8C%BA%E5%88%AB"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">12.3、Feign和OpenFeign两者区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-4%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">12.4、使用步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5%E3%80%81OpenFeign%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">12.5、OpenFeign超时控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#12-5-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.3.2.5.1.</span> <span class="nav-text">12.5.1、是什么？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-5-2%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-OpenFeign%E9%BB%98%E8%AE%A4%E6%94%AF%E6%8C%81Ribbon"><span class="nav-number">1.3.2.5.2.</span> <span class="nav-text">12.5.2、解决方法(OpenFeign默认支持Ribbon)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6%E3%80%81OpenFeign%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%8A%9F%E8%83%BD"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">12.6、OpenFeign日志打印功能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#12-6-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.3.2.6.1.</span> <span class="nav-text">12.6.1、是什么？</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-number">1.4.</span> <span class="nav-text">熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13%E3%80%81Hystrix%E7%86%94%E6%96%AD%E5%99%A8%EF%BC%88%E8%B1%AA%E7%8C%AA%E5%93%A5%EF%BC%89"><span class="nav-number">1.4.1.</span> <span class="nav-text">13、Hystrix熔断器（豪猪哥）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">13.1、分布式系统面临的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2%E3%80%81Hystrix%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">13.2、Hystrix是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3%E3%80%81%E4%BD%9C%E7%94%A8"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">13.3、作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-4%E3%80%81HyStrix%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">13.4、HyStrix重要概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-4-1%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-number">1.4.1.4.1.</span> <span class="nav-text">13.4.1、服务降级</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-4-2%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-number">1.4.1.4.2.</span> <span class="nav-text">13.4.2、服务熔断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-4-3%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="nav-number">1.4.1.4.3.</span> <span class="nav-text">12.4.3、服务限流</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-5%E3%80%81%E4%BE%9D%E8%B5%96"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">13.5、依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-6%E3%80%81%E9%AB%98%E5%8E%8B%E8%AE%BF%E9%97%AE%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">13.6、高压访问的解决方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-7%E3%80%81%E8%AE%BF%E9%97%AE%E9%99%8D%E7%BA%A7"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">13.7、访问降级</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-7-1%E3%80%81%E5%AF%B9%E4%BA%8E%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E6%96%B9%EF%BC%9A"><span class="nav-number">1.4.1.7.1.</span> <span class="nav-text">13.7.1、对于服务提供方：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-7-2%E3%80%81%E5%AF%B9%E4%BA%8E%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E6%96%B9%EF%BC%9A"><span class="nav-number">1.4.1.7.2.</span> <span class="nav-text">13.7.2、对于服务消费方：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-7-3%E3%80%81%E7%9B%AE%E5%89%8D%E9%97%AE%E9%A2%98"><span class="nav-number">1.4.1.7.3.</span> <span class="nav-text">13.7.3、目前问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-8%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-number">1.4.1.8.</span> <span class="nav-text">13.8、服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-8-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.4.1.8.1.</span> <span class="nav-text">13.8.1、是什么？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-8-2%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E7%9A%84%E6%B3%A8%E8%A7%A3-HystrixCommand-Service%E5%B1%82"><span class="nav-number">1.4.1.8.2.</span> <span class="nav-text">12.8.2、服务熔断的注解@HystrixCommand(Service层)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-8-3%E3%80%81%E5%A4%A7%E7%A5%9E%E7%BB%93%E8%AE%BA"><span class="nav-number">1.4.1.8.3.</span> <span class="nav-text">12.8.3、大神结论</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-8-4%E3%80%81%E6%96%AD%E8%B7%AF%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.4.1.8.4.</span> <span class="nav-text">12.8.4、断路流程图</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-9%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="nav-number">1.4.1.9.</span> <span class="nav-text">13.9、服务限流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-10%E3%80%81Hystrix%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.1.10.</span> <span class="nav-text">13.10、Hystrix的工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-11%E3%80%81%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7hystrixDashboard"><span class="nav-number">1.4.1.11.</span> <span class="nav-text">13.11、服务监控hystrixDashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-11-1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-number">1.4.1.11.1.</span> <span class="nav-text">13.11.1、概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-11-2%E3%80%81%E4%BE%9D%E8%B5%96"><span class="nav-number">1.4.1.11.2.</span> <span class="nav-text">13.11.2、依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-11-3%E3%80%81%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.4.1.11.3.</span> <span class="nav-text">13.11.3、步骤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-11-4%E3%80%81%E6%96%AD%E8%B7%AF%E5%99%A8%E6%BC%94%E7%A4%BA-%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7hystrixDashboard"><span class="nav-number">1.4.1.11.4.</span> <span class="nav-text">13.11.4、断路器演示(服务监控hystrixDashboard)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-11-5%E3%80%81%E5%A6%82%E4%BD%95%E7%9C%8BhystrixDashboard%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E5%9B%BE"><span class="nav-number">1.4.1.11.5.</span> <span class="nav-text">13.11.5、如何看hystrixDashboard服务监控图</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%BD%91%E5%85%B3"><span class="nav-number">1.5.</span> <span class="nav-text">路由网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14%E3%80%81Gateway%E6%96%B0%E4%B8%80%E4%BB%A3%E7%BD%91%E5%85%B3"><span class="nav-number">1.5.1.</span> <span class="nav-text">14、Gateway新一代网关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#14-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">14.1、是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-2%E3%80%81%E4%BD%9C%E7%94%A8"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">14.2、作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%BD%91%E5%85%B3%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">14.3、微服务架构中网关在哪里</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-4%E3%80%81Zool%E4%B8%8EGateway"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">14.4、Zool与Gateway</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-5%E3%80%81%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.5.1.5.</span> <span class="nav-text">14.5、三大核心概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-6%E3%80%81Gateway%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%88%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91-%E6%89%A7%E8%A1%8C%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%EF%BC%89"><span class="nav-number">1.5.1.6.</span> <span class="nav-text">14.6、Gateway工作流程（路由转发+执行过滤器链）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-7%E3%80%81%E4%BE%9D%E8%B5%96"><span class="nav-number">1.5.1.7.</span> <span class="nav-text">14.7、依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-8%E3%80%81Gateway%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1%E6%9C%89%E4%B8%A4%E7%A7%8D%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.1.8.</span> <span class="nav-text">14.8、Gateway网关路由有两种配置方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-9%E3%80%81%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E5%90%8D%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81"><span class="nav-number">1.5.1.9.</span> <span class="nav-text">14.9、通过服务名实现动态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-10%E3%80%81Predicate%EF%BC%88%E6%96%AD%E8%A8%80%EF%BC%89"><span class="nav-number">1.5.1.10.</span> <span class="nav-text">14.10、Predicate（断言）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-11%E3%80%81Filter%EF%BC%88%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.1.11.</span> <span class="nav-text">14.11、Filter（过滤器）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#14-11-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.5.1.11.1.</span> <span class="nav-text">14.11.1、是什么？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#14-11-2%E3%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.5.1.11.2.</span> <span class="nav-text">14.11.2、生命周期</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#14-11-3%E3%80%81%E7%A7%8D%E7%B1%BB"><span class="nav-number">1.5.1.11.3.</span> <span class="nav-text">14.11.3、种类</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.6.</span> <span class="nav-text">分布式配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#15%E3%80%81SpringCloud-config"><span class="nav-number">1.6.1.</span> <span class="nav-text">15、SpringCloud config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#15-1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">15.1、分布式系统面临的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-2%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9A"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">15.2、是什么：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-3%E3%80%81%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9A"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">15.3、怎么用：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-4%E3%80%81%E4%BD%9C%E7%94%A8"><span class="nav-number">1.6.1.4.</span> <span class="nav-text">15.4、作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-5%E3%80%81%E4%B8%8EGitHub%E6%95%B4%E5%90%88%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.1.5.</span> <span class="nav-text">15.5、与GitHub整合配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-6%E3%80%81bootstrap-yml%E4%B8%8Eapplication-yml"><span class="nav-number">1.6.1.6.</span> <span class="nav-text">15.6、bootstrap.yml与application.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-7%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.1.7.</span> <span class="nav-text">15.7、分布式配置的动态刷新问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-8%E3%80%81%E6%AE%8B%E7%95%99%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.1.8.</span> <span class="nav-text">15.8、残留问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF"><span class="nav-number">1.7.</span> <span class="nav-text">消息总线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#16%E3%80%81SpringCloud-Bus"><span class="nav-number">1.7.1.</span> <span class="nav-text">16、SpringCloud Bus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#16-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">16.1、是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-2%E3%80%81%E4%BD%9C%E7%94%A8"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">16.2、作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-3%E3%80%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">16.3、基本原理与执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-4%E3%80%81Bus%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="nav-number">1.7.1.4.</span> <span class="nav-text">16.4、Bus的两种设计思想</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-5%E3%80%81Bus-%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%85%A8%E5%B1%80%E5%B9%BF%E6%92%AD%E9%85%8D%E7%BD%AE"><span class="nav-number">1.7.1.5.</span> <span class="nav-text">16.5、Bus 动态刷新全局广播配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-6%E3%80%81Bus-%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%AE%9A%E7%82%B9%E9%80%9A%E7%9F%A5%E9%85%8D%E7%BD%AE"><span class="nav-number">1.7.1.6.</span> <span class="nav-text">16.6、Bus 动态刷新定点通知配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="nav-number">1.8.</span> <span class="nav-text">消息驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17%E3%80%81Spring-Cloud-Stream%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="nav-number">1.8.1.</span> <span class="nav-text">17、Spring Cloud Stream消息驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#17-1%E3%80%81%E7%9B%AE%E5%89%8D%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">17.1、目前微服务面临的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-2%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">17.2、是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-3%E3%80%81%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">17.3、设计思想</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#17-3-1%E3%80%81%E6%A0%87%E5%BF%97MQ"><span class="nav-number">1.8.1.3.1.</span> <span class="nav-text">17.3.1、标志MQ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#17-3-2%E3%80%81Spring-Cloud-Stream"><span class="nav-number">1.8.1.3.2.</span> <span class="nav-text">17.3.2、Spring Cloud Stream</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-4%E3%80%81Spring-Cloud-Stream%E5%A6%82%E4%BD%95%E7%BB%9F%E4%B8%80%E5%BA%95%E5%B1%82%E5%B7%AE%E5%BC%82"><span class="nav-number">1.8.1.4.</span> <span class="nav-text">17.4、Spring Cloud Stream如何统一底层差异</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-5%E3%80%81Binder"><span class="nav-number">1.8.1.5.</span> <span class="nav-text">17.5、Binder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-6%E3%80%81Spring-Cloud-Stream-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.8.1.6.</span> <span class="nav-text">17.6、Spring Cloud Stream 执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-7%E3%80%81%E7%BC%96%E7%A0%81API%E5%92%8C%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.8.1.7.</span> <span class="nav-text">17.7、编码API和常用注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-8%E3%80%81%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BB%A3%E7%A0%81"><span class="nav-number">1.8.1.8.</span> <span class="nav-text">17.8、详细配置与代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#17-9%E3%80%81Stream-%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9-%E6%8C%81%E4%B9%85%E5%8C%96%E9%97%AE%E9%A2%98"><span class="nav-number">1.8.1.9.</span> <span class="nav-text">17.9、Stream 重复消费&#x2F;持久化问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#17-9-1%E3%80%81%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="nav-number">1.8.1.9.1.</span> <span class="nav-text">17.9.1、重复消费问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#17-9-2%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E9%97%AE%E9%A2%98"><span class="nav-number">1.8.1.9.2.</span> <span class="nav-text">17.9.2、持久化问题</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="nav-number">1.9.</span> <span class="nav-text">分布式链路追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#18%E3%80%81Spring-Cloud-Sleuth-Zipkin-%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="nav-number">1.9.1.</span> <span class="nav-text">18、Spring Cloud Sleuth + Zipkin 分布式链路追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#18-1%E3%80%81%E7%9B%AE%E5%89%8D%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">18.1、目前微服务面临的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#18-2%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">18.2、是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#18-3%E3%80%81%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">18.3、调用结构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#18-4%E3%80%81%E6%90%AD%E5%BB%BA%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.9.1.4.</span> <span class="nav-text">18.4、搭建链路监控步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#18-4-1%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.9.1.4.1.</span> <span class="nav-text">18.4.1、环境准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#18-4-2%E3%80%81Sleuth%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.9.1.4.2.</span> <span class="nav-text">18.4.2、Sleuth测试环境搭建</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Alibaba"><span class="nav-number">1.10.</span> <span class="nav-text">Spring Cloud Alibaba</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E7%BB%B4%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.10.0.1.</span> <span class="nav-text">1、什么是维护模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81Spring-Cloud-Alibaba"><span class="nav-number">1.10.0.2.</span> <span class="nav-text">2、Spring Cloud Alibaba</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1%E3%80%81Spring-Cloud-Alibaba%E5%8C%85%E5%90%AB%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="nav-number">1.10.0.2.1.</span> <span class="nav-text">2.1、Spring Cloud Alibaba包含的组件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2%E3%80%81%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">1.10.0.2.2.</span> <span class="nav-text">2.2、主要功能</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%AD%A6%E4%B9%A0%E7%BB%84%E4%BB%B6"><span class="nav-number">1.10.0.3.</span> <span class="nav-text">3、学习组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%AE%98%E7%BD%91%E8%B5%84%E6%96%99"><span class="nav-number">1.10.0.4.</span> <span class="nav-text">4、官网资料</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19%E3%80%81Spring-Cloud-Alibaba-Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%B8%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.10.1.</span> <span class="nav-text">19、Spring Cloud Alibaba Nacos服务注册中心与配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#19-1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-Nacos"><span class="nav-number">1.10.1.1.</span> <span class="nav-text">19.1、什么是 Nacos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-2%E3%80%81%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="nav-number">1.10.1.2.</span> <span class="nav-text">19.2、能干嘛</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-3%E3%80%81Nacos-%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C"><span class="nav-number">1.10.1.3.</span> <span class="nav-text">19.3、Nacos 安装运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-4%E3%80%81Nacos%E4%B8%8E%E5%85%B6%E4%BB%96%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94"><span class="nav-number">1.10.1.4.</span> <span class="nav-text">19.4、Nacos与其他注册中心对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-5%E3%80%81Nacos%E7%94%A8%E4%BD%9C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.10.1.5.</span> <span class="nav-text">19.5、Nacos用作服务注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-6%E3%80%81Nacos%E7%94%A8%E4%BD%9C%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.10.1.6.</span> <span class="nav-text">19.6、Nacos用作服务配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#19-6-1%E3%80%81Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E2%80%93%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.1.6.1.</span> <span class="nav-text">19.6.1、Nacos作为配置中心–基础配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-6-2%E3%80%81dataId-%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99"><span class="nav-number">1.10.1.6.2.</span> <span class="nav-text">19.6.2、dataId 命名规则</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-6-3%E3%80%81Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E2%80%93%E5%88%86%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.1.6.3.</span> <span class="nav-text">19.6.3、Nacos作为配置中心–分类配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#19-6-3-1%E3%80%81Nacos%E7%9A%84%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99%E8%AF%B4%E6%98%8E"><span class="nav-number">1.10.1.6.3.1.</span> <span class="nav-text">19.6.3.1、Nacos的命名规则说明</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-6-3-2%E3%80%81%E6%96%B0%E5%BB%BANamespace"><span class="nav-number">1.10.1.6.3.2.</span> <span class="nav-text">19.6.3.2、新建Namespace</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-6-3-3%E3%80%81%E6%96%B0%E5%BB%BA-Group"><span class="nav-number">1.10.1.6.3.3.</span> <span class="nav-text">19.6.3.3、新建 Group</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-6-3-4%E3%80%81%E5%B0%86-namespace-%E5%92%8C-Group-%E5%BA%94%E7%94%A8%E5%88%B0%E9%A1%B9%E7%9B%AE%E4%B8%AD"><span class="nav-number">1.10.1.6.3.4.</span> <span class="nav-text">19.6.3.4、将 namespace 和 Group 应用到项目中</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-6-3-5%E3%80%81%E6%8C%87%E5%AE%9A-namespace-%E5%92%8C-group-%E5%90%8E%EF%BC%8C%E8%AF%BB%E5%8F%96%E7%9A%84%E4%BE%BF%E6%98%AF%E5%AF%B9%E5%BA%94%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="nav-number">1.10.1.6.3.5.</span> <span class="nav-text">19.6.3.5、指定 namespace 和 group 后，读取的便是对应配置内容</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-7%E3%80%81Nacos-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE-Linux-Mysql"><span class="nav-number">1.10.1.7.</span> <span class="nav-text">19.7、Nacos 集群搭建和持久化配置(Linux + Mysql)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#19-7-1%E3%80%81Nacos%E9%9B%86%E7%BE%A4%E5%AE%98%E6%96%B9%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.10.1.7.1.</span> <span class="nav-text">19.7.1、Nacos集群官方架构图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-7-2%E3%80%81Nacos%E9%9B%86%E7%BE%A4%E7%9C%9F%E5%AE%9E%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.10.1.7.2.</span> <span class="nav-text">19.7.2、Nacos集群真实架构图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-7-3%E3%80%81Nacos%E5%9C%A8linux%E4%B8%8B%E5%AE%89%E8%A3%85%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.10.1.7.3.</span> <span class="nav-text">19.7.3、Nacos在linux下安装下载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-7-4%E3%80%81Nacos%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81%EF%BC%88derby-%EF%BC%89"><span class="nav-number">1.10.1.7.4.</span> <span class="nav-text">19.7.4、Nacos数据库支持（derby ）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#19-7-5%E3%80%81Nacos-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%90%AD%E5%BB%BA"><span class="nav-number">1.10.1.7.5.</span> <span class="nav-text">19.7.5、Nacos 集群部署搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-1%E3%80%81%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="nav-number">1.10.1.7.5.1.</span> <span class="nav-text">19.7.5.1、节点部署情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-2%E3%80%81derby-%E5%88%87%E6%8D%A2-mysql-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.1.7.5.2.</span> <span class="nav-text">19.7.5.2、derby 切换 mysql 数据库配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-2%E3%80%81Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%94%B1%E4%BB%96%E4%BD%9C%E4%B8%BA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="nav-number">1.10.1.7.5.3.</span> <span class="nav-text">19.7.5.2、Nginx的配置，由他作为负载均衡器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-3%E3%80%81%E5%90%AF%E5%8A%A8nacos%E9%9B%86%E7%BE%A4"><span class="nav-number">1.10.1.7.5.4.</span> <span class="nav-text">19.7.5.3、启动nacos集群</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-4%E3%80%81%E8%BF%9B%E5%85%A5Nacos%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-number">1.10.1.7.5.5.</span> <span class="nav-text">19.7.5.4、进入Nacos控制台</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-5%E3%80%81%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E6%83%85%E5%86%B5"><span class="nav-number">1.10.1.7.5.6.</span> <span class="nav-text">19.7.5.5、查看集群节点启动情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#19-7-5-6%E3%80%81Nacos%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%EF%BC%8C%E9%A1%B9%E7%9B%AEapplication-yml%E4%B8%ADnacos%E5%9C%B0%E5%9D%80%E9%9C%80%E5%86%99-Nginx-%E5%9C%B0%E5%9D%80"><span class="nav-number">1.10.1.7.5.7.</span> <span class="nav-text">19.7.5.6、Nacos集群环境，项目application.yml中nacos地址需写 Nginx 地址</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20%E3%80%81Sentinel%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="nav-number">1.10.2.</span> <span class="nav-text">20、Sentinel实现服务降级、服务熔断、服务限流</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#20-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.10.2.1.</span> <span class="nav-text">20.1、是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-2%E3%80%81Sentinel%E7%9A%84%E7%89%B9%E5%BE%81"><span class="nav-number">1.10.2.2.</span> <span class="nav-text">20.2、Sentinel的特征</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-3%E3%80%81Sentinel%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.10.2.3.</span> <span class="nav-text">20.3、Sentinel的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-4%E3%80%81%E5%AE%89%E8%A3%85Sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0-Dashboard"><span class="nav-number">1.10.2.4.</span> <span class="nav-text">20.4、安装Sentinel控制台(Dashboard)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-5%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Sentinel"><span class="nav-number">1.10.2.5.</span> <span class="nav-text">20.5、微服务项目整合Sentinel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-6%E3%80%81Spring-Cloud-Alibaba-Sentinel-%E6%B5%81%E6%8E%A7%E3%80%81%E9%99%8D%E7%BA%A7%E3%80%81%E7%83%AD%E7%82%B9%E3%80%81%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="nav-number">1.10.2.6.</span> <span class="nav-text">20.6、Spring Cloud Alibaba Sentinel 流控、降级、热点、系统规则</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#20-6-1%E3%80%81%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="nav-number">1.10.2.6.1.</span> <span class="nav-text">20.6.1、流控规则</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-1%E3%80%81%E9%98%88%E5%80%BC%E7%B1%BB%E5%9E%8B%EF%BC%9AQPS"><span class="nav-number">1.10.2.6.1.1.</span> <span class="nav-text">20.6.1.1、阈值类型：QPS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-2%E3%80%81%E9%98%88%E5%80%BC%E7%B1%BB%E5%9E%8B%EF%BC%9A%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="nav-number">1.10.2.6.1.2.</span> <span class="nav-text">20.6.1.2、阈值类型：线程数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-3%E3%80%81%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%9B%B4%E6%8E%A5"><span class="nav-number">1.10.2.6.1.3.</span> <span class="nav-text">20.6.1.3、流控模式：直接</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-4%E3%80%81%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%85%B3%E8%81%94"><span class="nav-number">1.10.2.6.1.4.</span> <span class="nav-text">20.6.1.4、流控模式：关联</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-5%E3%80%81%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%EF%BC%9A%E9%93%BE%E8%B7%AF"><span class="nav-number">1.10.2.6.1.5.</span> <span class="nav-text">20.6.1.5、流控模式：链路</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-6%E3%80%81%E7%94%A8postman%E8%BF%9B%E8%A1%8C%E5%BE%AA%E7%8E%AF%E8%AE%BF%E9%97%AE"><span class="nav-number">1.10.2.6.1.6.</span> <span class="nav-text">20.6.1.6、用postman进行循环访问</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-7%E3%80%81%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="nav-number">1.10.2.6.1.7.</span> <span class="nav-text">20.6.1.7、流控效果：快速失败</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-8%E3%80%81%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%EF%BC%9AWarm-Up"><span class="nav-number">1.10.2.6.1.8.</span> <span class="nav-text">20.6.1.8、流控效果：Warm Up</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-1-9%E3%80%81%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%EF%BC%9A%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="nav-number">1.10.2.6.1.9.</span> <span class="nav-text">20.6.1.9、流控效果：排队等待</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-6-2%E3%80%81%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="nav-number">1.10.2.6.2.</span> <span class="nav-text">20.6.2、降级规则</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-2-1%E3%80%81%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="nav-number">1.10.2.6.2.1.</span> <span class="nav-text">20.6.2.1、慢调用比例</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-2-2%E3%80%81%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="nav-number">1.10.2.6.2.2.</span> <span class="nav-text">20.6.2.2、异常比例</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-2-3%E3%80%81%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="nav-number">1.10.2.6.2.3.</span> <span class="nav-text">20.6.2.3、异常数</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-6-3%E3%80%81%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-number">1.10.2.6.3.</span> <span class="nav-text">20.6.3、热点规则</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-3-1%E3%80%81%E4%BD%95%E4%B8%BA%E7%83%AD%E7%82%B9%EF%BC%9F"><span class="nav-number">1.10.2.6.3.1.</span> <span class="nav-text">20.6.3.1、何为热点？</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-3-2%E3%80%81%E4%BD%95%E4%B8%BA%E7%83%AD%E7%82%B9%E9%99%90%E6%B5%81"><span class="nav-number">1.10.2.6.3.2.</span> <span class="nav-text">20.6.3.2、何为热点限流</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-3-3%E3%80%81%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-number">1.10.2.6.3.3.</span> <span class="nav-text">20.6.3.3、热点规则</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-6-4%E3%80%81%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%EF%BC%88%E4%B8%8D%E5%B8%B8%E7%94%A8%EF%BC%89"><span class="nav-number">1.10.2.6.4.</span> <span class="nav-text">20.6.4、系统规则（不常用）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-4-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.10.2.6.4.1.</span> <span class="nav-text">20.6.4.1、是什么</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-4-2%E3%80%81%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%E6%94%AF%E6%8C%81%E7%9A%84%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.10.2.6.4.2.</span> <span class="nav-text">20.6.4.2、系统规则支持的模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-4-3%E3%80%81%E5%85%A5%E5%8F%A3QPS%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.2.6.4.3.</span> <span class="nav-text">20.6.4.3、入口QPS配置</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-6-5%E3%80%81-SentinelResource"><span class="nav-number">1.10.2.6.5.</span> <span class="nav-text">20.6.5、@SentinelResource</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-5-1%E3%80%81-SentinelResource-%E5%B1%9E%E6%80%A7%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.10.2.6.5.1.</span> <span class="nav-text">20.6.5.1、@SentinelResource 属性介绍</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-5-2%E3%80%81fallback-%E6%8C%87%E5%AE%9Ajava%E5%BC%82%E5%B8%B8%E5%85%9C%E5%BA%95%E6%96%B9%E6%B3%95"><span class="nav-number">1.10.2.6.5.2.</span> <span class="nav-text">20.6.5.2、fallback 指定java异常兜底方法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-5-3%E3%80%81blockHandler-%E6%8C%87%E5%AE%9A-Sentinel-%E9%85%8D%E7%BD%AE%E5%85%9C%E5%BA%95%E6%96%B9%E6%B3%95"><span class="nav-number">1.10.2.6.5.3.</span> <span class="nav-text">20.6.5.3、blockHandler 指定 Sentinel 配置兜底方法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-5-4%E3%80%81exceptionsToIgnore-%E7%94%A8%E4%BA%8E%E6%8C%87%E5%AE%9A%E5%BC%82%E5%B8%B8%E4%B8%8D%E8%B5%B0%E5%85%9C%E5%BA%95%E6%96%B9%E6%B3%95"><span class="nav-number">1.10.2.6.5.4.</span> <span class="nav-text">20.6.5.4、exceptionsToIgnore 用于指定异常不走兜底方法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20-6-5-5%E3%80%81defaultFallback-%E7%94%A8%E4%BA%8E%E6%8C%87%E5%AE%9A%E9%80%9A%E7%94%A8%E7%9A%84-fallback-%E5%85%9C%E5%BA%95%E6%96%B9%E6%B3%95"><span class="nav-number">1.10.2.6.5.5.</span> <span class="nav-text">20.6.5.5、defaultFallback 用于指定通用的 fallback 兜底方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-7%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-number">1.10.2.7.</span> <span class="nav-text">20.7、服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#20-7-1%E3%80%81Ribbon%E7%B3%BB%E5%88%97"><span class="nav-number">1.10.2.7.1.</span> <span class="nav-text">20.7.1、Ribbon系列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-7-2%E3%80%81OpenFeign%E7%B3%BB%E5%88%97%EF%BC%88Feign%E7%BB%84%E4%BB%B6%E4%B8%80%E8%88%AC%E6%98%AF%E5%9C%A8%E6%B6%88%E8%B4%B9%E8%80%85%E4%BE%A7%EF%BC%89"><span class="nav-number">1.10.2.7.2.</span> <span class="nav-text">20.7.2、OpenFeign系列（Feign组件一般是在消费者侧）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-7-3%E3%80%81%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83"><span class="nav-number">1.10.2.7.3.</span> <span class="nav-text">20.7.3、熔断框架比较</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-8%E3%80%81Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%88%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0Nacos%E6%AF%94%E8%BE%83%E9%B8%A1%E8%82%8B%EF%BC%89"><span class="nav-number">1.10.2.8.</span> <span class="nav-text">20.8、Sentinel 控制台规则持久化（持久化到Nacos比较鸡肋）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#20-8-1%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE%EF%BC%88%E9%B8%A1%E8%82%8B%EF%BC%89"><span class="nav-number">1.10.2.8.1.</span> <span class="nav-text">20.8.1、持久化配置（鸡肋）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#20-8-2%E3%80%81Alibaba-AHAS-%E4%B8%8E-Alibaba-Sentinel"><span class="nav-number">1.10.2.8.2.</span> <span class="nav-text">20.8.2、Alibaba AHAS 与 Alibaba Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#20-8-2-1%E3%80%81AHAS%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9A"><span class="nav-number">1.10.2.8.2.1.</span> <span class="nav-text">20.8.2.1、AHAS是什么：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21%E3%80%81SpringCloud-Alibaba-Seata%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.10.3.</span> <span class="nav-text">21、SpringCloud Alibaba Seata处理分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#21-1%E3%80%81%E7%9B%AE%E5%89%8D%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.10.3.1.</span> <span class="nav-text">21.1、目前微服务面临的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-1-1%E3%80%81-%E7%94%A8%E4%BE%8B"><span class="nav-number">1.10.3.1.1.</span> <span class="nav-text">21.1.1、 用例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-1-2%E3%80%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.10.3.1.2.</span> <span class="nav-text">21.1.2、架构图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-1-3%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.10.3.1.3.</span> <span class="nav-text">21.1.3、分布式事务解决方案</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-2%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.10.3.2.</span> <span class="nav-text">21.2、是什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-3%E3%80%81Seata-%E6%9C%AF%E8%AF%AD%E8%A1%A8"><span class="nav-number">1.10.3.3.</span> <span class="nav-text">21.3、Seata 术语表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-4%E3%80%81AT%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.10.3.4.</span> <span class="nav-text">21.4、AT模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-4-1%E3%80%81AT-%E5%89%8D%E6%8F%90"><span class="nav-number">1.10.3.4.1.</span> <span class="nav-text">21.4.1、AT 前提</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-4-2%E3%80%81AT-%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="nav-number">1.10.3.4.2.</span> <span class="nav-text">21.4.2、AT 整体机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-4-3%E3%80%81%E5%86%99%E9%9A%94%E7%A6%BB"><span class="nav-number">1.10.3.4.3.</span> <span class="nav-text">21.4.3、写隔离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-4-4%E3%80%81%E8%AF%BB%E9%9A%94%E7%A6%BB"><span class="nav-number">1.10.3.4.4.</span> <span class="nav-text">21.4.4、读隔离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-4-5%E3%80%81%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-number">1.10.3.4.5.</span> <span class="nav-text">21.4.5、工作机制</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#21-4-5-1%E3%80%81%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-number">1.10.3.4.5.1.</span> <span class="nav-text">21.4.5.1、一阶段</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-4-5-2%E3%80%81%E4%BA%8C%E9%98%B6%E6%AE%B5-%E5%9B%9E%E6%BB%9A"><span class="nav-number">1.10.3.4.5.2.</span> <span class="nav-text">21.4.5.2、二阶段-回滚</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-4-5-3%E3%80%81%E4%BA%8C%E9%98%B6%E6%AE%B5-%E6%8F%90%E4%BA%A4"><span class="nav-number">1.10.3.4.5.3.</span> <span class="nav-text">21.4.5.3、二阶段-提交</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-4-5-4%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.3.4.5.4.</span> <span class="nav-text">21.4.5.4、总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-5%E3%80%81Spring-Cloud-%E6%95%B4%E5%90%88-Nacos-1-3-1-Seata-1-2-0-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-Windows%E7%89%88"><span class="nav-number">1.10.3.5.</span> <span class="nav-text">21.5、Spring Cloud 整合 Nacos 1.3.1 + Seata 1.2.0 集群部署(Windows版)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-1%E3%80%81%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">1.10.3.5.1.</span> <span class="nav-text">21.5.1、环境说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-2%E3%80%81Seata-1-2-0-%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.10.3.5.2.</span> <span class="nav-text">21.5.2、Seata 1.2.0 下载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-3%E3%80%81%E5%AE%98%E7%BD%91%E6%96%B0%E4%BA%BA%E6%96%87%E6%A1%A3%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.10.3.5.3.</span> <span class="nav-text">21.5.3、官网新人文档中的资源目录介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-4%E3%80%81Seata-Server-%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.5.4.</span> <span class="nav-text">21.5.4、Seata Server 端配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-4-1%E3%80%81%E8%A7%A3%E5%8E%8B"><span class="nav-number">1.10.3.5.4.1.</span> <span class="nav-text">21.5.4.1、解压</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-4-2%E3%80%81MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.5.4.2.</span> <span class="nav-text">21.5.4.2、MySQL 数据库配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-4-3%E3%80%81Server%E7%AB%AF%E5%8F%82%E6%95%B0%E9%A1%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.5.4.3.</span> <span class="nav-text">21.5.4.3、Server端参数项配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-4-4%E3%80%81%E5%90%AF%E5%8A%A8Seata-Server%E7%AB%AF"><span class="nav-number">1.10.3.5.4.4.</span> <span class="nav-text">21.5.4.4、启动Seata Server端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-5-5%E3%80%81config-center-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.6.</span> <span class="nav-text">21.5.5、config-center 配置中心配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-5-1%E3%80%81%E8%8E%B7%E5%8F%96%E8%A6%81%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="nav-number">1.10.3.6.0.1.</span> <span class="nav-text">21.5.5.1、获取要配置的参数信息</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#21-5-5-2%E3%80%81%E5%B0%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E5%88%B0Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.10.3.6.0.2.</span> <span class="nav-text">21.5.5.2、将参数配置到Nacos配置中心</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-5-6%E3%80%81client-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.7.</span> <span class="nav-text">21.5.6、client 客户端配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-1%E3%80%81%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="nav-number">1.10.3.7.1.</span> <span class="nav-text">21.5.6.1、业务场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-2%E3%80%81%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87"><span class="nav-number">1.10.3.7.2.</span> <span class="nav-text">21.5.6.2、业务数据库准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-3%E3%80%81%E5%88%9B%E5%BB%BA-undo-log-%E8%A1%A8"><span class="nav-number">1.10.3.7.3.</span> <span class="nav-text">21.5.6.3、创建 undo_log 表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-4%E3%80%81%E5%BA%93%E8%A1%A8%E5%88%9B%E5%BB%BA%E5%AE%8C%E6%88%90%E5%9B%BE%E7%A4%BA"><span class="nav-number">1.10.3.7.4.</span> <span class="nav-text">21.5.6.4、库表创建完成图示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-5%E3%80%81%E6%B7%BB%E5%8A%A0-pom-%E4%BE%9D%E8%B5%96"><span class="nav-number">1.10.3.7.5.</span> <span class="nav-text">21.5.6.5、添加 pom 依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-6-7%E3%80%81application-yml-%E9%92%88%E5%AF%B9-seata-%E8%BF%9B%E8%A1%8C%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.7.6.</span> <span class="nav-text">21.5.6.7、application.yml 针对 seata 进行配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-5-7%E3%80%81Seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">1.10.3.8.</span> <span class="nav-text">21.5.7、Seata 高可用集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-7-1%E3%80%81%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">1.10.3.8.1.</span> <span class="nav-text">21.5.7.1、集群部署</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-7-2%E3%80%81%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F"><span class="nav-number">1.10.3.8.2.</span> <span class="nav-text">21.5.7.2、服务注册成功</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-7-3%E3%80%81Seata%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95"><span class="nav-number">1.10.3.8.3.</span> <span class="nav-text">21.5.7.3、Seata集群测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-5-8%E3%80%81%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%E6%9C%8D%E5%8A%A1-GTS-%E9%98%BF%E9%87%8C%E4%BA%91"><span class="nav-number">1.10.3.9.</span> <span class="nav-text">21.5.8、全局事务服务 GTS-阿里云</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-8-1%E3%80%81%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.10.3.9.1.</span> <span class="nav-text">21.5.8.1、是什么</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#21-5-8-2%E3%80%81GTS%E4%B8%8ESeata"><span class="nav-number">1.10.3.9.2.</span> <span class="nav-text">21.5.8.2、GTS与Seata</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">_little-star_</p>
  <div class="site-description" itemprop="description">记录个人在平时学习的过程中的一些笔记、感受与遇到的坑,例如：java、计算机考研四件套等等。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">_little-star_</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
