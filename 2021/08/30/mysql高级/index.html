<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xgh-user.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="[TOC] Mysql 高级篇1、索引（Index）1、索引概述MySQL官方对索引的定义为：索引（index）是帮助MySQL高效获取数据的数据结构（有序）。 在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。 如下面的&#x3D;&#x3D;示意图&#x3D;&#x3D;所示：  相关说明：  左边是数据表，一共有两列">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql高级">
<meta property="og:url" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="_little-star_">
<meta property="og:description" content="[TOC] Mysql 高级篇1、索引（Index）1、索引概述MySQL官方对索引的定义为：索引（index）是帮助MySQL高效获取数据的数据结构（有序）。 在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。 如下面的&#x3D;&#x3D;示意图&#x3D;&#x3D;所示：  相关说明：  左边是数据表，一共有两列">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555902055367.png">
<meta property="og:image" content="https://s4.51cto.com/oss/201910/11/f4ea17e54890a46428bb6c60663f70af.jpg-wh_651x-s_4115054255.jpg">
<meta property="og:image" content="https://s5.51cto.com/oss/201910/11/7e99a117195bb1def8f4caefec956700.jpg">
<meta property="og:image" content="https://s5.51cto.com/oss/201910/11/c9827921ee2294c43611957f5ab5ec30.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944126588.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944549825.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944596893.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944652560.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944686928.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944713486.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944749984.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944848294.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/00001.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555906287178.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/rcil81aoyd.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2w157wzq2u.jpeg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2q05hsflfa.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/iywj5q0imm.jpeg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/td2fso5cth.jpeg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011454316.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011537465.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011618614.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551438009843.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551440511890.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551440544483.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551438238293.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551503428635.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551537565159.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551537646323.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551588962944.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552057035580.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/000001-16304904919561.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/A99BAD74-2D62-4D19-B5CF-D53A685A64D5.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551186043529.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556086372754.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075130115.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087540767.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087611295.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087719145.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087759615.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087793738.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075336630.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901130955510.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075073836.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556076359503.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408083254.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408133323.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408216185.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408519889.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487172501.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901214257185.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556098544349.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487489859.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487526919.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556122799330.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556102471304.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556103009534.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556103294182.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/58EE7C45-EF06-458B-BBAC-89B268FB93A3.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220448958.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220550625.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220947928.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901221658084.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2F45DD10-6247-4FC7-A7DA-509AE0D9C949.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223108340.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223220731.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223310082.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223455304.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223635631.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223819993.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223749200.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223945702.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223912058.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/B908FE0F-38A4-437D-8B2A-42816B4DFF77.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F999ECF8-4C11-4FC6-AFFD-7697C63DB330.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/39476597-2608-4416-98CB-775466C83A8E.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/DCFEFA94-52FF-4813-AA4C-6094258C541B.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F1902368-4ED6-4EE2-B671-0F89898CC9DE.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/97901539-47E1-4BFA-8C4C-D9FC427208D6.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/23865FCE-17F9-4DC0-920C-54BC901560DA.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3C02A74F-0036-4B42-B5CB-F7A3E7B158A4.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/26689C8D-E3D2-439A-8183-AF75895D292D.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224456653.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224517422.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224657926.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224752479.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0DE5EE4B-CA7F-436B-8192-AAF861E8FD96.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/C66165E8-B8CB-4BBB-9FBB-954F72737323.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552488401999.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552488372405.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489017940.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489053763.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489671119.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225426139.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225525932.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225650475.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225744561.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225830193.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225903333.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225936532.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556170997921.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171348995.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901141116945.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171428140.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171662203.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172256791.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172813715.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172967493.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556173928299.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556173986068.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556174994440.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556175114369.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556247686483.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556175445210.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556180634889.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556249602732.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/99E8047C-D2AE-4931-8491-848B270EE55C.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552885364563.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556269346488.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555771750567.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555771959734.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555772132736.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555772351208.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556335817763.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556335866539.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556336352061.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556338367593.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339573979.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339633161.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339688158.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556359399199.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556359482142.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6EA2B1C8-9496-4AA2-917F-673978CB5403.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7B2D5228-E6FE-447D-8EEB-D2233274B32E.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/AEDCBEC9-5D08-48E2-BC0D-DD1E500448B4.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/4C8427B0-21FB-4D1A-AD44-AF3E0ACCF358.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/116420CA-77C2-4F3C-99F5-45B90CE54FE8.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/8066FB45-E00E-4BA3-8354-C43A3550A6BE.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0512F62F-7EA1-48E7-891F-4236AA861B2C.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/A910A719-08BE-4035-8962-564CFC7F65BD.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1772360F-4AAD-41D3-B042-DC7CBF56754C.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/63ADA277-3A11-4668-9CB2-ED2D0D55CD06.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354464657.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354887509.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354920964.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556355027728.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901151907930.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901151933870.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556361314783.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556416102800.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556363928151.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556370971576.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556371004594.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556371355788.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/20180919131632347.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555251383805.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902012301229.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902012643822.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013047619.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013106674.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013213494.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013312194.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013414184.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553906896564-16305217885821.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907044500-16305217885832.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908913515-16305217885843.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908973840-16305217885844.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907198462-16305217885845.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907403957-16305217885846.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907849829.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907875221.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908019755.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908131373.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030926626.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902031019830.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554331600009.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025707245.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025719304.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025728670.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025737987.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025748385.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025758851.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025807893.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025816158.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025826632.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025833220.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025841993.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025847203.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554385956215.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025946304.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025952429.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025958345.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030003757.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030008546.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030013887.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030020857.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030147061.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030153667.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030200257.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030211686.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030217111.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030222274.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556455943670.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/4.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/8.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/9.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/10.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/11.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/12.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/13.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/14.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/15.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/16.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/17.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/17.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/CD1FEFDE-D4C7-45B1-A107-10065C7407B3.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7C9B4A4B-2A23-4A79-8624-88EFA02FB1F9.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555325632715.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555326108697.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902222238916.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553993244446.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553993537874.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554079717375.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554080016778.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554095452022.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554118609489.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554118675264.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554125506938.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554128184632.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554128089851.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/E24A4982-114B-4FBD-9E67-C749E0CAF928.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5E69F422-6B75-48F3-BAEA-4B0F0159F147.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3DF6A981-8CC7-478A-8C08-1F05C5E672D1.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3EA8E1AE-25C9-4F8F-BF88-B97C29AAD38D.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1BFA19BF-98D7-4641-B1C2-BB29D96AC5E0.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130333472.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130448709.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130532577.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/FD701F3B-E9D7-44E3-9AA4-C59C2AF4A513.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130669360.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130856485.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1-16305935495972.jpg">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902224311154.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902224537288.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554544658640.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554544679538.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555075760661.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555077276426.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555081714638.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555152703824.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555235426739.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555235982584.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/aop-datasource.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901003856739.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/09DF557C-9B94-4314-9A1D-D9C8F59E0F23.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/59C3022F-A6AD-434C-95E1-BB9555E2C0B0.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0F314194-D9B1-4B48-BACF-A46BE2066E83.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/40FADB12-0946-4567-A47E-9FEC56226FCA.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6EAA3D86-4B7E-4BF8-A6C7-F1D649723294.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5CCB9E57-60DF-41F6-AA55-E8BDB1411846.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F49D3CE6-B08B-4968-8F8C-29F6C5EB09D8.png">
<meta property="og:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2D7109F6-A943-4A2E-9A38-3BE019D79F30.png">
<meta property="article:published_time" content="2021-08-30T14:58:25.000Z">
<meta property="article:modified_time" content="2021-09-19T14:53:48.633Z">
<meta property="article:author" content="_little-star_">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555902055367.png">

<link rel="canonical" href="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mysql高级 | _little-star_</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="_little-star_" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">_little-star_</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="_little-star_">
      <meta itemprop="description" content="记录个人在平时学习的过程中的一些笔记、感受与遇到的坑,例如：java、计算机考研四件套等等。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_little-star_">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql高级
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-30 22:58:25" itemprop="dateCreated datePublished" datetime="2021-08-30T22:58:25+08:00">2021-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-19 22:53:48" itemprop="dateModified" datetime="2021-09-19T22:53:48+08:00">2021-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/mysql%E9%AB%98%E7%BA%A7/" itemprop="url" rel="index"><span itemprop="name">mysql高级</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<h2 id="Mysql-高级篇"><a href="#Mysql-高级篇" class="headerlink" title="Mysql 高级篇"></a>Mysql 高级篇</h2><h3 id="1、索引（Index）"><a href="#1、索引（Index）" class="headerlink" title="1、索引（Index）"></a>1、索引（Index）</h3><h4 id="1、索引概述"><a href="#1、索引概述" class="headerlink" title="1、索引概述"></a>1、索引概述</h4><p>MySQL官方对索引的定义为：索引（index）是帮助MySQL高效获取数据的数据结构（有序）。</p>
<p>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，<strong>这些数据结构以某种方式引用（指向）数据</strong>， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p>
<p>如下面的==示意图==所示：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555902055367.png" alt="1555902055367"></p>
<p>相关说明：</p>
<ul>
<li>左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址（注意逻辑上相邻的记录在磁盘上也并不是一定物理相邻的）。</li>
<li>为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找快速获取到相应数据。</li>
</ul>
<p><strong>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上</strong>。<strong>索引</strong>是数据库中用来<strong>提高性能</strong>的最常用的工具。</p>
<h4 id="2、索引优势劣势"><a href="#2、索引优势劣势" class="headerlink" title="2、索引优势劣势"></a>2、索引优势劣势</h4><p>索引的优势：</p>
<ol>
<li>类似于书籍的目录索引，<strong>提高数据检索的效率，降低数据库的IO成本</strong>。</li>
<li>通过索引列对数据进行排序，<strong>降低数据排序的成本，降低CPU的消耗</strong>。</li>
</ol>
<p>索引的劣势：</p>
<ol>
<li>实际上索引也是一张表，该表中保存了主键与索引字段，并指向实体类的记录，所以<strong>索引列也是要占用空间</strong>的。</li>
<li>虽然索引大大提高了查询效率，同时却也<strong>降低更新表的速度</strong>，如对表进行INSERT、UPDATE、DELETE。因为更新表时，<strong>MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</strong>。</li>
</ol>
<h4 id="3、索引结构"><a href="#3、索引结构" class="headerlink" title="3、索引结构"></a>3、索引结构</h4><p><strong>索引是在MySQL的==存储引擎层==中实现的，而不是在服务器层实现的</strong>。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型的。</p>
<p>MySQL目前提供了以下4种索引：</p>
<ul>
<li><code>BTREE 索引</code> ：最常见的索引类型，大部分索引都支持 B 树索引。</li>
<li><code>HASH 索引</code>：只有Memory引擎支持 ， 使用场景简单 。</li>
<li><code>R-tree 索引（空间索引）</code>：空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少，不做特别介绍。</li>
<li><code>Full-text （全文索引）</code> ：全文索引也是MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从Mysql5.6版本开始支持全文索引。</li>
</ul>
<center><b>MyISAM、InnoDB、Memory三种存储引擎对各种索引类型的支持</b></center>

<table>
<thead>
<tr>
<th>索引</th>
<th>InnoDB引擎</th>
<th>MyISAM引擎</th>
<th>Memory引擎</th>
</tr>
</thead>
<tbody><tr>
<td>BTREE索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>HASH 索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>R-tree 索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Full-text</td>
<td>5.6版本之后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<ul>
<li>我们平常所说的索引，如果没有特别指明，都是指<strong>B+树</strong>（多路搜索树，并不一定是二叉的）结构组织的索引。</li>
<li>其中==聚集索引==、==次要索引==、==覆盖索引==、==复合索引==、==前缀索引==、==唯一索引==默认都是使用 <strong>B+tree</strong> 索引，统称为 索引。</li>
</ul>
<blockquote>
<p>注意：关于 InnoDB引擎 支不支持 HASH 索引问题</p>
<ul>
<li>InnoDB用户无法手动创建哈希索引，这一层上说，InnoDB确实不支持哈希索引</li>
<li>InnoDB会自调优(self-tuning)，如果判定建立自适应哈希索引(Adaptive Hash Index, AHI)，能够提升查询效率，InnoDB自己会建立相关哈希索引，这一层上说，InnoDB又是支持哈希索引的。</li>
</ul>
</blockquote>
<h5 id="1、InnoDB的自调优"><a href="#1、InnoDB的自调优" class="headerlink" title="1、InnoDB的自调优"></a>1、InnoDB的自调优</h5><p>那什么是自适应哈希索引(Adaptive Hash Index, AHI)呢?原理又是怎样的呢? 咱们先从一个例子开始。</p>
<p>不妨设有InnoDB数据表：t(id PK, name KEY, sex, flag)</p>
<blockquote>
<p> id是主键，name建了普通索引。</p>
</blockquote>
<p>假设表中有四条记录：</p>
<ul>
<li>1, shenjian, m, A</li>
<li>3, zhangsan, m, A</li>
<li>5, lisi, m, A</li>
<li>9, wangwu, f, B</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://s4.51cto.com/oss/201910/11/f4ea17e54890a46428bb6c60663f70af.jpg-wh_651x-s_4115054255.jpg"><img src="https://s4.51cto.com/oss/201910/11/f4ea17e54890a46428bb6c60663f70af.jpg-wh_651x-s_4115054255.jpg" alt="img"></a></p>
<p>如上图，通过前序知识，容易知道InnoDB在主键id上会建立聚集索引(Clustered Index)，叶子存储记录本身，在name上会建立普通索引(Secondary Index)，叶子存储主键值。</p>
<p>发起主键id查询时，能够通过聚集索引，直接定位到行记录。</p>
<p><a target="_blank" rel="noopener" href="https://s5.51cto.com/oss/201910/11/7e99a117195bb1def8f4caefec956700.jpg"><img src="https://s5.51cto.com/oss/201910/11/7e99a117195bb1def8f4caefec956700.jpg" alt="img"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t where name&#x3D;&#39;ls&#39;; </span><br></pre></td></tr></table></figure>

<p>发起普通索引查询时：</p>
<ul>
<li>会先从普通索引查询出主键(上图右边);</li>
<li>再由主键，从聚集索引上二次遍历定位到记录(上图左边)。</li>
</ul>
<p>不管聚集索引还是普通索引，记录定位的寻路路径(Search Path)都很长。</p>
<p>在MySQL运行的过程中，如果InnoDB发现，有很多SQL存在这类很长的寻路，并且有很多SQL会命中相同的页面(page)，InnoDB会在自己的内存缓冲区(Buffer)里，开辟一块区域，建立自适应哈希所有AHI，以加速查询。</p>
<p><a target="_blank" rel="noopener" href="https://s5.51cto.com/oss/201910/11/c9827921ee2294c43611957f5ab5ec30.jpg"><img src="https://s5.51cto.com/oss/201910/11/c9827921ee2294c43611957f5ab5ec30.jpg" alt="img"></a></p>
<p>从这个层面上来说，InnoDB的自使用哈希索引，更像“索引的索引”，毕竟其目的是为了加速索引寻路。</p>
<p><strong>既然是哈希，key是什么，value是什么?</strong></p>
<ul>
<li>==key是索引键值(或者键值前缀)。==</li>
<li>==value是索引记录页面位置。==</li>
</ul>
<p><strong>为啥叫“自适应(adaptive)”哈希索引?</strong></p>
<p>系统自己判断“应该可以加速查询”而建立的，不需要用户手动建立，故称“自适应”。</p>
<p><strong>系统会不会判断失误，是不是一定能加速?</strong></p>
<p>不是一定能加速，有时候会误判。 当业务场景为下面几种情况时：</p>
<ul>
<li>很多单行记录查询(例如passport，用户中心等业务)</li>
<li>索引范围查询(此时AHI可以快速定位首行记录)</li>
<li>所有记录内存能放得下</li>
</ul>
<p>AHI往往是有效的。</p>
<blockquote>
<p>任何脱离业务的技术方案，都是耍流氓。</p>
</blockquote>
<p><strong>当业务有大量like或者join，AHI的维护反而可能成为负担，降低系统效率，此时可以手动关闭AHI功能。</strong></p>
<h5 id="2、BTREE（B树）结构"><a href="#2、BTREE（B树）结构" class="headerlink" title="2、BTREE（B树）结构"></a>2、BTREE（B树）结构</h5><p>BTree又叫多路平衡搜索树，一颗m叉的BTree特性如下：</p>
<ul>
<li>树中每个节点最多包含m个孩子。</li>
<li>除根节点与叶子节点外，每个节点至少有[ceil(m/2)]个孩子。</li>
<li>若根节点不是叶子节点，则至少有两个孩子。</li>
<li>所有的叶子节点都在同一层。</li>
<li>每个非叶子节点由n个key与n+1个指针组成，其中[ceil(m/2)-1] &lt;= n &lt;= m-1 </li>
</ul>
<p>以5叉BTree为例，key的数量：公式推导[ceil(m/2)-1] &lt;= n &lt;= m-1。所以 2 &lt;= n &lt;=4 。当n&gt;4时，中间节点分裂到父节点，两边节点分裂。</p>
<p>插入 <code>C N G A H E K Q M F W L T Z D P R X Y S</code> 数据为例。</p>
<p>演变过程如下：</p>
<ol>
<li><p>插入前4个字母 C N G A </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944126588.png" alt="1555944126588"> </p>
</li>
<li><p>插入H，n&gt;4，中间元素G字母向上分裂到新的节点</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944549825.png" alt="1555944549825"></p>
</li>
<li><p>插入E，K，Q不需要分裂</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944596893.png" alt="1555944596893"></p>
</li>
<li><p>插入M，中间元素M字母向上分裂到父节点G</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944652560.png" alt="1555944652560"></p>
</li>
<li><p>插入F，W，L，T不需要分裂 </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944686928.png" alt="1555944686928"></p>
</li>
<li><p>插入Z，中间元素T向上分裂到父节点中 </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944713486.png" alt="1555944713486"></p>
</li>
<li><p>插入D，中间元素D向上分裂到父节点中。然后插入P，R，X，Y不需要分裂</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944749984.png" alt="1555944749984"></p>
</li>
<li><p>最后插入S，NPQR节点n&gt;5，中间节点Q向上分裂，但分裂后父节点DGMT的n&gt;5，中间节点M向上分裂</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555944848294.png" alt="1555944848294"> </p>
</li>
</ol>
<p>到此，该BTREE树就已经构建完成了。</p>
<p>BTREE树 和 二叉树 相比：</p>
<ul>
<li><strong>查询数据的效率更高</strong>， 因为对于相同的数据量来说，BTREE的层级结构比二叉树小，因此搜索速度快。</li>
</ul>
<h5 id="3、B-TREE（B-树）结构"><a href="#3、B-TREE（B-树）结构" class="headerlink" title="3、B+TREE（B+树）结构"></a>3、B+TREE（B+树）结构</h5><p>B+Tree为BTree的变种，B+Tree与BTree的区别为：</p>
<ol>
<li>n叉B+Tree最多含有n个key，而BTree最多含有n-1个key。</li>
<li>B+Tree的叶子节点保存所有的key信息，依key大小顺序排列。</li>
<li>所有的非叶子节点都可以看作是key的索引部分。</li>
</ol>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/00001.jpg" alt="1555906287178"> </p>
<p>由于B+Tree只有叶子节点保存key信息，查询任何key都要从root走到叶子。所以<strong>B+Tree的查询效率更加稳定</strong>。</p>
<h5 id="4、MySQL中的B-Tree"><a href="#4、MySQL中的B-Tree" class="headerlink" title="4、MySQL中的B+Tree"></a>4、MySQL中的B+Tree</h5><p>MySql索引数据结构对经典的B+Tree进行了优化：在原B+Tree的基础上，<strong>增加一个指向相邻叶子节点的链表指针</strong>，就形成了带有顺序指针的B+Tree，<strong>提高区间访问的性能</strong>。</p>
<p>MySQL中的 B+Tree 索引结构示意图：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555906287178.png" alt="1555906287178">  </p>
<h5 id="5、聚簇索引与非聚簇索引（了解）"><a href="#5、聚簇索引与非聚簇索引（了解）" class="headerlink" title="5、聚簇索引与非聚簇索引（了解）"></a>5、聚簇索引与非聚簇索引（了解）</h5><ul>
<li>聚簇索引：将数据存储与索引放到了一块，找到索引也就找到了数据</li>
<li>非聚簇索引：将数据存储于索引分开结构，索引结构的叶子节点指向了数据的对应行，myisam通过key_buffer把索引先缓存到内存中，当需要访问数据时（通过索引访问数据），在内存中直接搜索索引，然后通过索引找到磁盘相应数据，这也就是为什么索引不在key buffer命中时，速度慢的原因</li>
</ul>
<p><strong>澄清一个概念</strong>：innodb中，在聚簇索引之上创建的索引称之为辅助索引，辅助索引访问数据总是需要二次查找，非聚簇索引都是辅助索引，像复合索引、前缀索引、唯一索引，辅助索引叶子节点存储的不再是行的物理位置，而是主键值。</p>
<p><strong>何时使用聚簇索引与非聚簇索引</strong>：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/rcil81aoyd.jpg" alt="rcil81aoyd"></p>
<p><strong>聚簇索引具有唯一性</strong></p>
<p>由于聚簇索引是将数据跟索引结构放到一块，因此一个表仅有一个聚簇索引</p>
<p><strong>一个误区：把主键自动设为聚簇索引</strong></p>
<p><strong>聚簇索引默认是主键</strong>，如果表中没有定义主键，InnoDB 会选择一个<strong>唯一的非空索引</strong>代替。如果没有这样的索引，InnoDB 会<strong>隐式定义一个主键</strong>来作为聚簇索引。InnoDB 只聚集在同一个页面中的记录。包含相邻键值的页面可能相距甚远。<strong>如果你已经设置了主键为聚簇索引，必须先删除主键，然后添加我们想要的聚簇索引，最后恢复设置主键即可</strong>。</p>
<p>此时其他索引只能被定义为非聚簇索引。这个是最大的误区。有的主键还是无意义的自动增量字段，那样的话Clustered index对效率的帮助，完全被浪费了。</p>
<p>刚才说到了，聚簇索引性能最好而且具有唯一性，所以非常珍贵，必须慎重设置。<strong>一般要根据这个表最常用的SQL查询方式来进行选择，某个字段作为聚簇索引，或组合聚簇索引</strong>，这个要看实际情况。</p>
<p>记住我们的<strong>最终目的</strong>就是<strong>在相同结果集情况下，尽可能减少逻辑IO</strong>。</p>
<p><strong>结合图再仔细点看</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2w157wzq2u.jpeg" alt="2w157wzq2u"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2q05hsflfa.jpg" alt="2q05hsflfa"></p>
<ol>
<li>InnoDB使用的是聚簇索引，将<strong>主键组织到一棵B+树</strong>中，而<strong>行数据就储存在叶子节点</strong>上，若使用”where id = 14”这样的条件查找主键，则<strong>按照B+树的检索算法即可查找到对应的叶节点，之后获得行数据</strong>。</li>
<li>若<strong>对Name列进行条件搜索，则需要两个步骤</strong>：<strong>第一步在辅助索引B+树中检索Name，到达其叶子节点获取对应的主键</strong>。第二步<strong>使用主键在主索引B+树种再执行一次B+树检索操作，最终到达叶子节点即可获取整行数据</strong>。（<strong>重点在于通过其他键需要建立辅助索引</strong>）</li>
</ol>
<p>MyISM使用的是非聚簇索引，<strong>非聚簇索引的两棵B+树看上去没什么不同</strong>，节点的结构完全一致只是存储的内容不同而已，主键索引B+树的节点存储了主键，辅助键索引B+树存储了辅助键。表数据存储在独立的地方，这两颗B+树的叶子节点都使用一个地址指向真正的表数据，对于表数据来说，这两个键没有任何差别。由于<strong>索引树是独立的，通过辅助键检索无需访问主键的索引树</strong>。</p>
<p><strong>聚簇索引的优势</strong>：</p>
<p>看上去聚簇索引的效率明显要低于非聚簇索引，因为<strong>每次使用辅助索引检索都要经过两次B+树查找</strong>，这不是多此一举吗？聚簇索引的优势在哪？</p>
<ol>
<li>由于<strong>行数据和叶子节点存储在一起，同一页中会有多条行数据，访问同一数据页不同行记录时，已经把页加载到了Buffer中，再次访问的时候，会在内存中完成访问</strong>，不必访问磁盘。这样<strong>主键和行数据是一起被载入内存的，找到叶子节点就可以立刻将行数据返回</strong>了，<strong>如果按照主键Id来组织数据，获得数据更快</strong>。</li>
<li><strong>辅助索引使用主键作为”指针”而不是使用地址值作为指针的好处</strong>是，<strong>减少了当出现行移动或者数据页分裂时辅助索引的维护工作</strong>，<strong>使用主键值当作指针会让辅助索引占用更多的空间，换来的好处是InnoDB在移动行时无须更新辅助索引中的这个”指针”**。</strong>也就是说行的位置（实现中通过16K的Page来定位）会随着**<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/database?from=10680"><strong>数据库</strong></a><strong>里数据的修改而发生变化（前面的B+树节点分裂以及Page的分裂），使用聚簇索引就可以保证不管这个主键B+树的节点如何变化，辅助索引树都不受影响</strong>。</li>
<li>聚簇索引适合用在排序的场合，非聚簇索引不适合</li>
<li>取出一定范围数据的时候，使用用聚簇索引</li>
<li>二级索引需要两次索引查找，而不是一次才能取到数据，因为存储引擎第一次需要通过二级索引找到索引的叶子节点，从而找到数据的主键，然后在聚簇索引中用主键再次查找索引，再找到数据</li>
<li>可以把<strong>相关数据保存在一起</strong>。例如实现电子邮箱时，可以根据用户 ID 来聚集数据，这样只需要从磁盘读取少数的数据页就能获取某个用户的全部邮件。如果没有使用聚簇索引，则每封邮件都可能导致一次磁盘 I/O。</li>
</ol>
<p><strong>聚簇索引的劣势</strong>：</p>
<ol>
<li><strong>维护索引很昂贵，特别是插入新行或者主键被更新导至要分页(page split)的时候</strong>。建议在大量插入新行后，选在负载较低的时间段，通过OPTIMIZE TABLE优化表，因为必须被移动的行数据可能造成碎片。使用独享表空间可以弱化碎片</li>
<li>表因为使用UUId（随机ID）作为主键，使数据存储稀疏，这就会出现聚簇索引有可能有比全表扫面更慢，</li>
</ol>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/iywj5q0imm.jpeg" alt="iywj5q0imm"></p>
<p>所以建议使用int的auto_increment作为主键</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/td2fso5cth.jpeg" alt="td2fso5cth"></p>
<p>主键的值是顺序的，所以 InnoDB 把每一条记录都存储在上一条记录的后面。当达到页的最大填充因子时（InnoDB 默认的最大填充因子是页大小的 15/16，留出部分空间用于以后修改），下一条记录就会写入新的页中。一旦数据按照这种顺序的方式加载，主键页就会近似于被顺序的记录填满（二级索引页可能是不一样的）</p>
<ol>
<li>如果主键比较大的话，那辅助索引将会变的更大，因为<strong>辅助索引的叶子存储的是主键值；过长的主键值，会导致非叶子节点占用占用更多的物理空间</strong></li>
</ol>
<p><strong>为什么主键通常建议使用自增id</strong>：</p>
<p><strong>聚簇索引的数据的物理存放顺序与索引顺序是一致的</strong>，即：<strong>只要索引是相邻的，那么对应的数据一定也是相邻地存放在磁盘上的</strong>。如果主键不是自增id，那么可以想 象，它会干些什么，不断地调整数据的物理地址、分页，当然也有其他一些措施来减少这些操作，但却无法彻底避免。但，如果是自增的，那就简单了，它只需要一 页一页地写，索引结构相对紧凑，磁盘碎片少，效率也高。</p>
<p>因为<strong>MyISAM的主索引并非聚簇索引，那么他的数据的物理地址必然是凌乱的，拿到这些物理地址，按照合适的算法进行I/O读取，于是开始不停的寻道不停的旋转</strong>。<strong>聚簇索引则只需一次I/O</strong>。（强烈的对比）</p>
<p>不过，如果<strong>涉及到大数据量的排序、全表扫描、count之类的操作的话，还是MyISAM占优势些，因为索引所占空间小，这些操作是需要在内存中完成的</strong>。</p>
<p><strong>mysql中聚簇索引的设定</strong>：</p>
<p>聚簇索引<strong>默认是主键</strong>，如果表中没有定义主键，InnoDB 会选择一个<strong>唯一的非空索引</strong>代替。如果没有这样的索引，InnoDB 会<strong>隐式定义一个主键</strong>来作为聚簇索引。<strong>InnoDB 只聚集在同一个页面中的记录。包含相邻健值的页面可能相距甚远。</strong></p>
<h5 id="6、full-text全文索引"><a href="#6、full-text全文索引" class="headerlink" title="6、full-text全文索引"></a>6、full-text全文索引</h5><p>全文索引（也称全文检索）是目前搜索引擎使用的一种关键技术。它能够利用【分词技术】等多种算法智能分析出文本文字中关键词的频率和重要性，然后按照一定的算法规则智能地筛选出我们想要的搜索结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`article`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`content`</span> <span class="built_in">text</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  FULLTEXT <span class="keyword">KEY</span> <span class="string">`title`</span> (<span class="string">`title`</span>,<span class="string">`content`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<p>不同于like方式的的查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> <span class="keyword">content</span> <span class="keyword">LIKE</span> ‘%查询字符串%’;</span><br></pre></td></tr></table></figure>

<p>全文索引用<code>match+against</code>方式查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(title,<span class="keyword">content</span>) AGAINST (‘查询字符串’);</span><br></pre></td></tr></table></figure>

<p>明显的提高查询效率。</p>
<p>限制：</p>
<ul>
<li>mysql5.6.4以前只有Myisam支持，5.6.4版本以后innodb才支持，但是官方版本不支持中文分词，需要第三方分词插件。</li>
<li>5.7以后官方支持中文分词。</li>
<li>随着大数据时代的到来，关系型数据库应对全文索引的需求已力不从心，逐渐被 solr,elasticSearch等专门的搜索引擎所替代。</li>
</ul>
<h5 id="7、Hash索引"><a href="#7、Hash索引" class="headerlink" title="7、Hash索引"></a>7、Hash索引</h5><ul>
<li>Hash索引只有Memory，NDB两种引擎支持，Memory引擎默认支持Hash索引，如果多个hash值相同，出现哈希碰撞，那么索引以链表方式存储。</li>
<li>NoSql采用此索引结构。</li>
</ul>
<h5 id="8、R-Tree索引"><a href="#8、R-Tree索引" class="headerlink" title="8、R-Tree索引"></a>8、R-Tree索引</h5><ul>
<li>R-Tree在mysql很少使用，仅支持geometry数据类型，支持该类型的存储引擎只有myisam、bdb、innodb、ndb、archive几种。</li>
<li>相对于b-tree，r-tree的优势在于==范围查找==。</li>
</ul>
<h4 id="4、索引分类"><a href="#4、索引分类" class="headerlink" title="4、索引分类"></a>4、索引分类</h4><ol>
<li><p><code>单值索引</code> ：即<strong>一个索引只包含单个列，一个表可以有多个单列索引</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011454316.png" alt="image-20210901011454316"></p>
</li>
<li><p><code>唯一索引</code> ：索<strong>引列的值必须唯一，但允许有空值</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011537465.png" alt="image-20210901011537465"></p>
</li>
<li><p><code>复合索引</code> ：即<strong>一个索引包含多个列</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901011618614.png" alt="image-20210901011618614"></p>
</li>
<li><p><code>主键索引</code>：设定为主键后数据库会自动建立索引，innodb为聚簇索引</p>
<ul>
<li><p>随表一起建索引：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customer (<span class="keyword">id</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span>  AUTO_INCREMENT ,customer_no <span class="built_in">VARCHAR</span>(<span class="number">200</span>),customer_name <span class="built_in">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p> 使用 <code>AUTO_INCREMENT</code> 关键字的列必须有索引(只要有索引就行)。</p>
</li>
<li><p>单独建主键索引：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> customer <span class="keyword">add</span> PRIMARY <span class="keyword">KEY</span> customer(customer_no);  </span><br></pre></td></tr></table></figure>
</li>
<li><p>删除建主键索引：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> customer <span class="keyword">drop</span> PRIMARY <span class="keyword">KEY</span> ;  </span><br></pre></td></tr></table></figure>
</li>
<li><p>修改建主键索引：必须先删除掉(drop)原索引，再新建(add)索引</p>
</li>
</ul>
</li>
</ol>
<h4 id="5、索引语法"><a href="#5、索引语法" class="headerlink" title="5、索引语法"></a>5、索引语法</h4><p>索引在创建表的时候，可以同时创建， 也可以随时增加新的索引。</p>
<p>准备环境：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> demo_01 <span class="keyword">default</span> <span class="keyword">charset</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> demo_01;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建city表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`city`</span> (</span><br><span class="line">  <span class="string">`city_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`city_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`country_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`city_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建country表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`country`</span> (</span><br><span class="line">  <span class="string">`country_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`country_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`country_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`city`</span> (<span class="string">`city_id`</span>, <span class="string">`city_name`</span>, <span class="string">`country_id`</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;西安&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`city`</span> (<span class="string">`city_id`</span>, <span class="string">`city_name`</span>, <span class="string">`country_id`</span>) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;NewYork&#x27;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`city`</span> (<span class="string">`city_id`</span>, <span class="string">`city_name`</span>, <span class="string">`country_id`</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`city`</span> (<span class="string">`city_id`</span>, <span class="string">`city_name`</span>, <span class="string">`country_id`</span>) <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`country`</span> (<span class="string">`country_id`</span>, <span class="string">`country_name`</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;China&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`country`</span> (<span class="string">`country_id`</span>, <span class="string">`country_name`</span>) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;America&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`country`</span> (<span class="string">`country_id`</span>, <span class="string">`country_name`</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Japan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`country`</span> (<span class="string">`country_id`</span>, <span class="string">`country_name`</span>) <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;UK&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="1、创建索引"><a href="#1、创建索引" class="headerlink" title="1、创建索引"></a>1、创建索引</h5><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> 	[<span class="keyword">UNIQUE</span>|FULLTEXT|SPATIAL]  <span class="keyword">INDEX</span> index_name </span><br><span class="line">[<span class="keyword">USING</span>  index_type]</span><br><span class="line"><span class="keyword">ON</span> tbl_name(index_col_name,...)</span><br><span class="line"></span><br><span class="line">index_col_name : column_name[(<span class="keyword">length</span>)][<span class="keyword">ASC</span> | <span class="keyword">DESC</span>]</span><br></pre></td></tr></table></figure>

<p>示例 ： 为city表中的city_name字段创建索引 ；</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551438009843.png" alt="1551438009843">   </p>
<h5 id="2、查看索引"><a href="#2、查看索引" class="headerlink" title="2、查看索引"></a>2、查看索引</h5><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>

<p>示例：查看city表中的索引信息（其中加上<code>\G</code>可以将查询到的数据以row的方式展示，方便查看）</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551440511890.png" alt="1551440511890"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551440544483.png" alt="1551440544483"></p>
<h5 id="3、删除索引"><a href="#3、删除索引" class="headerlink" title="3、删除索引"></a>3、删除索引</h5><p>语法 ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name <span class="keyword">ON</span> tbl_name;</span><br></pre></td></tr></table></figure>

<p>示例 ： 想要删除city表上的索引idx_city_name，可以操作如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551438238293.png" alt="1551438238293"></p>
<h5 id="4、ALTER命令（添加索引）"><a href="#4、ALTER命令（添加索引）" class="headerlink" title="4、ALTER命令（添加索引）"></a>4、ALTER命令（添加索引）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">add</span> primary <span class="keyword">key</span>(column_list);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">add</span> <span class="keyword">unique</span> index_name(column_list);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加普通索引， 索引值可以出现多次。</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">add</span> <span class="keyword">index</span> index_name(column_list);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 该语句指定了索引为FULLTEXT， 用于全文索引</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">add</span> fulltext index_name(column_list);</span><br></pre></td></tr></table></figure>



<h4 id="6、索引设计原则"><a href="#6、索引设计原则" class="headerlink" title="6、索引设计原则"></a>6、索引设计原则</h4><p>索引的设计可以遵循一些已有的原则，创建索引的时候请尽量考虑符合这些原则，便于提升索引的使用效率，更高效的使用索引。</p>
<ul>
<li><p><strong>主键自动建立唯一索引</strong></p>
</li>
<li><p>对<strong>查询频次较高，且数据量比较大的表</strong>建立索引。</p>
</li>
<li><p>索引字段的选择，最佳候选列应当<strong>从where子句的条件中提取</strong>，如果where子句中的组合比较多，那么应当挑选最常用、过滤效果最好的列的组合。</p>
</li>
<li><p><strong>使用唯一索引</strong>，区分度越高，使用索引的效率越高。</p>
</li>
<li><p><strong>查询中与其它表关联的字段，外键关系建立索引</strong></p>
</li>
<li><p><strong>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</strong></p>
<ul>
<li>group by 和 order by 后面的字段有索引大大提高效率</li>
</ul>
</li>
<li><p><strong>查询中统计或者分组字段</strong>（分组包含着排序，因为在分组之前会先进行排序（当然也可以设置不排序））</p>
</li>
<li><p>索引可以有效的提升查询数据的效率，但索引数量不是多多益善，索引越多，维护索引的代价自然也就水涨船高。<strong>对于插入、更新、删除等DML操作比较频繁的表来说，索引过多，会引入相当高的维护代价，降低DML操作的效率，增加相应操作的时间消耗</strong>。另外<strong>索引过多的话，MySQL也会犯选择困难病，虽然最终仍然会找到一个可用的索引，但无疑提高了选择的代价</strong>。</p>
</li>
<li><p><strong>使用短索引，索引创建之后也是使用硬盘来存储的，因此提升索引访问的I/O效率，也可以提升总体的访问效率</strong>。假如构成索引的字段总长度比较短，那么在给定大小的存储块内可以存储更多的索引值，相应的可以有效的提升MySQL访问索引的I/O效率。</p>
</li>
<li><p><strong>在高并发下倾向创建组合索引</strong></p>
</li>
<li><p><strong>利用最左前缀</strong>，N个列组合而成的组合索引，那么相当于是创建了N个索引，如果查询时where子句中使用了组成该索引的前几个字段，那么这条查询SQL可以利用组合索引来提升查询效率。</p>
<ul>
<li><pre><code class="sql">-- 创建复合索引
CREATE INDEX idx_name_email_status ON tb_seller(NAME,email,STATUS);
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 就相当于：</span><br><span class="line"></span><br><span class="line">    - 对name 创建索引 ;</span><br><span class="line">    - 对name , email 创建了索引 ;</span><br><span class="line">    - 对name , email, status 创建了索引 ;</span><br><span class="line"></span><br><span class="line">**哪些情况不要创建索引：**</span><br><span class="line"></span><br><span class="line">- 表记录太少（没必要）</span><br><span class="line">- 经常增删改的表</span><br><span class="line">  - 提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。</span><br><span class="line">  - 因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件</span><br><span class="line">- Where条件里用不到的字段不创建索引，索引建多了影响 增删改 的效率</span><br><span class="line">- 数据重复且分布平均的表字段，因此应该**只为最经常查询和最经常排序的数据列建立索引**。</span><br><span class="line">  - **注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。**</span><br><span class="line">    - 假如一个表有10万行记录，有一个字段A只有T和F两种值，且每一个值的分布概率大约为50%，那么对这种表A字段建索引一般不会提高数据库的程序速度</span><br><span class="line">    - 索引的选择性是指索引列中不同值的数目与表中记录数的比。即：如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980&#x2F;2000 &#x3D; 0.99。**一个索引的选择性越接近于1，这个索引的效率就越高。**</span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2、视图（View）</span><br><span class="line"></span><br><span class="line">#### 1、视图概述</span><br><span class="line"></span><br><span class="line">**视图（View）是一种虚拟存在的表**。**视图并不在数据库中实际存在，行和列数据来自定义视图的&#x3D;&#x3D;查询&#x3D;&#x3D;中使用的表，并且是在使用视图时动态生成的。**</span><br><span class="line"></span><br><span class="line">通俗的讲，**视图就是一条SELECT语句执行后返回的结果集**。所以我们在创建视图的时候，主要的工作就落在创建这条SQL查询语句上。</span><br><span class="line"></span><br><span class="line">视图相对于普通的表的优势主要包括以下几项：</span><br><span class="line"></span><br><span class="line">- **简单**：**使用视图的用户完全不需要关心后面对应的表的结构、关联条件和筛选条件**，对用户来说已经是过滤好的复合条件的结果集。</span><br><span class="line">- **安全**：**使用视图的用户只能访问他们被允许查询的结果集**，对表的权限管理并不能限制到某个行某个列，但是通过视图就可以简单的实现。</span><br><span class="line">- **数据独立**：一旦视图的结构确定了，可以**屏蔽表结构变化对用户的影响，源表增加列对视图没有影响；源表修改列名，则可以通过修改视图来解决，不会造成对访问者的影响**。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 2、创建或者修改视图</span><br><span class="line"></span><br><span class="line">创建视图的语法为：</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">CREATE [OR REPLACE] [ALGORITHM &#x3D; &#123;UNDEFINED | MERGE | TEMPTABLE&#125;]</span><br><span class="line"></span><br><span class="line">VIEW view_name [(column_list)]</span><br><span class="line"></span><br><span class="line">AS select_statement</span><br><span class="line"></span><br><span class="line">[WITH [CASCADED | LOCAL] CHECK OPTION]</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<p>修改视图的语法为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> [ALGORITHM = &#123;UNDEFINED | <span class="keyword">MERGE</span> | TEMPTABLE&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">VIEW</span> view_name [(column_list)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">AS</span> select_statement</span><br><span class="line"></span><br><span class="line">[<span class="keyword">WITH</span> [<span class="keyword">CASCADED</span> | <span class="keyword">LOCAL</span>] <span class="keyword">CHECK</span> <span class="keyword">OPTION</span>]</span><br></pre></td></tr></table></figure>

<p>其中：选项WITH [CASCADED | LOCAL] CHECK OPTION <strong>决定了是否允许更新数据使记录不再满足视图的条件</strong>。</p>
<ul>
<li><code>LOCAL</code> ： 只要满足本视图的条件就可以更新。</li>
<li><code>CASCADED</code> ： 必须满足所有针对该视图的所有视图的条件才可以更新。 <strong>默认值</strong></li>
</ul>
<p>示例：创建city_country_view视图，执行如下SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">view</span> city_country_view </span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> t.*,c.country_name <span class="keyword">from</span> country c , city t <span class="keyword">where</span> c.country_id = t.country_id;</span><br></pre></td></tr></table></figure>

<p>由于视图是一种虚拟的表，所以可以使用操作表的SQL语句对视图进行查询：</p>
<p>查询视图 ： </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551503428635.png" alt="1551503428635"></p>
<p>当然，由于视图是一种虚拟的表，所以也可以对视图进行修改操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> city_country_view <span class="keyword">set</span> city_name = <span class="string">&#x27;GuangDong&#x27;</span> <span class="keyword">where</span> city_id = <span class="number">1</span>; </span><br></pre></td></tr></table></figure>

<p><strong>此时，修改操作不仅会修改视图上的表的数据，而且也会同步修改底层的表中的数据。</strong></p>
<blockquote>
<p>注意：一般不要在视图上进行修改，视图是用来简化我们的==查询==操作，方便我们进行数据查询的。</p>
</blockquote>
<h4 id="3、-查看视图"><a href="#3、-查看视图" class="headerlink" title="3、 查看视图"></a>3、 查看视图</h4><p>从 MySQL 5.1 版本开始，使用 <code>SHOW TABLES</code> 命令的时候不仅显示表的名字，同时也会显示视图的名字，而不存在单独显示视图的 SHOW VIEWS 命令。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551537565159.png" alt="1551537565159"></p>
<p>同样，在使用 <code>SHOW TABLE STATU</code>S 命令的时候，不但可以显示表的信息，同时也可以显示视图的信息。    </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551537646323.png" alt="1551537646323"> </p>
<p>如果需要查询某个视图的定义，可以使用 <code>SHOW CREATE VIEW</code> 命令进行查看：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551588962944.png" alt="1551588962944">  </p>
<h4 id="4、删除视图"><a href="#4、删除视图" class="headerlink" title="4、删除视图"></a>4、删除视图</h4><p>语法 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] view_name [, view_name] ...[RESTRICT | <span class="keyword">CASCADE</span>]	</span><br></pre></td></tr></table></figure>

<p>示例，删除视图city_country_view ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> city_country_view ;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3、存储过程（Procedure）和函数（Function）"><a href="#3、存储过程（Procedure）和函数（Function）" class="headerlink" title="3、存储过程（Procedure）和函数（Function）"></a>3、存储过程（Procedure）和函数（Function）</h3><h4 id="1、存储过程和函数概述"><a href="#1、存储过程和函数概述" class="headerlink" title="1、存储过程和函数概述"></a>1、存储过程和函数概述</h4><p>存储过程和函数是：<strong>事先经过编译并存储在数据库中的一段 SQL 语句的集合</strong>，调用存储过程和函数可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。    </p>
<p>存储过程和函数的区别在于函数必须有返回值，而存储过程没有：</p>
<ul>
<li>函数（function）： 是一个有返回值的过程 ；</li>
<li>过程（procedure）： 是一个没有返回值的函数 ；</li>
</ul>
<p>其实存储过程与存储函数的作用并没有太大的区别：</p>
<ul>
<li>存储函数可以获取返回值</li>
<li>存储过程可以通过<code>OUT</code>也能获取返回值</li>
</ul>
<h4 id="2、存储过程"><a href="#2、存储过程" class="headerlink" title="2、存储过程"></a>2、存储过程</h4><h5 id="1、创建存储过程"><a href="#1、创建存储过程" class="headerlink" title="1、创建存储过程"></a>1、创建存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> procedure_name ([proc_parameter[,...]])</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="comment">-- SQL语句</span></span><br><span class="line"><span class="keyword">end</span> ;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test1()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">select</span> <span class="string">&#x27;Hello Mysql&#x27;</span> ;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p><strong><font color="red">知识小贴士</font></strong></p>
<p><code>DELIMITER</code></p>
<ul>
<li>该关键字用来声明SQL语句的分隔符，告诉 MySQL 解释器，该段命令是否已经结束了，mysql是否可以执行了。</li>
<li>默认情况下，delimiter是分号<code>;</code>。</li>
<li>在命令行客户端中，如果有一行命令以<code>;</code>结束，那么回车后，mysql将会执行该命令。</li>
<li>如果要创建存储过程的话，在定义里面的sql语句时，使用<code>;</code>会让mysql执行命令，而此时的命令是不完全的，会报错。此时使用DELIMITER将分隔符修改为其他符号，等到创建存储过程之后，在将分隔符改回<code>;</code>就行。</li>
</ul>
<h5 id="2、调用存储过程"><a href="#2、调用存储过程" class="headerlink" title="2、调用存储过程"></a>2、调用存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> procedure_name() ;	</span><br></pre></td></tr></table></figure>

<h5 id="3、查看存储过程"><a href="#3、查看存储过程" class="headerlink" title="3、查看存储过程"></a>3、查看存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询db_name数据库中的所有的存储过程</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> mysql.proc <span class="keyword">where</span> db=<span class="string">&#x27;db_name&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询存储过程的状态信息</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">procedure</span> <span class="keyword">status</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询某个存储过程的定义</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> test.pro_test1 \G;</span><br></pre></td></tr></table></figure>

<h5 id="4、删除存储过程"><a href="#4、删除存储过程" class="headerlink" title="4、删除存储过程"></a>4、删除存储过程</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span>  [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] sp_name;</span><br></pre></td></tr></table></figure>

<h5 id="5、在存储过程的sql当中的语法"><a href="#5、在存储过程的sql当中的语法" class="headerlink" title="5、在存储过程的sql当中的语法"></a>5、在存储过程的sql当中的语法</h5><p>存储过程是可以编程的，意味着可以使用<strong>变量</strong>，<strong>表达式</strong>，<strong>控制结构</strong> ， 来完成比较复杂的功能。</p>
<h6 id="1、变量"><a href="#1、变量" class="headerlink" title="1、变量"></a>1、变量</h6><ul>
<li><p><code>DECLARE</code></p>
<ul>
<li><p>通过 DECLARE 可以定义一个局部变量，该变量的作用范围只能在 BEGIN…END 块中。</p>
</li>
<li><pre><code class="sql">DECLARE var_name[,...] type [DEFAULT value]
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 示例：</span><br><span class="line"></span><br><span class="line">- &#96;&#96;&#96;sql</span><br><span class="line">  delimiter $</span><br><span class="line">  </span><br><span class="line">   create procedure pro_test2() </span><br><span class="line">   begin </span><br><span class="line">   	declare num int default 5;</span><br><span class="line">   	select num+ 10; </span><br><span class="line">   	-- concat(&#39;xxx&#39;,&#39;ooo&#39;) 把里面的东西连接成一个字符串</span><br><span class="line">   	-- select concat(&#39;num的值为:&#39;,num);</span><br><span class="line">   end$</span><br><span class="line">  </span><br><span class="line">   delimiter;</span><br></pre></td></tr></table></figure></code></pre>
</li>
</ul>
</li>
<li><p><code>SET</code></p>
<ul>
<li><p>直接赋值使用 SET，可以赋常量或者赋表达式，具体语法如下：</p>
</li>
<li><pre><code class="sql">SET var_name = expr [, var_name = expr] ...
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 示例：</span><br><span class="line"></span><br><span class="line">- &#96;&#96;&#96;sql</span><br><span class="line">    DELIMITER $</span><br><span class="line">    </span><br><span class="line">    CREATE  PROCEDURE pro_test3()</span><br><span class="line">    BEGIN</span><br><span class="line">    	DECLARE NAME VARCHAR(20);</span><br><span class="line">    	SET NAME &#x3D; &#39;MYSQL&#39;;</span><br><span class="line">    	SELECT NAME ;</span><br><span class="line">    END$</span><br><span class="line">    </span><br><span class="line">    DELIMITER ;</span><br></pre></td></tr></table></figure></code></pre>
</li>
<li><p>也可以通过select … into 方式进行赋值操作：</p>
</li>
<li><pre><code class="sql">DELIMITER $

CREATE  PROCEDURE pro_test5()
BEGIN
    declare  countnum int;
    select count(*) into countnum from city;
    select concat(&#39;city表当中的记录数为:&#39;,num);
END$

DELIMITER ;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 2、if条件判断</span><br><span class="line"></span><br><span class="line">语法结构：</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">if search_condition then statement_list</span><br><span class="line"></span><br><span class="line">	[elseif search_condition then statement_list] ...</span><br><span class="line">	</span><br><span class="line">	[else statement_list]</span><br><span class="line">	</span><br><span class="line">end if;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<p>需求：根据定义的身高变量，判定当前身高的所属的身材类型 </p>
<ul>
<li>180 及以上：身材高挑</li>
<li>170 - 180：标准身材</li>
<li>170 以下：一般身材</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test6()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span>  height  <span class="built_in">int</span>  <span class="keyword">default</span>  <span class="number">175</span>; </span><br><span class="line">  <span class="keyword">declare</span>  description  <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">  </span><br><span class="line">  if  height &gt;= 180  then</span><br><span class="line">    <span class="keyword">set</span> description = <span class="string">&#x27;身材高挑&#x27;</span>;</span><br><span class="line">  elseif height &gt;= 170 and height &lt; 180  then</span><br><span class="line">    <span class="keyword">set</span> description = <span class="string">&#x27;标准身材&#x27;</span>;</span><br><span class="line">  else</span><br><span class="line">    <span class="keyword">set</span> description = <span class="string">&#x27;一般身材&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> description ;</span><br><span class="line">  <span class="comment">-- select concat(&#x27;身高:&#x27;,height,&#x27;对应的身材类型:&#x27;,description)</span></span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>调用结果为：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552057035580.png" alt="1552057035580"> </p>
<h6 id="3、传递参数"><a href="#3、传递参数" class="headerlink" title="3、传递参数"></a>3、传递参数</h6><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> procedure_name([<span class="keyword">in</span>/<span class="keyword">out</span>/inout] 参数名   参数类型)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>IN</code> ：<strong>该参数可以作为输入，也就是需要调用方传入值，默认</strong></li>
<li><code>OUT</code>：<strong>该参数作为输出，也就是该参数可以作为返回值</strong></li>
<li><code>INOUT</code>：<strong>既可以作为输入参数，也可以作为输出参数</strong></li>
</ul>
<p><strong>IN - 输入</strong></p>
<p>需求：根据定义的身高变量，判定当前身高的所属的身材类型 </p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test5(<span class="keyword">in</span> height <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> description <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  if height &gt;= 180 then</span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;身材高挑&#x27;</span>;</span><br><span class="line">  elseif height &gt;= 170 and height &lt; 180 then</span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;标准身材&#x27;</span>;</span><br><span class="line">  else</span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;一般身材&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;身高 &#x27;</span>, height , <span class="string">&#x27;对应的身材类型为:&#x27;</span>,description);</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>



<p><strong>OUT-输出</strong></p>
<p> 需求：根据传入的身高变量，获取当前身高的所属的身材类型  </p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test5(<span class="keyword">in</span> height <span class="built_in">int</span> , <span class="keyword">out</span> description <span class="built_in">varchar</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> height &gt;= <span class="number">180</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;身材高挑&#x27;</span>;</span><br><span class="line">  elseif height &gt;= 170 and height &lt; 180 then</span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;标准身材&#x27;</span>;</span><br><span class="line">  else</span><br><span class="line">    <span class="keyword">set</span> description=<span class="string">&#x27;一般身材&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"><span class="keyword">end</span>$	</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call pro_test5(168, @description)$</span><br><span class="line"></span><br><span class="line">select @description$</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>小知识</strong> </font></p>
<ul>
<li><code>@description</code>：这种变量要在变量名称前面加上“@”符号，叫做<strong>用户会话变量</strong>，代表<strong>整个会话过程他都是有作用的，这个类似于全局变量一样</strong>。</li>
<li><code>@@global.sort_buffer_size</code>：这种在变量前加上 “@@” 符号，叫做 <strong>系统变量</strong> </li>
</ul>
<h6 id="4、case结构"><a href="#4、case结构" class="headerlink" title="4、case结构"></a>4、case结构</h6><p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方式一</span></span><br><span class="line">CASE case_value</span><br><span class="line"></span><br><span class="line">  WHEN when_value THEN statement_list</span><br><span class="line">  </span><br><span class="line">  [WHEN when_value THEN statement_list] ...</span><br><span class="line">  </span><br><span class="line">  [ELSE statement_list]</span><br><span class="line">  </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式二</span></span><br><span class="line"></span><br><span class="line">CASE</span><br><span class="line"></span><br><span class="line">  WHEN search_condition THEN statement_list</span><br><span class="line">  </span><br><span class="line">  [WHEN search_condition THEN statement_list] ...</span><br><span class="line">  </span><br><span class="line">  [ELSE statement_list]</span><br><span class="line">  </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需求：给定一个月份，然后计算出所在的季度</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test9(<span class="keyword">month</span> <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> <span class="keyword">result</span> <span class="built_in">varchar</span>(<span class="number">20</span>);</span><br><span class="line">  case </span><br><span class="line">    when month &gt;= 1 and month &lt;=3 then </span><br><span class="line">      <span class="keyword">set</span> <span class="keyword">result</span> = <span class="string">&#x27;第一季度&#x27;</span>;</span><br><span class="line">    when month &gt;= 4 and month &lt;=6 then </span><br><span class="line">      <span class="keyword">set</span> <span class="keyword">result</span> = <span class="string">&#x27;第二季度&#x27;</span>;</span><br><span class="line">    when month &gt;= 7 and month &lt;=9 then </span><br><span class="line">      <span class="keyword">set</span> <span class="keyword">result</span> = <span class="string">&#x27;第三季度&#x27;</span>;</span><br><span class="line">    when month &gt;= 10 and month &lt;=12 then </span><br><span class="line">      <span class="keyword">set</span> <span class="keyword">result</span> = <span class="string">&#x27;第四季度&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;您输入的月份为 :&#x27;</span>, <span class="keyword">month</span> , <span class="string">&#x27; , 该月份为 : &#x27;</span> , <span class="keyword">result</span>) <span class="keyword">as</span> <span class="keyword">content</span> ;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h6 id="5、while循环"><a href="#5、while循环" class="headerlink" title="5、while循环"></a>5、while循环</h6><p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while search_condition <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">	statement_list</span><br><span class="line">	</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">while</span>;</span><br></pre></td></tr></table></figure>

<p>需求：计算从1加到n的值</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test8(n <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> total <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">declare</span> <span class="keyword">num</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">  while num&lt;=n do</span><br><span class="line">    <span class="keyword">set</span> total = total + <span class="keyword">num</span>;</span><br><span class="line">	<span class="keyword">set</span> <span class="keyword">num</span> = <span class="keyword">num</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">while</span>;</span><br><span class="line">  <span class="keyword">select</span> total;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h6 id="6、repeat结构"><a href="#6、repeat结构" class="headerlink" title="6、repeat结构"></a>6、repeat结构</h6><p>有条件的循环控制语句，当满足条件的时候退出循环。</p>
<blockquote>
<p>while 是满足条件才执行，repeat 是满足条件就退出循环。</p>
</blockquote>
<p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">REPEAT</span><br><span class="line"></span><br><span class="line">  statement_list</span><br><span class="line"></span><br><span class="line">  UNTIL search_condition</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="keyword">REPEAT</span>;</span><br></pre></td></tr></table></figure>

<p>需求：计算从1加到n的值</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test10(n <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> total <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  repeat </span><br><span class="line">    <span class="keyword">set</span> total = total + n;</span><br><span class="line">    <span class="keyword">set</span> n = n - <span class="number">1</span>;</span><br><span class="line">    until n=0  </span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> total ;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p><strong>注意：until后面的语句不要加上 <code>;</code> ，否则语法报错。</strong></p>
<h6 id="7、loop语句"><a href="#7、loop语句" class="headerlink" title="7、loop语句"></a>7、loop语句</h6><p>LOOP 实现简单的循环，退出循环的条件需要使用其他的语句定义，通常可以使用 LEAVE 语句实现，具体语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[begin_label:] LOOP</span><br><span class="line"></span><br><span class="line">  statement_list</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span> [end_label]</span><br></pre></td></tr></table></figure>

<p>如果不在 statement_list 中增加退出循环的语句，那么 LOOP 语句可以用来实现简单的死循环。</p>
<h6 id="8、leave语句"><a href="#8、leave语句" class="headerlink" title="8、leave语句"></a>8、leave语句</h6><p>用来从标注的流程构造中退出，通常和 BEGIN … END 或者循环一起使用。下面是一个使用 LOOP 和 LEAVE 的简单例子，退出循环：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_test11(n <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">declare</span> total <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  ins: LOOP</span><br><span class="line">    </span><br><span class="line">    IF n &lt;= 0 then</span><br><span class="line">      leave ins;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">set</span> total = total + n;</span><br><span class="line">    <span class="keyword">set</span> n = n - <span class="number">1</span>;</span><br><span class="line">  	</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span> ins;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> total;</span><br><span class="line"><span class="keyword">END</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h6 id="9、游标-光标（Cursor）"><a href="#9、游标-光标（Cursor）" class="headerlink" title="9、游标/光标（Cursor）"></a>9、游标/光标（Cursor）</h6><p>游标是用来存储查询结果集的数据类型，在存储过程和函数中可以使用光标对结果集进行循环的处理。</p>
<p>光标的使用包括光标的声明、OPEN、FETCH 和 CLOSE，其语法分别如下：</p>
<p>声明光标：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> cursor_name <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> select_statement ;</span><br></pre></td></tr></table></figure>

<p>OPEN 光标：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPEN cursor_name ;</span><br></pre></td></tr></table></figure>

<p>FETCH 光标：（每fetch一次，指针往下走一个）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FETCH cursor_name INTO var_name [, var_name] ...</span><br></pre></td></tr></table></figure>

<p>CLOSE 光标：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSE cursor_name ;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>初始化脚本：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> auto_increment ,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  age <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">comment</span> <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  salary <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">comment</span> <span class="string">&#x27;薪水&#x27;</span>,</span><br><span class="line">  primary <span class="keyword">key</span>(<span class="string">`id`</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8 ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(<span class="keyword">id</span>,<span class="keyword">name</span>,age,salary) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;金毛狮王&#x27;</span>,<span class="number">55</span>,<span class="number">3800</span>),(<span class="literal">null</span>,<span class="string">&#x27;白眉鹰王&#x27;</span>,<span class="number">60</span>,<span class="number">4000</span>),(<span class="literal">null</span>,<span class="string">&#x27;青翼蝠王&#x27;</span>,<span class="number">38</span>,<span class="number">2800</span>),(<span class="literal">null</span>,<span class="string">&#x27;紫衫龙王&#x27;</span>,<span class="number">42</span>,<span class="number">1800</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查询emp表中数据，并逐行获取进行展示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test11()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> e_id <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_name <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_age <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_salary <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">declare</span> emp_result <span class="keyword">cursor</span> <span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> emp;</span><br><span class="line">  </span><br><span class="line">  open emp_result;</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id=&#x27;</span>,e_id , <span class="string">&#x27;, name=&#x27;</span>,e_name, <span class="string">&#x27;, age=&#x27;</span>, e_age, <span class="string">&#x27;, 薪资为: &#x27;</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id=&#x27;</span>,e_id , <span class="string">&#x27;, name=&#x27;</span>,e_name, <span class="string">&#x27;, age=&#x27;</span>, e_age, <span class="string">&#x27;, 薪资为: &#x27;</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id=&#x27;</span>,e_id , <span class="string">&#x27;, name=&#x27;</span>,e_name, <span class="string">&#x27;, age=&#x27;</span>, e_age, <span class="string">&#x27;, 薪资为: &#x27;</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id=&#x27;</span>,e_id , <span class="string">&#x27;, name=&#x27;</span>,e_name, <span class="string">&#x27;, age=&#x27;</span>, e_age, <span class="string">&#x27;, 薪资为: &#x27;</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id=&#x27;</span>,e_id , <span class="string">&#x27;, name=&#x27;</span>,e_name, <span class="string">&#x27;, age=&#x27;</span>, e_age, <span class="string">&#x27;, 薪资为: &#x27;</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  close emp_result;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果：前四条数据被成功fetch出来展示，最后一次fetch由于表中已经没有数据，所以会报错：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1329 (020000): No data - zero rows fetched ,selected, or processed</span><br></pre></td></tr></table></figure>

<p>通过循环结构，获取游标中的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test12()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">DECLARE</span> <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">DECLARE</span> <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">  <span class="keyword">DECLARE</span> age <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">DECLARE</span> salary <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">DECLARE</span> has_data <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">DECLARE</span> emp_result <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">select</span> * <span class="keyword">from</span> emp;</span><br><span class="line">  <span class="comment">-- 这里的条件声明必须放在游标声明之后，否则报错</span></span><br><span class="line">  <span class="keyword">DECLARE</span> <span class="keyword">EXIT</span> <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">NOT</span> <span class="keyword">FOUND</span> <span class="keyword">set</span> has_data = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  open emp_result;</span><br><span class="line">  </span><br><span class="line">  repeat</span><br><span class="line">    fetch emp_result into id , name , age , salary;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">&#x27;id为&#x27;</span>,<span class="keyword">id</span>, <span class="string">&#x27;, name 为&#x27;</span> ,<span class="keyword">name</span> , <span class="string">&#x27;, age为 &#x27;</span> ,age , <span class="string">&#x27;, 薪水为: &#x27;</span>, salary);</span><br><span class="line">    until has_data = 0</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line">  </span><br><span class="line">  close emp_result;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">DELIMITER ; </span><br></pre></td></tr></table></figure>

<p><strong>注意：这里的条件声明必须放在游标声明之后，否则报错</strong></p>
<h4 id="3、存储函数"><a href="#3、存储函数" class="headerlink" title="3、存储函数"></a>3、存储函数</h4><p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> function_name([param <span class="keyword">type</span> ... ]) </span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">type</span> </span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="comment">-- SQL语句</span></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>案例：定义一个存储函数，请求满足条件的总记录数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> count_city(countryId <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> cnum <span class="built_in">int</span> ;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">into</span> cnum <span class="keyword">from</span> city <span class="keyword">where</span> country_id = countryId;</span><br><span class="line">  </span><br><span class="line">  return cnum;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select count_city(1);</span><br><span class="line"></span><br><span class="line">select count_city(2);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4、触发器（Trigger）"><a href="#4、触发器（Trigger）" class="headerlink" title="4、触发器（Trigger）"></a>4、触发器（Trigger）</h3><h4 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h4><p><strong>触发器是与表有关的数据库对象，指在 insert/update/delete 之前或之后，触发并执行触发器中定义的SQL语句集合</strong>。</p>
<p>触发器的这种特性可以<strong>协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作 。</strong></p>
<p>使用别名 <code>OLD</code> 和 <code>NEW</code> 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。</p>
<ul>
<li>mysql触发器还只支持行级触发器，不支持语句级触发器。</li>
<li>Oracle数据库既支持行级触发器，又支持语句级触发器。</li>
</ul>
<table>
<thead>
<tr>
<th>触发器类型</th>
<th>NEW 和 OLD 的使用</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT 型触发器</td>
<td>NEW 表示将要或者已经新增的数据</td>
</tr>
<tr>
<td>UPDATE 型触发器</td>
<td>OLD 表示修改之前的数据，NEW 表示将要或已经修改后的数据</td>
</tr>
<tr>
<td>DELETE 型触发器</td>
<td>OLD 表示将要或者已经删除的数据</td>
</tr>
</tbody></table>
<h4 id="2、创建触发器"><a href="#2、创建触发器" class="headerlink" title="2、创建触发器"></a>2、创建触发器</h4><p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> trigger_name </span><br><span class="line"></span><br><span class="line"><span class="keyword">before</span>/<span class="keyword">after</span> <span class="keyword">insert</span>/<span class="keyword">update</span>/<span class="keyword">delete</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">on</span> tbl_name </span><br><span class="line"></span><br><span class="line">[ <span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span> ]  <span class="comment">-- 行级触发器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">	trigger_stmt ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>需求：通过触发器记录 emp 表的数据变更日志，包含增加、修改、删除</p>
<p>首先创建一张日志表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp_logs(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> auto_increment,</span><br><span class="line">  operation <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">&#x27;操作类型, insert/update/delete&#x27;</span>,</span><br><span class="line">  operate_time datetime <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">  operate_id <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">&#x27;操作表的ID&#x27;</span>,</span><br><span class="line">  operate_params <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">comment</span> <span class="string">&#x27;操作参数&#x27;</span>,</span><br><span class="line">  primary <span class="keyword">key</span>(<span class="string">`id`</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br></pre></td></tr></table></figure>

<p>创建 insert 型触发器，完成插入数据时的日志记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> emp_logs_insert_trigger</span><br><span class="line"><span class="keyword">after</span> <span class="keyword">insert</span> </span><br><span class="line"><span class="keyword">on</span> emp </span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span> </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">insert</span> <span class="keyword">into</span> emp_logs (<span class="keyword">id</span>,operation,operate_time,operate_id,operate_params) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="keyword">now</span>(),new.id,<span class="keyword">concat</span>(<span class="string">&#x27;插入后(id:&#x27;</span>,new.id,<span class="string">&#x27;, name:&#x27;</span>,new.name,<span class="string">&#x27;, age:&#x27;</span>,new.age,<span class="string">&#x27;, salary:&#x27;</span>,new.salary,<span class="string">&#x27;)&#x27;</span>));	</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>创建 update 型触发器，完成更新数据时的日志记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> emp_logs_update_trigger</span><br><span class="line"><span class="keyword">after</span> <span class="keyword">update</span> </span><br><span class="line"><span class="keyword">on</span> emp </span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span> </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">insert</span> <span class="keyword">into</span> emp_logs (<span class="keyword">id</span>,operation,operate_time,operate_id,operate_params) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;update&#x27;</span>,<span class="keyword">now</span>(),new.id,<span class="keyword">concat</span>(<span class="string">&#x27;修改前(id:&#x27;</span>,old.id,<span class="string">&#x27;, name:&#x27;</span>,old.name,<span class="string">&#x27;, age:&#x27;</span>,old.age,<span class="string">&#x27;, salary:&#x27;</span>,old.salary,<span class="string">&#x27;) , 修改后(id&#x27;</span>,new.id, <span class="string">&#x27;name:&#x27;</span>,new.name,<span class="string">&#x27;, age:&#x27;</span>,new.age,<span class="string">&#x27;, salary:&#x27;</span>,new.salary,<span class="string">&#x27;)&#x27;</span>));                                                                      </span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>创建delete 行的触发器 , 完成删除数据时的日志记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> emp_logs_delete_trigger</span><br><span class="line"><span class="keyword">after</span> <span class="keyword">delete</span> </span><br><span class="line"><span class="keyword">on</span> emp </span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span> </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">insert</span> <span class="keyword">into</span> emp_logs (<span class="keyword">id</span>,operation,operate_time,operate_id,operate_params) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;delete&#x27;</span>,<span class="keyword">now</span>(),old.id,<span class="keyword">concat</span>(<span class="string">&#x27;删除前(id:&#x27;</span>,old.id,<span class="string">&#x27;, name:&#x27;</span>,old.name,<span class="string">&#x27;, age:&#x27;</span>,old.age,<span class="string">&#x27;, salary:&#x27;</span>,old.salary,<span class="string">&#x27;)&#x27;</span>));                                                                      </span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(<span class="keyword">id</span>,<span class="keyword">name</span>,age,salary) <span class="keyword">values</span>(<span class="literal">null</span>, <span class="string">&#x27;光明左使&#x27;</span>,<span class="number">30</span>,<span class="number">3500</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(<span class="keyword">id</span>,<span class="keyword">name</span>,age,salary) <span class="keyword">values</span>(<span class="literal">null</span>, <span class="string">&#x27;光明右使&#x27;</span>,<span class="number">33</span>,<span class="number">3200</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> emp <span class="keyword">set</span> age = <span class="number">39</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp_logs;</span><br></pre></td></tr></table></figure>



<h4 id="3、删除触发器"><a href="#3、删除触发器" class="headerlink" title="3、删除触发器"></a>3、删除触发器</h4><p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> [schema_name.]trigger_name</span><br></pre></td></tr></table></figure>

<p>如果没有指定 schema_name，默认为当前数据库 。</p>
<h4 id="4、查看触发器"><a href="#4、查看触发器" class="headerlink" title="4、查看触发器"></a>4、查看触发器</h4><p>可以通过执行 <code>SHOW TRIGGERS</code> 命令查看触发器的状态、语法等信息。</p>
<p>语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">triggers</span>；</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5、Mysql的体系结构概览"><a href="#5、Mysql的体系结构概览" class="headerlink" title="5、Mysql的体系结构概览"></a>5、Mysql的体系结构概览</h3><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/000001-16304904919561.jpg" alt="171214401286615"> </p>
<p>整个MySQL Server由以下组成</p>
<ul>
<li>Connection Pool：连接池组件</li>
<li>Management Services &amp; Utilities：管理服务和工具组件</li>
<li>SQL Interface：SQL接口组件</li>
<li>Parser：查询分析器组件</li>
<li>Optimizer：优化器组件</li>
<li>Caches &amp; Buffers：缓冲池组件</li>
<li>Pluggable Storage Engines：存储引擎</li>
<li>File System：文件系统</li>
</ul>
<p>整个MySQL Server 从上往下可以分为以下四层：</p>
<ol>
<li>连接层<ul>
<li>最上层是一些客户端和链接服务，包含本地sock 通信和大多数基于客户端/服务端工具实现的类似于 TCP/IP的通信。</li>
<li>主要完成一些类似于连接处理、授权认证、及相关的安全方案。</li>
<li>在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。</li>
<li>同样在该层上可以实现基于SSL的安全链接。</li>
<li>服务器也会为安全接入的每个客户端验证它所具有的操作权限。</li>
</ul>
</li>
<li>服务层<ul>
<li>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。</li>
<li>所有跨存储引擎的功能也在这一层实现，如 过程、函数等。</li>
<li>在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定表的查询的顺序，是否利用索引等， 最后生成相应的执行操作。</li>
<li>如果是select语句，服务器还会查询内部的缓存，如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</li>
</ul>
</li>
<li>引擎层<ul>
<li>存储引擎层， 存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。</li>
<li>不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎。</li>
</ul>
</li>
<li>存储层<ul>
<li>数据存储层， 主要是将数据存储在文件系统之上，并完成与存储引擎的交互。</li>
</ul>
</li>
</ol>
<p>和其他数据库相比，MySQL有点与众不同，<strong>它的架构可以在多种不同场景中应用并发挥良好作用。主要体现在存储引擎上，插件式的存储引擎架构，将查询处理和其他的系统任务以及数据的存储提取分离</strong>。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。</p>
<p>查询流程图：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/A99BAD74-2D62-4D19-B5CF-D53A685A64D5.png" alt="img"> </p>
<p>首先，mysql的查询流程大致是：</p>
<ul>
<li><p>mysql客户端通过协议与mysql服务器建连接，发送查询语句，先检查查询缓存，如果命中(一模一样的sql才能命中)，直接返回结果，否则进行语句解析。也就是说，在解析查询之前，服务器会先访问查询缓存(query cache)——它存储SELECT语句以及相应的查询结果集。如果某个查询结果已经位于缓存中，服务器就不会再对查询进行解析、优化、以及执行。它仅仅将缓存中的结果返回给用户即可，这将大大提高系统的性能。</p>
</li>
<li><p>语法解析器和预处理：首先mysql通过关键字将SQL语句进行解析，并生成一颗对应的“解析树”。mysql解析器将使用mysql语法规则验证和解析查询；预处理器则根据一些mysql规则进一步检查解析数是否合法。</p>
</li>
<li><p>查询优化器当解析树被认为是合法的了，并且由优化器将其转化成执行计划。一条查询可以有很多种执行方式，最后都返回相同的结果。优化器的作用就是找到这其中最好的执行计划。</p>
</li>
<li><p>然后，mysql默认使用的BTREE索引，并且一个大致方向是：无论怎么折腾sql，至少在目前来说，mysql最多只用到表中的一个索引。</p>
</li>
</ul>
<hr>
<h3 id="6、存储引擎"><a href="#6、存储引擎" class="headerlink" title="6、存储引擎"></a>6、存储引擎</h3><h4 id="1、存储引擎概述"><a href="#1、存储引擎概述" class="headerlink" title="1、存储引擎概述"></a>1、存储引擎概述</h4><ul>
<li><p>和大多数的数据库不同，MySQL中有一个存储引擎的概念，针对不同的存储需求可以选择最优的存储引擎。</p>
</li>
<li><p><strong>存储引擎就是存储数据，建立索引，更新查询数据等等技术的实现方式</strong> 。</p>
</li>
<li><p><strong>存储引擎是基于表的，而不是基于库的。所以存储引擎也可被称为表类型。所以数据库的每一张表都可以使用不同的存储引擎。</strong></p>
</li>
<li><p><strong>Oracle，SqlServer等数据库只有一种存储引擎</strong>。MySQL提供了插件式的存储引擎架构。所以<strong>MySQL存在多种存储引擎，可以根据需要使用相应引擎，或者编写存储引擎</strong>。</p>
</li>
<li><p>MySQL5.0支持的存储引擎包含 ： <code>InnoDB</code> 、<code>MyISAM</code> 、<code>BDB</code>、<code>MEMORY</code>、<code>MERGE</code>、<code>EXAMPLE</code>、<code>NDB</code> <code>Cluster</code>、<code>ARCHIVE</code>、<code>CSV</code>、<code>BLACKHOLE</code>、<code>FEDERATED</code>等，<strong>其中InnoDB和BDB提供事务安全表，其他存储引擎是非事务安全表。</strong></p>
</li>
</ul>
<p>可以通过指定 <code>show engines</code> ， 来查询当前数据库支持的存储引擎：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551186043529.png" alt="1551186043529"> </p>
<p>创建新表时如果不指定存储引擎，那么系统就会使用默认的存储引擎，<strong>MySQL5.5之前的默认存储引擎是MyISAM，5.5之后就改为了InnoDB。</strong></p>
<p>查看Mysql数据库默认的存储引擎，指令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%storage_engine%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556086372754.png" alt="1556086372754"></p>
<h4 id="2、各种存储引擎特性"><a href="#2、各种存储引擎特性" class="headerlink" title="2、各种存储引擎特性"></a>2、各种存储引擎特性</h4><p>下面重点介绍几种常用的存储引擎， 并对比各个存储引擎之间的区别， 如下表所示 ： </p>
<table>
<thead>
<tr>
<th>特点</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>MEMORY</th>
<th>MERGE</th>
<th>NDB</th>
</tr>
</thead>
<tbody><tr>
<td>存储限制</td>
<td>64TB</td>
<td>有</td>
<td>有</td>
<td>没有</td>
<td>有</td>
</tr>
<tr>
<td>事务安全</td>
<td>==支持==</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>锁机制</td>
<td>==行锁(适合高并发)==</td>
<td>==表锁==</td>
<td>表锁</td>
<td>表锁</td>
<td>行锁</td>
</tr>
<tr>
<td>B树索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>哈希索引</td>
<td></td>
<td></td>
<td>支持</td>
<td></td>
<td></td>
</tr>
<tr>
<td>全文索引</td>
<td>支持(5.6版本之后)</td>
<td>支持</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>集群索引</td>
<td>支持</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>数据索引</td>
<td>支持</td>
<td></td>
<td>支持</td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>索引缓存</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据可压缩</td>
<td></td>
<td>支持</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>空间使用</td>
<td>高</td>
<td>低</td>
<td>N/A</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td>内存使用</td>
<td>高</td>
<td>低</td>
<td>中等</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>批量插入速度</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>支持外键</td>
<td>==支持==（唯一支持外键的存储引擎）</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>下面我们将重点介绍最长使用的两种存储引擎： ==InnoDB==、==MyISAM== ， 另外两种 MEMORY、MERGE ， 了解即可。</p>
<h5 id="1、InnoDB"><a href="#1、InnoDB" class="headerlink" title="1、InnoDB"></a>1、InnoDB</h5><p><strong>InnoDB存储引擎是Mysql的默认存储引擎</strong>。InnoDB存储引擎提供了具有提交、回滚、崩溃恢复能力的事务安全。但是对比MyISAM的存储引擎，InnoDB写的处理效率差一些，并且会占用更多的磁盘空间以保留数据和索引。</p>
<p>InnoDB存储引擎不同于其他存储引擎的特点：</p>
<ul>
<li><p><strong>事务控制</strong></p>
<ul>
<li><pre><code class="sql">create table goods_innodb(
    id int NOT NULL AUTO_INCREMENT,
    name varchar(20) NOT NULL,
    primary key(id)
)ENGINE=innodb DEFAULT CHARSET=utf8;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;sql</span><br><span class="line">  start transaction;</span><br><span class="line">  </span><br><span class="line">  insert into goods_innodb(id,name)values(null,&#39;Meta20&#39;);</span><br><span class="line">  </span><br><span class="line">  commit;</span><br></pre></td></tr></table></figure></code></pre>
</li>
<li><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075130115.png" alt="1556075130115"></p>
</li>
<li><p>测试，发现在InnoDB中是存在事务的</p>
</li>
</ul>
</li>
<li><p><strong>外键约束</strong></p>
<ul>
<li><p>MySQL支持外键的存储引擎只有InnoDB，<strong>在创建外键的时候，要求父表必须有对应的索引，子表在创建外键的时候，也会自动的创建对应的索引。</strong></p>
</li>
<li><p>下面两张表中 ， country_innodb是父表 ， country_id为主键索引，city_innodb表是子表，country_id字段为外键，对应于country_innodb表的主键country_id：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> country_innodb(</span><br><span class="line">	country_id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    country_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    primary <span class="keyword">key</span>(country_id)</span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> city_innodb(</span><br><span class="line">	city_id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    city_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    country_id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    primary <span class="keyword">key</span>(city_id),</span><br><span class="line">    <span class="keyword">key</span> idx_fk_country_id(country_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> <span class="string">`fk_city_country`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(country_id) <span class="keyword">REFERENCES</span> country_innodb(country_id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CASCADE</span></span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> country_innodb <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;China&#x27;</span>),(<span class="literal">null</span>,<span class="string">&#x27;America&#x27;</span>),(<span class="literal">null</span>,<span class="string">&#x27;Japan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> city_innodb <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Xian&#x27;</span>,<span class="number">1</span>),(<span class="literal">null</span>,<span class="string">&#x27;NewYork&#x27;</span>,<span class="number">2</span>),(<span class="literal">null</span>,<span class="string">&#x27;BeiJing&#x27;</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在创建索引时， 可以指定在删除、更新父表时，对子表进行的相应操作</strong>，包括：</p>
<ul>
<li><code>RESTRICT</code></li>
<li><code>CASCADE</code></li>
<li><code>SET NULL</code></li>
<li><code>NO ACTION</code></li>
</ul>
</li>
<li><p>RESTRICT和NO ACTION相同， 是<strong>指限制在子表有关联记录的情况下， 父表不能更新</strong>；</p>
<ul>
<li>如 DELETE RESTRICT ：表示在删除父表当中数据的时候，如果该数据有外键关联着子表的数据的话，则删除失败。</li>
</ul>
</li>
<li><p>CASCADE 表示<strong>父表在更新或者删除时，更新或者删除子表对应的记录；</strong></p>
<ul>
<li>如 UPDATE CASCADE ： 表示在更新父表数据的时候，如果该数据有外键关联着子表的数据的话，则子表的数据也会跟着一起更新。</li>
</ul>
</li>
<li><p>SET NULL 则<strong>表示父表在更新或者删除的时候，子表的对应字段被SET NULL</strong> 。</p>
<ul>
<li>如 DELETE SET NULL ： 表示在删除数据的时候，如果该数据有外键关联着子表的数据的话，则子表对应的数据会被设置为null</li>
</ul>
</li>
<li><p>针对上面创建的两个表， 子表的外键指定是ON DELETE RESTRICT ON UPDATE CASCADE 方式的：</p>
<ul>
<li>ON DELETE RESTRICT：<strong>那么在主表删除记录的时候， 如果子表有对应记录， 则不允许删除</strong>， </li>
<li>ON UPDATE CASCADE：<strong>主表在更新记录的时候， 如果子表有对应记录， 则子表对应更新</strong> 。</li>
</ul>
</li>
<li><p>表中数据如下图所示：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087540767.png" alt="1556087540767"></p>
</li>
<li><p>外键信息可以使用如下两种方式查看：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> city_innodb ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087611295.png" alt="1556087611295"></p>
</li>
<li><p>删除country_id为1 的country数据：(在主表删除记录的时候， 如果子表有对应记录， 则不允许删除)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> country_innodb <span class="keyword">where</span> country_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087719145.png" alt="1556087719145"></p>
</li>
<li><p>更新主表country表的字段 country_id：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> country_innodb <span class="keyword">set</span> country_id = <span class="number">100</span> <span class="keyword">where</span> country_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087759615.png" alt="1556087759615"></p>
</li>
<li><p>更新后， 子表的数据信息为：(主表在更新记录的时候， 如果子表有对应记录， 则子表对应更新)</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556087793738.png" alt="1556087793738"></p>
</li>
</ul>
</li>
<li><p><strong>存储方式</strong></p>
<ul>
<li><p>在Linux环境下，数据库表的数据信息默认存储在 var/lib/mysql 下</p>
</li>
<li><p>InnoDB 存储表和索引有以下两种方式：</p>
<ol>
<li><p><strong>使用共享表空间存储</strong>， 这种方式创建的表的表结构保存在==.frm文件==中， 数据和索引保存在 ==innodb_data_home_dir== 和 ==innodb_data_file_path== 定义的表空间中，可以是多个文件。</p>
</li>
<li><p><strong>使用多表空间存储</strong>， 这种方式创建的表的表结构仍然存在 ==.frm 文件==中，但是每个表的数据和索引单独保存在 ==.ibd== 中。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075336630.png" alt="1556075336630"></p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h5 id="2、MyISAM"><a href="#2、MyISAM" class="headerlink" title="2、MyISAM"></a>2、MyISAM</h5><p>MyISAM 不支持事务、也不支持外键，<strong>其优势是访问的速度快</strong>，<strong>对事务的完整性没有要求或者以SELECT、INSERT为主的应用基本上都可以使用这个引擎来创建表</strong>。</p>
<p>MyISAM有以下两个比较重要的特点：</p>
<ul>
<li><p><strong>不支持事务</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> goods_myisam(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    primary <span class="keyword">key</span>(<span class="keyword">id</span>)</span><br><span class="line">)<span class="keyword">ENGINE</span>=myisam <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901130955510.png" alt="image-20210901130955510"></li>
<li>通过测试，我们发现，就算mysql显示的好像开启了事务，但是在MyISAM存储引擎中，是没有事务控制的，因此就算 start transaction 之后，执行sql在commit之前还是可以执行到mysql数据库当中的。</li>
</ul>
</li>
<li><p><strong>文件存储方式</strong></p>
<ul>
<li><p>每个MyISAM在磁盘上存储成3个文件，其文件名都和表名相同，但拓展名分别是：</p>
<ul>
<li><strong>.frm (存储表定义)</strong></li>
<li><strong>.MYD(MYData , 存储数据)</strong></li>
<li><strong>.MYI(MYIndex , 存储索引)</strong></li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556075073836.png" alt="1556075073836"> </p>
</li>
</ul>
</li>
</ul>
<h5 id="3、MEMORY"><a href="#3、MEMORY" class="headerlink" title="3、MEMORY"></a>3、MEMORY</h5><ul>
<li>Memory存储引擎将表的数据存放在内存中。</li>
<li>每个MEMORY表实际对应一个磁盘文件，格式是==.frm== ，<strong>该文件中只存储表的结构</strong>，而其<strong>数据文件，都是存储在内存中，这样有利于数据的快速处理，提高整个表的效率</strong>。</li>
<li>优点：<strong>MEMORY 类型的表访问非常地快，因为他的数据是存放在内存中的，并且默认使用HASH索引</strong> </li>
<li>缺点：<ul>
<li>但是对于内存来说，存储空间是很宝贵的，因此<strong>MEMORY 类型的表存储的数据量不能很大</strong>；</li>
<li>而且<strong>服务一旦关闭，表中的数据就会丢失</strong>。</li>
</ul>
</li>
</ul>
<h5 id="4、MERGE"><a href="#4、MERGE" class="headerlink" title="4、MERGE"></a>4、MERGE</h5><p><strong>MERGE存储引擎是一组MyISAM表的组合，这些MyISAM表必须结构完全相同，MERGE表本身并没有存储数据，对MERGE类型的表可以进行查询、更新、删除操作，这些操作实际上是对内部的MyISAM表进行的。类似于视图（View）</strong></p>
<p>对于MERGE类型表的插入操作，是通过INSERT_METHOD子句定义插入的表，可以有3个不同的值：</p>
<ol>
<li>使用FIRST 或 LAST 值使得插入操作被相应地作用在第一或者最后一个表上</li>
<li>不定义这个子句或者定义为NO，表示不能对这个MERGE表执行插入操作。</li>
</ol>
<p><strong>可以对MERGE表进行DROP操作，但是这个操作只是删除MERGE表的定义，对内部的表是没有任何影响的。</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556076359503.png" alt="1556076359503"> </p>
<p>下面是一个创建和使用MERGE表的示例：</p>
<ol>
<li><p>创建3个测试表 order_1990，order_1991，order_all，其中order_all是前两个表的MERGE表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> order_1990(</span><br><span class="line">	order_id <span class="built_in">int</span> ,</span><br><span class="line">	order_money <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">	order_address <span class="built_in">varchar</span>(<span class="number">50</span>),</span><br><span class="line">	primary <span class="keyword">key</span> (order_id)</span><br><span class="line">)<span class="keyword">engine</span> = myisam <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> order_1991(</span><br><span class="line">	order_id <span class="built_in">int</span> ,</span><br><span class="line">	order_money <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">	order_address <span class="built_in">varchar</span>(<span class="number">50</span>),</span><br><span class="line">	primary <span class="keyword">key</span> (order_id)</span><br><span class="line">)<span class="keyword">engine</span> = myisam <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> order_all(</span><br><span class="line">	order_id <span class="built_in">int</span> ,</span><br><span class="line">	order_money <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">	order_address <span class="built_in">varchar</span>(<span class="number">50</span>),</span><br><span class="line">	primary <span class="keyword">key</span> (order_id)</span><br><span class="line">)<span class="keyword">engine</span> = <span class="keyword">merge</span> <span class="keyword">union</span> = (order_1990,order_1991) INSERT_METHOD=<span class="keyword">LAST</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别向两张表中插入记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_1990 <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">100.0</span>,<span class="string">&#x27;北京&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_1990 <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">100.0</span>,<span class="string">&#x27;上海&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_1991 <span class="keyword">values</span>(<span class="number">10</span>,<span class="number">200.0</span>,<span class="string">&#x27;北京&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_1991 <span class="keyword">values</span>(<span class="number">11</span>,<span class="number">200.0</span>,<span class="string">&#x27;上海&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询3张表中的数据：</p>
<ul>
<li><p>order_1990中的数据：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408083254.png" alt="1551408083254"></p>
</li>
<li><p>order_1991中的数据：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408133323.png" alt="1551408133323"></p>
</li>
<li><p>order_all中的数据：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408216185.png" alt="1551408216185"></p>
</li>
</ul>
</li>
<li><p>往order_all中插入一条记录，由于在MERGE表定义时，INSERT_METHOD 选择的是LAST，那么插入的数据会想最后一张表中插入。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_all <span class="keyword">values</span>(<span class="number">100</span>,<span class="number">10000.0</span>,<span class="string">&#x27;西安&#x27;</span>)；</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1551408519889.png" alt="1551408519889"> </p>
</li>
</ol>
<h4 id="3、存储引擎的选择"><a href="#3、存储引擎的选择" class="headerlink" title="3、存储引擎的选择"></a>3、存储引擎的选择</h4><p><strong>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</strong></p>
<p>以下是几种常用的存储引擎的使用环境：</p>
<ul>
<li><code>InnoDB</code>：是<strong>Mysql的默认存储引擎，用于事务处理应用程序，支持外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询意外，还包含很多的更新、删除操作，那么InnoDB存储引擎是比较合适的选择</strong>。InnoDB存储引擎除了有效的降低由于删除和更新导致的锁定， 还可以确保事务的完整提交和回滚，对于类似于计费系统或者财务系统等对数据准确性要求比较高的系统，InnoDB是最合适的选择。</li>
<li><code>MyISAM</code> ： 如果应用是以<strong>读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的</strong>。</li>
<li><code>MEMORY</code>：<strong>将所有数据保存在RAM中，在需要快速定位记录和其他类似数据环境下，可以提供几块的访问</strong>。MEMORY的缺陷就是对<strong>表的大小有限制，太大的表无法缓存在内存中</strong>，其次是要<strong>确保表的数据可以恢复，数据库异常终止后表中的数据是可以恢复</strong>的。MEMORY表<strong>通常用于更新不太频繁的小表，用以快速得到访问结果</strong>。</li>
<li><code>MERGE</code>：用于将一系列等同的MyISAM表以逻辑方式组合在一起，并作为一个对象引用他们。MERGE表的优点在于<strong>可以突破对单个MyISAM表的大小限制，并且通过将不同的表分布在多个磁盘上，可以有效的改善MERGE表的访问效率。这对于存储诸如数据仓储等VLDB环境十分合适。</strong></li>
</ul>
<hr>
<h3 id="7、优化SQL步骤"><a href="#7、优化SQL步骤" class="headerlink" title="7、优化SQL步骤"></a>7、优化SQL步骤</h3><p>在应用的的开发过程中，由于初期数据量小，开发人员写 SQL 语句时更重视功能上的实现，但是当应用系统正式上线后，随着生产数据量的急剧增长，很多 SQL 语句开始逐渐显露出性能问题，对生产的影响也越来越大，此时这些有问题的 SQL 语句就成为整个系统性能的瓶颈，因此我们必须要对它们进行优化，这里将详细介绍在 MySQL 中优化 SQL 语句的方法。</p>
<p><strong>当面对一个有 SQL 性能问题的数据库时，我们应该从何处入手来进行系统的分析，使得能够尽快定位问题 SQL 并尽快解决问题</strong>。</p>
<h4 id="1、查看SQL执行频率"><a href="#1、查看SQL执行频率" class="headerlink" title="1、查看SQL执行频率"></a>1、查看SQL执行频率</h4><p>MySQL 客户端连接成功后，通过 <code>show [session|global] status</code> 命令可以提供服务器状态信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> [<span class="keyword">session</span>|<span class="keyword">global</span>] <span class="keyword">status</span>;</span><br></pre></td></tr></table></figure>

<p><code>show [session|global] status</code> 可以根据需要加上参数“session”或者“global”来显示 session 级（当前连接）的计结果和 global 级（自数据库上次启动至今）的统计结果。<strong>如果不写，默认使用参数是“session”。</strong></p>
<p>下面的命令显示了当前 session 中整个数据库所有统计参数的值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 七个下划线</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Com_______&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487172501.png" alt="1552487172501"></p>
<p>下面的命令显示了当前Innodb存储引擎的所有统计参数的值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Innodb_rows_%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901214257185.png" alt="image-20210901214257185"></p>
<p><strong>以上sql语句查询的是当前连接的相关的状态信息，如果想要查看全局的状态信息，即整一个数据库的状态信息，需要在show与status之间加入 global</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Com_______&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Innodb_rows_%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>Com_xxx 表示每个 xxx 语句执行的次数，我们通常比较关心的是以下几个统计参数。</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">==Com_select==</td>
<td>==执行 select 操作的次数，一次查询只累加 1。==</td>
</tr>
<tr>
<td align="left">==Com_insert==</td>
<td>==执行 INSERT 操作的次数，对于批量插入的 INSERT 操作，只累加一次。==</td>
</tr>
<tr>
<td align="left">==Com_update==</td>
<td>==执行 UPDATE 操作的次数。==</td>
</tr>
<tr>
<td align="left">==Com_delete==</td>
<td>==执行 DELETE 操作的次数。==</td>
</tr>
<tr>
<td align="left">Innodb_rows_read</td>
<td>select 查询返回的行数。</td>
</tr>
<tr>
<td align="left">Innodb_rows_inserted</td>
<td>执行 INSERT 操作插入的行数。</td>
</tr>
<tr>
<td align="left">Innodb_rows_updated</td>
<td>执行 UPDATE 操作更新的行数。</td>
</tr>
<tr>
<td align="left">Innodb_rows_deleted</td>
<td>执行 DELETE 操作删除的行数。</td>
</tr>
<tr>
<td align="left">Connections</td>
<td>试图连接 MySQL 服务器的次数。</td>
</tr>
<tr>
<td align="left">Uptime</td>
<td>服务器工作时间。</td>
</tr>
<tr>
<td align="left">Slow_queries</td>
<td>慢查询的次数。</td>
</tr>
</tbody></table>
<ul>
<li><code>Com_***</code>：这些参数对于==所有存储引擎的表操作==都会进行累计。</li>
<li><code>Innodb_***</code>：这几个参数==只是针对InnoDB 存储引擎==的，累加的算法也略有不同。</li>
</ul>
<h4 id="2、定位低效率执行SQL"><a href="#2、定位低效率执行SQL" class="headerlink" title="2、定位低效率执行SQL"></a>2、定位低效率执行SQL</h4><p>可以通过以下两种方式定位执行效率较低的 SQL 语句：</p>
<ul>
<li><strong>慢查询日志</strong>：通过慢查询日志定位那些执行效率较低的 SQL 语句，用<code>--log-slow-queries[=file_name]</code>选项启动时，<strong>mysqld 写一个包含所有执行时间超过 long_query_time 秒的 SQL 语句的日志文件</strong>。具体可以查看日志管理的相关部分。</li>
<li><strong>show processlist</strong>：<strong>慢查询日志在查询结束以后才纪录，所以在应用反映执行效率出现问题的时候查询慢查询日志并不能定位问题，可以使用show processlist命令查看当前MySQL在进行的线程，包括线程的状态、是否锁表等，可以实时地查看 SQL 的执行情况，同时对一些锁表操作进行优化。</strong></li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556098544349.png" alt="1556098544349"></p>
<p>其中几个表头的相关信息：</p>
<ul>
<li><code>id</code>：用户登录mysql时，<strong>系统分配的”connection_id”**，</strong>可以使用函数<code>connection_id()</code>查看**</li>
<li><code>user</code>：显示<strong>当前用户</strong>。如果不是root，这个命令就只显示用户权限范围的sql语句</li>
<li><code>host</code>：显示这个语句是从<strong>哪个ip的哪个端口上发的</strong>，可以用来跟踪出现问题语句的用户</li>
<li><code>db</code>：显示<strong>这个进程目前连接的是哪个数据库</strong></li>
<li><code>command</code>：<strong>显示当前连接的执行的命令</strong>，一般取值为<ul>
<li>休眠（sleep）</li>
<li>查询（query）</li>
<li>连接（connect）等</li>
</ul>
</li>
<li><code>time</code>：显示<strong>这个状态持续的时间，单位是秒</strong></li>
<li><code>state</code>：显示<strong>使用当前连接的sql语句的状态</strong>，很重要的列。<ul>
<li>state描述的是语句执行中的某一个状态。</li>
<li>一个sql语句，以查询为例，可能需要经过：<ol>
<li>copying to tmp table</li>
<li>sorting result</li>
<li>sending data等状态才可以完成</li>
</ol>
</li>
</ul>
</li>
<li><code>info</code>：<strong>显示这个sql语句，是判断问题语句的一个重要依据</strong></li>
</ul>
<h4 id="3、explain分析执行计划"><a href="#3、explain分析执行计划" class="headerlink" title="3、explain分析执行计划"></a>3、explain分析执行计划</h4><p>通过以上步骤查询到效率低的 SQL 语句后，可以通过 <code>EXPLAIN</code> 或者 <code>DESC</code> 命令获取 MySQL如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。</p>
<p>查询SQL语句的执行计划 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487489859.png" alt="1552487489859"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> title = <span class="string">&#x27;阿尔卡特 (OT-979) 冰川白 联通3G手机3&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552487526919.png" alt="1552487526919">  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>select查询的序列号，是一组数字，表示的是查询中执行select子句或者是操作表的顺序。（与表结构的执行顺序有关）</td>
</tr>
<tr>
<td>select_type</td>
<td>表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION 中的第二个或者后面的查询语句）、SUBQUERY（子查询中的第一个 SELECT）等</td>
</tr>
<tr>
<td>table</td>
<td>输出结果集的表</td>
</tr>
<tr>
<td>type</td>
<td>表示表的连接类型，性能由好到差的连接类型为( system  —&gt;  const  —–&gt;  eq_ref  ——&gt;  ref  ——-&gt;  ref_or_null—-&gt;  index_merge  —&gt;  index_subquery  —–&gt;  range  —–&gt;  index  ——&gt; all )</td>
</tr>
<tr>
<td>possible_keys</td>
<td>表示查询时，可能使用的索引</td>
</tr>
<tr>
<td>key</td>
<td>表示实际使用的索引</td>
</tr>
<tr>
<td>key_len</td>
<td>索引字段的长度</td>
</tr>
<tr>
<td>rows</td>
<td>扫描行的数量</td>
</tr>
<tr>
<td>extra</td>
<td>执行情况的说明和描述</td>
</tr>
</tbody></table>
<p>现在对以上字段进行相关说明：</p>
<h5 id="1、环境准备"><a href="#1、环境准备" class="headerlink" title="1、环境准备"></a>1、环境准备</h5><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556122799330.png" alt="1556122799330"> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_role`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_code`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`description`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unique_role_name`</span> (<span class="string">`role_name`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">96</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unique_user_username`</span> (<span class="string">`username`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_role`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> auto_increment ,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`fk_ur_user_id`</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`fk_ur_role_id`</span> (<span class="string">`role_id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`fk_ur_role_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`role_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span>,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`fk_ur_user_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`user_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;super&#x27;</span>,<span class="string">&#x27;$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe&#x27;</span>,<span class="string">&#x27;超级管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe&#x27;</span>,<span class="string">&#x27;系统管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;itcast&#x27;</span>,<span class="string">&#x27;$2a$10$8qmaHgUFUAmPR5pOuWhYWOr291WJYjHelUlYn07k5ELF8ZCrW0Cui&#x27;</span>,<span class="string">&#x27;test02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;stu1&#x27;</span>,<span class="string">&#x27;$2a$10$pLtt2KDAFpwTWLjNsmTEi.oU1yOZyIn9XkziK/y/spH5rftCpUMZa&#x27;</span>,<span class="string">&#x27;学生1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;stu2&#x27;</span>,<span class="string">&#x27;$2a$10$nxPKkYSez7uz2YQYUnwhR.z57km3yqKn3Hr/p1FR6ZKgc18u.Tvqm&#x27;</span>,<span class="string">&#x27;学生2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`t_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`name`</span>) <span class="keyword">values</span>(<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;t1&#x27;</span>,<span class="string">&#x27;$2a$10$TJ4TmCdK.X4wv/tCqHW14.w70U3CC33CeVncD3SLmyMXMknstqKRe&#x27;</span>,<span class="string">&#x27;老师1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>, <span class="string">`role_name`</span>, <span class="string">`role_code`</span>, <span class="string">`description`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;学生&#x27;</span>,<span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;学生&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>, <span class="string">`role_name`</span>, <span class="string">`role_code`</span>, <span class="string">`description`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;老师&#x27;</span>,<span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;老师&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>, <span class="string">`role_name`</span>, <span class="string">`role_code`</span>, <span class="string">`description`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;教学管理员&#x27;</span>,<span class="string">&#x27;teachmanager&#x27;</span>,<span class="string">&#x27;教学管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>, <span class="string">`role_name`</span>, <span class="string">`role_code`</span>, <span class="string">`description`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;管理员&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;管理员&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_role`</span> (<span class="string">`id`</span>, <span class="string">`role_name`</span>, <span class="string">`role_code`</span>, <span class="string">`description`</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;超级管理员&#x27;</span>,<span class="string">&#x27;super&#x27;</span>,<span class="string">&#x27;超级管理员&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_role(<span class="keyword">id</span>,user_id,role_id) <span class="keyword">VALUES</span>(<span class="literal">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>),(<span class="literal">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;7&#x27;</span>),(<span class="literal">NULL</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>),(<span class="literal">NULL</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;9&#x27;</span>),(<span class="literal">NULL</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;8&#x27;</span>),(<span class="literal">NULL</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;10&#x27;</span>) ;</span><br></pre></td></tr></table></figure>

<h5 id="2、explain-之-id"><a href="#2、explain-之-id" class="headerlink" title="2、explain 之 id"></a>2、explain 之 id</h5><p>id 字段是 select查询的序列号，是一组数字，表示的是查询中执行select子句或者是操作表的顺序。</p>
<p>id 情况有三种：</p>
<ol>
<li><p><strong>id 相同表示加载表的顺序是从上到下</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 一次性查询多张表</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_role r, t_user u, user_role ur <span class="keyword">where</span> r.id = ur.role_id <span class="keyword">and</span> u.id = ur.user_id;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556102471304.png" alt="1556102471304"></p>
<p>此例中 先执行where 后的第一条语句 r.id = ur.role_id 通过 r.id 关联 ur.role_id 。 而 ur.role_id 的结果建立在 u.id = ur.user_id 的基础之上。</p>
</li>
<li><p><strong>id 不同id值越大，优先级越高，越先被执行。</strong> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 采用子查询的方式</span></span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_role <span class="keyword">WHERE</span> <span class="keyword">id</span> = (<span class="keyword">SELECT</span> role_id <span class="keyword">FROM</span> user_role <span class="keyword">WHERE</span> user_id = (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> username = <span class="string">&#x27;stu1&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556103009534.png" alt="1556103009534"></p>
</li>
<li><p><strong>id 有相同，也有不同，同时存在</strong>。<strong>id相同的可以认为是一组，从上往下顺序执行；在所有的组中，id的值越大，优先级越高，越先执行。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 既查询了多张表，又进行了子查询</span></span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_role r , (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> user_role ur <span class="keyword">WHERE</span> ur.<span class="string">`user_id`</span> = <span class="string">&#x27;2&#x27;</span>) a <span class="keyword">WHERE</span> r.id = a.role_id ; </span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556103294182.png" alt="1556103294182"></p>
</li>
</ol>
<h5 id="3、explain-之-select-type"><a href="#3、explain-之-select-type" class="headerlink" title="3、explain 之 select_type"></a>3、explain 之 select_type</h5><p>表示 SELECT 的类型，有哪些：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/58EE7C45-EF06-458B-BBAC-89B268FB93A3.png" alt="img"></p>
<p>常见的取值，如下表所示：</p>
<table>
<thead>
<tr>
<th>select_type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SIMPLE</td>
<td>简单的select查询，查询中不包含子查询或者UNION</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>查询中若包含任何复杂的子查询，最外层查询标记为该标识</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>在SELECT 或 WHERE 列表中包含了子查询</td>
</tr>
<tr>
<td>DERIVED</td>
<td>在FROM 列表中包含的子查询，被标记为 DERIVED（衍生） MYSQL会递归执行这些子查询，把结果放在临时表中</td>
</tr>
<tr>
<td>UNION</td>
<td>若第二个SELECT出现在UNION之后，则标记为UNION ； 若UNION包含在FROM子句的子查询中，外层SELECT将被标记为 ： DERIVED</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>从UNION表获取结果的SELECT</td>
</tr>
</tbody></table>
<h6 id="1、select-type-之-SIMPLE"><a href="#1、select-type-之-SIMPLE" class="headerlink" title="1、select_type 之 SIMPLE"></a>1、select_type 之 SIMPLE</h6><p>SIMPLE：简单的select查询，查询中不包含子查询或者UNION</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220448958.png" alt="image-20210901220448958"></p>
<h6 id="2、select-type-之-PRIMARY"><a href="#2、select-type-之-PRIMARY" class="headerlink" title="2、select_type 之 PRIMARY"></a>2、select_type 之 PRIMARY</h6><p>PRIMARY：查询中若包含任何复杂的子查询，最外层查询标记为该标识</p>
<h6 id="3、select-type-之-SUBQUERY"><a href="#3、select-type-之-SUBQUERY" class="headerlink" title="3、select_type 之 SUBQUERY"></a>3、select_type 之 SUBQUERY</h6><p>SUBQUERY：在SELECT 或 WHERE 列表中包含了子查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t_user表是查询的最外层的表，所以t_user表是PRIMARY</span></span><br><span class="line"><span class="comment">-- user_role表是在WHERE 语句当中的子查询当中出现的表，所以user_role表是SUBQUERY</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">id</span> = (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> user_role <span class="keyword">where</span> role_id = <span class="string">&#x27;9&#x27;</span>) ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220550625.png" alt="image-20210901220550625"></p>
<h6 id="4、select-type-之-DERIVED"><a href="#4、select-type-之-DERIVED" class="headerlink" title="4、select_type 之 DERIVED"></a>4、select_type 之 DERIVED</h6><p>DERIVED：在FROM 列表中包含的子查询，被标记为 DERIVED（衍生） MYSQL会递归执行这些子查询，把结果放在临时表中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t_user表是在FROM 列表中包含的子查询当中查询的表，所以t_user表是DERIVED，而生成的临时表就是&lt;derived2&gt;(里面的2表示产生这个临时表的DERIVED的id)</span></span><br><span class="line"><span class="comment">-- 结果从临时表&lt;derived2&gt;当中获取，即临时表&lt;derived2&gt;是最外层的表，因此是PRIMARY</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> a.* <span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)) a;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901220947928.png" alt="image-20210901220947928"></p>
<h6 id="5、select-type-之-UNION"><a href="#5、select-type-之-UNION" class="headerlink" title="5、select_type 之 UNION"></a>5、select_type 之 UNION</h6><p>UNION：若第二个SELECT出现在UNION之后，则标记为UNION ； 若UNION包含在FROM子句的子查询中，外层SELECT将被标记为 ： DERIVED</p>
<h6 id="6、select-type-之-UNION-RESULT"><a href="#6、select-type-之-UNION-RESULT" class="headerlink" title="6、select_type 之 UNION RESULT"></a>6、select_type 之 UNION RESULT</h6><p>UNION RESULT：从UNION表获取结果的SELECT</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t_user表是查询的最外层的表，所以t_user表是PRIMARY</span></span><br><span class="line"><span class="comment">-- 在union之后也查询了t_user表，所以在id=2的t_user表是UNION</span></span><br><span class="line"><span class="comment">-- &lt;union1,2&gt;表是连接了id=1与id=2的两张t_user表的结果表，标记为UNION RESULT</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">&#x27;1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">&#x27;2&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901221658084.png" alt="image-20210901221658084"></p>
<h6 id="7、其他不常见的类型：select-type-之-DEPENDENT-SUBQUERY"><a href="#7、其他不常见的类型：select-type-之-DEPENDENT-SUBQUERY" class="headerlink" title="7、其他不常见的类型：select_type 之 DEPENDENT SUBQUERY"></a>7、其他不常见的类型：select_type 之 DEPENDENT SUBQUERY</h6><p>DEPENDENT SUBQUERY：<strong>在SELECT或WHERE列表中包含了子查询，子查询基于外层</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2F45DD10-6247-4FC7-A7DA-509AE0D9C949.png" alt="img"></p>
<p>dependent subquery 与 subquery 的区别：</p>
<ul>
<li>dependent subquery（依赖子查询） ： <strong>子查询结果为 多值</strong></li>
<li>subquery （子查询）：<strong>查询结果为 单值</strong> </li>
</ul>
<h6 id="8、其他不常见的类型：select-type-之-UNCACHEABLE-SUBQUREY"><a href="#8、其他不常见的类型：select-type-之-UNCACHEABLE-SUBQUREY" class="headerlink" title="8、其他不常见的类型：select_type 之 UNCACHEABLE SUBQUREY"></a>8、其他不常见的类型：select_type 之 UNCACHEABLE SUBQUREY</h6><p>UNCACHEABLE SUBQUREY：无法被缓存的子查询</p>
<p>@@ 表示查的环境参数 。没办法缓存</p>
<h5 id="4、explain-之-table"><a href="#4、explain-之-table" class="headerlink" title="4、explain 之 table"></a>4、explain 之 table</h5><p><strong>展示这一行的数据是关于哪一张表的</strong> </p>
<h5 id="5、explain-之-type"><a href="#5、explain-之-type" class="headerlink" title="5、explain 之 type"></a>5、explain 之 type</h5><p>type 显示的是访问类型，是较为重要的一个指标，可取值为：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>NULL</td>
<td>MySQL不访问任何表，索引，直接返回结果</td>
</tr>
<tr>
<td>system</td>
<td>表只有一行记录(等于系统表)，这是const类型的特例，一般不会出现</td>
</tr>
<tr>
<td>const</td>
<td>表示通过索引一次就找到了，const 用于比较primary key 或者 unique 索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL 就能将该查询转换为一个常量。const于将 “主键” 或 “唯一” 索引的所有部分与常量值进行比较</td>
</tr>
<tr>
<td>eq_ref</td>
<td>类似ref，区别在于使用的是唯一索引，使用主键的关联查询，关联查询出的记录只有一条。常见于主键或唯一索引扫描</td>
</tr>
<tr>
<td>ref</td>
<td>非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，返回所有匹配某个单独值的所有行（多个）</td>
</tr>
<tr>
<td>range</td>
<td>只检索给定返回的行，使用一个索引来选择行。 where 之后出现 between ， &lt; , &gt; , in 等操作。</td>
</tr>
<tr>
<td>index</td>
<td>index 与 ALL的区别为  index 类型只是遍历了索引树， 通常比ALL 快， ALL 是遍历数据文件。</td>
</tr>
<tr>
<td>all</td>
<td>将遍历全表以找到匹配的行</td>
</tr>
</tbody></table>
<p>结果值从最好到最坏以此是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NULL &gt; system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</span><br></pre></td></tr></table></figure>

<p>==一般来说， 我们需要保证查询至少达到 range 级别， 最好达到ref 。==</p>
<p>相关补充：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>index_merge</td>
<td>在查询过程中需要多个索引组合使用，通常出现在有 or 的关键字的sql中</td>
</tr>
<tr>
<td>ref_or_null</td>
<td>对于某个字段既需要关联条件，也需要null值得情况下。查询优化器会选择用ref_or_null连接查询。</td>
</tr>
<tr>
<td>index_subquery</td>
<td>利用索引来关联子查询，不再全表扫描。</td>
</tr>
<tr>
<td>unique_subquery</td>
<td>该联接类型类似于index_subquery。 子查询中的唯一索引</td>
</tr>
</tbody></table>
<h6 id="1、type-之-NULL"><a href="#1、type-之-NULL" class="headerlink" title="1、type 之 NULL"></a>1、type 之 NULL</h6><p>NULL：<strong>MySQL不访问任何表，索引，直接返回结果</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223108340.png" alt="image-20210901223108340"></p>
<h6 id="2、type-之-system"><a href="#2、type-之-system" class="headerlink" title="2、type 之 system"></a>2、type 之 system</h6><p>system：<strong>表只有一行记录</strong>(等于系统表)，这是const类型的特例，一般不会出现</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223220731.png" alt="image-20210901223220731"></p>
<h6 id="3、type-之-const"><a href="#3、type-之-const" class="headerlink" title="3、type 之 const"></a>3、type 之 const</h6><p>const：表示<strong>通过索引一次就找到了</strong>，<strong>const 用于比较primary key 或者 unique 索引</strong>。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL 就能将该查询转换为一个常量。<strong>const于将 “主键” 或 “唯一” 索引的所有部分与常量值进行比较</strong></p>
<p>通过比较primary key</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223310082.png" alt="image-20210901223310082"></p>
<p>通过比较unique 索引</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223455304.png" alt="image-20210901223455304"></p>
<h6 id="4、type-之-eq-ref"><a href="#4、type-之-eq-ref" class="headerlink" title="4、type 之 eq_ref"></a>4、type 之 eq_ref</h6><p>eq_ref：类似ref，区别在于<strong>使用的是唯一索引，使用主键的关联查询，关联查询出的记录只有一条</strong>。常见于<strong>主键或唯一索引扫描</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223635631.png" alt="image-20210901223635631"></p>
<h6 id="5、type-之-ref"><a href="#5、type-之-ref" class="headerlink" title="5、type 之 ref"></a>5、type 之 ref</h6><p>ref：<strong>非唯一性索引扫描，返回匹配某个单独值的所有行</strong>。本质上也是一种索引访问，返回所有匹配某个单独值的所有行（多个）</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223819993.png" alt="image-20210901223819993"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223749200.png" alt="image-20210901223749200"></p>
<h6 id="6、type-之-range"><a href="#6、type-之-range" class="headerlink" title="6、type 之 range"></a>6、type 之 range</h6><p>range：<strong>只检索给定返回的行，使用一个索引来选择行</strong>。 <strong>where 之后出现 between ， &lt; , &gt; , in 等操作。</strong></p>
<h6 id="7、type-之-index"><a href="#7、type-之-index" class="headerlink" title="7、type 之 index"></a>7、type 之 index</h6><p>index：index 与 ALL的区别为  <strong>index 类型只是遍历了索引树</strong>， 通常比ALL 快， ALL 是遍历数据文件。</p>
<p>查询的是id主键，mysql的主键默认有着主键索引：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223945702.png" alt="image-20210901223945702"></p>
<h6 id="8、type-之-all"><a href="#8、type-之-all" class="headerlink" title="8、type 之 all"></a>8、type 之 all</h6><p>all：<strong>将遍历全表以找到匹配的行</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901223912058.png" alt="image-20210901223912058"></p>
<h6 id="9、补充：type-之-index-merge"><a href="#9、补充：type-之-index-merge" class="headerlink" title="9、补充：type 之 index_merge"></a>9、补充：type 之 index_merge</h6><p>index_merge：在查询过程中需要多个索引组合使用，通常出现在有 or 的关键字的sql中</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/B908FE0F-38A4-437D-8B2A-42816B4DFF77.png" alt="img"></p>
<h6 id="10、补充：type-之-ref-or-null"><a href="#10、补充：type-之-ref-or-null" class="headerlink" title="10、补充：type 之 ref_or_null"></a>10、补充：type 之 ref_or_null</h6><p>ref_or_null：对于某个字段既需要关联条件，也需要null值得情况下。查询优化器会选择用ref_or_null连接查询。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F999ECF8-4C11-4FC6-AFFD-7697C63DB330.png" alt="img"></p>
<h6 id="11、补充：type-之-index-subquery"><a href="#11、补充：type-之-index-subquery" class="headerlink" title="11、补充：type 之 index_subquery"></a>11、补充：type 之 index_subquery</h6><p>index_subquery：利用索引来关联子查询，不再全表扫描。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/39476597-2608-4416-98CB-775466C83A8E.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/DCFEFA94-52FF-4813-AA4C-6094258C541B.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F1902368-4ED6-4EE2-B671-0F89898CC9DE.png" alt="img"></p>
<h6 id="12、-补充：type-之-unique-subquery"><a href="#12、-补充：type-之-unique-subquery" class="headerlink" title="12、 补充：type 之 unique_subquery"></a>12、 补充：type 之 unique_subquery</h6><p>unique_subquery：该联接类型类似于index_subquery。 子查询中的唯一索引</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/97901539-47E1-4BFA-8C4C-D9FC427208D6.png" alt="img"></p>
<h5 id="6、explain-之-key"><a href="#6、explain-之-key" class="headerlink" title="6、explain 之  key"></a>6、explain 之  key</h5><ul>
<li><code>possible_keys</code>：显示==可能==应用在这张表的索引， 一个或多个。 </li>
<li><code>key</code>：==实际使用==的索引， 如果为NULL， 则没有使用索引。</li>
<li><code>key_len</code>：表示==索引中使用的字节数==， 该值为索引字段最大可能长度，<strong>并非实际使用长度</strong>，即key_len是根据表定义计算而得，不是通过表内检索出的<ul>
<li><strong>在不损失精确性的前提下， 长度越短越好，越短执行效率越高。</strong></li>
</ul>
</li>
</ul>
<h6 id="1、key-len的长度如何计算"><a href="#1、key-len的长度如何计算" class="headerlink" title="1、key_len的长度如何计算"></a>1、key_len的长度如何计算</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> emp.deptno=<span class="number">109</span> <span class="keyword">AND</span> emp.<span class="string">`ename`</span>=<span class="string">&#x27;AvDEjl&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/23865FCE-17F9-4DC0-920C-54BC901560DA.png" alt="img"> </p>
<p>如何计算</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3C02A74F-0036-4B42-B5CB-F7A3E7B158A4.png" alt="img"> </p>
<p>总结一下：char(30) utf8 –&gt; key_len = 30*3 +1 表示:</p>
<ul>
<li>utf8 格式需要 *3 (跟数据类型有关)  </li>
<li>允许为 NULL +1 ，不允许 +0</li>
<li>动态类型 +2 (动态类型包括 : varchar , detail text() 截取字符窜)</li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/26689C8D-E3D2-439A-8183-AF75895D292D.png" alt="img"> </p>
<ul>
<li>第一组：key_len = deptno(int) + null + ename(varchar(20) * 3 + 动态) = 4 + 1+ 20 * 3 + 2= 67</li>
<li>第二组：key_len = deptno(int) + null = 4 + 1 = 5</li>
</ul>
<h5 id="7、explain-之-rows"><a href="#7、explain-之-rows" class="headerlink" title="7、explain 之 rows"></a>7、explain 之 rows</h5><p><strong>rows列显示MySQL认为它执行查询时必须检查的行数。</strong> <strong>越少越好</strong></p>
<h5 id="8、explain-之-extra"><a href="#8、explain-之-extra" class="headerlink" title="8、explain 之 extra"></a>8、explain 之 extra</h5><p>其他的额外的执行计划信息，在该列展示 。</p>
<table>
<thead>
<tr>
<th>extra</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong>using  filesort</strong></td>
<td>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取， 称为 “文件排序”, 效率低。</td>
</tr>
<tr>
<td><strong>using  temporary</strong></td>
<td>使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于 order by 和 group by； 效率低</td>
</tr>
<tr>
<td><strong>using  index</strong></td>
<td>表示相应的select操作使用了覆盖索引， 避免访问表的数据行， 效率不错。</td>
</tr>
<tr>
<td>Using where</td>
<td>表明使用了where过滤</td>
</tr>
<tr>
<td>using join buffer</td>
<td>使用了连接缓存：</td>
</tr>
<tr>
<td>impossible where</td>
<td>where子句的值总是false，不能用来获取任何元组</td>
</tr>
<tr>
<td>select tables optimized away</td>
<td>在没有GROUPBY子句的情况下，基于索引优化MIN/MAX操作或者</td>
</tr>
<tr>
<td>distinct</td>
<td>优化distinct操作，在找到第一匹配的元祖后即停止找同样值的动作</td>
</tr>
</tbody></table>
<p>如果出现的是前面两个，就需要考虑优化了，因为前面那两个是非常耗费性能的。如果出现的是最后一个，则需要保持，因为使用到了索引，性能较高。</p>
<h6 id="1、extra-之-using-filesort（重要）"><a href="#1、extra-之-using-filesort（重要）" class="headerlink" title="1、extra 之 using  filesort（重要）"></a>1、extra 之 using  filesort（重要）</h6><p>using  filesort：说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取， 称为 “文件排序”；效率低。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224456653.png" alt="image-20210901224456653"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224517422.png" alt="image-20210901224517422"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224657926.png" alt="image-20210901224657926"></p>
<h6 id="2、extra-之-using-temporary（重要）"><a href="#2、extra-之-using-temporary（重要）" class="headerlink" title="2、extra 之 using  temporary（重要）"></a>2、extra 之 using  temporary（重要）</h6><p>using  temporary：使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于 order by 和 group by；效率低</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901224752479.png" alt="image-20210901224752479"></p>
<h6 id="3、extra-之-using-index（重要）"><a href="#3、extra-之-using-index（重要）" class="headerlink" title="3、extra 之 using  index（重要）"></a>3、extra 之 using  index（重要）</h6><p>using  index：表示相应的select操作使用了覆盖索引，避免访问表的数据行，效率不错。</p>
<ul>
<li>如果同时出现using where，表明索引被用来执行索引键值的查找;</li>
<li>如果没有同时出现using where，表明索引只是用来读取数据而非利用索引执行查找。</li>
</ul>
<p>**覆盖索引(Covering Index)**：</p>
<p>索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。</p>
<ol>
<li>==一个索引==</li>
<li>==包含了(或覆盖了)[select子句]与查询条件[Where子句]中==</li>
<li>==所有需要的字段就叫做覆盖索引==。</li>
</ol>
<p>上句理解：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> , <span class="keyword">name</span> <span class="keyword">from</span> t_xxx <span class="keyword">where</span> age=<span class="number">18</span>;</span><br></pre></td></tr></table></figure>

<p>有一个组合索引 <code>idx_id_name_age_xxx</code> 包含了(覆盖了)，id,name,age三个字段。查询时直接将建立了索引的列读取出来了，而不需要去查找所在行的其他数据。所以很高效。</p>
<p>(个人认为：在数据量较大，固定字段查询情况多时可以使用这种方法。)</p>
<p>注意：</p>
<ul>
<li>*<em>如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select **</em>，</li>
<li>因为<strong>如果将所有字段一起做索引会导致索引文件过大，查询性能下降</strong>。</li>
</ul>
<h6 id="4、extra-之-using-join-buffer（了解）"><a href="#4、extra-之-using-join-buffer（了解）" class="headerlink" title="4、extra 之 using join buffer（了解）"></a>4、extra 之 using join buffer（了解）</h6><p>using join buffer：使用了连接缓存</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0DE5EE4B-CA7F-436B-8192-AAF861E8FD96.png" alt="img"> </p>
<p>出现在当两个连接时：</p>
<ul>
<li>驱动表(被连接的表，left join 左边的表。inner join 中数据少的表) 没有索引的情况下，给驱动表建立索引可解决此问题。且 type 将改变成 ref</li>
</ul>
<h6 id="5、extra-之-impossible-where（了解）"><a href="#5、extra-之-impossible-where（了解）" class="headerlink" title="5、extra 之 impossible where（了解）"></a>5、extra 之 impossible where（了解）</h6><p>impossible where：where子句的值总是false，不能用来获取任何元组</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/C66165E8-B8CB-4BBB-9FBB-954F72737323.png" alt="img"></p>
<h4 id="4、show-profile分析SQL"><a href="#4、show-profile分析SQL" class="headerlink" title="4、show profile分析SQL"></a>4、show profile分析SQL</h4><p>Mysql从5.0.37版本开始增加了对 show profiles 和 show profile 语句的支持。<strong>show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。</strong></p>
<p>通过 <code>have_profiling</code> 参数，<strong>能够看到当前MySQL是否支持profile</strong>：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552488401999.png" alt="1552488401999"> </p>
<p><strong>默认profiling是关闭的，可以通过set语句在Session级别开启profiling</strong>：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552488372405.png" alt="1552488372405"> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启profiling 开关；</span></span><br><span class="line"><span class="keyword">set</span> profiling = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>通过profile，我们能够更清楚地了解SQL执行的过程。</p>
<p>首先，我们可以执行一系列的操作，如下图所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> db01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> <span class="keyword">id</span> &lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tb_item;</span><br></pre></td></tr></table></figure>

<p>执行完上述命令之后，再执行show profiles 指令， 来查看SQL语句执行的耗时：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489017940.png" alt="1552489017940">  </p>
<p>通过show  profile for  query  query_id 语句可以查看到该SQL执行过程中每个线程的状态和消耗的时间：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489053763.png" alt="1552489053763"> </p>
<blockquote>
<p> 注意：Sending data 状态表示==MySQL线程开始访问数据行并把结果返回给客户端==，而不仅仅是返回个客户端。由于在Sending data状态下，MySQL线程往往需要做大量的磁盘读取操作，所以经常是整各查询中耗时最长的状态。</p>
</blockquote>
<p>在获取到最消耗时间的线程状态后，MySQL支持进一步选择<code>all</code>、<code>cpu</code>、<code>block io</code> 、<code>context switch</code>、<code>page faults</code>等明细类型类查看MySQL在使用什么资源上耗费了过高的时间。</p>
<p>例如，选择查看CPU的耗费时间  ：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552489671119.png" alt="1552489671119"> </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Status</td>
<td>sql 语句执行的状态</td>
</tr>
<tr>
<td>Duration</td>
<td>sql 执行过程中每一个步骤的耗时</td>
</tr>
<tr>
<td>CPU_user</td>
<td>当前用户占有的cpu</td>
</tr>
<tr>
<td>CPU_system</td>
<td>系统占有的cpu</td>
</tr>
</tbody></table>
<h4 id="5、trace分析优化器执行计划"><a href="#5、trace分析优化器执行计划" class="headerlink" title="5、trace分析优化器执行计划"></a>5、trace分析优化器执行计划</h4><p>MySQL5.6提供了对SQL的跟踪trace，通过trace文件能够进一步了解为什么优化器选择A计划，而不是选择B计划。</p>
<p><strong>打开trace，设置格式为 JSON，并设置trace最大能够使用的内存大小,避免解析过程中因为默认内存过小而不能够完整展示</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> optimizer_trace=<span class="string">&quot;enabled=on&quot;</span>,end_markers_in_json=<span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">set</span> optimizer_trace_max_mem_size=<span class="number">1000000</span>;</span><br></pre></td></tr></table></figure>

<p>执行SQL语句 ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> <span class="keyword">id</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p>最后， 检查<code>information_schema.optimizer_trace</code>就可以知道MySQL是如何执行SQL的 ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.optimizer_trace\G;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">QUERY: select * from tb_item where id &lt; 4</span><br><span class="line">TRACE: &#123;</span><br><span class="line">  &quot;steps&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_preparation&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;expanded_query&quot;</span>: <span class="string">&quot;/* select#1 */ select `tb_item`.`id` AS `id`,`tb_item`.`title` AS `title`,`tb_item`.`price` AS `price`,`tb_item`.`num` AS `num`,`tb_item`.`categoryid` AS `categoryid`,`tb_item`.`status` AS `status`,`tb_item`.`sellerid` AS `sellerid`,`tb_item`.`createtime` AS `createtime`,`tb_item`.`updatetime` AS `updatetime` from `tb_item` where (`tb_item`.`id` &lt; 4)&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_preparation */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* steps */</span></span><br><span class="line">            &#125; <span class="comment">/* condition_processing */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;table_dependencies&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`tb_item`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;row_may_be_null&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;map_bit&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;depends_on_map_bits&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* depends_on_map_bits */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* table_dependencies */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;ref_optimizer_key_uses&quot;</span>: [</span><br><span class="line">            ] <span class="comment">/* ref_optimizer_key_uses */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`tb_item`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;range_analysis&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;rows&quot;</span>: <span class="number">9816098</span>,</span><br><span class="line">                    <span class="attr">&quot;cost&quot;</span>: <span class="number">2.04e6</span></span><br><span class="line">                  &#125; <span class="comment">/* table_scan */</span>,</span><br><span class="line">                  <span class="attr">&quot;potential_range_indices&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                      <span class="attr">&quot;key_parts&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;id&quot;</span></span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* potential_range_indices */</span>,</span><br><span class="line">                  <span class="attr">&quot;setup_range_conditions&quot;</span>: [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  <span class="attr">&quot;group_index_range&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_group_by_or_distinct&quot;</span></span><br><span class="line">                  &#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  <span class="attr">&quot;analyzing_range_alternatives&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_scan_alternatives&quot;</span>: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                          <span class="string">&quot;id &lt; 4&quot;</span></span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        <span class="attr">&quot;index_dives_for_eq_ranges&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">&quot;rowid_ordered&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">&quot;using_mrr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;index_only&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;rows&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                        <span class="attr">&quot;cost&quot;</span>: <span class="number">1.6154</span>,</span><br><span class="line">                        <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    ] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">                    <span class="attr">&quot;analyzing_roworder_intersect&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;too_few_roworder_scans&quot;</span></span><br><span class="line">                    &#125; <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">                  &#125; <span class="comment">/* analyzing_range_alternatives */</span>,</span><br><span class="line">                  <span class="attr">&quot;chosen_range_access_summary&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_access_plan&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;range_scan&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                      <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;id &lt; 4&quot;</span></span><br><span class="line">                      ] <span class="comment">/* ranges */</span></span><br><span class="line">                    &#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">                    <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                    <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">1.6154</span>,</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                  &#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">                &#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* rows_estimation */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;considered_execution_plans&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;plan_prefix&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`tb_item`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;best_access_path&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;considered_access_paths&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;range&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                      <span class="attr">&quot;cost&quot;</span>: <span class="number">2.2154</span>,</span><br><span class="line">                      <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">                &#125; <span class="comment">/* best_access_path */</span>,</span><br><span class="line">                <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">2.2154</span>,</span><br><span class="line">                <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* considered_execution_plans */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_computation&quot;</span>: [</span><br><span class="line">              ] <span class="comment">/* attached_conditions_computation */</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_summary&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`tb_item`&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;attached&quot;</span>: <span class="string">&quot;(`tb_item`.`id` &lt; 4)&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* attached_conditions_summary */</span></span><br><span class="line">            &#125; <span class="comment">/* attaching_conditions_to_tables */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;refine_plan&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`tb_item`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;range&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* refine_plan */</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_optimization */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_execution&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_execution */</span></span><br><span class="line">    &#125;</span><br><span class="line">  ] /* steps */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8、索引的使用"><a href="#8、索引的使用" class="headerlink" title="8、索引的使用"></a>8、索引的使用</h3><p><strong>索引是数据库优化最常用也是最重要的手段之一</strong>，通过索引通常可以帮助用户解决大多数的MySQL的性能优化问题。</p>
<h4 id="1、验证索引提升查询效率"><a href="#1、验证索引提升查询效率" class="headerlink" title="1、验证索引提升查询效率"></a>1、验证索引提升查询效率</h4><p>在我们准备的表结构tb_item 中， 一共存储了 300 万记录；</p>
<h5 id="1、根据ID查询"><a href="#1、根据ID查询" class="headerlink" title="1、根据ID查询"></a>1、根据ID查询</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1999</span>\G;</span><br></pre></td></tr></table></figure>

<p>查询速度很快， 接近0s ， 主要的原因是因为id为主键， 有索引；</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225426139.png" alt="image-20210901225426139"></p>
<p>查看SQL语句的执行计划：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225525932.png" alt="image-20210901225525932"></p>
<h5 id="2、根据-title-进行精确查询"><a href="#2、根据-title-进行精确查询" class="headerlink" title="2、根据 title 进行精确查询"></a>2、根据 title 进行精确查询</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> title = <span class="string">&#x27;iphoneX 移动3G 32G941&#x27;</span>\G; </span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225650475.png" alt="image-20210901225650475"></p>
<p>查看SQL语句的执行计划：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225744561.png" alt="image-20210901225744561"></p>
<p>处理方案 ， 针对title字段， 创建索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_item_title <span class="keyword">on</span> tb_item(title);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225830193.png" alt="image-20210901225830193"></p>
<p>索引创建完成之后，再次进行查询：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225903333.png" alt="image-20210901225903333"></p>
<p>通过explain ， 查看执行计划，执行SQL时使用了刚才创建的索引：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901225936532.png" alt="image-20210901225936532"></p>
<h4 id="2、索引的使用"><a href="#2、索引的使用" class="headerlink" title="2、索引的使用"></a>2、索引的使用</h4><h5 id="1、准备环境"><a href="#1、准备环境" class="headerlink" title="1、准备环境"></a>1、准备环境</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`tb_seller`</span> (</span><br><span class="line">    <span class="string">`sellerid`</span> <span class="built_in">varchar</span> (<span class="number">100</span>),</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span> (<span class="number">100</span>),</span><br><span class="line">    <span class="string">`nickname`</span> <span class="built_in">varchar</span> (<span class="number">50</span>),</span><br><span class="line">    <span class="string">`password`</span> <span class="built_in">varchar</span> (<span class="number">60</span>),</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">varchar</span> (<span class="number">1</span>),</span><br><span class="line">    <span class="string">`address`</span> <span class="built_in">varchar</span> (<span class="number">100</span>),</span><br><span class="line">    <span class="string">`createtime`</span> datetime,</span><br><span class="line">    primary <span class="keyword">key</span>(<span class="string">`sellerid`</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8mb4; </span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;alibaba&#x27;</span>,<span class="string">&#x27;阿里巴巴&#x27;</span>,<span class="string">&#x27;阿里小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;baidu&#x27;</span>,<span class="string">&#x27;百度科技有限公司&#x27;</span>,<span class="string">&#x27;百度小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;huawei&#x27;</span>,<span class="string">&#x27;华为科技有限公司&#x27;</span>,<span class="string">&#x27;华为小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;itcast&#x27;</span>,<span class="string">&#x27;传智播客教育科技有限公司&#x27;</span>,<span class="string">&#x27;传智播客&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;itheima&#x27;</span>,<span class="string">&#x27;黑马程序员&#x27;</span>,<span class="string">&#x27;黑马程序员&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;luoji&#x27;</span>,<span class="string">&#x27;罗技科技有限公司&#x27;</span>,<span class="string">&#x27;罗技小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;oppo&#x27;</span>,<span class="string">&#x27;OPPO科技有限公司&#x27;</span>,<span class="string">&#x27;OPPO官方旗舰店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;ourpalm&#x27;</span>,<span class="string">&#x27;掌趣科技股份有限公司&#x27;</span>,<span class="string">&#x27;掌趣小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;qiandu&#x27;</span>,<span class="string">&#x27;千度科技&#x27;</span>,<span class="string">&#x27;千度小店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;sina&#x27;</span>,<span class="string">&#x27;新浪科技有限公司&#x27;</span>,<span class="string">&#x27;新浪官方旗舰店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;xiaomi&#x27;</span>,<span class="string">&#x27;小米科技&#x27;</span>,<span class="string">&#x27;小米官方旗舰店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;西安市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`tb_seller`</span> (<span class="string">`sellerid`</span>, <span class="string">`name`</span>, <span class="string">`nickname`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`address`</span>, <span class="string">`createtime`</span>) <span class="keyword">values</span>(<span class="string">&#x27;yijia&#x27;</span>,<span class="string">&#x27;宜家家居&#x27;</span>,<span class="string">&#x27;宜家家居旗舰店&#x27;</span>,<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>,<span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建name,status,address的复合索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_name_sta_addr <span class="keyword">on</span> tb_seller(<span class="keyword">name</span>,<span class="keyword">status</span>,address);</span><br></pre></td></tr></table></figure>

<h5 id="2、避免索引失效"><a href="#2、避免索引失效" class="headerlink" title="2、避免索引失效"></a>2、避免索引失效</h5><h6 id="1、全值匹配-，对索引中所有列都指定具体值"><a href="#1、全值匹配-，对索引中所有列都指定具体值" class="headerlink" title="1、全值匹配 ，对索引中所有列都指定具体值"></a>1、全值匹配 ，对索引中所有列都指定具体值</h6><p>该情况下，索引生效，执行效率高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 对索引中所有列(name,status,address)都指定具体值</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tb_seller <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">&#x27;小米科技&#x27;</span> <span class="keyword">and</span> <span class="keyword">status</span>=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> address=<span class="string">&#x27;北京市&#x27;</span>\G;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556170997921.png" alt="1556170997921"> </p>
<h6 id="2、最左前缀法则"><a href="#2、最左前缀法则" class="headerlink" title="2、最左前缀法则"></a>2、最左前缀法则</h6><p>如果索引了多列，即复合索引，要遵守最左前缀法则。<strong>指的是查询从索引的最左前列开始，并且不跳过索引中的列</strong>。</p>
<p>注意：</p>
<ul>
<li>创建的复合索引为name,status,address的复合索引，在该表中会创建三个索引：<ul>
<li>idx_seller_name：name的索引——对应的索引长度为：403</li>
<li>idx_seller_name_sta：name与status的索引——对应的索引长度为：410</li>
<li>idx_seller_name_sta_addr：name、status与address的索引——对应的索引长度为：813</li>
</ul>
</li>
</ul>
<ul>
<li><p>匹配最左前缀法则，走索引：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171348995.png" alt="1556171348995"></p>
</li>
<li><p>把name放在最后面，走索引：（与where之后的条件先后顺序没有关系，只与查询条件有无有关）</p>
<ul>
<li>and 忽略左右关系。既即使没有没有按顺序 由于优化器的存在，会自动优化。</li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901141116945.png" alt="image-20210901141116945"></p>
</li>
<li><p>违法最左前缀法则 ， 索引失效：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171428140.png" alt="1556171428140"></p>
</li>
<li><p>如果符合最左法则，但是出现跳跃某一列，只有最左列索引生效：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556171662203.png" alt="1556171662203"></p>
</li>
</ul>
<p>节点比较排序是先比较第一列，第一列相同就比较第二列，接着第三列，以此类推。所以不使用第一列的话，后面就乱序了，走不了索引。</p>
<p>举一个简单的例子：走楼层</p>
<ul>
<li>对应的三个索引就是上层楼：<ul>
<li>name——第一层</li>
<li>name&amp;status——第二层</li>
<li>name$status$address——第三层</li>
</ul>
</li>
<li>匹配最左前缀法则，走索引——成功走到楼顶</li>
<li>违法最左前缀法则 ， 索引失效<ul>
<li>只是使用了status或者address：未走第一层楼就想走到第二层楼或者第三层楼——失败</li>
<li>同时使用了status与address：也是一样，走第一层楼就想走到第二层楼和第三层楼——失败</li>
</ul>
</li>
<li>如果符合最左法则，但是出现跳跃某一列，只有最左列索引生效<ul>
<li>同时使用了name与address：走了第一层，但是没走第二层就想到第三层楼——第一层楼成功，第二第三层楼失败</li>
</ul>
</li>
</ul>
<h6 id="3、范围查询右边的列，不能使用索引"><a href="#3、范围查询右边的列，不能使用索引" class="headerlink" title="3、范围查询右边的列，不能使用索引"></a>3、范围查询右边的列，不能使用索引</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172256791.png" alt="1556172256791"> </p>
<p>根据前面的两个字段name ， status 查询是走索引的， 但是最后一个条件address 没有用到索引。</p>
<h6 id="4、不要在索引列上进行运算操作，-索引将失效"><a href="#4、不要在索引列上进行运算操作，-索引将失效" class="headerlink" title="4、不要在索引列上进行运算操作， 索引将失效"></a>4、不要在索引列上进行运算操作， 索引将失效</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172813715.png" alt="1556172813715"> </p>
<h6 id="5、字符串不加单引号，造成索引失效"><a href="#5、字符串不加单引号，造成索引失效" class="headerlink" title="5、字符串不加单引号，造成索引失效"></a>5、字符串不加单引号，造成索引失效</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556172967493.png" alt="1556172967493"> </p>
<p>由于在查询时，没有对字符串加单引号，MySQL的查询优化器，会自动的进行类型转换（隐式类型转换），造成索引失效（底层对索引进行了运算操作）。</p>
<h6 id="6、尽量使用覆盖索引，避免select"><a href="#6、尽量使用覆盖索引，避免select" class="headerlink" title="6、尽量使用覆盖索引，避免select *"></a>6、尽量使用覆盖索引，避免<code>select *</code></h6><p>尽量使用覆盖索引（只访问索引的查询（索引列完全包含查询列）），减少select * 。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556173928299.png" alt="1556173928299"> </p>
<p>如果查询列，超出索引列，也会降低性能。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556173986068.png" alt="1556173986068"></p>
<p> 注意：</p>
<ul>
<li><code>using index</code>：使用覆盖索引的时候就会出现</li>
<li><code>using where</code>：在查找使用索引的情况下，需要回表去查询所需的数据</li>
<li><code>using index condition</code>：查找使用了索引，但是索引只是记录当前索引值的数据，需要回表查询其他数据<br>（回调查询）</li>
<li><code>using index ; using where</code>：查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询数据</li>
</ul>
<h6 id="7、用or分割开的条件，-如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到"><a href="#7、用or分割开的条件，-如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到" class="headerlink" title="7、用or分割开的条件， 如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到"></a>7、用or分割开的条件， 如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到</h6><p>示例，name字段是索引列 ， 而createtime不是索引列，中间是or进行连接是不走索引的 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tb_seller <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">&#x27;黑马程序员&#x27;</span> <span class="keyword">or</span> createtime = <span class="string">&#x27;2088-01-01 12:00:00&#x27;</span>\G;	</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556174994440.png" alt="1556174994440"> </p>
<h6 id="8、以-开头的Like模糊查询，索引失效"><a href="#8、以-开头的Like模糊查询，索引失效" class="headerlink" title="8、以%开头的Like模糊查询，索引失效"></a>8、以%开头的Like模糊查询，索引失效</h6><p>如果仅仅是尾部模糊匹配，索引不会失效。如果是头部模糊匹配，索引失效。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556175114369.png" alt="1556175114369"> </p>
<p>解决方案 ： </p>
<p>通过覆盖索引来解决 </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556247686483.png" alt="1556247686483"> </p>
<h6 id="9、如果MySQL评估使用索引比全表更慢，则不使用索引"><a href="#9、如果MySQL评估使用索引比全表更慢，则不使用索引" class="headerlink" title="9、如果MySQL评估使用索引比全表更慢，则不使用索引"></a>9、如果MySQL评估使用索引比全表更慢，则不使用索引</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556175445210.png" alt="1556175445210"> </p>
<h6 id="10、is-NULL-，-is-NOT-NULL-有时索引失效"><a href="#10、is-NULL-，-is-NOT-NULL-有时索引失效" class="headerlink" title="10、is  NULL ， is NOT NULL  有时索引失效"></a>10、is  NULL ， is NOT NULL  <font color="red">有时</font>索引失效</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556180634889.png" alt="1556180634889">  </p>
<p>mysql底层会判定该字段中的数据大部分是null还是not null：</p>
<ul>
<li>如果大部分是not null，则使用is NOT NULL 的时候查询的是大部分数据，mysql底层会评估使用索引比全表更慢，则不使用索引，使用全表扫描；同理，如果使用的是is NULL的话，查询的是少量数据，这时候mysql使用索引查询的效率会比全表扫描高，使用mysql会使用索引。</li>
<li>而且因为这里是select * 查询全部数据，如果使用了索引，那么还需要回表查询索引匹配的其他数据，速度上还不如直接全表扫描。</li>
</ul>
<h6 id="11、in-走索引，-not-in-索引失效"><a href="#11、in-走索引，-not-in-索引失效" class="headerlink" title="11、in 走索引， not in 索引失效"></a>11、in 走索引， not in 索引失效</h6><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556249602732.png" alt="1556249602732">  </p>
<h6 id="12、-单列索引和复合索引"><a href="#12、-单列索引和复合索引" class="headerlink" title="12、 单列索引和复合索引"></a>12、 单列索引和复合索引</h6><p>尽量使用复合索引，而少使用单列索引 。</p>
<p>创建复合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_name_sta_address <span class="keyword">on</span> tb_seller(<span class="keyword">name</span>, <span class="keyword">status</span>, address);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 就相当于创建了三个索引 ： </span></span><br><span class="line">	<span class="comment">-- name</span></span><br><span class="line">	<span class="comment">-- name + status</span></span><br><span class="line">	<span class="comment">-- name + status + address</span></span><br></pre></td></tr></table></figure>

<p>创建单列索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_name <span class="keyword">on</span> tb_seller(<span class="keyword">name</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_status <span class="keyword">on</span> tb_seller(<span class="keyword">status</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_address <span class="keyword">on</span> tb_seller(address);</span><br></pre></td></tr></table></figure>

<ul>
<li>数据库会选择一个最优的索引（辨识度最高索引）来使用，并不会使用全部索引 。<ul>
<li>最优索引：表中的数据辨识度，辨识度越高，索引越优。（当查询的常量在表中只有一条数据，此时的辨识度是很高的）</li>
</ul>
</li>
<li>3个单列索引对应3个b+tree数据结构，通过索引查找只能以一个b+tree为标准来查，所以就算可能涉及到多个索引，但是只能使用一个索引。</li>
</ul>
<h6 id="13、mysql-在使用不等于-或者-lt-gt-的时候无法使用索引会导致全表扫描"><a href="#13、mysql-在使用不等于-或者-lt-gt-的时候无法使用索引会导致全表扫描" class="headerlink" title="13、mysql 在使用不等于(!= 或者&lt;&gt;)的时候无法使用索引会导致全表扫描"></a>13、mysql 在使用不等于(!= 或者&lt;&gt;)的时候无法使用索引会导致全表扫描</h6><p>索引：</p>
<ul>
<li>idx_nameAgeJob</li>
<li>idx_name</li>
</ul>
<p>使用 != 和&lt;&gt;的字段索引失效( != 针对数值类型。 针对字符类型 != 针对数值类型)</p>
<p>前提 where and 后的字段在混合索引中的位置比当前字段靠后 where age != 10 and name=’xxx’，这种情况下，mysql自动优化，将 name=’xxx’ 放在 age ！=10 之前，name 依然能使用索引。只是 age 的索引失效)</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/99E8047C-D2AE-4931-8491-848B270EE55C.png" alt="img"> </p>
<h5 id="3、一般性建议"><a href="#3、一般性建议" class="headerlink" title="3、一般性建议"></a>3、一般性建议</h5><ul>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。(避免索引过滤性好的索引失效)</li>
<li>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
</ul>
<h5 id="4、查看索引使用情况"><a href="#4、查看索引使用情况" class="headerlink" title="4、查看索引使用情况"></a>4、查看索引使用情况</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前会话的索引情况</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Handler_read%&#x27;</span>;	</span><br><span class="line"><span class="comment">-- 查看全局的索引情况</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Handler_read%&#x27;</span>;	</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1552885364563.png" alt="1552885364563"></p>
<ul>
<li> <code>Handler_read_first</code>：<strong>索引中第一条被读的次数。如果较高，表示服务器正执行大量全索引扫描（这个值越低越好）。</strong></li>
<li><code>Handler_read_key</code>：<strong>如果索引正在工作，这个值代表一个行被索引值读的次数，如果值越低，表示索引得到的性能改善不高，因为索引不经常使用（这个值越高越好）</strong>。</li>
<li><code>Handler_read_next</code>：<strong>按照键顺序读下一行的请求数</strong>。如果你用范围约束或如果执行索引扫描来查询索引列，该值增加。</li>
<li><code>Handler_read_prev</code>：<strong>按照键顺序读前一行的请求数</strong>。该读方法<strong>主要用于优化ORDER BY … DESC</strong>。</li>
<li><code>Handler_read_rnd</code>：<strong>根据固定位置读一行的请求数</strong>。如果你正执行大量查询并需要对结果进行排序该值较高。你可能使用了大量需要MySQL扫描整个表的查询或你的连接没有正确使用键。<strong>这个值较高，意味着运行效率低，应该建立索引来补救</strong>。</li>
<li><code>Handler_read_rnd_next</code>：<strong>在数据文件中读下一行的请求数</strong>。如果你正进行大量的表扫描，该值较高。<strong>通常说明你的表索引不正确或写入的查询没有利用索引</strong>。</li>
</ul>
<hr>
<h3 id="9、SQL优化"><a href="#9、SQL优化" class="headerlink" title="9、SQL优化"></a>9、SQL优化</h3><p>什么时候需要用到SQL优化？</p>
<p>步骤：</p>
<ol>
<li>查询优化</li>
<li>观察，至少跑1天，看看生产的慢SQL情况。</li>
<li>开启慢查询日志，设置阙值，比如超过5秒钟的就是慢SQL，并将它抓取出来。</li>
<li>explain+慢SQL分析</li>
<li>show profile</li>
<li>运维经理or DBA，进行SQL数据库服务器的参数调优。</li>
</ol>
<p>优化原则：<strong>小表驱动大表</strong>（原理：RBO）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> B)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于:</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> B</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> A.id = B.id</span><br></pre></td></tr></table></figure>

<p><strong>当B表的数据集必须小于A表的数据集时，用in优于exists。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id = A.id)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于：</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> A</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> B <span class="keyword">where</span> B.id = A.id</span><br></pre></td></tr></table></figure>

<p><strong>当A表的数据集系小于B表的数据集时，用exists优于in。</strong></p>
<p>注意：<strong>A表与B表的ID字段应建立索引。</strong></p>
<ul>
<li><p>EXISTS</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> .. <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (subquery)</span><br></pre></td></tr></table></figure>

<p>该语法可以理解为:将主查询的数据，放到子查询中做条件验证，根据验证结果(TRUE或FALSE)来决定主查询的数据结果是否得以保留。</p>
</li>
<li><p>提示：</p>
<ol>
<li>*<em>EXISTS (subquery)只返回TRUE或FALSE，因此子查询中的SELECT <em>也可以是SELECT 1或select’X’，官方说法是实际执行时会忽略SELECT清单，因此没有区别</em></em></li>
<li><strong>EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比</strong>，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</li>
<li><strong>EXISTS子查询往往也可以用条件表达式、其他子查询或者JOIN来替代，何种最优需要具体问题具体分析</strong></li>
</ol>
</li>
</ul>
<h4 id="1、大批量插入数据"><a href="#1、大批量插入数据" class="headerlink" title="1、大批量插入数据"></a>1、大批量插入数据</h4><p>环境准备 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 两个表示一模一样的，一个用来测试有顺序的插入，一个用来测试没有顺序的插入</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tb_user_1`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">96</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`birthday`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`qq`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户状态&#x27;</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unique_user_username`</span> (<span class="string">`username`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tb_user_2`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">96</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`birthday`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`qq`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户状态&#x27;</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unique_user_username`</span> (<span class="string">`username`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ;</span><br></pre></td></tr></table></figure>

<p>当使用load 命令导入数据的时候，适当的设置可以提高导入的效率。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556269346488.png" alt="1556269346488"> </p>
<p>对于 InnoDB 类型的表，有以下几种方式可以提高导入的效率：</p>
<h5 id="1、主键顺序插入"><a href="#1、主键顺序插入" class="headerlink" title="1、主键顺序插入"></a>1、主键顺序插入</h5><p><strong>因为InnoDB类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效的提高导入数据的效率（底层使用的是B+树）</strong>。如果InnoDB表没有主键，那么系统会自动默认创建一个内部列作为主键，所以如果可以给表创建一个主键，将可以利用这点，来提高导入数据的效率。</p>
<blockquote>
<p>脚本文件介绍：</p>
<ul>
<li>sql1.log  —-&gt; 主键有序</li>
<li>sql2.log  —-&gt; 主键无序</li>
</ul>
</blockquote>
<p>插入ID顺序排列数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 记忆：load（加载） data（数据） 到本地文件 + 本地文件地址 into table（到哪一张表） + 表名 fields （属性） 之间的 terminated（分隔符）by 确定的分隔符 + lines（行）之间的 terminated（分隔符）by 确定的分隔符</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> <span class="keyword">infile</span> <span class="string">&#x27;/root/sql1.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> <span class="string">&#x27;tb_user_1&#x27;</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> <span class="keyword">lines</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555771750567.png" alt="1555771750567"></p>
<p>插入ID无序排列数据：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555771959734.png" alt="1555771959734"> </p>
<h5 id="2、关闭唯一性校验"><a href="#2、关闭唯一性校验" class="headerlink" title="2、关闭唯一性校验"></a>2、关闭唯一性校验</h5><p>如果保证自己数据没问题，在导入数据前执行 SET UNIQUE_CHECKS=0，关闭唯一性校验，在导入结束后执行SET UNIQUE_CHECKS=1，恢复唯一性校验，可以提高导入的效率。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555772132736.png" alt="1555772132736"> </p>
<h5 id="3、手动提交事务"><a href="#3、手动提交事务" class="headerlink" title="3、手动提交事务"></a>3、手动提交事务</h5><p>如果应用使用自动提交的方式，建议在导入前执行 SET AUTOCOMMIT=0，关闭自动提交，导入结束后再执行 SET AUTOCOMMIT=1，打开自动提交，也可以提高导入的效率。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555772351208.png" alt="1555772351208"></p>
<h4 id="2、优化-insert-语句"><a href="#2、优化-insert-语句" class="headerlink" title="2、优化 insert 语句"></a>2、优化 insert 语句</h4><p>当进行数据的insert操作的时候，可以考虑采用以下几种优化方案：</p>
<ol>
<li><p><strong>如果需要同时对一张表插入很多行数据时，应该尽量使用多个值表的insert语句</strong>，这种方式将大大的缩减客户端与数据库之间的连接、关闭等消耗。使得效率比分开执行的单个insert语句快。</p>
<p>示例， 原始方式为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>优化后的方案为 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>)，(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在事务中进行数据插入</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>数据有序插入</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;Tim&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;Rose&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>优化后</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;Tim&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;Rose&#x27;</span>);</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h4 id="3、优化-order-by-语句"><a href="#3、优化-order-by-语句" class="headerlink" title="3、优化 order by 语句"></a>3、优化 order by 语句</h4><h5 id="1、环境准备-1"><a href="#1、环境准备-1" class="headerlink" title="1、环境准备"></a>1、环境准备</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`emp`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`salary`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;2300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;Jerry&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;3500&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;Luci&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;2800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;Jay&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;3500&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;Tom2&#x27;</span>,<span class="string">&#x27;21&#x27;</span>,<span class="string">&#x27;2200&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;Jerry2&#x27;</span>,<span class="string">&#x27;31&#x27;</span>,<span class="string">&#x27;3300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;Luci2&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;2700&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;Jay2&#x27;</span>,<span class="string">&#x27;33&#x27;</span>,<span class="string">&#x27;3500&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;Tom3&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;2400&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;Jerry3&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;3100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;Luci3&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;2900&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="string">`emp`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`salary`</span>) <span class="keyword">values</span>(<span class="string">&#x27;12&#x27;</span>,<span class="string">&#x27;Jay3&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;4500&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_emp_age_salary <span class="keyword">on</span> emp(age,salary);</span><br></pre></td></tr></table></figure>

<h5 id="2、两种排序方式"><a href="#2、两种排序方式" class="headerlink" title="2、两种排序方式"></a>2、两种排序方式</h5><h6 id="1、filesort-排序"><a href="#1、filesort-排序" class="headerlink" title="1、filesort 排序"></a>1、filesort 排序</h6><p>第一种是通过<strong>对返回数据进行排序</strong>，也就是通常说的 filesort 排序，<strong>所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序。</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556335817763.png" alt="1556335817763"> </p>
<h6 id="2、using-index"><a href="#2、using-index" class="headerlink" title="2、using index"></a>2、using index</h6><p>第二种通过<strong>有序索引顺序扫描直接返回有序数据</strong>，这种情况即为 using index，不需要额外排序，操作效率高。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556335866539.png" alt="1556335866539"> </p>
<p>多字段排序</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556336352061.png" alt="1556336352061"> </p>
<p>了解了MySQL的排序方式，优化目标就清晰了：</p>
<ul>
<li>尽量减少额外的排序，通过索引直接返回有序数据。</li>
<li>where 条件和Order by 使用相同的索引，并且Order By 的顺序和索引顺序相同，</li>
<li>并且Order  by 的字段都是升序，或者都是降序。否则肯定需要额外的操作，这样就会出现FileSort。</li>
</ul>
<h5 id="3、Filesort-的优化"><a href="#3、Filesort-的优化" class="headerlink" title="3、Filesort 的优化"></a>3、Filesort 的优化</h5><p><strong>通过创建合适的索引，能够减少 Filesort 的出现，但是在某些情况下，条件限制不能让Filesort消失，那就需要加快 Filesort的排序操作。</strong></p>
<p>对于Filesort ， MySQL 有两种排序算法：</p>
<ol>
<li>两次扫描算法：MySQL4.1 之前，使用该方式排序。<strong>首先根据条件取出排序字段和行指针信息，然后在排序区 sort buffer 中排序，如果sort buffer不够，则在临时表 temporary table 中存储排序结果（一次扫描）。完成排序之后，再根据行指针回表读取记录（两次扫描），该操作可能会导致大量随机I/O操作。</strong><ul>
<li>多路排序需要借助 磁盘来进行排序。所以 取数据，排好了取数据。两次 io操作。比较慢</li>
</ul>
</li>
<li>一次扫描算法：<strong>一次性取出满足条件的所有字段，然后在排序区 sort  buffer 中排序后直接输出结果集</strong>。<strong>排序时内存开销较大，但是排序效率比两次扫描算法要高</strong>。<ul>
<li>单路排序 ，将排好的数据存在内存中，省去了一次 io 操作，所以比较快，但是需要内存空间足够。</li>
<li>但是用单路也有它的问题：<ul>
<li>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出，所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取取sort_buffer容量大小，再排……从而多次I/O。</li>
<li>本来想省一次I/O操作，反而导致了大量的I/O操作，反而得不偿失。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>MySQL 通过比较系统变量 <code>max_length_for_sort_data</code> 的大小和==Query语句取出的字段总大小==， <strong>来判定是否那种排序算法，如果max_length_for_sort_data 更大，那么使用第二种优化之后的算法；否则使用第一种。</strong></p>
<p>可以<strong>适当提高 sort_buffer_size  和 max_length_for_sort_data  系统变量，来增大排序区的大小，提高排序的效率。</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556338367593.png" alt="1556338367593"> </p>
<h4 id="4、优化-group-by-语句"><a href="#4、优化-group-by-语句" class="headerlink" title="4、优化 group by 语句"></a>4、优化 group by 语句</h4><p><strong>由于GROUP BY 实际上也同样会进行排序操作，而且与ORDER BY 相比，GROUP BY 主要只是多了排序之后的分组操作</strong>。当然，如果在分组的时候还使用了其他的一些聚合函数，那么还需要一些聚合函数的计算。所以，在GROUP BY 的实现过程中，与 ORDER BY 一样也可以利用到索引。</p>
<p>如果查询包含 group by 但是用户想要避免排序结果的消耗， 则<strong>可以执行order by null 禁止排序</strong>。如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> idx_emp_age_salary <span class="keyword">on</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> age,<span class="keyword">count</span>(*) <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> age;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339573979.png" alt="1556339573979">  </p>
<p>优化后：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> age,<span class="keyword">count</span>(*) <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> age <span class="keyword">order</span> <span class="keyword">by</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339633161.png" alt="1556339633161">  </p>
<p>从上面的例子可以看出，第一个SQL语句需要进行”filesort”，而第二个SQL由于order  by  null 不需要进行 “filesort”， 而上文提过Filesort往往非常耗费时间。</p>
<p>创建索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_emp_age_salary <span class="keyword">on</span> emp(age,salary)；</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556339688158.png" alt="1556339688158"> </p>
<p>一些建议：</p>
<ul>
<li>group by实质是先排序后进行分组，遵照<strong>索引建的最佳左前缀</strong></li>
<li>当无法使用索引列，<strong>增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置</strong></li>
<li><strong>where高于having，能写在where限定的条件就不要去having限定了。</strong></li>
</ul>
<h4 id="5、优化嵌套查询"><a href="#5、优化嵌套查询" class="headerlink" title="5、优化嵌套查询"></a>5、优化嵌套查询</h4><h5 id="1、使用join替代子查询"><a href="#1、使用join替代子查询" class="headerlink" title="1、使用join替代子查询"></a>1、使用join替代子查询</h5><p>Mysql4.1版本之后，开始支持SQL的子查询。这个技术可以使用SELECT语句来创建一个单列的查询结果，然后把这个结果作为过滤条件用在另一个查询中。<strong>使用子查询可以一次性的完成很多逻辑上需要多个步骤才能完成的SQL操作，同时也可以避免事务或者表锁死，并且写起来也很容易。</strong>但是，<strong>有些情况下，子查询是可以被更高效的连接（JOIN）替代。</strong></p>
<p>示例 ，查找有角色的所有的用户信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> user_id <span class="keyword">from</span> user_role );</span><br></pre></td></tr></table></figure>

<p>执行计划为：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556359399199.png" alt="1556359399199">   </p>
<p>优化后：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_user u , user_role ur <span class="keyword">where</span> u.id = ur.user_id;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556359482142.png" alt="1556359482142">   </p>
<p>连接(Join)查询之所以更有效率一些 ，是因为<strong>MySQL不需要在内存中创建临时表来完成这个逻辑上需要两个步骤的查询工作。</strong></p>
<h5 id="2、where-之后使用的是-用in-还是-exists"><a href="#2、where-之后使用的是-用in-还是-exists" class="headerlink" title="2、where 之后使用的是 用in 还是 exists"></a>2、where 之后使用的是 <code>用in 还是 exists</code></h5><h6 id="1、实验"><a href="#1、实验" class="headerlink" title="1、实验"></a>1、实验</h6><p>1、有索引&amp;大表驱动小表</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6EA2B1C8-9496-4AA2-917F-673978CB5403.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7B2D5228-E6FE-447D-8EEB-D2233274B32E.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/AEDCBEC9-5D08-48E2-BC0D-DD1E500448B4.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/4C8427B0-21FB-4D1A-AD44-AF3E0ACCF358.png" alt="img"></p>
<p>2、有索引&amp;小表驱动大表</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/116420CA-77C2-4F3C-99F5-45B90CE54FE8.png" alt="img"></p>
<p>结论：有索引 <strong>小驱动大表 性能优于 大表驱动小表</strong></p>
<p>3、无索引&amp;小表驱动大表</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/8066FB45-E00E-4BA3-8354-C43A3550A6BE.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0512F62F-7EA1-48E7-891F-4236AA861B2C.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/A910A719-08BE-4035-8962-564CFC7F65BD.png" alt="img"></p>
<p>4、无索引&amp;大表驱动小表</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1772360F-4AAD-41D3-B042-DC7CBF56754C.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/63ADA277-3A11-4668-9CB2-ED2D0D55CD06.png" alt="img"> </p>
<h6 id="3、结论"><a href="#3、结论" class="headerlink" title="3、结论"></a>3、结论</h6><ul>
<li><strong>有索引的情况下 用 inner join 是最好的 其次是 in ，exists最糟糕</strong></li>
<li>无索引的情况下用：<ul>
<li><strong>小表驱动大表</strong> 因为join 方式需要distinct ，没有索引distinct消耗性能较大 </li>
<li>所以 exists性能最佳 in其次 join性能最差</li>
</ul>
</li>
<li>无索引的情况下大表驱动小表<ul>
<li>in 和 exists 的性能应该是接近的 都比较糟糕 exists稍微好一点 超不过5%   但是inner join 优于使用了 join buffer 所以快很多</li>
<li>如果left join 则最慢</li>
</ul>
</li>
</ul>
<h4 id="6、优化OR条件"><a href="#6、优化OR条件" class="headerlink" title="6、优化OR条件"></a>6、优化OR条件</h4><p><strong>对于包含OR的查询子句，如果要利用索引，则OR之间的每个条件列都必须用到索引 ， 而且==不能使用到复合索引，要使用单列索引==； 如果没有索引，则应该考虑增加索引。</strong></p>
<p>获取 emp 表中的所有的索引：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354464657.png" alt="1556354464657">  </p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span> <span class="keyword">or</span> age = <span class="number">30</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354887509.png" alt="1556354887509"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556354920964.png" alt="1556354920964">  </p>
<p>建议使用 union 替换 or：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556355027728.png" alt="1556355027728"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901151907930.png" alt="image-20210901151907930"></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901151933870.png" alt="image-20210901151933870"></p>
<p>我们来比较下重要指标，发现主要差别是 type 和 ref 这两项</p>
<p>type 显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null  &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</span><br></pre></td></tr></table></figure>

<p>UNION 语句的 type 值为 ref，OR 语句的 type 值为 range，可以看到这是一个很明显的差距</p>
<p>UNION 语句的 ref 值为 const，OR 语句的 type 值为 null，const 表示是常量值引用，非常快</p>
<p>这两项的差距就说明了 <strong>UNION 要优于 OR</strong> 。</p>
<h4 id="7、优化分页查询"><a href="#7、优化分页查询" class="headerlink" title="7、优化分页查询"></a>7、优化分页查询</h4><p>一般分页查询时，通过<strong>创建覆盖索引能够比较好地提高性能</strong>。一个常见又非常头疼的问题就是 limit 2000000,10  ，此时需要MySQL排序前2000010 记录，仅仅返回2000000 - 2000010 的记录，其他记录丢弃，因此使用limit进行分页查询的时候，越往后，耗费的时间越长，查询排序的代价就越大 。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556361314783.png" alt="1556361314783"> </p>
<h5 id="1、优化思路一"><a href="#1、优化思路一" class="headerlink" title="1、优化思路一"></a>1、优化思路一</h5><p><strong>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容</strong>。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556416102800.png" alt="1556416102800"> </p>
<h5 id="2、优化思路二"><a href="#2、优化思路二" class="headerlink" title="2、优化思路二"></a>2、优化思路二</h5><p>该方案适用于==主键自增==的表，可以把Limit 查询转换成某个位置的查询 。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556363928151.png" alt="1556363928151"> </p>
<p>一般来说思路二要比思路一要简单而且效率要好，但是思路二有许多的限制：</p>
<ul>
<li>主键自增</li>
<li>不能出现断层</li>
</ul>
<h4 id="8、优化单表查询"><a href="#8、优化单表查询" class="headerlink" title="8、优化单表查询"></a>8、优化单表查询</h4><h5 id="1、建表SQL"><a href="#1、建表SQL" class="headerlink" title="1、建表SQL"></a>1、建表SQL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`article`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT,</span><br><span class="line"><span class="string">`author_id`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`category_id`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`views`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`comments`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`title`</span> VARBINARY(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`article`</span>(<span class="string">`author_id`</span>, <span class="string">`category_id`</span>, <span class="string">`views`</span>, <span class="string">`comments`</span>, <span class="string">`title`</span>, <span class="string">`content`</span>) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>),</span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> article;</span><br></pre></td></tr></table></figure>

<h5 id="2、案例"><a href="#2、案例" class="headerlink" title="2、案例"></a>2、案例</h5><p>查询 category_id 为1 且 comments 大于 1 的情况下，views 最多的 article_id。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>结论：很显然，type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort，也是最坏的情况。优化是必须的。</p>
<p>开始优化：</p>
<ol>
<li><p>新建索引+删除索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ALTER TABLE `article` ADD INDEX idx_article_ccv ( `category_id` , `comments`, `views` );</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_article_ccv <span class="keyword">on</span> article(category_id,comments,views);</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> idx_article_ccv <span class="keyword">ON</span> article</span><br></pre></td></tr></table></figure>
</li>
<li><p>第2次EXPLAIN</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> <span class="string">`article`</span> <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt;<span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>结论：type 变成了 range,这是可以忍受的。但是 extra 里使用 Using filesort 仍是无法接受的。</p>
<p>但是我们已经建立了索引，为啥没用呢?</p>
<ul>
<li>这是因为按照 BTree 索引的工作原理，先排序 category_id，如果遇到相同的 category_id 则再排序 comments，如果遇到相同的 comments 则再排序 views。</li>
<li>当 comments 字段在联合索引里处于中间位置时，因comments &gt; 1 条件是一个范围值(所谓 range)，MySQL 无法利用索引再对后面的 views 部分进行检索，即 range 类型查询字段后面的索引无效。</li>
</ul>
</li>
<li><p>删除第一次建立的索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> idx_article_ccv <span class="keyword">ON</span> article;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第2次新建索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ALTER TABLE `article` ADD INDEX idx_article_cv ( `category_id` , `views` ) ;</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_article_cv <span class="keyword">on</span> article(category_id,views);</span><br></pre></td></tr></table></figure>
</li>
<li><p>第3次EXPLAIN</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>结论：可以看到，type 变为了 ref，Extra 中的 Using filesort 也消失了，结果非常理想。</p>
</li>
</ol>
<h4 id="9、优化关联查询"><a href="#9、优化关联查询" class="headerlink" title="9、优化关联查询"></a>9、优化关联查询</h4><h5 id="1、建表SQL-1"><a href="#1、建表SQL-1" class="headerlink" title="1、建表SQL"></a>1、建表SQL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`class`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"><span class="string">`card`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`book`</span> (</span><br><span class="line"><span class="string">`bookid`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"><span class="string">`card`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`bookid`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<h5 id="2、案例-1"><a href="#2、案例-1" class="headerlink" title="2、案例"></a>2、案例</h5><p>下面开始explain分析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card;</span><br></pre></td></tr></table></figure>

<p>结论：type 有All</p>
<p>添加索引优化：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`book`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> Y ( <span class="string">`card`</span>);</span><br></pre></td></tr></table></figure>

<p>第2次explain：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card;</span><br></pre></td></tr></table></figure>

<p>结论：可以看到第二行的 type 变为了 ref，rows 也变成了优化比较明显。</p>
<p>这是由左连接特性决定的。LEFT JOIN 条件用于确定如何从右表搜索行，左边一定都有，所以右边是我们的关键点,一定需要建立索引。</p>
<h5 id="3、建议"><a href="#3、建议" class="headerlink" title="3、建议"></a>3、建议</h5><ol>
<li><p>保证**==被驱动表==的join字段已经被索引**</p>
<ul>
<li>被驱动表 join 后的表为被驱动表 (需要被查询)</li>
</ul>
</li>
<li><p>left join 时，<strong>选择小表作为驱动表，大表作为被驱动表</strong>。(原则：<strong>小表驱动大表</strong>)</p>
<ul>
<li>left join 时一定是左边是驱动表，右边是被驱动表</li>
</ul>
</li>
<li><p><strong>inner join 时，mysql会自己帮你把小结果集的表选为驱动表</strong>。</p>
</li>
<li><p>子查询尽量不要放在被驱动表，有可能使用不到索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	a.name,bc.name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	t_emp a </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">	(<span class="keyword">select</span> </span><br><span class="line">     	b.id,c.name </span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">     	t_dept b</span><br><span class="line">     <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">     	t_emp c </span><br><span class="line">     <span class="keyword">on</span> b.ceo = c.id)</span><br><span class="line"><span class="keyword">on</span> bc.id = a.deptid;</span><br></pre></td></tr></table></figure>

<p>上段查询中用到了子查询，必然 bc 表没有索引。肯定会进行全表扫描</p>
<p>上段查询 可以直接使用 两个 left join 优化：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name , c.name <span class="keyword">from</span> t_emp a</span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptid = b.id</span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> t_emp c <span class="keyword">on</span> b.ceo=c.id</span><br></pre></td></tr></table></figure>

<p>所有条件都可以使用到索引</p>
<p>若必须用到子查询，可将子查询设置为驱动表。</p>
<ul>
<li><strong>因为驱动表的type 肯定是 all，而子查询返回的结果表没有索引，必定也是all</strong></li>
</ul>
</li>
</ol>
<h4 id="8、使用SQL提示"><a href="#8、使用SQL提示" class="headerlink" title="8、使用SQL提示"></a>8、使用SQL提示</h4><p>SQL提示，是优化数据库的一个重要手段，简单来说，就是<strong>在SQL语句中加入一些人为的提示来达到优化操作的目的</strong>。</p>
<h5 id="1、USE-INDEX"><a href="#1、USE-INDEX" class="headerlink" title="1、USE INDEX"></a>1、USE INDEX</h5><p>在查询语句中表名的后面，添加 use index 来提供希望MySQL去==参考==的索引列表（数据库不一定使用），就可以让MySQL不再考虑其他可用的索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_name <span class="keyword">on</span> tb_seller(<span class="keyword">name</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556370971576.png" alt="1556370971576"> </p>
<h5 id="2、IGNORE-INDEX"><a href="#2、IGNORE-INDEX" class="headerlink" title="2、IGNORE INDEX"></a>2、IGNORE INDEX</h5><p>如果用户只是单纯的想让MySQL忽略一个或者多个索引，则可以使用 ignore index 作为 hint 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tb_seller <span class="keyword">ignore</span> <span class="keyword">index</span>(idx_seller_name) <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">&#x27;小米科技&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556371004594.png" alt="1556371004594"> </p>
<h5 id="3、FORCE-INDEX"><a href="#3、FORCE-INDEX" class="headerlink" title="3、FORCE INDEX"></a>3、FORCE INDEX</h5><p>为强制MySQL使用一个特定的索引，可在查询中使用 force index 作为hint 。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_seller_address <span class="keyword">on</span> tb_seller(address);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556371355788.png" alt="1556371355788"> </p>
<hr>
<h3 id="10、应用优化"><a href="#10、应用优化" class="headerlink" title="10、应用优化"></a>10、应用优化</h3><p>前面章节，我们介绍了很多数据库的优化措施。但是在实际生产环境中，由于数据库本身的性能局限，就必须要对前台的应用进行一些优化，来降低数据库的访问压力。</p>
<h4 id="1、使用连接池"><a href="#1、使用连接池" class="headerlink" title="1、使用连接池"></a>1、使用连接池</h4><p>对于访问数据库来说，建立连接的代价是比较昂贵的，因为我们频繁的创建关闭连接，是比较耗费资源的，我们有必要建立 数据库连接池，以提高访问的性能。</p>
<h4 id="2、减少对MySQL的访问"><a href="#2、减少对MySQL的访问" class="headerlink" title="2、减少对MySQL的访问"></a>2、减少对MySQL的访问</h4><h5 id="1、避免对数据进行重复检索"><a href="#1、避免对数据进行重复检索" class="headerlink" title="1、避免对数据进行重复检索"></a>1、避免对数据进行重复检索</h5><p>在编写应用代码时，需要能够理清对数据库的访问逻辑。能够一次连接就获取到结果的，就不用两次连接，这样可以大大减少对数据库无用的重复请求。</p>
<p>比如 ，需要获取书籍的id 和name字段 ， 则查询如下： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> , <span class="keyword">name</span> <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<p>之后，在业务逻辑中有需要获取到书籍状态信息， 则查询如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> , <span class="keyword">status</span> <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<p>这样，就需要向数据库提交两次请求，数据库就要做两次查询操作。其实完全可以用一条SQL语句得到想要的结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> , <span class="keyword">status</span> <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<h5 id="2、增加cache层"><a href="#2、增加cache层" class="headerlink" title="2、增加cache层"></a>2、增加cache层</h5><p>在应用中，我们可以<strong>在应用中增加 缓存 层来达到减轻数据库负担的目的</strong>。缓存层有很多种，也有很多实现方式，只要能达到降低数据库的负担又能满足应用需求就可以。</p>
<p>因此可以部分数据从数据库中抽取出来放到应用端<strong>以文本方式存储（采用配置文件的方式）</strong>， 或者<strong>使用框架(Mybatis, Hibernate)提供的一级缓存/二级缓存</strong>，或者<strong>使用redis数据库来缓存数据</strong> 。</p>
<h4 id="3、负载均衡"><a href="#3、负载均衡" class="headerlink" title="3、负载均衡"></a>3、负载均衡</h4><p><strong>负载均衡是应用中使用非常普遍的一种优化方法</strong>，它的机制就是<strong>利用某种均衡算法，将固定的负载量分布到不同的服务器上， 以此来降低单台服务器的负载，达到优化的效果</strong>。</p>
<h5 id="1、利用MySQL复制分流查询"><a href="#1、利用MySQL复制分流查询" class="headerlink" title="1、利用MySQL复制分流查询"></a>1、利用MySQL复制分流查询</h5><p><strong>通过MySQL的主从复制，实现读写分离，使增删改操作走主节点，查询操作走从节点，从而可以降低单台服务器的读写压力</strong>。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1.jpg" alt="1"> </p>
<h5 id="2、采用分布式数据库架构"><a href="#2、采用分布式数据库架构" class="headerlink" title="2、采用分布式数据库架构"></a>2、采用分布式数据库架构</h5><p><strong>分布式数据库架构适合大数据量、负载高的情况，它有良好的拓展性和高可用性。通过在多台服务器之间分布数据，可以实现在多台服务器之间的负载均衡，提高访问效率</strong>。</p>
<hr>
<h3 id="11、Mysql中查询缓存优化"><a href="#11、Mysql中查询缓存优化" class="headerlink" title="11、Mysql中查询缓存优化"></a>11、Mysql中查询缓存优化</h3><h4 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h4><p>开启Mysql的查询缓存，当执行完全相同的SQL语句的时候，服务器就会直接从缓存中读取结果，当数据被修改，之前的缓存会失效，修改比较频繁的表不适合做查询缓存。MySQL 5.6(2013)以来，查询缓存已被禁用。</p>
<h4 id="2、操作流程"><a href="#2、操作流程" class="headerlink" title="2、操作流程"></a>2、操作流程</h4><p> <img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/20180919131632347.png" alt="20180919131632347"> </p>
<ol>
<li>客户端发送一条查询给服务器；</li>
<li>服务器先会检查查询缓存，如果命中了缓存，则立即返回存储在缓存中的结果。否则进入下一阶段；</li>
<li>服务器端进行SQL解析、预处理，再由优化器生成对应的执行计划；</li>
<li>MySQL根据优化器生成的执行计划，调用存储引擎的API来执行查询；</li>
<li>将结果返回给客户端。</li>
</ol>
<h4 id="3、查询缓存配置"><a href="#3、查询缓存配置" class="headerlink" title="3、查询缓存配置"></a>3、查询缓存配置</h4><ol>
<li><p>查看当前的MySQL数据库是否支持查询缓存：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;have_query_cache&#x27;</span>;	</span><br></pre></td></tr></table></figure>

<p>![1555249929012](D:\编程\黑马\mysql高级/资料-MySQL高级教程\MySQL 高级 - day-03\文档\assets\1555249929012.png) </p>
</li>
<li><p>查看当前MySQL是否开启了查询缓存：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;query_cache_type&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>![1555250015377](D:\编程\黑马\mysql高级/资料-MySQL高级教程\MySQL 高级 - day-03\文档\assets\1555250015377.png) </p>
</li>
<li><p>查看查询缓存的占用大小 ：（单位：字节）默认：1M。如果想要增加的话，建议增加的值为1024的倍数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;query_cache_size&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>![1555250142451](D:\编程\黑马\mysql高级/资料-MySQL高级教程\MySQL 高级 - day-03\文档\assets\1555250142451.png) </p>
</li>
<li><p>查看查询缓存的状态变量：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">&#x27;Qcache%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>![1555250443958](D:\编程\黑马\mysql高级/资料-MySQL高级教程\MySQL 高级 - day-03\文档\assets\1555250443958.png) </p>
<p>各个变量的含义如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Qcache_free_blocks</td>
<td>查询缓存中的可用内存块数</td>
</tr>
<tr>
<td>Qcache_free_memory</td>
<td>查询缓存的可用内存量</td>
</tr>
<tr>
<td>==Qcache_hits==</td>
<td>查询缓存命中数</td>
</tr>
<tr>
<td>==Qcache_inserts==</td>
<td>添加到查询缓存的查询数</td>
</tr>
<tr>
<td>Qcache_lowmen_prunes</td>
<td>由于内存不足而从查询缓存中删除的查询数</td>
</tr>
<tr>
<td>==Qcache_not_cached==</td>
<td>非缓存查询的数量（由于 query_cache_type 设置而无法缓存或未缓存）</td>
</tr>
<tr>
<td>Qcache_queries_in_cache</td>
<td>查询缓存中注册的查询数</td>
</tr>
<tr>
<td>Qcache_total_blocks</td>
<td>查询缓存中的块总数</td>
</tr>
</tbody></table>
</li>
</ol>
<h4 id="4、开启查询缓存"><a href="#4、开启查询缓存" class="headerlink" title="4、开启查询缓存"></a>4、开启查询缓存</h4><p><strong>MySQL的查询缓存默认是关闭的，需要手动配置参数 query_cache_type ， 来开启查询缓存</strong>。</p>
<p>query_cache_type 该参数的可取值有三个：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>OFF 或 0</td>
<td>查询缓存功能关闭</td>
</tr>
<tr>
<td>ON 或 1</td>
<td>查询缓存功能打开，SELECT的结果符合缓存条件即会缓存，否则，不予缓存，显式指定 SQL_NO_CACHE，不予缓存</td>
</tr>
<tr>
<td>DEMAND 或 2</td>
<td>查询缓存功能按需进行，显式指定 SQL_CACHE 的SELECT语句才会缓存；其它均不予缓存</td>
</tr>
</tbody></table>
<p>在 /usr/my.cnf 配置中，增加以下配置：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555251383805.png" alt="1555251383805"> </p>
<p>配置完毕之后，重启服务既可生效 ；</p>
<p>然后就可以在命令行执行SQL语句进行验证 ，执行一条比较耗时的SQL语句，然后再多执行几次，查看后面几次的执行时间；获取通过查看查询缓存的缓存命中数，来判定是否走查询缓存。</p>
<h4 id="5、查询缓存SELECT选项"><a href="#5、查询缓存SELECT选项" class="headerlink" title="5、查询缓存SELECT选项"></a>5、查询缓存SELECT选项</h4><p>可以在SELECT语句中指定两个与查询缓存相关的选项：</p>
<ul>
<li>SQL_CACHE：如果查询结果是可缓存的，并且 query_cache_type 系统变量的值为ON或 DEMAND ，则缓存查询结果 。</li>
<li>SQL_NO_CACHE：服务器不使用查询缓存。它既不检查查询缓存，也不检查结果是否已缓存，也不缓存查询结果。</li>
</ul>
<p>例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SQL_CACHE</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> customer;</span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> customer;</span><br></pre></td></tr></table></figure>



<h4 id="6、查询缓存失效的情况"><a href="#6、查询缓存失效的情况" class="headerlink" title="6、查询缓存失效的情况"></a>6、查询缓存失效的情况</h4><h5 id="1、SQL-语句不一致的情况，-要想命中查询缓存，查询的SQL语句必须一致"><a href="#1、SQL-语句不一致的情况，-要想命中查询缓存，查询的SQL语句必须一致" class="headerlink" title="1、SQL 语句不一致的情况， 要想命中查询缓存，查询的SQL语句必须一致"></a>1、SQL 语句不一致的情况， 要想命中查询缓存，查询的SQL语句必须一致</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL1 : <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tb_item;</span><br><span class="line">SQL2 : <span class="keyword">Select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tb_item;</span><br></pre></td></tr></table></figure>

<h5 id="2、当查询语句中有一些不确定的时，则不会缓存"><a href="#2、当查询语句中有一些不确定的时，则不会缓存" class="headerlink" title="2、当查询语句中有一些不确定的时，则不会缓存"></a>2、当查询语句中有一些不确定的时，则不会缓存</h5><p>如 ： now() , current_date() , curdate() , curtime() , rand() , uuid() , user() , database() 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQL1 : <span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> updatetime &lt; <span class="keyword">now</span>() <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line">SQL2 : <span class="keyword">select</span> <span class="keyword">user</span>();</span><br><span class="line">SQL3 : <span class="keyword">select</span> <span class="keyword">database</span>();</span><br></pre></td></tr></table></figure>

<h5 id="3、不使用任何表查询语句"><a href="#3、不使用任何表查询语句" class="headerlink" title="3、不使用任何表查询语句"></a>3、不使用任何表查询语句</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;A&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="4、查询-mysql，-information-schema或-performance-schema-数据库中的表时，不会走查询缓存"><a href="#4、查询-mysql，-information-schema或-performance-schema-数据库中的表时，不会走查询缓存" class="headerlink" title="4、查询 mysql， information_schema或  performance_schema 数据库中的表时，不会走查询缓存"></a>4、查询 mysql， information_schema或  performance_schema 数据库中的表时，不会走查询缓存</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.engines;</span><br></pre></td></tr></table></figure>

<h5 id="5、在存储的函数，触发器或事件的主体内执行的查询"><a href="#5、在存储的函数，触发器或事件的主体内执行的查询" class="headerlink" title="5、在存储的函数，触发器或事件的主体内执行的查询"></a>5、在存储的函数，触发器或事件的主体内执行的查询</h5><h5 id="6、如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除"><a href="#6、如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除" class="headerlink" title="6、如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除"></a>6、如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除</h5><p>这包括使用<code>MERGE</code>映射到已更改表的表的查询。一个表可以被许多类型的语句，如被改变 INSERT， UPDATE， DELETE， TRUNCATE TABLE， ALTER TABLE， DROP TABLE，或 DROP DATABASE 。当然，与此同时也会<strong>将更改之后的表重新加入查询缓存当中</strong>。</p>
<hr>
<h3 id="12、Mysql内存管理及优化"><a href="#12、Mysql内存管理及优化" class="headerlink" title="12、Mysql内存管理及优化"></a>12、Mysql内存管理及优化</h3><h4 id="1、内存优化原则"><a href="#1、内存优化原则" class="headerlink" title="1、内存优化原则"></a>1、内存优化原则</h4><ol>
<li><strong>将尽量多的内存分配给MySQL做缓存</strong>，但要给操作系统和其他程序预留足够内存。</li>
<li>MyISAM 存储引擎的数据文件读取依赖于操作系统自身的IO缓存，因此，<strong>如果有MyISAM表，就要预留更多的内存给操作系统做IO缓存</strong>。</li>
<li><strong>排序区、连接区等缓存是分配给每个数据库会话（session）专用的，其默认值的设置要根据最大连接数合理分配</strong>，如果设置太大，不但浪费资源，而且在并发连接较高时会导致物理内存耗尽。</li>
</ol>
<h4 id="2、MyISAM-内存优化"><a href="#2、MyISAM-内存优化" class="headerlink" title="2、MyISAM 内存优化"></a>2、MyISAM 内存优化</h4><p>myisam存储引擎使用 <code>key_buffer</code> <strong>缓存索引块</strong>，加速myisam索引的读写速度。<strong>对于myisam表的数据块</strong>，mysql没有特别的缓存机制，<strong>完全依赖于操作系统的IO缓存</strong>。</p>
<h5 id="1、key-buffer-size"><a href="#1、key-buffer-size" class="headerlink" title="1、key_buffer_size"></a>1、key_buffer_size</h5><p><code>key_buffer_size</code><strong>决定MyISAM索引块缓存区的大小，直接影响到MyISAM表的存取效率</strong>。可以在MySQL参数文件中设置key_buffer_size的值，<strong>对于一般MyISAM数据库，建议至少将1/4可用内存分配给key_buffer_size。</strong></p>
<p>在/usr/my.cnf 中做如下配置：（默认值为8388608字节 = 8M）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key_buffer_size&#x3D;512M</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902012301229.png" alt="image-20210902012301229"></p>
<h5 id="2、read-buffer-size"><a href="#2、read-buffer-size" class="headerlink" title="2、read_buffer_size"></a>2、read_buffer_size</h5><p>如果需要经常顺序扫描myisam表，可以通过增大read_buffer_size的值来改善性能。但需要注意的是<strong>read_buffer_size是每个session独占的，如果默认值设置太大，就会造成内存浪费</strong>。</p>
<h5 id="3、read-rnd-buffer-size"><a href="#3、read-rnd-buffer-size" class="headerlink" title="3、read_rnd_buffer_size"></a>3、read_rnd_buffer_size</h5><p>对于需要<strong>做排序的myisam表的查询</strong>，如带有order by子句的sql，适当增加 read_rnd_buffer_size 的值，可以改善此类的sql性能。但需要注意的是 <strong>read_rnd_buffer_size 是每个session独占的，如果默认值设置太大，就会造成内存浪费。</strong></p>
<h4 id="3、InnoDB-内存优化"><a href="#3、InnoDB-内存优化" class="headerlink" title="3、InnoDB 内存优化"></a>3、InnoDB 内存优化</h4><p><strong>innodb用一块内存区做IO缓存池，该缓存池不仅用来缓存innodb的索引块，而且也用来缓存innodb的数据块。</strong></p>
<h5 id="1、innodb-buffer-pool-size"><a href="#1、innodb-buffer-pool-size" class="headerlink" title="1、innodb_buffer_pool_size"></a>1、innodb_buffer_pool_size</h5><p><strong>该变量决定了 innodb 存储引擎表数据和索引数据的最大缓存区大小</strong>。</p>
<p><strong>在保证操作系统及其他程序有足够内存可用的情况下，innodb_buffer_pool_size 的值越大，缓存命中率越高，访问InnoDB表需要的磁盘I/O 就越少，性能也就越高。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_buffer_pool_size&#x3D;512M</span><br></pre></td></tr></table></figure>

<p>innodb_buffer_pool_size 的默认大小为134217728字节 = 128M</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902012643822.png" alt="image-20210902012643822"></p>
<h5 id="2、innodb-log-buffer-size"><a href="#2、innodb-log-buffer-size" class="headerlink" title="2、innodb_log_buffer_size"></a>2、innodb_log_buffer_size</h5><p><strong>决定了innodb重做日志缓存的大小，对于可能产生大量更新记录的大事务，增加innodb_log_buffer_size的大小，可以避免innodb在事务提交前就执行不必要的日志写入磁盘操作</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_log_buffer_size&#x3D;10M</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="13、Mysql并发参数调整"><a href="#13、Mysql并发参数调整" class="headerlink" title="13、Mysql并发参数调整"></a>13、Mysql并发参数调整</h3><p>从实现上来说，<strong>MySQL Server 是多线程结构，包括后台线程和客户服务线程。多线程可以有效利用服务器资源，提高数据库的并发性能</strong>。</p>
<p>在Mysql中，控制并发连接和线程的主要参数包括：</p>
<ul>
<li><code>max_connections</code></li>
<li><code>back_log</code></li>
<li><code>thread_cache_size</code></li>
<li><code>table_open_cahce</code></li>
</ul>
<h4 id="1、max-connections"><a href="#1、max-connections" class="headerlink" title="1、max_connections"></a>1、max_connections</h4><p><strong>采用max_connections 控制允许连接到MySQL数据库的最大数量，默认值是 151。</strong></p>
<p><strong>如果状态变量 <code>connection_errors_max_connections</code> 不为零，并且一直增长，则说明不断有连接请求因数据库连接数已达到允许最大值而失败，这是可以考虑增大max_connections 的值。</strong></p>
<p>Mysql 最大可支持的连接数，取决于很多因素，包括给定==操作系统平台的线程库的质量==、==内存大小==、==每个连接的负荷==、==CPU的处理速度==，==期望的响应时间==等。<strong>在Linux 平台下，性能好的服务器，支持 500-1000 个连接不是难事</strong>，需要根据服务器性能进行评估设定。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013047619.png" alt="image-20210902013047619"></p>
<h4 id="2、back-log"><a href="#2、back-log" class="headerlink" title="2、back_log"></a>2、back_log</h4><p><strong>back_log 参数控制MySQL监听TCP端口时设置的积压请求栈大小</strong>。</p>
<p><strong>如果MySql的连接数达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log，如果等待连接的数量超过back_log，将不被授予连接资源，将会报错。</strong></p>
<p><strong>5.6.6 版本之前默认值为 50 ， 之后的版本默认为 <code>50 + （max_connections / 5）</code>， 但最大不超过900。</strong></p>
<p><strong>如果需要数据库在较短的时间内处理大量连接请求， 可以考虑适当增大back_log 的值。</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013106674.png" alt="image-20210902013106674"></p>
<h4 id="3、table-open-cache"><a href="#3、table-open-cache" class="headerlink" title="3、table_open_cache"></a>3、table_open_cache</h4><p><strong>该参数用来控制==所有SQL语句==执行线程可打开表缓存的数量</strong>， 而在执行SQL语句时，每一个SQL执行线程至少要打开 1 个表缓存。<strong>该参数的值应该根据设置的最大连接数 max_connections 以及每个连接执行关联查询中涉及的表的最大数量来设定</strong> ：<code>max_connections x N</code> ；<strong>默认值为：2000</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013213494.png" alt="image-20210902013213494"></p>
<h4 id="4、thread-cache-size"><a href="#4、thread-cache-size" class="headerlink" title="4、thread_cache_size"></a>4、thread_cache_size</h4><p><strong>为了加快连接数据库的速度，MySQL 会缓存一定数量的客户服务线程以备重用，通过参数 thread_cache_size 可控制 MySQL 缓存客户服务线程的数量。</strong></p>
<p><strong>默认大小为：9</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013312194.png" alt="image-20210902013312194"></p>
<h4 id="5、innodb-lock-wait-timeout"><a href="#5、innodb-lock-wait-timeout" class="headerlink" title="5、innodb_lock_wait_timeout"></a>5、innodb_lock_wait_timeout</h4><p><strong>该参数是用来设置InnoDB 事务等待行锁的时间，默认值是50ms ，可以根据需要进行动态设置</strong>。</p>
<ul>
<li><strong>对于需要快速反馈的业务系统来说，可以将行锁的等待时间调小，以避免事务长时间挂起</strong>；</li>
<li><strong>对于后台运行的批量处理程序来说， 可以将行锁的等待时间调大， 以避免发生大的回滚操作</strong>。</li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902013414184.png" alt="image-20210902013414184"></p>
<hr>
<h3 id="14、Mysql锁问题"><a href="#14、Mysql锁问题" class="headerlink" title="14、Mysql锁问题"></a>14、Mysql锁问题</h3><h4 id="1、锁概述"><a href="#1、锁概述" class="headerlink" title="1、锁概述"></a>1、锁概述</h4><p><strong>锁是计算机协调多个进程或线程并发访问某一资源的机制（避免争抢）。</strong></p>
<p>在数据库中，除传统的计算资源（如 CPU、RAM、I/O 等）的争用以外，<strong>数据也是一种供许多用户共享的资源</strong>。</p>
<p>如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<h4 id="2、锁分类"><a href="#2、锁分类" class="headerlink" title="2、锁分类"></a>2、锁分类</h4><p>从对数据操作的粒度分：</p>
<ol>
<li><strong>表锁</strong>：操作时，会锁定整个表。</li>
<li><strong>行锁</strong>：操作时，会锁定当前操作行。</li>
</ol>
<p>从对数据操作的类型分：</p>
<ol>
<li><strong>读锁（共享锁）（S Lock）</strong>：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li>
<li><strong>写锁（排它锁）（X Lock）</strong>：当前操作没有完成之前，它会阻断其他写锁和读锁。</li>
</ol>
<h4 id="3、行锁：记录锁-Record-Locks"><a href="#3、行锁：记录锁-Record-Locks" class="headerlink" title="3、行锁：记录锁(Record Locks)"></a>3、行锁：记录锁(Record Locks)</h4><p>mysql的行锁是<strong>通过索引加载的</strong>，即<strong>行锁是加在索引响应的行上的，要是对应的SQL语句没有走索引，则会全表扫描</strong>.</p>
<ol>
<li><strong>记录锁，仅仅锁住索引记录的一行，在单条索引记录上加锁</strong>。</li>
<li><strong>record lock锁住的永远是索引，而非记录本身</strong>，即使<strong>该表上没有任何索引，那么innodb会在后台创建一个隐藏的聚集主键索引，那么锁住的就是这个隐藏的聚集主键索引。</strong></li>
</ol>
<p>所以说当一条sql没有走任何索引时，那么将会在每一条聚合索引后面加X锁，这个类似于表锁，但原理上和表锁应该是完全不同的。</p>
<h4 id="4、行锁：间隙锁-Gap-Locks"><a href="#4、行锁：间隙锁-Gap-Locks" class="headerlink" title="4、行锁：间隙锁(Gap Locks)"></a>4、行锁：间隙锁(Gap Locks)</h4><ol>
<li><strong>区间锁，仅仅锁住一个索引区间（开区间，不包括双端端点）</strong>。</li>
<li><strong>在索引记录之间的间隙中加锁</strong>，或者是<strong>在某一条索引记录之前或者之后加锁，==并不包括该索引记录本==身</strong>。比如在 1、2、3中，间隙锁的可能值有 (∞, 1)，(1, 2)，(2, ∞)，</li>
<li><strong>间隙锁可用于防止幻读，保证索引间的不会被插入数据</strong></li>
</ol>
<h4 id="5、行锁：临键锁-Next-Key-Locks"><a href="#5、行锁：临键锁-Next-Key-Locks" class="headerlink" title="5、行锁：临键锁(Next-Key Locks)"></a>5、行锁：临键锁(Next-Key Locks)</h4><ol>
<li><p><strong>record lock + gap lock，左开右闭区间。</strong></p>
</li>
<li><p><strong>默认情况下，innodb使用next-key locks来锁定记录。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> … <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>但当查询的索引含有唯一属性的时候，Next-Key Lock 会进行优化，将其降级为Record Lock，即仅锁住索引本身，不是范围。</strong></p>
</li>
<li><p>Next-Key Lock在不同的场景中会退化:</p>
</li>
</ol>
<table>
<thead>
<tr>
<th align="left">场景</th>
<th align="left">退化锁类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>使用unique index精确匹配(=)，且记录存在</strong></td>
<td align="left"><strong>Record Locks</strong></td>
</tr>
<tr>
<td align="left"><strong>使用unique index精确匹配(=)，且记录不存在</strong></td>
<td align="left"><strong>Gap Locks</strong></td>
</tr>
<tr>
<td align="left"><strong>使用unique index范围匹配（<code>&lt;和&gt;</code>）</strong></td>
<td align="left"><strong>Record Locks + Gap Locks，锁上界不锁下界(左开右闭区间)</strong></td>
</tr>
</tbody></table>
<h4 id="6、表锁：意向锁"><a href="#6、表锁：意向锁" class="headerlink" title="6、表锁：意向锁"></a>6、表锁：意向锁</h4><p>表锁，其实也可以叫意向锁，表明“某个事务正在某些行持有了锁、或该事务准备去持有锁”。</p>
<ul>
<li>注意：表锁可以是意向锁，但是意向锁不一定是表锁</li>
</ul>
<p>意向锁产生的主要目的是<strong>为了处理行锁和表锁之间的冲突</strong>：</p>
<ul>
<li>事务在请求S锁和X锁前，需要先获得对应的IS、IX锁，</li>
<li>在为数据行加共享 / 排他锁之前，InooDB 会先获取该数据行所在在数据表的对应意向锁。</li>
</ul>
<p>例子：事务A修改user表的记录r，会给记录r上一把行级的排他锁（X），同时会给user表上一把意向排他锁（IX），这时事务B要给user表上一个表级的排他锁就会被阻塞。<strong>意向锁通过这种方式实现了行锁和表锁共存且满足事务隔离性的要求。</strong></p>
<ol>
<li>意向共享锁（IS锁）：事务在请求S锁前，要先获得IS锁</li>
<li>意向排他锁（IX锁）：事务在请求X锁前，要先获得IX锁</li>
</ol>
<p><strong>q1：为什么意向锁是表级锁呢？</strong></p>
<p>当我们需要加一个排他锁时，需要根据意向锁去判断表中有没有数据行被锁定（行锁）；</p>
<ul>
<li>如果意向锁是行锁，则需要遍历每一行数据去确认；</li>
<li>如果意向锁是表锁，则只需要判断一次即可知道有没数据行被锁定，提升性能。</li>
</ul>
<p><strong>q2：意向锁怎么支持表锁和行锁并存？</strong></p>
<ul>
<li><p>首先明确并存的概念是指<strong>数据库同时支持表、行锁</strong>，而不是任何情况都支持一个表中同时有一个事务A持有行锁、又有一个事务B持有表锁，因为<strong>表一旦被上了一个表级的写锁，肯定不能再上一个行级的锁</strong>。</p>
</li>
<li><p><strong>如果事务A对某一行上锁，其他事务就不可能修改这一行。这与“事务B锁住整个表就能修改表中的任意一行”形成了冲突</strong>。所以，没有意向锁的时候，让行锁与表锁共存，就会带来很多问题。于是有了意向锁的出现，如q1的答案中，数据库不需要在检查每一行数据是否有锁，而是直接判断一次意向锁是否存在即可，能提升很多性能。</p>
<ol>
<li>共享锁和排他锁，系统在特定的条件下会自动添加共享锁或者排他锁，也可以手动添加共享锁或者排他锁。</li>
<li><strong>意向共享锁和意向排他锁都是系统自动添加和自动释放的，整个过程无需人工干预</strong></li>
<li><strong>共享锁和排他锁都是锁的行记录，意向共享锁和意向排他锁锁定的是表</strong></li>
<li><strong>由于InnoDB存储引擎支持的是行级别的锁，因此意向锁不会阻塞除全表扫描以外的任何请求。</strong></li>
</ol>
</li>
<li><p>意向共享锁与排他锁冲突，也就是说如果A表中一行被加了排它锁，那么当有select * 这样的全表扫描语句的时候将会加锁失败，因为全表扫描需要对表加意向共享锁，但是表上有排他行锁，于是加锁失败；</p>
</li>
<li><p>意向排他锁与排他锁和共享锁都冲突，同理也就是说如果A表中一行被加了排它锁或者共享锁，那么当有需要加表级的意向排它锁的时候，加锁失败；</p>
</li>
</ul>
<h4 id="3、Mysql-锁"><a href="#3、Mysql-锁" class="headerlink" title="3、Mysql 锁"></a>3、Mysql 锁</h4><p>相对其他数据库而言，MySQL的锁机制比较简单，其最显著的特点是<strong>不同的存储引擎支持不同的锁机制</strong>。</p>
<p>下表中罗列出了各存储引擎对锁的支持情况：</p>
<table>
<thead>
<tr>
<th>存储引擎</th>
<th>表级锁</th>
<th>行级锁</th>
<th>页面锁</th>
</tr>
</thead>
<tbody><tr>
<td>MyISAM</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>==InnoDB==</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>MEMORY</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>BDB</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
</tbody></table>
<p>MySQL这3种锁的特性可大致归纳如下：</p>
<table>
<thead>
<tr>
<th>锁类型</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>表级锁</td>
<td>偏向MyISAM 存储引擎，开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</td>
</tr>
<tr>
<td>行级锁</td>
<td>偏向InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</td>
</tr>
<tr>
<td>页面锁</td>
<td>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</td>
</tr>
</tbody></table>
<p>从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适！</p>
<ul>
<li>仅从锁的角度来说：<strong>表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web 应用</strong>；</li>
<li>而<strong>行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用，如一些在线事务处理（OLTP）系统。</strong></li>
</ul>
<h4 id="4、MyISAM-表锁"><a href="#4、MyISAM-表锁" class="headerlink" title="4、MyISAM 表锁"></a>4、MyISAM 表锁</h4><p><strong>MyISAM 存储引擎只支持表锁，这也是MySQL开始几个版本中唯一支持的锁类型</strong>。</p>
<h5 id="1、如何加表锁"><a href="#1、如何加表锁" class="headerlink" title="1、如何加表锁"></a>1、如何加表锁</h5><ul>
<li>MyISAM 在执行查询语句（<code>SELECT</code>）前，会<strong>自动给涉及的所有表加读锁</strong>；</li>
<li>在执行更新操作（<code>UPDATE</code>、<code>DELETE</code>、<code>INSERT</code> 等）前，会<strong>自动给涉及的表加写锁</strong>；</li>
<li><strong>这个过程并不需要用户干预，因此用户一般不需要直接用 LOCK TABLE 命令给 MyISAM 表显式加锁</strong>。</li>
</ul>
<p>显示加表锁语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加读锁</span></span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> table_name <span class="keyword">read</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 加写锁</span></span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> table_name write；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解锁</span></span><br><span class="line"><span class="keyword">unlock</span> <span class="keyword">tables</span></span><br></pre></td></tr></table></figure>

<h5 id="2、读锁案例"><a href="#2、读锁案例" class="headerlink" title="2、读锁案例"></a>2、读锁案例</h5><p>准备环境</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> demo_03 <span class="keyword">default</span> <span class="keyword">charset</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> demo_03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tb_book`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) auto_increment,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`publish_time`</span> <span class="built_in">DATE</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">CHAR</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=myisam <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_book (<span class="keyword">id</span>, <span class="keyword">name</span>, publish_time, <span class="keyword">status</span>) <span class="keyword">VALUES</span>(<span class="literal">NULL</span>,<span class="string">&#x27;java编程思想&#x27;</span>,<span class="string">&#x27;2088-08-01&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_book (<span class="keyword">id</span>, <span class="keyword">name</span>, publish_time, <span class="keyword">status</span>) <span class="keyword">VALUES</span>(<span class="literal">NULL</span>,<span class="string">&#x27;solr编程思想&#x27;</span>,<span class="string">&#x27;2088-08-08&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tb_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) auto_increment,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=myisam <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span>(<span class="literal">NULL</span>,<span class="string">&#x27;令狐冲&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span>(<span class="literal">NULL</span>,<span class="string">&#x27;田伯光&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>客户端一：</p>
<p>1）获得tb_book 表的读锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> tb_book <span class="keyword">read</span>;</span><br></pre></td></tr></table></figure>

<p>2） 执行查询操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553906896564-16305217885821.png" alt="1553906896564"> </p>
<p>可以正常执行 ， 查询出数据。</p>
<p>客户端二：</p>
<p>3） 执行查询操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907044500-16305217885832.png" alt="1553907044500"> </p>
<p>客户端一：</p>
<p>4）查询未锁定的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> tb_seller;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908913515-16305217885843.png" alt="1553908913515"> </p>
<p>客户端二：</p>
<p>5）查询未锁定的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> tb_seller;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908973840-16305217885844.png" alt="1553908973840"> </p>
<p>可以正常查询出未锁定的表；</p>
<p>客户端一：</p>
<p>6） 执行插入操作 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Mysql高级&#x27;</span>,<span class="string">&#x27;2088-01-01&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907198462-16305217885845.png" alt="1553907198462"> </p>
<p>执行插入， 直接报错 ， 由于当前tb_book 获得的是 读锁， 不能执行更新操作。</p>
<p>客户端二：</p>
<p>7） 执行插入操作 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Mysql高级&#x27;</span>,<span class="string">&#x27;2088-01-01&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907403957-16305217885846.png" alt="1553907403957"> </p>
<p>当在客户端一中释放锁指令 unlock tables  后 ， 客户端二中的 inesrt 语句 ， 立即执行 ；</p>
<h5 id="3、写锁案例"><a href="#3、写锁案例" class="headerlink" title="3、写锁案例"></a>3、写锁案例</h5><p>客户端一：</p>
<p>1）获得tb_book 表的写锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> tb_book write;</span><br></pre></td></tr></table></figure>

<p>2）执行查询操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907849829.png" alt="1553907849829"> </p>
<p>查询操作执行成功；</p>
<p>3）执行更新操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> tb_book <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">&#x27;java编程思想（第二版）&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553907875221.png" alt="1553907875221"> </p>
<p>更新操作执行成功 ；</p>
<p>客户端二：</p>
<p>4）执行查询操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908019755.png" alt="1553908019755"> </p>
<p>当在客户端一中释放锁指令 unlock tables  后 ， 客户端二中的 select 语句 ， 立即执行 ；</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553908131373.png" alt="1553908131373"> </p>
<h5 id="4、结论"><a href="#4、结论" class="headerlink" title="4、结论"></a>4、结论</h5><p>锁模式的相互兼容性如表中所示：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030926626.png" alt="image-20210902030926626"></p>
<p>由上表可见： </p>
<ol>
<li><strong>对MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；</strong></li>
<li><strong>对MyISAM 表的写操作，则会阻塞其他用户对同一表的读和写操作；</strong></li>
</ol>
<p>简而言之，就是<strong>读锁会阻塞写，但是不会阻塞读</strong>。而<strong>写锁，则既会阻塞读，又会阻塞写</strong>。</p>
<p>此外，<strong>MyISAM 的读写锁调度是==写优先==，这也是MyISAM不适合做写为主的表的存储引擎的原因。</strong>因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。</p>
<h5 id="5、查看锁的争用情况"><a href="#5、查看锁的争用情况" class="headerlink" title="5、查看锁的争用情况"></a>5、查看锁的争用情况</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span>；</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902031019830.png" alt="image-20210902031019830"></p>
<ul>
<li><code>In_user</code>：<strong>表当前被查询使用的次数</strong>。如果该数为零，则表是打开的，但是当前没有被使用。</li>
<li><code>Name_locked</code>：<strong>表名称是否被锁定</strong>。<strong>名称锁定用于==取消表==或==对表进行重命名==等操作</strong>。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Table_locks%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Table_locks_immediate</code>：指的是<strong>能够立即获得表级锁的次数，每立即获取锁，值加1</strong>。</li>
<li><code>Table_locks_waited</code>：指的是<strong>不能立即获取表级锁而需要等待的次数，每等待一次，该值加1，此值高说明存在着较为严重的表级锁争用情况。</strong></li>
</ul>
<h4 id="5、InnoDB-行锁"><a href="#5、InnoDB-行锁" class="headerlink" title="5、InnoDB 行锁"></a>5、InnoDB 行锁</h4><h5 id="1、行锁介绍"><a href="#1、行锁介绍" class="headerlink" title="1、行锁介绍"></a>1、行锁介绍</h5><p>行锁特点 ：</p>
<ul>
<li><strong>偏向InnoDB 存储引擎，开销大，加锁慢</strong>；</li>
<li><strong>会出现死锁</strong>；</li>
<li><strong>锁定粒度最小，发生锁冲突的概率最低，并发度也最高</strong>。</li>
</ul>
<p>InnoDB 与 MyISAM 的最大不同有两点：</p>
<ol>
<li>一是==支持事务==；</li>
<li>二是 ==采用了行级锁==。</li>
</ol>
<h5 id="2、背景知识"><a href="#2、背景知识" class="headerlink" title="2、背景知识"></a>2、背景知识</h5><h6 id="1、事务及其ACID属性"><a href="#1、事务及其ACID属性" class="headerlink" title="1、事务及其ACID属性"></a>1、事务及其ACID属性</h6><p>事务是由一组SQL语句组成的逻辑处理单元。</p>
<p>事务具有以下4个特性，简称为事务==ACID属性==。</p>
<table>
<thead>
<tr>
<th>ACID属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>原子性（Atomicity）</td>
<td>事务是一个原子操作单元，其对数据的修改，要么全部成功，要么全部失败。</td>
</tr>
<tr>
<td>一致性（Consistent）</td>
<td>在事务开始和完成时，数据都必须保持一致状态。</td>
</tr>
<tr>
<td>隔离性（Isolation）</td>
<td>数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的 “独立” 环境下运行。</td>
</tr>
<tr>
<td>持久性（Durable）</td>
<td>事务完成之后，对于数据的修改是永久的。</td>
</tr>
</tbody></table>
<h6 id="2、并发事务处理带来的问题"><a href="#2、并发事务处理带来的问题" class="headerlink" title="2、并发事务处理带来的问题"></a>2、并发事务处理带来的问题</h6><table>
<thead>
<tr>
<th>问题</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>丢失更新（Lost Update）</td>
<td>当两个或多个事务选择同一行，最初的事务修改的值，会被后面的事务修改的值覆盖。</td>
</tr>
<tr>
<td>脏读（Dirty Reads）</td>
<td>当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</td>
</tr>
<tr>
<td>不可重复读（Non-Repeatable Reads）</td>
<td>一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现和以前读出的数据不一致。</td>
</tr>
<tr>
<td>幻读（Phantom Reads）</td>
<td>一个事务按照相同的查询条件重新读取以前查询过的数据，却发现其他事务插入了满足其查询条件的新数据。</td>
</tr>
</tbody></table>
<h6 id="3、事务隔离级别"><a href="#3、事务隔离级别" class="headerlink" title="3、事务隔离级别"></a>3、事务隔离级别</h6><p>为了解决上述提到的事务并发问题，数据库提供一定的事务隔离机制来解决这个问题。<strong>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使用事务在一定程度上“串行化” 进行，这显然与“并发” 是矛盾的。</strong> </p>
<p>数据库的隔离级别有4个，由低到高依次为：</p>
<ul>
<li>Read uncommitted</li>
<li>Read committed（Oracle默认）</li>
<li>Repeatable read（Mysql默认）</li>
<li>Serializable</li>
</ul>
<p>这四个级别可以逐个解决脏写、脏读、不可重复读、幻读这几类问题。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>丢失更新</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>Read uncommitted</td>
<td>×</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Read committed</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Repeatable read（默认）</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>Serializable</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<p>备注 ： √  代表可能出现 ， × 代表不会出现 。</p>
<p>Mysql 的数据库的默认隔离级别为 Repeatable read ， 查看方式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;tx_isolation&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554331600009.png" alt="1554331600009">  </p>
<h6 id="4、解决方案解析"><a href="#4、解决方案解析" class="headerlink" title="4、解决方案解析"></a>4、解决方案解析</h6><p>解决脏读——使用 读已提交：</p>
<p>首先我们要理解什么是脏读，既然脏读是一个事物读到了另一个事务未提交的数据，那么我们就让它提交后再让别的事物读就好了，<strong>读已提交就是改变了释放锁的时机，让事务完成提交后再去释放锁</strong>。这样就解决了脏读问题。</p>
<p>解决不可重复读——使用 可重复读：</p>
<p>不可重复读是因为读取过程中有其他事务修改数据，导致读取数据不一致。那我们就要保证一个事务读取数据的时候就让他老老实实读那个数据。<strong>可重复读是用一个MVCC(多版本并发控制)机制去解决的</strong>。</p>
<blockquote>
<p>MVCC(多版本并发控制)</p>
<p>MVCC其实就是行级锁的一个升级版。我们都知道数据库中有表锁和行锁，在表锁中读写操作是阻塞的，而MVCC的读写一般是不会阻塞的，这样避免了很多加锁过程。</p>
<p>MVCC具体实现：通过在每行记录后面保存两个隐藏的字段，一个保存的是此行的创建时间，一个保存的是指向旧版本的指针。它们存储的也并不是真的时间，而是系统版本号。就跟我们使用软件都有1.0，2.0这些版本，每个版本有它们自己的特点和数据。MVCC就是在每次开始事务时，都会对应自动递增并保存一个版本号，通过这个版本号去生成对应的一个时间点的数据快照，利用这个快照就可以保证数据读取的一致性。</p>
<p>MVCC把SQL分为两类：一种是快照读，就是普通的select操作，读的就是历史版本的数据。另一种是当前读，比如select … for update，insert，update，delete 读的都是最新的数据，不可重复读就是利用快照保存数据，然后就解决啦！</p>
<p>通俗的说就是：MVCC就是给每次事务操作的数据行都加个字段，代表这次事务的版本，那么如果我现在读取这行数据时，就会通过这个版本生成一个数据快照，那么我这个事务再读的时候，会直接从版本快照中获得数据，相当于帮我们缓存了一份数据，注意喔，我这两次读取都是同一个事务喔！</p>
</blockquote>
<p>解决幻读——使用 串行化：</p>
<p>上文说到解决不可重复读用MVCC就可以根据版本保证读取的数据一致，那幻读不是也可以用这个去解决吗？</p>
<p>那么这里又要重申幻读和不可重复读的区别，不可重复读是针对某行数据，幻读是特指查询到记录条数，也就是多条数据的查询。</p>
<p>所以我们使用<strong>MVCC + Next-key Lock锁</strong>去解决幻读问题。</p>
<blockquote>
<p>科普一下Innodb的三种行锁的算法：</p>
<ul>
<li>行锁：就是对单条记录上锁。</li>
<li>间隙锁：锁定一个范围，但是不会包括记录自己，就是如果要查询一个id=10的数据时，就会把它范围外的加上锁防止插入数据操作，这个就是间隙锁。</li>
<li>Next-key Lock：行锁+间隙锁的合体算法，使用它时不仅会把id=10 的范围加上行锁，也会把它间隙加上锁，对于行的查询，使用此法便ok。</li>
</ul>
</blockquote>
<p>具体实现：</p>
<p>当事务执行的是select…for update 时，Next-key Lock对范围加锁，这样事务A执行这个查询当前读语句时，事务B是不能去修改范围内的数据的。</p>
<p>遇到的问题：</p>
<p>我们使用串行化解决幻读会有什么问题产生呢？<br>我们知道解决幻读使用了间隙锁，那么我们在并发情况下很容易造成死锁！</p>
<p>举个栗子：</p>
<p>事务A、事务B同时执行<code>select * from table where id = 10 for update</code> ，前提是我们没有id=10这条数据，事务A执行时因加上了间隙锁，同时事务B也执行这条语句。这时，事务B如果去添加数据就会因为事务A的间隙锁造成阻塞，事务A再执行添加数据也会因为事务B间隙锁造成阻塞，这样就形成了一个死锁。</p>
<p>所以串行化的并发性不好，那我们实际项目中要合理的选择取舍。</p>
<h5 id="3、InnoDB-的行锁模式"><a href="#3、InnoDB-的行锁模式" class="headerlink" title="3、InnoDB 的行锁模式"></a>3、InnoDB 的行锁模式</h5><p>InnoDB  实现了以下两种类型的行锁：</p>
<ul>
<li><strong>共享锁（S）</strong>：又称为==读锁==，简称==S锁==，**共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是==只能读不能修改==**。</li>
<li><strong>排他锁（X）</strong>：又称为==写锁==，简称==X锁==，<strong>排他锁就是不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。</strong></li>
</ul>
<p><strong>对于UPDATE、DELETE和INSERT语句，InnoDB会自动给涉及数据集加排他锁（X)；</strong></p>
<p><strong>对于普通SELECT语句，InnoDB不会加任何锁；</strong></p>
<p>可以通过以下语句显示给记录集加共享锁或排他锁 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 共享锁（S）</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> ... <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 排他锁（X)</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br></pre></td></tr></table></figure>

<h5 id="4、案例准备工作"><a href="#4、案例准备工作" class="headerlink" title="4、案例准备工作"></a>4、案例准备工作</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_innodb_lock(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>),</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">16</span>),</span><br><span class="line">	sex <span class="built_in">varchar</span>(<span class="number">1</span>)</span><br><span class="line">)<span class="keyword">engine</span> = <span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;400&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;500&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">&#x27;600&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;700&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">8</span>,<span class="string">&#x27;800&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">9</span>,<span class="string">&#x27;900&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_innodb_lock <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;200&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建两个单列索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_test_innodb_lock_id <span class="keyword">on</span> test_innodb_lock(<span class="keyword">id</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_test_innodb_lock_name <span class="keyword">on</span> test_innodb_lock(<span class="keyword">name</span>);</span><br></pre></td></tr></table></figure>

<h5 id="5、行锁基本演示"><a href="#5、行锁基本演示" class="headerlink" title="5、行锁基本演示"></a>5、行锁基本演示</h5><table>
<thead>
<tr>
<th>Session-1</th>
<th>Session-2</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025707245.png" alt="image-20210902025707245">     关闭自动提交功能</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025719304.png" alt="image-20210902025719304"> 关闭自动提交功能</td>
</tr>
<tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025728670.png" alt="image-20210902025728670"> 可以正常的查询出全部的数据</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025737987.png" alt="image-20210902025737987">可以正常的查询出全部的数据</td>
</tr>
<tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025748385.png" alt="image-20210902025748385">查询id 为3的数据 ；</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025758851.png" alt="image-20210902025758851">查询id为3的数据 ；</td>
</tr>
<tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025807893.png" alt="image-20210902025807893">更新id为3的数据，但是不提交；</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025816158.png" alt="image-20210902025816158">更新id为3 的数据， 出于等待状态</td>
</tr>
<tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025826632.png" alt="image-20210902025826632">通过commit， 提交事务</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025833220.png" alt="image-20210902025833220">解除阻塞，更新正常进行</td>
</tr>
<tr>
<td>以上， 操作的都是同一行的数据，接下来，演示不同行的数据 ：</td>
<td></td>
</tr>
<tr>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025841993.png" alt="image-20210902025841993"> 更新id为3数据，正常的获取到行锁 ， 执行更新 ；</td>
<td><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025847203.png" alt="image-20210902025847203">由于与Session-1 操作不是同一行，获取当前行锁，执行更新；</td>
</tr>
</tbody></table>
<h5 id="6、无索引行锁升级为表锁"><a href="#6、无索引行锁升级为表锁" class="headerlink" title="6、无索引行锁升级为表锁"></a>6、无索引行锁升级为表锁</h5><p><strong>条件不具备索引性质（索引失效或不是索引），则会导致行锁变为表锁</strong></p>
<p><strong>如果不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，实际效果跟表锁一样</strong>。</p>
<p>查看当前表的索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span>  <span class="keyword">index</span>  <span class="keyword">from</span> test_innodb_lock ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554385956215.png" alt="1554385956215"> </p>
<table>
<thead>
<tr>
<th>Session-1</th>
<th>Session-2</th>
</tr>
</thead>
<tbody><tr>
<td>关闭事务的自动提交<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025946304.png" alt="image-20210902025946304"></td>
<td>关闭事务的自动提交<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025952429.png" alt="image-20210902025952429"></td>
</tr>
<tr>
<td>执行更新语句 ：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902025958345.png" alt="image-20210902025958345"></td>
<td>执行更新语句， 但处于阻塞状态：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030003757.png" alt="image-20210902030003757"></td>
</tr>
<tr>
<td>提交事务：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030008546.png" alt="image-20210902030008546"></td>
<td>解除阻塞，执行更新成功 ：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030013887.png" alt="image-20210902030013887"></td>
</tr>
<tr>
<td></td>
<td>执行提交操作 ：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030020857.png" alt="image-20210902030020857"></td>
</tr>
</tbody></table>
<p><strong>由于执行更新时 ， name字段本来为varchar类型， 我们是作为数组类型使用，存在类型转换，索引失效，最终行锁变为表锁</strong>。</p>
<h5 id="7、间隙锁危害"><a href="#7、间隙锁危害" class="headerlink" title="7、间隙锁危害"></a>7、间隙锁危害</h5><p><strong>当我们用范围条件，而不是使用相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据进行加锁； 对于键值在条件范围内但并不存在的记录，叫做 “间隙（GAP）” ， InnoDB也会对这个 “间隙” 加锁，这种锁机制就是所谓的 间隙锁（Next-Key锁）</strong> 。</p>
<p>示例 ： </p>
<table>
<thead>
<tr>
<th>Session-1</th>
<th>Session-2</th>
</tr>
</thead>
<tbody><tr>
<td>关闭事务自动提交 <img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030147061.png" alt="image-20210902030147061"></td>
<td>关闭事务自动提交<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030153667.png" alt="image-20210902030153667"></td>
</tr>
<tr>
<td>根据id范围更新数据<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030200257.png" alt="image-20210902030200257"></td>
<td>此时id=2的数据不存在（间隙）</td>
</tr>
<tr>
<td></td>
<td>插入id为2的记录， 出于阻塞状态<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030211686.png" alt="image-20210902030211686"></td>
</tr>
<tr>
<td>提交事务 ；<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030217111.png" alt="image-20210902030217111"></td>
<td></td>
</tr>
<tr>
<td></td>
<td>解除阻塞 ， 执行插入操作 ：<img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902030222274.png" alt="image-20210902030222274"></td>
</tr>
<tr>
<td></td>
<td>提交事务 ：</td>
</tr>
</tbody></table>
<h5 id="8、InnoDB-行锁争用情况"><a href="#8、InnoDB-行锁争用情况" class="headerlink" title="8、InnoDB 行锁争用情况"></a>8、InnoDB 行锁争用情况</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;innodb_row_lock%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1556455943670.png" alt="1556455943670"></p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>：<strong>当前正在等待锁定的数量</strong></li>
<li><code>Innodb_row_lock_time</code>：<strong>从系统启动到现在锁定总时间长度</strong></li>
<li><code>Innodb_row_lock_time_avg</code>：**==每次等待所花平均时长==**</li>
<li><code>Innodb_row_lock_time_max</code>：<strong>从系统启动到现在等待最长的一次所花的时间</strong></li>
<li><code>Innodb_row_lock_waits</code>：**==系统启动后到现在总共等待的次数==**</li>
</ul>
<p>当等待的次数很高，而且每次等待的时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化计划。</p>
<h5 id="9、总结"><a href="#9、总结" class="headerlink" title="9、总结"></a>9、总结</h5><p><strong>InnoDB存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高一些，但是在整体并发处理能力方面要远远由于MyISAM的表锁的</strong>。当系统并发量较高的时候，InnoDB的整体性能和MyISAM相比就会有比较明显的优势。</p>
<p>但是，<strong>InnoDB的行级锁同样也有其脆弱的一面，当我们使用不当的时候，可能会让InnoDB的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</strong></p>
<p>优化建议：</p>
<ul>
<li><strong>尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁</strong>。</li>
<li><strong>合理设计索引，尽量缩小锁的范围</strong></li>
<li><strong>尽可能减少索引条件，及索引范围，避免间隙锁</strong></li>
<li><strong>尽量控制事务大小，减少锁定资源量和时间长度</strong></li>
<li><strong>尽可使用低级别事务隔离（但是需要业务层面满足需求）</strong></li>
</ul>
<hr>
<h3 id="15、Mysql-事务隔离的底层实现"><a href="#15、Mysql-事务隔离的底层实现" class="headerlink" title="15、Mysql 事务隔离的底层实现"></a>15、Mysql 事务隔离的底层实现</h3><h4 id="1、MVCC（Multi-Version-Concurrency-Control）多版本并发控制"><a href="#1、MVCC（Multi-Version-Concurrency-Control）多版本并发控制" class="headerlink" title="1、MVCC（Multi-Version Concurrency Control）多版本并发控制"></a>1、MVCC（Multi-Version Concurrency Control）多版本并发控制</h4><h5 id="1、什么是MVCC？"><a href="#1、什么是MVCC？" class="headerlink" title="1、什么是MVCC？"></a>1、什么是MVCC？</h5><p>MVCC（Multi-Version Concurrency Control）多版本并发控制，是数据库控制并发访问的一种手段。</p>
<p>在Mysql的InnoDB引擎中就是指在已提交读(READ COMMITTD)和可重复读(REPEATABLE READ)这两种隔离级别下的事务对于SELECT操作会访问版本链中的记录的过程。</p>
<p>这就使得别的事务可以修改这条记录，反正每次修改都会在版本链中记录。SELECT可以去版本链中拿记录，这就实现了读-写，写-读的并发执行，提升了系统的性能。</p>
<p>总结：</p>
<ul>
<li><strong>MVCC</strong>只在 <strong>读已提交(RC)</strong> 和 <strong>可重复度（RR）</strong> 这两种事务隔离级别下才有效</li>
<li><strong>数据库引擎（InnoDB）</strong> 层面实现的，用来处理读写冲突的手段（不用加锁），提高访问性能</li>
</ul>
<h5 id="2、MVCC的底层原理——版本链和一致性视图"><a href="#2、MVCC的底层原理——版本链和一致性视图" class="headerlink" title="2、MVCC的底层原理——版本链和一致性视图"></a>2、MVCC的底层原理——版本链和一致性视图</h5><h6 id="1、版本链"><a href="#1、版本链" class="headerlink" title="1、版本链"></a>1、版本链</h6><ul>
<li>版本链是一条链表，链接的是每条数据曾经的修改记录</li>
</ul>
<p><strong>那么这个版本链又是如何形成的呢，每条数据又是靠什么链接起来的呢？</strong></p>
<p>其实是这样的，对于<strong>InnoDB存储引擎</strong>的表来说，它的<strong>聚簇索引</strong>记录包含两个隐藏字段：</p>
<ul>
<li><strong>trx_id</strong>：==存储修改此数据的事务id，只有这个事务操作了某些表的数据后当更改操作发生的时候（update,delete,insert），才会分配唯一的事务id，并且此事务id是递增的==</li>
<li><strong>roll_pointer</strong>：指针，==指向上一次修改的记录==</li>
<li>row_id(非必须)：当有==主键==或者有==不允许为null的unique键==时，不包含此字段</li>
</ul>
<p>假如说当前数据库有一条这样的数据，假设是事务ID为100的事务插入的这条数据，那么此条数据的结构如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2.png" alt="img"></p>
<p>后来，事务200，事务300，分别来修改此数据：</p>
<table>
<thead>
<tr>
<th>时间T</th>
<th>trx_id 200</th>
<th>trx_id 300</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>开始事务</td>
<td>开始事务</td>
</tr>
<tr>
<td>T2</td>
<td>更改名字为A</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>更改名字为B</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td>提交事务</td>
<td>更改名字为C</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>提交事务</td>
</tr>
</tbody></table>
<p>所以此时的版本链如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3.png" alt="img"></p>
<p>我们每更改一次数据，<strong>就会插入一条undo日志</strong>，并且记录的<strong>roll_pointer</strong>指针会指向上一条记录，如图所示：（注意：插入操作的undo日志没有roll_pointer这个属性，因为它没有老版本）</p>
<ol>
<li>第一条数据是小杰，事务ID为100</li>
<li>事务ID为200的事务将名称从小杰改为了A</li>
<li>事务ID为200的事务将名称从A又改为了B</li>
<li>事务ID为300的事务将名称从B又改为了C</li>
</ol>
<p>所以串成的链表就是 C -&gt; B -&gt; A -&gt; 小杰 （从最新的数据到最老的数据）</p>
<h6 id="2、一致性视图（ReadView）"><a href="#2、一致性视图（ReadView）" class="headerlink" title="2、一致性视图（ReadView）"></a>2、一致性视图（ReadView）</h6><p>需要判断<strong>版本链中的哪个版本是是当前事务可见的</strong>，因此有了一致性视图的概念。其中有四个属性比较重要：</p>
<ul>
<li><strong>m_ids</strong>：在生成ReadView时，当前活跃的读写事务的事务id列表<ul>
<li>当前活跃的读写事务就是begin了还未提交的事务</li>
</ul>
</li>
<li><strong>min_trx_id</strong>：m_ids的最小值</li>
<li><strong>max_trx_id</strong>：m_ids的最大值+1</li>
<li><strong>creator_trx_id</strong>：生成该事务的事务id，<strong>单纯开启事务是没有事务id的，默认为0，creator_trx_id是0</strong>。</li>
</ul>
<p><strong>版本链中的当前版本是否可以被当前事务可见</strong>的要根据这四个属性按照以下几种情况来判断：</p>
<ul>
<li>当 trx_id = creator_trx_id 时：当前事务可以看见自己所修改的数据， <strong>可见</strong>，</li>
<li>当 trx_id &lt; min_trx_id 时：生成此数据的事务已经在生成readView前提交了， <strong>可见</strong></li>
<li>当 trx_id &gt;= max_trx_id 时：表明生成该数据的事务是在生成ReadView后才开启的， <strong>不可见</strong></li>
<li>当 min_trx_id &lt;= trx_id &lt; max_trx_id 时<ul>
<li>trx_id 在 m_ids 列表里面 ：生成ReadView时，活跃事务还未提交，<strong>不可见</strong></li>
<li>trx_id 不在 m_ids 列表里面 ：事务在生成readView前已经提交了，<strong>可见</strong></li>
</ul>
</li>
</ul>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/4.png" alt="img"></p>
<p><strong>如果某个版本数据对当前事务不可见，那么则要顺着版本链继续向前寻找下个版本</strong>，继续这样判断，以此类推。</p>
<h6 id="3、对于RR（可重复读）和RC（读已提交）在生成一致性视图时机的区别"><a href="#3、对于RR（可重复读）和RC（读已提交）在生成一致性视图时机的区别" class="headerlink" title="3、对于RR（可重复读）和RC（读已提交）在生成一致性视图时机的区别"></a>3、对于RR（可重复读）和RC（读已提交）在生成一致性视图时机的区别</h6><p>对于事务的隔离级别：RR（可重复读）和RC（读已提交）在生成一致性视图的时机是不一样的：</p>
<ul>
<li><p>读提交（read committed RC） 是在<strong>每一次</strong>select的时候生成ReadView的</p>
</li>
<li><p>可重复读（repeatable read RR）是在<strong>第一次</strong>select的时候生成ReadView的</p>
</li>
</ul>
<p>示例：</p>
<p>多个事务如下执行，我们通过这个例子来分析当数据库隔离级别为RC和RR的情况下，当时读数据的<strong>一致性视图</strong>和<strong>版本链</strong>，也就是<strong>MVCC</strong>，分别是怎么样的。</p>
<ul>
<li>假设数据库中有一条初始数据 姓名是小杰，id是1 （id,姓名,trx_id,roll_point），插入此数据的事务id是1</li>
<li>尤其要指出的是，只有这个事务操作了某些表的数据后当更改操作发生的时候（update,delete,insert），才会分配唯一的事务id,并且此事务id是递增的，单纯开启事务是没有事务id的，默认为0，creator_trx_id是0。</li>
<li>以下例子中的A,B,C的意思是将姓名更改为A,B,C，读也是读取当前时刻的姓名，默认全都开启事务，并且此事务都经历过某些操作产生了事务id</li>
</ul>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务100</th>
<th>事务200</th>
<th>事务300</th>
<th>事务400</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>A</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>B</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>C</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>读</td>
<td></td>
</tr>
<tr>
<td>T5</td>
<td>提交</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td></td>
<td>D</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td></td>
<td></td>
<td></td>
<td>读</td>
</tr>
<tr>
<td>T8</td>
<td></td>
<td>E</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T9</td>
<td></td>
<td>提交</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T10</td>
<td></td>
<td></td>
<td>读</td>
<td></td>
</tr>
</tbody></table>
<p>1、读已提交（RC）与MVCC</p>
<ul>
<li>一个事务提交之后，它做的变更才会被其他事务看到<ul>
<li><strong>==每次读==的时候，ReadView(一致性视图)都会重新生成</strong></li>
</ul>
</li>
</ul>
<ol>
<li>当T1时刻时，事务100修改名字为A</li>
<li>当T2时刻时，事务100修改名字为B</li>
<li>当T3时刻时，事务200修改名字为C</li>
<li>当T4时刻时，事务300开始读取名字</li>
</ol>
<p>此时这条数据的版本链如下：（同颜色代表是同一事务内的操作）</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5.png" alt="img"></p>
<p>此时T4时刻事务300要读了，<strong>究竟会读到什么数据</strong>？</p>
<p>当前最近的一条数据是，C，事务200修改的，还记得我们前文说的一致性视图的几个属性和按照什么规则判断这个数据能不能被当前事务读。我们就分析这个例子。</p>
<p>此时 （<strong>生成一致性视图ReadView</strong>）</p>
<ul>
<li><strong>m_ids 是{100,200}：</strong> 当前活跃的读写事务的事务id列表</li>
<li><strong>min_trx_id 是 100：</strong> m_ids的最小值</li>
<li><strong>max_trx_id 是 201：</strong> m_ids的最大值+1</li>
</ul>
<p>当前数据的trx_id(事务id)是 200，符合min_trx_id&lt;=trx_id&lt;max_trx_id 此时需要判断：</p>
<ul>
<li>trx_id 是否在m_ids活跃事务列表里面，<ul>
<li>一看，活跃事务列表里面是{100，200}，只有两个事务活跃，而此时的trx_id是200，则trx_id在活跃事务列表里面，</li>
</ul>
</li>
<li>活跃事务列表代表还未提交的事务，所以该版本数据不可见，就要根据roll_point指针指向上一个版本，</li>
<li>继续这样的判断，上一个版本事务id是100，数据是B，发现100也在活跃事务列表里面，所以不可见，</li>
<li>继续找到上个版本，事务是100，数据是A，发现是同样的情况，</li>
<li>继续找到上个版本，发现事务是1，数据是小杰，1小于100，trx_id&lt;min_trx_id，代表生成这个数据的事务已经在生成ReadView前提交了，此数据可以被读到。所以读取的数据就是<strong>小杰</strong></li>
</ul>
<p>分析完第一个读，我们继续向下分析：</p>
<ol>
<li>当T5时刻时，事务100提交</li>
<li>当T6时刻时，事务300将名字改为D</li>
<li>当T7时刻时，事务400读取当前数据</li>
</ol>
<p>此时这条数据的版本链如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6.png" alt="img"></p>
<p>此时 （<strong>重新生成一致性视图ReadView</strong>）</p>
<ul>
<li><p><strong>m_ids 是{200,300}：</strong> 当前活跃的读写事务的事务id列表</p>
</li>
<li><p><strong>min_trx_id 是 200：</strong> m_ids的最小值</p>
</li>
<li><p><strong>max_trx_id 是 301：</strong> m_ids的最大值+1</p>
</li>
<li><p>当前数据事务id是300，数据为D，符合min_trx_id&lt;=trx_id&lt;max_trx_id</p>
</li>
<li><p>此时需要判断数据是否在活跃事务列表里，300在这里面，所以就是还未提交的事务就是不可见，所以就去查看上个版本的数据，</p>
</li>
<li><p>上个版本事务id是200，数据是C，也在活跃事务列表里面，也不可见，继续向上个版本找，</p>
</li>
<li><p>上个版本事务id是100，数据是B，100小于min_trx_id，就代表，代表生成这个数据的事务已经在生成ReadView前提交了，此数据可见，所以读取出来的数据就是<strong>B</strong></p>
</li>
</ul>
<p>分析完第二个读，我们继续向下分析：</p>
<ol>
<li>当T8时刻时，事务200将名字改为E</li>
<li>当T9时刻时，事务200提交</li>
<li>当T10时刻时，事务300读取当前数据</li>
</ol>
<p>此时这条数据的版本链如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7.png" alt="img"></p>
<p>此时 （<strong>重新生成一致性视图ReadView</strong>）</p>
<ul>
<li><strong>m_ids 是[300]：</strong> 当前活跃的读写事务的事务id列表</li>
<li><strong>min_trx_id 是 300：</strong> m_ids的最小值</li>
<li><strong>max_trx_id 是 301：</strong> m_ids的最大值+1</li>
</ul>
<p>当前事务id是200，200&lt;min_trx_id ,代表生成这个数据的事务已经在生成ReadView前提交了，此数据可见，所以读出的数据就是<strong>E</strong>.</p>
<p>总结：当隔离级别是<strong>读已提交RC</strong>的情况下，每次读都会<strong>重新生成 一致性视图（ReadView）</strong></p>
<ul>
<li>T4时刻 事务300读取到的数据是<strong>小杰</strong></li>
<li>T7时刻 事务400读取到的数据是<strong>B</strong></li>
<li>T10时刻 事务300读取到的数据是<strong>E</strong></li>
</ul>
<p>2、可重复读（RR）与MVCC</p>
<ul>
<li>一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的<ul>
<li>所以对于事务300来讲，它分别在T4和T10的时候，读取数据，但是它的一致性视图，<strong>用的永远都是第一次读取时的视图</strong>，就是T3时刻产生的一致性视图</li>
</ul>
</li>
</ul>
<p><strong>==RR和RC的版本链是一样的==，但是判断当前数据可见与否用到的一致性视图不一样</strong></p>
<p>在此<strong>可重复读RR</strong>隔离级别下：</p>
<ol>
<li>T4时刻时事务300第一次读时的分析和结果与RC都一样，可以见上文分析与结果</li>
<li>T7时刻时事务400第一次读时的分析和结果与RC都一样，可以见上文分析与结果</li>
<li>T10时刻时事务300第二次读时的一致性视图和第一次读时的一样，所以此时到底读取到什么数据就要重新分析了</li>
</ol>
<p>此时 （<strong>用的是第一次读时生成的一致性视图ReadView</strong>）</p>
<ul>
<li><strong>m_ids 是[100,200]：</strong> 当前活跃的读写事务的事务id列表</li>
<li><strong>min_trx_id 是 100：</strong> m_ids的最小值</li>
<li><strong>max_trx_id 是 201：</strong> m_ids的最大值+1</li>
</ul>
<p>此时的版本链是：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7.png" alt="img"></p>
<p>当前数据的事务id是200，数据是E，在当前事务活跃列表里面，所以数据不可见，根据回滚指针找到上个版本，发现事务id是300，当前事务也是300，可见，所以读取的数据是<strong>D</strong></p>
<p>总结：当隔离级别是<strong>可重复读RR</strong>的情况下，每次读都会<strong>用第一次读取数据时生成的一致性视图（ReadView）</strong></p>
<ul>
<li>T4时刻 事务300读取到的数据是<strong>小杰</strong></li>
<li>T7时刻 事务400读取到的数据是<strong>B</strong></li>
<li>T10时刻 事务300读取到的数据是<strong>D</strong></li>
</ul>
<h4 id="2、关于间隙锁与Next-Key-Lock"><a href="#2、关于间隙锁与Next-Key-Lock" class="headerlink" title="2、关于间隙锁与Next-Key Lock"></a>2、关于间隙锁与Next-Key Lock</h4><h5 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h5><p>科普一下Innodb的三种行锁的算法：</p>
<ul>
<li>行锁：就是对单条记录上锁。记录锁（Record Lock）</li>
<li>间隙锁：gap锁，又称为间隙锁。存在的主要目的就是为了<strong>防止在<code>可重复读</code>的事务级别下，出现幻读问题</strong>。</li>
<li>Next-key Lock：Next-Key Locks是在存储引擎innodb、事务级别在<code>可重复读</code>的情况下使用的数据库锁。innodb默认的锁就是Next-Key locks。是行锁和gap锁的组合。<ul>
<li>在可重复读的事务级别下面，普通的select读的是快照，不存在幻读情况，但是如果加上for update的话，读取是已提交事务数据，Next-key Lock锁保证for update情况下，不出现幻读。</li>
</ul>
</li>
</ul>
<h5 id="2、那么gap锁到底是如何加锁的呢？"><a href="#2、那么gap锁到底是如何加锁的呢？" class="headerlink" title="2、那么gap锁到底是如何加锁的呢？"></a>2、那么gap锁到底是如何加锁的呢？</h5><p>假如是for update级别操作，先看看几条总结的何时加锁的规则：</p>
<ul>
<li><strong>唯一索引</strong><ul>
<li><strong>精确等值检索</strong>：Next-Key Locks就<strong>退化为记录锁，不会加gap锁</strong></li>
<li><strong>范围检索</strong>：<strong>会锁住where条件中相应的范围，范围中的记录以及间隙，换言之就是加上记录锁和 gap 锁</strong>（至于区间是多大稍后讨论）。</li>
<li><strong>不走索引检索</strong>：全表间隙加gap锁、全表记录加记录锁——&gt;<strong>升级为表锁</strong></li>
</ul>
</li>
<li><strong>非唯一索引</strong><ul>
<li><strong>精确等值检索</strong>：Next-Key Locks会<strong>对间隙加gap锁</strong>（至于区间是多大稍后讨论），以及<strong>对应检索到的记录加记录锁</strong>。</li>
<li><strong>范围检索</strong>：<strong>会锁住where条件中相应的范围，范围中的记录以及间隙，换言之就是加上记录锁和gap 锁</strong>（至于区间是多大稍后讨论）。</li>
<li><strong>非索引检索</strong>：<strong>全表间隙gap lock，全表记录record lock</strong></li>
</ul>
</li>
</ul>
<h5 id="3、相关实例"><a href="#3、相关实例" class="headerlink" title="3、相关实例"></a>3、相关实例</h5><h6 id="1、建表"><a href="#1、建表" class="headerlink" title="1、建表"></a>1、建表</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gap_table</span><br><span class="line">(</span><br><span class="line">  letter <span class="built_in">varchar</span>(<span class="number">2</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    primary <span class="keyword">key</span>,</span><br><span class="line">  <span class="keyword">num</span>    <span class="built_in">int</span>                   <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> gap_table_num_uindex</span><br><span class="line">  <span class="keyword">on</span> gap_table (<span class="keyword">num</span>);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;d&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;g&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;j&#x27;</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<p>表结构：主键简单点是字符，属性列只有一个数字，是非唯一索引。</p>
<h6 id="2、无gap锁"><a href="#2、无gap锁" class="headerlink" title="2、无gap锁"></a>2、无gap锁</h6><p>假如没有gap锁，也就是把事务级别调到<code>读已提交</code>，执行以下两个session</p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td>select * from gap_table where num=6 for update;结果是一条</td>
<td></td>
</tr>
<tr>
<td></td>
<td>INSERT INTO gap_table (letter, num) VALUES (’’, 6);</td>
</tr>
<tr>
<td>select * from gap_table where num=6 for update;结果是二条，出现幻读</td>
<td></td>
</tr>
</tbody></table>
<h6 id="3、非唯一索引等值检索gap锁"><a href="#3、非唯一索引等值检索gap锁" class="headerlink" title="3、非唯一索引等值检索gap锁"></a>3、非唯一索引等值检索gap锁</h6><p>假如有gap锁，演示一个非唯一索引等值检索gap锁。也就是把事务级别调到<code>可重复读</code>，执行以下两个session</p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td>select * from gap_table where num=6 for update;结果是一条。</td>
<td></td>
</tr>
<tr>
<td></td>
<td>INSERT INTO gap_table (letter, num) VALUES (’’, 6);gap锁住间隙，阻塞无法插入数据。</td>
</tr>
<tr>
<td>select * from gap_table where num=6 for update;结果是一条。不出现幻读</td>
<td></td>
</tr>
</tbody></table>
<h6 id="4、唯一索引（主键）范围检索gap锁"><a href="#4、唯一索引（主键）范围检索gap锁" class="headerlink" title="4、唯一索引（主键）范围检索gap锁"></a>4、唯一索引（主键）范围检索gap锁</h6><p>假如有gap锁，演示一个唯一索引范围检索gap锁。也就是把事务级别调到<code>可重复读</code>，执行以下两个session</p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td>select * from gap_table where letter&gt;’d’ for update;结果是两条。</td>
<td></td>
</tr>
<tr>
<td></td>
<td>INSERT INTO gap_table (letter, num) VALUES (‘z’, 10);gap锁住间隙，阻塞无法插入数据。</td>
</tr>
<tr>
<td>select * from gap_table where letter&gt;’d’ for update;结果是两条。不出现幻读</td>
<td></td>
</tr>
</tbody></table>
<h5 id="4、gap锁是如何锁区间？"><a href="#4、gap锁是如何锁区间？" class="headerlink" title="4、gap锁是如何锁区间？"></a>4、gap锁是如何锁区间？</h5><p>经过上面的演示可以知道<strong>gap锁的基本作用就是保证可重复读的情况下不出现幻读</strong>。</p>
<p>那么还有一点就是gap是按照什么原则进行锁的呢？</p>
<p>要了解gap锁的原则，需要先了解innodb中索引树的结构。</p>
<p>下面一张图片描述了在innodb中，索引的数据结构是如何组织的：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/8.png" alt="img"></p>
<p>从上面的图片可以看出，索引结构分为主索引树和辅助索引树，辅助索引树的叶子节点中包含了主键数据，主键数据影响着叶子节点的排序，<strong>gap锁的关键就是锁住索引树的叶子节点之间的间隙，不让新的记录插入到间隙之中</strong>，说起来可能拗口，下面画图分析。</p>
<h6 id="1、非唯一索引gap锁原则分析"><a href="#1、非唯一索引gap锁原则分析" class="headerlink" title="1、非唯一索引gap锁原则分析"></a>1、非唯一索引gap锁原则分析</h6><p>假如还是使用一开始演示的表结构和数据，那么当前的辅助索引树（数字列）叶子节点的排序结构应该如下。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/9.png" alt="img"></p>
<p>假如执行以下sql的话：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;k&#x27;</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>辅助索引树的叶子节点结构变为以下图片结构，k大于g，所以(6,k)排在后面，我们<strong>先把(6,k)这条数据删除</strong>，方便后面演示：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/10.png" alt="img"></p>
<p>了解了以上的规则，我们进行实际操作演示gap锁区间原则，从而推测锁住哪些区间。</p>
<p><strong>情况1</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行成功</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;a&#x27;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则，叶子节点插入结构如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/11.png" alt="在这里插入图片描述"></p>
<p><strong>情况2</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行失败</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;e&#x27;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则，叶子节点应该插入如下地方，但是因为区间被锁插入失败。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/12.png" alt="img"></p>
<p><strong>情况3</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行失败</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;h&#x27;</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则，叶子节点应该插入如下地方，但是因为区间被锁插入失败。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/13.png" alt="在这里插入图片描述"></p>
<p><strong>情况4</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行失败</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;h&#x27;</span>, <span class="number">7</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则，叶子节点应该插入如下地方，但是因为区间被锁插入失败。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/14.png" alt="在这里插入图片描述"></p>
<p><strong>情况5</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行成功</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> gap_table (letter, <span class="keyword">num</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;h&#x27;</span>, <span class="number">9</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则,插入在未锁区间就能插入成功。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/15.png" alt="在这里插入图片描述"></p>
<h6 id="1、总结"><a href="#1、总结" class="headerlink" title="1、总结"></a>1、总结</h6><p>当session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_table <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>锁住的区间如图所示。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/16.png" alt="在这里插入图片描述"></p>
<p>按照B+索引树排序规则，计算好叶子节点插入位置时，<strong>在被gap锁住的区间段内，不能插入任何数据，只有在gap锁释放时才能进行插入。</strong></p>
<p>在上面的各种情况中锁住的区间其实是（3，d）到（6，g）和（6，g）到（8，j），落到这个区间段的叶子节点都是无法插入的。主键也作为一个信息参与到叶子节点的排序规则中。<strong>这里面边界都是开区间</strong>，插入（3，d），（8，j）的数据会报错主键重复而不是lock等待超时。</p>
<h6 id="2、唯一索引或者非唯一索引范围检索gap锁原则分析"><a href="#2、唯一索引或者非唯一索引范围检索gap锁原则分析" class="headerlink" title="2、唯一索引或者非唯一索引范围检索gap锁原则分析"></a>2、唯一索引或者非唯一索引范围检索gap锁原则分析</h6><p>另一种会出现gap锁的情况就是使用索引时，用到范围检索，就会出现gap 锁。</p>
<p>使用以下表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gap_tbz</span><br><span class="line">(</span><br><span class="line">  <span class="keyword">id</span>   <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    primary <span class="keyword">key</span>,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">11</span>)   <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.gap_tbz (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.gap_tbz (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;h&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.gap_tbz (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;m&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.gap_tbz (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;ds&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>情况1</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行失败</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> gap_tbz <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">&#x27;cc&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>按照排序规则，这里应该是在主键索引树检索，叶子节点插入结构如下。由于session1执行了范围的for update sql语句，因此范围内添加了gap锁，<strong>gap锁的区间是id在（5，+无限）</strong></p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/17.png" alt="在这里插入图片描述"></p>
<p>当执行插入的id范围在5之前，如下sql，能够<strong>执行成功</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> gap_tbz <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;cc&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>但若此时将session1的sql修改为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt;= <span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>则<strong>此时gap锁的区间为id区间（1,5）和（5，+无限）</strong>，也就是说以下sql会执行失败：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> gap_tbz <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;cc&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>这也同时反映了间隙锁Gap的危害：在数据行2/3/4进行插入操作不会影响session1的sql的执行效果，但是此时数据行2/3/4却因为被加上了间隙锁而导致不能实现插入操作</li>
</ul>
<p><strong>情况2</strong></p>
<p>分别有两个session，session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt; <span class="number">11</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>session2执行以下sql，<strong>执行失败</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以下报错 lock等待超时</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> gap_tbz <span class="keyword">values</span>(<span class="number">11</span>,<span class="string">&#x27;cc&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下报错 主键重复</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> gap_tbz <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;cc&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#从两种报错来看也可以看出gap锁区间是左开右闭</span></span><br></pre></td></tr></table></figure>

<p>按照排序规则，这里应该是在主键索引树检索，由于session1执行了范围的for update sql语句，因此范围内添加了gap锁，<strong>gap锁的区间是id在（5，11]**，</strong>唯一索引gap锁区间是左开右闭**。</p>
<h6 id="2、总结"><a href="#2、总结" class="headerlink" title="2、总结"></a>2、总结</h6><p>当session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>此时gap锁的区间是id在（5，+无限）</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/17.png" alt="在这里插入图片描述"></p>
<p>当session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt;= <span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>此时gap锁的区间为id区间（1,5）和（5，+无限）</p>
<p>当session1执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> gap_tbz <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt; <span class="number">11</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>此时gap锁的区间是id在（5，11]，唯一索引gap锁区间是左开右闭</p>
<h6 id="3、思考（在session1执行for-update语句）"><a href="#3、思考（在session1执行for-update语句）" class="headerlink" title="3、思考（在session1执行for update语句）"></a>3、思考（在session1执行for update语句）</h6><p>假如条件是一个非索引列，那么如何处理？</p>
<ul>
<li><strong>假如是非索引列，那么将会全表间隙加上gap锁。</strong></li>
<li>如果此时整个锁没有数据的话，那么整个表都会加上<strong>一个间隙锁</strong></li>
</ul>
<p>条件是唯一索引等值检索且记录不存在的情况，会使用gap lock？</p>
<ul>
<li>我们要考虑，gap lock是防止幻读，那么尝试思考，使用唯一索引所谓条件查找数据for update，如果对应的记录不存在的话，是无法使用行锁的。</li>
<li>这时候，会使用gap lock来锁住区间，保证记录不会插入，防止出现幻读。</li>
</ul>
<p>使用了间隙锁可以在可重复读的隔离级别下解决幻读问题，那么间隙锁Gap在并发情况下很容易造成死锁问题</p>
<ul>
<li><p>字段id为不是主键，可以查询出多个值，数据库没有id=10这些数据</p>
</li>
<li><p>事务A、事务B同时执行select * from table where id = 10 for update 语句</p>
</li>
<li><p>事务A执行时SQL语句时加上了间隙锁，同时添加数据一条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span>(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="number">10</span>,<span class="string">&quot;zs&quot;</span>); </span><br></pre></td></tr></table></figure>

<p>此时事务A对除了（10，”zs”）这条数据以外的数据都设置了间隙锁</p>
</li>
<li><p>事务B 执行select * from table where id = 10 for update 语句查出（10，”zs”）这条数据，并对除了（10，”zs”）这条数据以外的数据都设置了间隙锁</p>
</li>
<li><p>此时事务A如果去添加数据一条其他数据，如（10，”ls”）或者事务B如果去添加数据一条其他数据，如（10，”ww”）</p>
</li>
<li><p>事务A与事务B都会因为对方的间隙锁而导致插入阻塞，从而导致死锁。</p>
</li>
<li><p>使用Next-Key Lock 可以解决以上问题：因为使用Next-Key Lock可以把（10，”zs”）这条数据也加上锁</p>
</li>
</ul>
<h6 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h6><p><strong>间隙锁的危害</strong></p>
<ol>
<li>在数据行2/3/4（间隙）进行插入操作不会影响session1的sql的执行效果的情况下，此时数据行2/3/4（间隙）却因为被加上了间隙锁而导致不能实现插入操作</li>
<li>在使用for update的情况下，会有大面积的间隙锁产生，此时其他连接不能操作当前数据</li>
<li>死锁问题</li>
</ol>
<p><strong>Next-Key Lock的作用</strong></p>
<ol>
<li>在<strong>非唯一索引</strong>的<strong>精确等值检索</strong>时，Next-Key Locks会<strong>对间隙加gap锁</strong>，以及<strong>对应检索到的记录加记录锁</strong>。防止出现幻读问题</li>
<li>解决死锁问题</li>
<li>Next-Key Locks是在存储引擎innodb、事务级别在<code>可重复读</code>的情况下使用的数据库锁。</li>
</ol>
<p>补充：<strong>关于Next-Key Lock加的记录锁是读锁还是写锁的问题</strong></p>
<p>经过测试得：在Mysql8，存储引擎为InnoDB的情况下</p>
<ul>
<li>如果使用的select……lock in share mode进行搜索，使用的是共享锁，则记录锁是读锁</li>
<li>如果使用的select……for update进行搜索，使用的是独占锁，则记录锁是写锁</li>
</ul>
<hr>
<h3 id="16、常用SQL技巧"><a href="#16、常用SQL技巧" class="headerlink" title="16、常用SQL技巧"></a>16、常用SQL技巧</h3><h4 id="1、常见通用的Join查询"><a href="#1、常见通用的Join查询" class="headerlink" title="1、常见通用的Join查询"></a>1、常见通用的Join查询</h4><h5 id="1、SQL执行顺序"><a href="#1、SQL执行顺序" class="headerlink" title="1、SQL执行顺序"></a>1、SQL执行顺序</h5><p>编写顺序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">	&lt;<span class="keyword">select</span> <span class="keyword">list</span>&gt;</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	&lt;left_table&gt; &lt;join_type&gt;</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">	&lt;right_table&gt; <span class="keyword">ON</span> &lt;join_condition&gt;</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	&lt;where_condition&gt;</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	&lt;group_by_list&gt;</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">	&lt;having_condition&gt;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	&lt;order_by_condition&gt;</span><br><span class="line"><span class="keyword">LIMIT</span></span><br><span class="line">	&lt;limit_params&gt;</span><br></pre></td></tr></table></figure>

<p>执行顺序（随着Mysql版本的更新换代，其优化器也在不断的升级，优化器会分析不同执行顺序产生的性能消耗不同而动态调整执行顺序）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM	&lt;left_table&gt;</span><br><span class="line"></span><br><span class="line">ON 		&lt;join_condition&gt;</span><br><span class="line"></span><br><span class="line">&lt;join_type&gt;		JOIN	&lt;right_table&gt;</span><br><span class="line"></span><br><span class="line">WHERE		&lt;where_condition&gt;</span><br><span class="line"></span><br><span class="line">GROUP BY 	&lt;group_by_list&gt;</span><br><span class="line"></span><br><span class="line">HAVING		&lt;having_condition&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>		&lt;<span class="keyword">select</span> <span class="keyword">list</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>	&lt;order_by_condition&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">LIMIT</span>		&lt;limit_params&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/CD1FEFDE-D4C7-45B1-A107-10065C7407B3.png" alt="img"></p>
<h5 id="2、Join图"><a href="#2、Join图" class="headerlink" title="2、Join图"></a>2、Join图</h5><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/7C9B4A4B-2A23-4A79-8624-88EFA02FB1F9.png" alt="img"></p>
<p>共有与独有(理解)：</p>
<ul>
<li>共有：满足 a.deptid = b.id 的叫共有</li>
<li>A独有：A 表中所有不满足 a.deptid = b.id 连接关系的数据</li>
</ul>
<p>同时参考 join 图</p>
<h6 id="1、案例准备"><a href="#1、案例准备" class="headerlink" title="1、案例准备"></a>1、案例准备</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_dept`</span> (</span><br><span class="line"> <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"> <span class="string">`deptName`</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> <span class="string">`address`</span> <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_emp`</span> (</span><br><span class="line"> <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"> <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">INT</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> <span class="string">`deptId`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line"> <span class="keyword">KEY</span> <span class="string">`fk_dept_id`</span> (<span class="string">`deptId`</span>)</span><br><span class="line"> <span class="comment">#CONSTRAINT `fk_dept_id` FOREIGN KEY (`deptId`) REFERENCES `t_dept` (`id`)</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;华山&#x27;</span>,<span class="string">&#x27;华山&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;丐帮&#x27;</span>,<span class="string">&#x27;洛阳&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;峨眉&#x27;</span>,<span class="string">&#x27;峨眉山&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;武当&#x27;</span>,<span class="string">&#x27;武当山&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;明教&#x27;</span>,<span class="string">&#x27;光明顶&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_dept(deptName,address) <span class="keyword">VALUES</span>(<span class="string">&#x27;少林&#x27;</span>,<span class="string">&#x27;少林寺&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;风清扬&#x27;</span>,<span class="number">90</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;岳不群&#x27;</span>,<span class="number">50</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;令狐冲&#x27;</span>,<span class="number">24</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;洪七公&#x27;</span>,<span class="number">70</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;乔峰&#x27;</span>,<span class="number">35</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;灭绝师太&#x27;</span>,<span class="number">70</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;周芷若&#x27;</span>,<span class="number">20</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;张三丰&#x27;</span>,<span class="number">100</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;张无忌&#x27;</span>,<span class="number">25</span>,<span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_emp(<span class="keyword">NAME</span>,age,deptId) <span class="keyword">VALUES</span>(<span class="string">&#x27;韦小宝&#x27;</span>,<span class="number">18</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h6 id="2、7种JOIN"><a href="#2、7种JOIN" class="headerlink" title="2、7种JOIN"></a>2、7种JOIN</h6><ol>
<li><p>A、B两表共有（inner join）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_emp a <span class="keyword">inner</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptId = b.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>A、B两表共有 + A的独有（a left join b）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_emp a <span class="keyword">left</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptId = b.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>A、B两表共有 + B的独有（a right join b）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_emp a <span class="keyword">right</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptId = b.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>A的独有（a left join b + on a.Id = b.id + where b.id is null）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_emp a <span class="keyword">left</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptId = b.id <span class="keyword">where</span> b.id <span class="keyword">is</span> <span class="literal">null</span>; </span><br></pre></td></tr></table></figure>
</li>
<li><p>B的独有（a right join b + on a.Id = b.id where a.Id is null）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_emp a <span class="keyword">right</span> <span class="keyword">join</span> t_dept b <span class="keyword">on</span> a.deptId = b.id <span class="keyword">where</span> a.deptId <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AB全有（a full outer join b）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL Full Join的实现 因为MySQL不支持FULL JOIN,下面是替代方法：</span></span><br><span class="line"><span class="comment">-- left join + union(可去除重复数据)+ right join</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_emp A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_dept B <span class="keyword">ON</span> A.deptId = B.id</span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_emp A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> t_dept B <span class="keyword">ON</span> A.deptId = B.id</span><br></pre></td></tr></table></figure>

<p>这里因为要联合的缘故，不能考虑到小表驱动大表的情况。只能用right join。要保证查询出来的数字要一致。</p>
</li>
<li><p>A的独有 + B的独有（a full outer join b + on a.Id = b.id + where a.Id is null or b,id = null）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">FROM</span> t_emp A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_dept B <span class="keyword">ON</span> A.deptId = B.id <span class="keyword">WHERE</span> B.<span class="string">`id`</span> <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_emp A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> t_dept B <span class="keyword">ON</span> A.deptId = B.id <span class="keyword">WHERE</span> A.<span class="string">`deptId`</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h6 id="3、子查询与join两者区别"><a href="#3、子查询与join两者区别" class="headerlink" title="3、子查询与join两者区别"></a>3、子查询与join两者区别</h6><p>思想上的区别：</p>
<ul>
<li>子查询理解：<ol>
<li>先知道需要查询并将数据拿出来(若from 后的表也是一个子查询结果)。</li>
<li>在去寻找满足判断条件的数据(where,on,having 后的参数等)。而这些查询条件通常是通过子查询获得的。</li>
<li>子查询是一种根据结果找条件的倒推的顺序。比较好理解与判断</li>
</ol>
</li>
<li>join理解：<ol>
<li>执行完第一步后的结果为一张新表。</li>
<li>在将新表与 t_emp 进行下一步的 left join 关联。</li>
<li>先推出如何获得条件，再像算数题一样一步一步往下 join。可以交换顺序，但只能是因为条件间不相互关联时才能交换顺序。</li>
<li>join 比 子查询难一点 </li>
<li><strong>join 能用到索引，但是子查询出来的表会使索引失效。</strong></li>
</ol>
</li>
</ul>
<h4 id="2、正则表达式使用"><a href="#2、正则表达式使用" class="headerlink" title="2、正则表达式使用"></a>2、正则表达式使用</h4><p>正则表达式（Regular Expression）是指一个用来描述或者匹配一系列符合某个句法规则的字符串的单个字符串。</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>在字符串开始处进行匹配</td>
</tr>
<tr>
<td>$</td>
<td>在字符串末尾处进行匹配</td>
</tr>
<tr>
<td>.</td>
<td>匹配任意单个字符, 包括换行符</td>
</tr>
<tr>
<td>[…]</td>
<td>匹配出括号内的任意字符</td>
</tr>
<tr>
<td>[^…]</td>
<td>匹配不出括号内的任意字符</td>
</tr>
<tr>
<td>a*</td>
<td>匹配零个或者多个a(包括空串)</td>
</tr>
<tr>
<td>a+</td>
<td>匹配一个或者多个a(不包括空串)</td>
</tr>
<tr>
<td>a?</td>
<td>匹配零个或者一个a</td>
</tr>
<tr>
<td>a1|a2</td>
<td>匹配a1或a2</td>
</tr>
<tr>
<td>a(m)</td>
<td>匹配m个a</td>
</tr>
<tr>
<td>a(m,)</td>
<td>至少匹配m个a</td>
</tr>
<tr>
<td>a(m,n)</td>
<td>匹配m个a 到 n个a</td>
</tr>
<tr>
<td>a(,n)</td>
<td>匹配0到n个a</td>
</tr>
<tr>
<td>(…)</td>
<td>将模式元素组成单一元素</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> <span class="keyword">name</span> regexp <span class="string">&#x27;^T&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> <span class="keyword">name</span> regexp <span class="string">&#x27;2$&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> <span class="keyword">name</span> regexp <span class="string">&#x27;[uvw]&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="3、MySQL-常用函数"><a href="#3、MySQL-常用函数" class="headerlink" title="3、MySQL 常用函数"></a>3、MySQL 常用函数</h4><p>数字函数</p>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody><tr>
<td>ABS</td>
<td>求绝对值</td>
</tr>
<tr>
<td>SQRT</td>
<td>求二次方根</td>
</tr>
<tr>
<td>MOD</td>
<td>求余数</td>
</tr>
<tr>
<td>CEIL 和 CEILING</td>
<td>两个函数功能相同，都是返回不小于参数的最小整数，即向上取整</td>
</tr>
<tr>
<td>FLOOR</td>
<td>向下取整，返回值转化为一个BIGINT</td>
</tr>
<tr>
<td>RAND</td>
<td>生成一个0~1之间的随机数，传入整数参数是，用来产生重复序列</td>
</tr>
<tr>
<td>ROUND</td>
<td>对所传参数进行四舍五入</td>
</tr>
<tr>
<td>SIGN</td>
<td>返回参数的符号</td>
</tr>
<tr>
<td>POW 和 POWER</td>
<td>两个函数的功能相同，都是所传参数的次方的结果值</td>
</tr>
<tr>
<td>SIN</td>
<td>求正弦值</td>
</tr>
<tr>
<td>ASIN</td>
<td>求反正弦值，与函数 SIN 互为反函数</td>
</tr>
<tr>
<td>COS</td>
<td>求余弦值</td>
</tr>
<tr>
<td>ACOS</td>
<td>求反余弦值，与函数 COS 互为反函数</td>
</tr>
<tr>
<td>TAN</td>
<td>求正切值</td>
</tr>
<tr>
<td>ATAN</td>
<td>求反正切值，与函数 TAN 互为反函数</td>
</tr>
<tr>
<td>COT</td>
<td>求余切值</td>
</tr>
</tbody></table>
<p>字符串函数</p>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody><tr>
<td>LENGTH</td>
<td>计算字符串长度函数，返回字符串的字节长度</td>
</tr>
<tr>
<td>CONCAT</td>
<td>合并字符串函数，返回结果为连接参数产生的字符串，参数可以使一个或多个</td>
</tr>
<tr>
<td>INSERT</td>
<td>替换字符串函数</td>
</tr>
<tr>
<td>LOWER</td>
<td>将字符串中的字母转换为小写</td>
</tr>
<tr>
<td>UPPER</td>
<td>将字符串中的字母转换为大写</td>
</tr>
<tr>
<td>LEFT</td>
<td>从左侧字截取符串，返回字符串左边的若干个字符</td>
</tr>
<tr>
<td>RIGHT</td>
<td>从右侧字截取符串，返回字符串右边的若干个字符</td>
</tr>
<tr>
<td>TRIM</td>
<td>删除字符串左右两侧的空格</td>
</tr>
<tr>
<td>REPLACE</td>
<td>字符串替换函数，返回替换后的新字符串</td>
</tr>
<tr>
<td>SUBSTRING</td>
<td>截取字符串，返回从指定位置开始的指定长度的字符换（下标从1开始）</td>
</tr>
<tr>
<td>REVERSE</td>
<td>字符串反转（逆序）函数，返回与原始字符串顺序相反的字符串</td>
</tr>
</tbody></table>
<p>日期函数</p>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody><tr>
<td>CURDATE 和 CURRENT_DATE</td>
<td>两个函数作用相同，返回当前系统的日期值</td>
</tr>
<tr>
<td>CURTIME 和 CURRENT_TIME</td>
<td>两个函数作用相同，返回当前系统的时间值</td>
</tr>
<tr>
<td>NOW 和  SYSDATE</td>
<td>两个函数作用相同，返回当前系统的日期和时间值</td>
</tr>
<tr>
<td>MONTH</td>
<td>获取指定日期中的月份</td>
</tr>
<tr>
<td>MONTHNAME</td>
<td>获取指定日期中的月份英文名称</td>
</tr>
<tr>
<td>DAYNAME</td>
<td>获取指定曰期对应的星期几的英文名称</td>
</tr>
<tr>
<td>DAYOFWEEK</td>
<td>获取指定日期对应的一周的索引位置值</td>
</tr>
<tr>
<td>WEEK</td>
<td>获取指定日期是一年中的第几周，返回值的范围是否为 0〜52 或 1〜53</td>
</tr>
<tr>
<td>DAYOFYEAR</td>
<td>获取指定曰期是一年中的第几天，返回值范围是1~366</td>
</tr>
<tr>
<td>DAYOFMONTH</td>
<td>获取指定日期是一个月中是第几天，返回值范围是1~31</td>
</tr>
<tr>
<td>YEAR</td>
<td>获取年份，返回值范围是 1970〜2069</td>
</tr>
<tr>
<td>TIME_TO_SEC</td>
<td>将时间参数转换为秒数</td>
</tr>
<tr>
<td>SEC_TO_TIME</td>
<td>将秒数转换为时间，与TIME_TO_SEC 互为反函数</td>
</tr>
<tr>
<td>DATE_ADD 和 ADDDATE</td>
<td>两个函数功能相同，都是向日期添加指定的时间间隔</td>
</tr>
<tr>
<td>DATE_SUB 和 SUBDATE</td>
<td>两个函数功能相同，都是向日期减去指定的时间间隔</td>
</tr>
<tr>
<td>ADDTIME</td>
<td>时间加法运算，在原始时间上添加指定的时间</td>
</tr>
<tr>
<td>SUBTIME</td>
<td>时间减法运算，在原始时间上减去指定的时间</td>
</tr>
<tr>
<td>DATEDIFF</td>
<td>获取两个日期之间间隔，返回参数 1 减去参数 2 的值</td>
</tr>
<tr>
<td>DATE_FORMAT</td>
<td>格式化指定的日期，根据参数返回指定格式的值</td>
</tr>
<tr>
<td>WEEKDAY</td>
<td>获取指定日期在一周内的对应的工作日索引</td>
</tr>
</tbody></table>
<p>聚合函数</p>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>MAX</td>
<td>查询指定列的最大值</td>
</tr>
<tr>
<td>MIN</td>
<td>查询指定列的最小值</td>
</tr>
<tr>
<td>COUNT</td>
<td>统计查询结果的行数</td>
</tr>
<tr>
<td>SUM</td>
<td>求和，返回指定列的总和</td>
</tr>
<tr>
<td>AVG</td>
<td>求平均值，返回指定列数据的平均值</td>
</tr>
</tbody></table>
<hr>
<h3 id="17、MySql中常用工具"><a href="#17、MySql中常用工具" class="headerlink" title="17、MySql中常用工具"></a>17、MySql中常用工具</h3><h4 id="1、mysql"><a href="#1、mysql" class="headerlink" title="1、mysql"></a>1、mysql</h4><p>该mysql不是指mysql服务，而是指mysql的客户端工具。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql [options] [database]</span><br></pre></td></tr></table></figure>

<h5 id="1、连接选项"><a href="#1、连接选项" class="headerlink" title="1、连接选项"></a>1、连接选项</h5><p>参数[options]：</p>
<ul>
<li>-u, –user=name：指定用户名</li>
<li>-p, –password[=name]：指定密码</li>
<li>-h, –host=name：指定服务器IP或域名</li>
<li>-P, –port=#：指定连接端口</li>
</ul>
<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -P 3306 -u root -p</span><br><span class="line"></span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p2143</span><br></pre></td></tr></table></figure>

<h5 id="2、执行选项"><a href="#2、执行选项" class="headerlink" title="2、执行选项"></a>2、执行选项</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行SQL语句并退出</span></span><br><span class="line">-e, --execute=name</span><br></pre></td></tr></table></figure>

<p>此选项可以<strong>在Mysql客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这种方式尤其方便。</strong></p>
<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p2143 db01 -e <span class="string">&quot;select * from tb_book&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555325632715.png" alt="1555325632715"> </p>
<h4 id="2、mysqladmin"><a href="#2、mysqladmin" class="headerlink" title="2、mysqladmin"></a>2、mysqladmin</h4><p><strong>mysqladmin 是一个执行管理操作的客户端程序</strong>。可以用它来==检查服务器的配置和当前状态==、==创建并删除数据库==等。也是对于一些批处理脚本，这种方式尤其方便。</p>
<p>可以通过 ： <code>mysqladmin --help</code>  指令查看帮助文档</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555326108697.png" alt="1555326108697"></p>
<p>示例 ： </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p2143 create <span class="string">&#x27;test01&#x27;</span>;  </span><br><span class="line"></span><br><span class="line">mysqladmin -uroot -p2143 drop <span class="string">&#x27;test01&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysqladmin -uroot -p2143 version;	</span><br></pre></td></tr></table></figure>



<h4 id="3、mysqlbinlog"><a href="#3、mysqlbinlog" class="headerlink" title="3、mysqlbinlog"></a>3、mysqlbinlog</h4><p><strong>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到mysqlbinlog 日志管理工具。</strong></p>
<p>语法 ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [options]  log-files1 log-files2 ...</span><br></pre></td></tr></table></figure>

<p>选项[options]：</p>
<ul>
<li>-d, –database=name：指定数据库名称，只列出指定的数据库相关操作。</li>
<li>-o, –offset=#：忽略掉日志中的前n行命令。</li>
<li>-r,–result-file=name：将输出的文本格式日志输出到指定文件。</li>
<li>-s, –short-form：显示简单格式， 省略掉一些信息。</li>
<li>–start-datatime=date1  –stop-datetime=date2：指定日期间隔内的所有日志。</li>
<li>–start-position=pos1 –stop-position=pos2：指定位置间隔内的所有日志。</li>
</ul>
<h4 id="4、mysqldump"><a href="#4、mysqldump" class="headerlink" title="4、mysqldump"></a>4、mysqldump</h4><p>mysqldump 客户端工具用来==备份数据库==或==在不同数据库之间进行数据迁移==。</p>
<p><strong>备份内容包含创建表，及插入表的SQL语句。</strong></p>
<p>语法 ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqldump [options] db_name [tables]</span><br><span class="line"></span><br><span class="line">mysqldump [options] --database/-B db1 [db2 db3...]</span><br><span class="line"></span><br><span class="line">mysqldump [options] --all-databases/-A</span><br></pre></td></tr></table></figure>

<h5 id="1、连接选项-1"><a href="#1、连接选项-1" class="headerlink" title="1、连接选项"></a>1、连接选项</h5><p>参数[options]：</p>
<ul>
<li>-u, –user=name：指定用户名</li>
<li>-p, –password[=name]：指定密码</li>
<li>-h, –host=name：指定服务器IP或域名</li>
<li>-P, –port=#：指定连接端口</li>
</ul>
<h5 id="2、输出内容选项"><a href="#2、输出内容选项" class="headerlink" title="2、输出内容选项"></a>2、输出内容选项</h5><p>参数[options]：</p>
<ul>
<li>–add-drop-database：在每个数据库创建语句前加上 Drop database 语句（如果数据库存在就删除旧数据库）</li>
<li>–add-drop-table：在每个表创建语句前加上 Drop table 语句 , 默认开启 ; 不开启 (<code>--skip-add-drop-table</code>)</li>
<li>-n, –no-create-db：不包含数据库的创建语句</li>
<li>-t, –no-create-info：不包含数据表的创建语句</li>
<li>-d –no-data：不包含数据</li>
<li>-q –quick：加上 -q 后，不会把SELECT出来的结果放在buffer中，而是直接dump到标准输出中，顶多只是buffer当前行结果，正常情况下是不会超过 max_allowed_packet 限制的，它默认情况下是开启的。</li>
<li>-R：备份存储过程等</li>
<li>-T, –tab=name：自动生成两个文件：<ul>
<li>一个.sql文件，创建表结构的语句；</li>
<li>一个.txt文件，数据文件，相当于select into outfile </li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table &gt; a</span><br><span class="line">	</span><br><span class="line">mysqldump -uroot -p2143 -T /tmp <span class="built_in">test</span> city</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902222238916.png" alt="image-20210902222238916"></p>
<h4 id="5、mysqlimport-source"><a href="#5、mysqlimport-source" class="headerlink" title="5、mysqlimport/source"></a>5、mysqlimport/source</h4><p>mysqlimport 是<strong>客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件</strong>。</p>
<p>语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport [options]  db_name  textfile1  [textfile2...]</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport -uroot -p2143 <span class="built_in">test</span> /tmp/city.txt</span><br></pre></td></tr></table></figure>

<p>如果需要导入sql文件，可以使用mysql中的source 指令 : </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /root/tb_book.sql</span><br></pre></td></tr></table></figure>



<h4 id="6、mysqlshow"><a href="#6、mysqlshow" class="headerlink" title="6、mysqlshow"></a>6、mysqlshow</h4><p>mysqlshow <strong>客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引</strong>。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlshow [options] [db_name [table_name [col_name]]]</span><br></pre></td></tr></table></figure>

<p>参数[options]：</p>
<ul>
<li>–count：显示数据库及表的统计信息（数据库，表 均可以不指定）</li>
<li>-i：显示指定数据库或者指定表的状态信息</li>
</ul>
<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询每个数据库的表的数量及表中记录的数量</span></span><br><span class="line">mysqlshow -uroot -p2143 --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中每个表中的字段书，及行数</span></span><br><span class="line">mysqlshow -uroot -p2143 <span class="built_in">test</span> --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中book表的详细情况</span></span><br><span class="line">mysqlshow -uroot -p2143 <span class="built_in">test</span> book --count</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="18、Mysql-日志"><a href="#18、Mysql-日志" class="headerlink" title="18、Mysql 日志"></a>18、Mysql 日志</h3><p>在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的方方面面，以帮助数据库管理员追踪数据库曾经发生过的各种事件。MySQL 也不例外。</p>
<p>在 MySQL 中，有 4 种不同的日志，分别是：</p>
<ul>
<li>错误日志</li>
<li>二进制日志（BINLOG 日志）</li>
<li>查询日志</li>
<li>慢查询日志</li>
</ul>
<p>这些日志记录着数据库在不同方面的踪迹。</p>
<p>全局查询日志：</p>
<p>配置启用：</p>
<p>在mysql的my.cnf中，设置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启</span></span><br><span class="line">general_log=1   </span><br><span class="line"><span class="comment"># 记录日志文件的路径</span></span><br><span class="line">general_log_file=/path/logfile</span><br><span class="line"><span class="comment">#输出格式</span></span><br><span class="line">log_output=FILE</span><br></pre></td></tr></table></figure>

<p>编码启用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全局日志可以存放到日志文件中，也可以存放到Mysql系统表中。存放到日志中性能更好一些，存储到表中</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_output=<span class="string">&#x27;TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 此后 ，你所编写的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mysql.general_log;</span><br></pre></td></tr></table></figure>



<h4 id="1、错误日志"><a href="#1、错误日志" class="headerlink" title="1、错误日志"></a>1、错误日志</h4><p>错误日志是 MySQL 中最重要的日志之一，它<strong>记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志</strong>。</p>
<p>该日志是<strong>默认开启</strong>的 ， <strong>默认存放目录为 mysql 的数据目录（var/lib/mysql）, 默认的日志文件名为  hostname.err（hostname是主机名）。</strong></p>
<p>查看日志位置指令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;log_error%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553993244446.png" alt="1553993244446"> </p>
<p>查看日志内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/lib/mysql/xaxh-server.err</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1553993537874.png" alt="1553993537874"> </p>
<h4 id="2、二进制日志"><a href="#2、二进制日志" class="headerlink" title="2、二进制日志"></a>2、二进制日志</h4><h5 id="1、概述-1"><a href="#1、概述-1" class="headerlink" title="1、概述"></a>1、概述</h5><p><strong>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但是不包括数据查询语句</strong>。</p>
<p>此日志<strong>对于灾难时的数据恢复起着极其重要的作用，MySQL的主从复制， 就是通过该binlog实现的。</strong></p>
<p>二进制日志，<strong>默认情况下是没有开启的，需要到MySQL的配置文件中开启，并配置MySQL日志的格式</strong>。 </p>
<p><strong>配置文件位置 : /usr/my.cnf</strong></p>
<p>日志存放位置：配置时，给定了文件名但是没有指定路径，<strong>日志默认写入Mysql的数据目录（var/lib/mysql）</strong>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002</span></span><br><span class="line">log_bin=mysqlbin</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置二进制日志的格式</span></span><br><span class="line">binlog_format=STATEMENT</span><br></pre></td></tr></table></figure>

<h5 id="2、日志格式"><a href="#2、日志格式" class="headerlink" title="2、日志格式"></a>2、日志格式</h5><h6 id="1、STATEMENT"><a href="#1、STATEMENT" class="headerlink" title="1、STATEMENT"></a>1、STATEMENT</h6><p><strong>该日志格式在日志文件中记录的都是==SQL语句（statement）==，每一条对数据进行修改的SQL都会记录在日志文件中，通过Mysql提供的mysqlbinlog工具，可以清晰的查看到每条语句的文本。</strong></p>
<p><strong>主从复制的时候，从库（slave）会将日志解析为原文本，并在从库重新执行一次。</strong></p>
<h6 id="2、ROW"><a href="#2、ROW" class="headerlink" title="2、ROW"></a>2、ROW</h6><p><strong>该日志格式在日志文件中记录的是==每一行的数据变更==，而不是记录SQL语句。</strong></p>
<p>比如，执行SQL语句 ： update tb_book set status=’1’：</p>
<ul>
<li>如果是STATEMENT 日志格式，在日志中会记录一行SQL文件；</li>
<li> 如果是ROW，由于是对全表进行更新，也就是每一行记录都会发生变更，ROW 格式的日志中会记录每一行的数据变更。</li>
</ul>
<h6 id="3、MIXED"><a href="#3、MIXED" class="headerlink" title="3、MIXED"></a>3、MIXED</h6><p><strong>这是目前MySQL默认的日志格式，即混合了STATEMENT 和 ROW两种格式。</strong></p>
<p><strong>默认情况下采用STATEMENT</strong>，但是在一些特殊情况下采用ROW来进行记录。MIXED 格式能尽量利用两种模式的优点，而避开他们的缺点。</p>
<h5 id="3、日志读取"><a href="#3、日志读取" class="headerlink" title="3、日志读取"></a>3、日志读取</h5><p>由于日志以二进制方式存储，不能直接读取，需要用mysqlbinlog工具来查看，语法如下 ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog log-file；</span><br></pre></td></tr></table></figure>

<h6 id="1、查看STATEMENT格式日志"><a href="#1、查看STATEMENT格式日志" class="headerlink" title="1、查看STATEMENT格式日志"></a>1、查看STATEMENT格式日志</h6><p>执行插入语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Lucene&#x27;</span>,<span class="string">&#x27;2088-05-01&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p> 查看日志文件：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554079717375.png" alt="1554079717375"> </p>
<ul>
<li>mysqlbin.index：该文件是日志索引文件 ， 记录日志的文件名；</li>
<li>mysqlbing.000001：日志文件</li>
</ul>
<p>查看日志内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog mysqlbing.000001；</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554080016778.png" alt="1554080016778"> </p>
<h6 id="2、查看ROW格式日志"><a href="#2、查看ROW格式日志" class="headerlink" title="2、查看ROW格式日志"></a>2、查看ROW格式日志</h6><p>配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002</span></span><br><span class="line">log_bin=mysqlbin</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置二进制日志的格式</span></span><br><span class="line">binlog_format=ROW</span><br></pre></td></tr></table></figure>

<p>插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;SpringCloud实战&#x27;</span>,<span class="string">&#x27;2088-05-05&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>如果日志格式是 ROW , 直接查看数据 , 是查看不懂的；可以在mysqlbinlog 后面加上参数 -vv  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -vv mysqlbin.000002 </span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554095452022.png" alt="1554095452022"> </p>
<h5 id="4、日志删除"><a href="#4、日志删除" class="headerlink" title="4、日志删除"></a>4、日志删除</h5><p><strong>对于比较繁忙的系统，由于每天生成日志量大 ，这些日志如果长时间不清楚，将会占用大量的磁盘空间</strong>。</p>
<p>下面我们将会讲解几种删除日志的常见方法 ：</p>
<h6 id="1、方式一：Reset-Master"><a href="#1、方式一：Reset-Master" class="headerlink" title="1、方式一：Reset Master"></a>1、方式一：Reset Master</h6><p>通过 <code>Reset Master</code> 指令删除全部 binlog 日志，删除之后，日志编号，将从 xxxx.000001重新开始 。</p>
<p>查询之前 ，先查询下日志文件：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554118609489.png" alt="1554118609489">   </p>
<p>执行删除日志指令： </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reset Master</span><br></pre></td></tr></table></figure>

<p>执行之后， 查看日志文件：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554118675264.png" alt="1554118675264"> </p>
<h6 id="2、方式二：purge-master-logs-to-‘mysqlbin-’"><a href="#2、方式二：purge-master-logs-to-‘mysqlbin-’" class="headerlink" title="2、方式二：purge  master logs to ‘mysqlbin.*’"></a>2、方式二：purge  master logs to ‘mysqlbin.*’</h6><p>执行指令 <code> purge  master logs to &#39;mysqlbin.******&#39;</code> ，该命令将删除  <code> ******</code> 编号之前的所有日志。 </p>
<h6 id="3、方式三：purge-master-logs-before-‘yyyy-mm-dd-hh24-mi-ss’"><a href="#3、方式三：purge-master-logs-before-‘yyyy-mm-dd-hh24-mi-ss’" class="headerlink" title="3、方式三：purge master logs before ‘yyyy-mm-dd hh24:mi:ss’"></a>3、方式三：purge master logs before ‘yyyy-mm-dd hh24:mi:ss’</h6><p>执行指令 <code> purge master logs before &#39;yyyy-mm-dd hh24:mi:ss&#39;</code> ，该命令将删除日志为 “yyyy-mm-dd hh24:mi:ss” 之前产生的所有日志 。</p>
<h6 id="4、方式四：–expire-logs-days"><a href="#4、方式四：–expire-logs-days" class="headerlink" title="4、方式四：–expire_logs_days=#"></a>4、方式四：–expire_logs_days=#</h6><p>设置参数 <code>--expire_logs_days=#</code> ，此参数的含义是<strong>设置日志的过期天数， 过了指定的天数后日志将会被自动删除，这样将有利于减少DBA 管理日志的工作量</strong>。</p>
<p>配置如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554125506938.png" alt="1554125506938"> </p>
<h4 id="3、查询日志"><a href="#3、查询日志" class="headerlink" title="3、查询日志"></a>3、查询日志</h4><p><strong>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。</strong></p>
<p><strong>默认情况下， 查询日志是未开启的</strong>。如果需要开启查询日志，可以设置以下配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#该选项用来开启查询日志 ， 可选值 ： 0 或者 1 ； 0 代表关闭， 1 代表开启 </span></span><br><span class="line">general_log=1</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name.log，默认生成在mysql的数据目录下（var/lib/mysql）</span></span><br><span class="line">general_log_file=file_name</span><br></pre></td></tr></table></figure>

<p>在 mysql 的配置文件 /usr/my.cnf 中配置如下内容：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554128184632.png" alt="1554128184632"> </p>
<p>配置完毕之后，在数据库执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> tb_book <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">&#x27;lucene入门指南&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_book <span class="keyword">where</span> <span class="keyword">id</span> &lt; <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>执行完毕之后， 再次来查询日志文件：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554128089851.png" alt="1554128089851"> </p>
<h4 id="4、慢查询日志"><a href="#4、慢查询日志" class="headerlink" title="4、慢查询日志"></a>4、慢查询日志</h4><p><strong>慢查询日志记录了所有执行时间超过参数 long_query_time 设置值并且扫描记录数不小于 min_examined_row_limit 的所有的SQL语句的日志</strong>。</p>
<p><strong>long_query_time 默认为 10 秒，最小为 0， 精度可以到微秒。</strong></p>
<h5 id="1、文件位置和格式"><a href="#1、文件位置和格式" class="headerlink" title="1、文件位置和格式"></a>1、文件位置和格式</h5><p><strong>慢查询日志默认是关闭的</strong> 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%slow_query_log%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/E24A4982-114B-4FBD-9E67-C749E0CAF928.png" alt="img"></p>
<p>使用set global slow_query_log=1开启了慢查询日志只对当前数据库生效，</p>
<p>如果MySQL重启后则会失效。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5E69F422-6B75-48F3-BAEA-4B0F0159F147.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3DF6A981-8CC7-478A-8C08-1F05C5E672D1.png" alt="img"> </p>
<p>全局变量设置，对当前连接不影响</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/3EA8E1AE-25C9-4F8F-BF88-B97C29AAD38D.png" alt="img"> </p>
<p>对当前连接立刻生效</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1BFA19BF-98D7-4641-B1C2-BB29D96AC5E0.png" alt="img"> </p>
<p>如果要永久生效，可以通过两个参数来控制慢查询日志 ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该参数用来控制慢查询日志是否开启， 可取值： 1 和 0 ， 1 代表开启， 0 代表关闭</span></span><br><span class="line">slow_query_log=1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 该参数用来指定慢查询日志的文件名</span></span><br><span class="line">slow_query_log_file=slow_query.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该选项用来配置查询的时间限制， 超过这个时间将认为值慢查询， 将需要进行日志记录， 默认10s</span></span><br><span class="line"><span class="comment"># 假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</span></span><br><span class="line">long_query_time=10</span><br><span class="line"></span><br><span class="line">log_output=FILE</span><br></pre></td></tr></table></figure>

<p>当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p>
<h5 id="2、日志的读取"><a href="#2、日志的读取" class="headerlink" title="2、日志的读取"></a>2、日志的读取</h5><p>和错误日志、查询日志一样，慢查询日志记录的格式也是纯文本，可以被直接读取。</p>
<ol>
<li><p>查询long_query_time 的值。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130333472.png" alt="1554130333472"></p>
</li>
<li><p>执行查询操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, title,price,<span class="keyword">num</span> ,<span class="keyword">status</span> <span class="keyword">from</span> tb_item <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130448709.png" alt="1554130448709"></p>
<p>由于该语句执行时间很短，为0s ， 所以不会记录在慢查询日志中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_item <span class="keyword">where</span> title <span class="keyword">like</span> <span class="string">&#x27;%阿尔卡特 (OT-927) 炭黑 联通3G手机 双卡双待165454%&#x27;</span> ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130532577.png" alt="1554130532577"></p>
<p>该SQL语句 ， 执行时长为 26.77s ，超过10s ， 所以会记录在慢查询日志文件中。</p>
<p>查询当前系统中有多少条慢查询记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;%Slow_queries%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/FD701F3B-E9D7-44E3-9AA4-C59C2AF4A513.png" alt="img"></p>
</li>
<li><p>查看慢查询日志文件</p>
<ul>
<li><p>直接通过cat\tail 指令查询该日志文件：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130669360.png" alt="1554130669360"></p>
</li>
<li><p>如果慢查询日志内容很多， 直接查看文件，比较麻烦， 这个时候可以借助于mysql自带的 mysqldumpslow 工具， 来对慢查询日志进行分类汇总。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554130856485.png" alt="1554130856485"></p>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="19、Mysql复制"><a href="#19、Mysql复制" class="headerlink" title="19、Mysql复制"></a>19、Mysql复制</h3><h4 id="1、复制概述"><a href="#1、复制概述" class="headerlink" title="1、复制概述"></a>1、复制概述</h4><p><strong>复制是指将主数据库的DDL 和 DML 操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。</strong></p>
<p><strong>MySQL支持一台主库同时向多台从库进行复制， 从库同时也可以作为其他从服务器的主库，实现链状复制。</strong></p>
<h4 id="2、复制原理"><a href="#2、复制原理" class="headerlink" title="2、复制原理"></a>2、复制原理</h4><p>MySQL 的主从复制原理如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1-16305935495972.jpg" alt="1554423698190"> </p>
<p>从上层来看，复制分成三步：</p>
<ul>
<li><p>Master 主库在事务提交时，会把数据变更作为时间 Events 记录在二进制日志文件 Binlog 中。</p>
</li>
<li><p>主库推送二进制日志文件 Binlog 中的日志事件到从库的中继日志 Relay Log 。</p>
</li>
<li><p>slave重做中继日志中的事件，将改变反映它自己的数据。</p>
</li>
</ul>
<h4 id="3、复制优势"><a href="#3、复制优势" class="headerlink" title="3、复制优势"></a>3、复制优势</h4><p>MySQL 复制的有点主要包含以下三个方面：</p>
<ul>
<li><p><strong>主库出现问题，可以快速切换到从库提供服务</strong>。</p>
</li>
<li><p><strong>可以在从库上执行查询操作，从主库中更新，实现读写分离，降低主库的访问压力</strong>。</p>
</li>
<li><p><strong>可以在从库中执行备份，以避免备份期间影响主库的服务</strong>。</p>
</li>
</ul>
<h4 id="4、搭建步骤"><a href="#4、搭建步骤" class="headerlink" title="4、搭建步骤"></a>4、搭建步骤</h4><h5 id="1、master"><a href="#1、master" class="headerlink" title="1、master"></a>1、master</h5><ol>
<li><p>在master 的配置文件（/usr/my.cnf）中，配置如下内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 服务ID,保证整个集群环境中唯一</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql binlog 日志的存储路径和文件名</span></span><br><span class="line"><span class="meta">log-bin</span>=<span class="string">/var/lib/mysql/mysqlbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#错误日志,默认已经开启</span></span><br><span class="line"><span class="comment">#log-err</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql的安装目录</span></span><br><span class="line"><span class="comment">#basedir</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql的临时目录</span></span><br><span class="line"><span class="comment">#tmpdir</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql的数据存放目录</span></span><br><span class="line"><span class="comment">#datadir</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否只读,1 代表只读, 0 代表读写</span></span><br><span class="line"><span class="meta">read-only</span>=<span class="string">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#忽略的数据, 指不需要同步的数据库</span></span><br><span class="line"><span class="meta">binlog-ignore-db</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定同步的数据库</span></span><br><span class="line"><span class="comment">#binlog-do-db=db01</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完毕之后，需要重启Mysql：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart ；</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建同步数据的账户，并且进行授权操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建主节点的账户完成主从复制、指定对所有数据库（如果相关忽略的在mysql配置文件中配置）、主节点账户的名字、从结点的账户IP、主节点账户的密码</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;192.168.192.131&#x27;</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;itcast&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前master结点状态信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902224311154.png" alt="image-20210902224311154"></p>
<p>字段含义：</p>
<ul>
<li>File：从哪个日志文件开始推送日志文件 </li>
<li>Position：从哪个位置开始推送日志</li>
<li>Binlog_Ignore_DB：指定不需要同步的数据库</li>
</ul>
</li>
</ol>
<h5 id="2、slave"><a href="#2、slave" class="headerlink" title="2、slave"></a>2、slave</h5><ol>
<li><p>在 slave 端配置文件中，配置如下内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql服务端ID,唯一</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定binlog日志</span></span><br><span class="line"><span class="meta">log-bin</span>=<span class="string">/var/lib/mysql/mysqlbin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完毕之后，需要重启Mysql：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart；</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行如下指令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 指定哪一个主节点、主节点IP地址、主节点账户名称	、主节点的账户密码、主节点二进制日志名称、主节点日志的位置</span></span><br><span class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host= <span class="string">&#x27;192.168.192.130&#x27;</span>, master_user=<span class="string">&#x27;itcast&#x27;</span>, master_password=<span class="string">&#x27;itcast&#x27;</span>, master_log_file=<span class="string">&#x27;mysqlbin.000001&#x27;</span>, master_log_pos=<span class="number">413</span>;</span><br></pre></td></tr></table></figure>

<p>指定当前从库对应的主库的IP地址，用户名，密码，从哪个日志文件开始的那个位置开始同步推送日志。</p>
</li>
<li><p>开启同步操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210902224537288.png" alt="image-20210902224537288"></p>
</li>
<li><p>停止同步操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="3、验证同步操作"><a href="#3、验证同步操作" class="headerlink" title="3、验证同步操作"></a>3、验证同步操作</h5><ol>
<li><p>在主库中创建数据库，创建表，并插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> db01;</span><br><span class="line"></span><br><span class="line">user db01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> auto_increment,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	sex <span class="built_in">varchar</span>(<span class="number">1</span>),</span><br><span class="line">	primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Trigger&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">id</span>,<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">&#x27;Dawn&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在从库中查询数据，进行验证：</p>
<p>在从库中，可以查看到刚才创建的数据库：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554544658640.png" alt="1554544658640"> </p>
<p>在该数据库中，查询user表中的数据：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1554544679538.png" alt="1554544679538"> </p>
</li>
</ol>
<hr>
<h3 id="20、综合案例"><a href="#20、综合案例" class="headerlink" title="20、综合案例"></a>20、综合案例</h3><h4 id="1、需求分析"><a href="#1、需求分析" class="headerlink" title="1、需求分析"></a>1、需求分析</h4><p>在业务系统中，需要记录当前业务系统的访问日志，该访问日志包含：操作人，操作时间，访问类，访问方法，请求参数，请求结果，请求结果类型，请求时长 等信息。记录详细的系统访问日志，主要便于对系统中的用户请求进行追踪，并且在系统 的管理后台可以查看到用户的访问记录。</p>
<p>记录系统中的日志信息，可以通过Spring 框架的AOP来实现。具体的请求处理流程，如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555075760661.png" alt="1555075760661"> </p>
<h4 id="2、搭建案例环境"><a href="#2、搭建案例环境" class="headerlink" title="2、搭建案例环境"></a>2、搭建案例环境</h4><h5 id="1、数据库表"><a href="#1、数据库表" class="headerlink" title="1、数据库表"></a>1、数据库表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> mysql_demo <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 ；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 品牌表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`brand`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;品牌名称&#x27;</span>,</span><br><span class="line">  <span class="string">`first_char`</span> <span class="built_in">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;品牌首字母&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`item`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;商品id&#x27;</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;商品标题&#x27;</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;商品价格，单位为：元&#x27;</span>,</span><br><span class="line">  <span class="string">`num`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;库存数量&#x27;</span>,</span><br><span class="line">  <span class="string">`categoryid`</span> <span class="built_in">bigint</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;所属类目，叶子类目&#x27;</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;商品状态，1-正常，2-下架，3-删除&#x27;</span>,</span><br><span class="line">  <span class="string">`sellerid`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;商家ID&#x27;</span>,</span><br><span class="line">  <span class="string">`createtime`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="string">`updatetime`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">&#x27;商品表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">96</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`birthday`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`qq`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作日志表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`operation_log`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  <span class="string">`operate_class`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;操作类&#x27;</span>,</span><br><span class="line">  <span class="string">`operate_method`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;操作方法&#x27;</span>,</span><br><span class="line">  <span class="string">`return_class`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;返回值类型&#x27;</span>,</span><br><span class="line">  <span class="string">`operate_user`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;操作用户&#x27;</span>,</span><br><span class="line">  <span class="string">`operate_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">  <span class="string">`param_and_value`</span> <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;请求参数名及参数值&#x27;</span>,</span><br><span class="line">  <span class="string">`cost_time`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;执行方法耗时, 单位 ms&#x27;</span>,</span><br><span class="line">  <span class="string">`return_value`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;返回值&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br></pre></td></tr></table></figure>

<h5 id="2、pom-xml"><a href="#2、pom-xml" class="headerlink" title="2、pom.xml"></a>2、pom.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.6.6<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.12<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mybatis.version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">mybatis.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span> <span class="comment">&lt;!-- spring --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="3、通过AOP记录操作日志"><a href="#3、通过AOP记录操作日志" class="headerlink" title="3、通过AOP记录操作日志"></a>3、通过AOP记录操作日志</h4><h5 id="1、自定义注解"><a href="#1、自定义注解" class="headerlink" title="1、自定义注解"></a>1、自定义注解</h5><p>通过自定义注解，来标示方法需不需要进行记录日志，如果该方法在访问时需要记录日志，则在该方法上标示该注解既可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OperateLog &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2、定义通知类"><a href="#2、定义通知类" class="headerlink" title="2、定义通知类"></a>2、定义通知类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperateAdvice</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(OperateAdvice.class);</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> OperationLogService operationLogService;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   <span class="meta">@Around(&quot;execution(* cn.itcast.controller.*.*(..)) &amp;&amp; @annotation(operateLog)&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">insertLogAround</span><span class="params">(ProceedingJoinPoint pjp , OperateLog operateLog)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot; ************************ 记录日志 [start]  ****************************** &quot;</span>);</span><br><span class="line">      </span><br><span class="line">      OperationLog op = <span class="keyword">new</span> OperationLog();</span><br><span class="line">      </span><br><span class="line">      DateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">      op.setOperateTime(sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">      op.setOperateUser(DataUtils.getRandStr(<span class="number">8</span>));</span><br><span class="line">      </span><br><span class="line">      op.setOperateClass(pjp.getTarget().getClass().getName());</span><br><span class="line">      op.setOperateMethod(pjp.getSignature().getName());</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//获取方法调用时传递的参数</span></span><br><span class="line">      Object[] args = pjp.getArgs();</span><br><span class="line">      op.setParamAndValue(Arrays.toString(args));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> start_time = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//放行</span></span><br><span class="line">      Object object = pjp.proceed();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> end_time = System.currentTimeMillis();</span><br><span class="line">      op.setCostTime(end_time - start_time);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(object != <span class="keyword">null</span>)&#123;</span><br><span class="line">         op.setReturnClass(object.getClass().getName());</span><br><span class="line">         op.setReturnValue(object.toString());</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         op.setReturnClass(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">         op.setParamAndValue(<span class="string">&quot;void&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      log.error(JsonUtils.obj2JsonString(op));</span><br><span class="line"></span><br><span class="line">      operationLogService.insert(op);</span><br><span class="line">      </span><br><span class="line">      System.out.println(<span class="string">&quot; ************************** 记录日志 [end]  *************************** &quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3、方法上加注解"><a href="#3、方法上加注解" class="headerlink" title="3、方法上加注解"></a>3、方法上加注解</h5><p>在需要记录日志的方法上加上注解@OperateLog。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OperateLog</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/insert&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">insert</span><span class="params">(<span class="meta">@RequestBody</span> Brand brand)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        brandService.insert(brand);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,<span class="string">&quot;操作成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,<span class="string">&quot;操作失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、日志查询后端代码实现"><a href="#4、日志查询后端代码实现" class="headerlink" title="4、日志查询后端代码实现"></a>4、日志查询后端代码实现</h4><h5 id="1、Mapper接口"><a href="#1、Mapper接口" class="headerlink" title="1、Mapper接口"></a>1、Mapper接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OperationLogMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(OperationLog operationLog)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;OperationLog&gt; <span class="title">selectListByCondition</span><span class="params">(Map dataMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">countByCondition</span><span class="params">(Map dataMap)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2、Mapper-xml-映射配置文件"><a href="#2、Mapper-xml-映射配置文件" class="headerlink" title="2、Mapper.xml 映射配置文件"></a>2、Mapper.xml 映射配置文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;cn.itcast.mapper.OperationLogMapper&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;operationLog&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO operation_log(id,return_value,return_class,operate_user,operate_time,param_and_value,</span><br><span class="line">        operate_class,operate_method,cost_time)</span><br><span class="line">      VALUES(NULL,#&#123;returnValue&#125;,#&#123;returnClass&#125;,#&#123;operateUser&#125;,#&#123;operateTime&#125;,#&#123;paramAndValue&#125;,</span><br><span class="line">        #&#123;operateClass&#125;,#&#123;operateMethod&#125;,#&#123;costTime&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectListByCondition&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;operationLog&quot;</span>&gt;</span></span><br><span class="line">      select</span><br><span class="line">        id ,</span><br><span class="line">        operate_class as operateClass ,</span><br><span class="line">        operate_method as operateMethod,</span><br><span class="line">        return_class as returnClass,</span><br><span class="line">        operate_user as operateUser,</span><br><span class="line">        operate_time as operateTime,</span><br><span class="line">        param_and_value as paramAndValue,</span><br><span class="line">        cost_time as costTime,</span><br><span class="line">        return_value as returnValue</span><br><span class="line">      from operation_log</span><br><span class="line">      <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;oplog_where&quot;</span>/&gt;</span></span><br><span class="line">      limit #&#123;start&#125;,#&#123;size&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countByCondition&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">        select count(*) from operation_log</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;oplog_where&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;oplog_where&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;operateClass != null and operateClass != &#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">                and operate_class = #&#123;operateClass&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;operateMethod != null and operateMethod != &#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">                and operate_method = #&#123;operateMethod&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;returnClass != null and returnClass != &#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">                and return_class = #&#123;returnClass&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;costTime != null&quot;</span>&gt;</span></span><br><span class="line">                and cost_time =  #&#123;costTime&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3、Service"><a href="#3、Service" class="headerlink" title="3、Service"></a>3、Service</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationLogService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//private static Logger logger = Logger.getLogger(OperationLogService.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OperationLogMapper operationLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(OperationLog operationLog)</span></span>&#123;</span><br><span class="line">        operationLogMapper.insert(operationLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据条件查询</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageResult <span class="title">selectListByCondition</span><span class="params">(Map dataMap, Integer pageNum , Integer pageSize)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(paramMap ==<span class="keyword">null</span>)&#123;</span><br><span class="line">            paramMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        &#125;</span><br><span class="line">        paramMap.put(<span class="string">&quot;start&quot;</span> , (pageNum-<span class="number">1</span>)*rows);</span><br><span class="line">        paramMap.put(<span class="string">&quot;rows&quot;</span>,rows);</span><br><span class="line"></span><br><span class="line">        Object costTime = paramMap.get(<span class="string">&quot;costTime&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(costTime != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;&quot;</span>.equals(costTime.toString()))&#123;</span><br><span class="line">                paramMap.put(<span class="string">&quot;costTime&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                paramMap.put(<span class="string">&quot;costTime&quot;</span>,<span class="keyword">new</span> Long(paramMap.get(<span class="string">&quot;costTime&quot;</span>).toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(dataMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> countStart = System.currentTimeMillis();</span><br><span class="line">        Long count = operationLogMapper.countByCondition(dataMap);</span><br><span class="line">        <span class="keyword">long</span> countEnd = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;Count Cost Time : &quot;</span> + (countEnd-countStart)+<span class="string">&quot; ms&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        List&lt;OperationLog&gt; list = operationLogMapper.selectListByCondition(dataMap);</span><br><span class="line">        <span class="keyword">long</span> queryEnd = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;Query Cost Time : &quot;</span> + (queryEnd-countEnd)+<span class="string">&quot; ms&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PageResult(count,list);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4、Controller"><a href="#4、Controller" class="headerlink" title="4、Controller"></a>4、Controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/operationLog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationLogController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OperationLogService operationLogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/findList&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageResult <span class="title">findList</span><span class="params">(<span class="meta">@RequestBody</span> Map dataMap, Integer pageNum , Integer pageSize)</span></span>&#123;</span><br><span class="line">        PageResult page = operationLogService.selectListByCondition(dataMap, pageNum, pageSize);</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5、日志查询前端代码实现"><a href="#5、日志查询前端代码实现" class="headerlink" title="5、日志查询前端代码实现"></a>5、日志查询前端代码实现</h4><p>前端代码使用 BootStrap + AdminLTE 进行布局， 使用Vuejs 进行视图层展示。</p>
<h5 id="1、js"><a href="#1、js" class="headerlink" title="1、js"></a>1、js</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">       el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">       data: &#123;</span><br><span class="line">           dataList:[],</span><br><span class="line">           searchEntity:&#123;</span><br><span class="line"><span class="javascript">               operateClass:<span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="javascript">               operateMethod:<span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="javascript">               returnClass:<span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="javascript">               costTime:<span class="string">&#x27;&#x27;</span></span></span><br><span class="line">           &#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">           page: <span class="number">1</span>,  <span class="comment">//显示的是哪一页</span></span></span><br><span class="line"><span class="javascript">           pageSize: <span class="number">10</span>, <span class="comment">//每一页显示的数据条数</span></span></span><br><span class="line"><span class="javascript">           total: <span class="number">150</span>, <span class="comment">//记录总数</span></span></span><br><span class="line"><span class="javascript">           maxPage:<span class="number">8</span>  <span class="comment">//最大页数</span></span></span><br><span class="line">       &#125;,</span><br><span class="line">       methods: &#123;</span><br><span class="line"><span class="javascript">           pageHandler: <span class="function"><span class="keyword">function</span> (<span class="params">page</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">               <span class="built_in">this</span>.page = page;</span></span><br><span class="line"><span class="javascript">               <span class="built_in">this</span>.search();</span></span><br><span class="line">           &#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">           search: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">               <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span></span><br><span class="line"><span class="javascript">               <span class="built_in">this</span>.showLoading();</span></span><br><span class="line"><span class="javascript">               axios.post(<span class="string">&#x27;/operationLog/findList.do?pageNum=&#x27;</span> + _this.page + <span class="string">&quot;&amp;pageSize=&quot;</span> + _this.pageSize, _this.searchEntity).then(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span></span><br><span class="line">                   if (response) &#123;</span><br><span class="line">                       _this.dataList = response.data.dataList;</span><br><span class="line">                       _this.total = response.data.total;</span><br><span class="line">                       _this.hideLoading();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">           &#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">           showLoading: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">               $(<span class="string">&#x27;#loadingModal&#x27;</span>).modal(&#123;<span class="attr">backdrop</span>: <span class="string">&#x27;static&#x27;</span>, <span class="attr">keyboard</span>: <span class="literal">false</span>&#125;);</span></span><br><span class="line">           &#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">           hideLoading: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">               $(<span class="string">&#x27;#loadingModal&#x27;</span>).modal(<span class="string">&#x27;hide&#x27;</span>);</span></span><br><span class="line">           &#125;,</span><br><span class="line">       &#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">       created:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">this</span>.pageHandler(<span class="number">1</span>);</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2、列表数据展示"><a href="#2、列表数据展示" class="headerlink" title="2、列表数据展示"></a>2、列表数据展示</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">v-for</span>=<span class="string">&quot;item in dataList&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.operateClass&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.operateMethod&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.returnClass&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.returnValue&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.operateUser&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.operateTime&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item.costTime&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;text-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn bg-olive btn-xs&quot;</span>&gt;</span>详情<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn bg-olive btn-xs&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3、分页插件"><a href="#3、分页插件" class="headerlink" title="3、分页插件"></a>3、分页插件</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span> <span class="attr">id</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">zpagenav</span> <span class="attr">v-bind:page</span>=<span class="string">&quot;page&quot;</span> <span class="attr">v-bind:page-size</span>=<span class="string">&quot;pageSize&quot;</span> <span class="attr">v-bind:total</span>=<span class="string">&quot;total&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">v-bind:max-page</span>=<span class="string">&quot;maxPage&quot;</span>  <span class="attr">v-on:pagehandler</span>=<span class="string">&quot;pageHandler&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">zpagenav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="6、联调测试"><a href="#6、联调测试" class="headerlink" title="6、联调测试"></a>6、联调测试</h4><p>可以通过postman来访问业务系统，再查看数据库中的日志信息，验证能不能将用户的访问日志记录下来。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555077276426.png" alt="1555077276426"> </p>
<h4 id="7、分析性能问题"><a href="#7、分析性能问题" class="headerlink" title="7、分析性能问题"></a>7、分析性能问题</h4><p>系统中用户访问日志的数据量，随着时间的推移，这张表的数据量会越来越大，因此我们需要根据业务需求，来对日志查询模块的性能进行优化。</p>
<h5 id="1、分页查询优化"><a href="#1、分页查询优化" class="headerlink" title="1、分页查询优化"></a>1、分页查询优化</h5><p>由于在进行日志查询时，是进行分页查询，那也就意味着，在查看时，至少需要查询两次：</p>
<ol>
<li>查询符合条件的总记录数。–&gt; count 操作</li>
<li>查询符合条件的列表数据。–&gt; 分页查询 limit 操作</li>
</ol>
<p>通常来说，count() 都需要扫描大量的行（意味着需要访问大量的数据）才能获得精确的结果，因此是很难对该SQL进行优化操作的。如果需要对count进行优化，可以采用另外一种思路，可以==增加汇总表==，或者==redis缓存来专门记录该表对应的记录数==，这样的话，就可以很轻松的实现汇总数据的查询，而且效率很高。</p>
<p>但是这种统计并不能保证百分之百的准确 。对于数据库的操作，“快速、精确、实现简单”，三者永远只能满足其二，必须舍掉其中一个。</p>
<h5 id="2、条件查询优化"><a href="#2、条件查询优化" class="headerlink" title="2、条件查询优化"></a>2、条件查询优化</h5><p>针对于<strong>条件查询</strong>，需要==对查询条件，及排序字段建立索引==。</p>
<h5 id="3、读写分离"><a href="#3、读写分离" class="headerlink" title="3、读写分离"></a>3、读写分离</h5><p>通过==主从复制集群，来完成读写分离，使写操作走主节点， 而读操作，走从节点==。</p>
<h5 id="4、MySQL服务器优化"><a href="#4、MySQL服务器优化" class="headerlink" title="4、MySQL服务器优化"></a>4、MySQL服务器优化</h5><h5 id="5、应用优化"><a href="#5、应用优化" class="headerlink" title="5、应用优化"></a>5、应用优化</h5><h4 id="8、性能优化-分页"><a href="#8、性能优化-分页" class="headerlink" title="8、性能优化 - 分页"></a>8、性能优化 - 分页</h4><h5 id="1、优化count"><a href="#1、优化count" class="headerlink" title="1、优化count"></a>1、优化count</h5><p>创建一张表用来记录日志表的总数据量：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_counter(</span><br><span class="line">	logcount <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">)<span class="keyword">engine</span> = <span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">CHARSET</span> = utf8;</span><br></pre></td></tr></table></figure>

<p>在每次插入数据之后，更新该表：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateLogCounter&quot;</span> &gt;</span></span><br><span class="line">    update log_counter set logcount = logcount + 1</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在进行分页查询时，获取总记录数，从该表中查询既可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countLogFromCounter&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;long&quot;</span>&gt;</span></span><br><span class="line">    select logcount from log_counter limit 1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2、优化-limit"><a href="#2、优化-limit" class="headerlink" title="2、优化 limit"></a>2、优化 limit</h5><p>在进行分页时，一般通过创建覆盖索引，能够比较好的提高性能。一个非常常见，而又非常头疼的分页场景就是 “limit 1000000,10” ，此时MySQL需要搜索出前1000010 条记录后，仅仅需要返回第 1000001 到 1000010 条记录，前1000000 记录会被抛弃，查询代价非常大。 </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555081714638.png" alt="1555081714638"> </p>
<p>当点击比较靠后的页码时，就会出现这个问题，查询效率非常慢。</p>
<p>优化前的SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> operation_log <span class="keyword">limit</span> <span class="number">3000000</span> , <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>将上述SQL优化为：（使用子查询的方式进行优化）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> operation_log t , (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> operation_log <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">limit</span> <span class="number">3000000</span>,<span class="number">10</span>) b <span class="keyword">where</span> t.id = b.id ;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectListByCondition&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;operationLog&quot;</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">    id ,</span><br><span class="line">    operate_class as operateClass ,</span><br><span class="line">    operate_method as operateMethod,</span><br><span class="line">    return_class as returnClass,</span><br><span class="line">    operate_user as operateUser,</span><br><span class="line">    operate_time as operateTime,</span><br><span class="line">    param_and_value as paramAndValue,</span><br><span class="line">    cost_time as costTime,</span><br><span class="line">    return_value as returnValue</span><br><span class="line">  from operation_log t,</span><br><span class="line">    </span><br><span class="line">  (select id from operation_log </span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;oplog_where&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">  order by id limit #&#123;start&#125;,#&#123;rows&#125;) b  where t.id = b.id  </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="9、性能优化-索引"><a href="#9、性能优化-索引" class="headerlink" title="9、性能优化 - 索引"></a>9、性能优化 - 索引</h4><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555152703824.png" alt="1555152703824"></p>
<p>当根据操作人进行查询时， 查询的效率很低，耗时比较长。原因就是因为在创建数据库表结构时，并没有针对于 操作人 字段建立索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_user_method_return_cost <span class="keyword">ON</span> operation_log(operate_user,operate_method,return_class,cost_time);</span><br></pre></td></tr></table></figure>

<p>同上，为了查询效率高，我们也需要对 ==操作方法==、==返回值类型==、==操作耗时== 等字段进行创建索引，以提高查询效率。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_optlog_method_return_cost <span class="keyword">ON</span> operation_log(operate_method,return_class,cost_time);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_optlog_return_cost <span class="keyword">ON</span> operation_log(return_class,cost_time);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_optlog_cost <span class="keyword">ON</span> operation_log(cost_time);</span><br></pre></td></tr></table></figure>



<h4 id="10、性能优化-排序"><a href="#10、性能优化-排序" class="headerlink" title="10、性能优化 - 排序"></a>10、性能优化 - 排序</h4><p>在查询数据时，如果业务需求中需要我们对结果内容进行了排序处理 , 这个时候，我们还需要==对排序的字段建立适当的索引==，来提高排序的效率 。</p>
<h4 id="11、性能优化-读写分离"><a href="#11、性能优化-读写分离" class="headerlink" title="11、性能优化 - 读写分离"></a>11、性能优化 - 读写分离</h4><h5 id="1、概述-2"><a href="#1、概述-2" class="headerlink" title="1、概述"></a>1、概述</h5><p>在Mysql主从复制的基础上，可以使用读写分离来降低单台Mysql节点的压力，从而来提高访问效率，读写分离的架构如下：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555235426739.png" alt="1555235426739"> </p>
<p>对于读写分离的实现，可以通过Spring AOP 来进行动态的切换数据源，进行操作：</p>
<h5 id="2、实现方式"><a href="#2、实现方式" class="headerlink" title="2、实现方式"></a>2、实现方式</h5><p>db.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">jdbc.write.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">jdbc.write.url</span>=<span class="string">jdbc:mysql://192.168.142.128:3306/mysql_demo</span></span><br><span class="line"><span class="meta">jdbc.write.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.write.password</span>=<span class="string">itcast</span></span><br><span class="line"></span><br><span class="line"><span class="meta">jdbc.read.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">jdbc.read.url</span>=<span class="string">jdbc:mysql://192.168.142.129:3306/mysql_demo</span></span><br><span class="line"><span class="meta">jdbc.read.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.read.password</span>=<span class="string">itcast</span></span><br></pre></td></tr></table></figure>

<p>applicationContext-datasource.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据源 - Read --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;readDataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>  <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.read.driver&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.read.url&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.read.username&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.read.password&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据源 - Write --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;writeDataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>  <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>  <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.write.driver&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.write.url&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.write.username&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.write.password&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置动态分配的读写 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.itcast.aop.datasource.ChooseDataSource&quot;</span> <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetDataSources&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span> <span class="attr">key-type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;javax.sql.DataSource&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;write&quot;</span> <span class="attr">value-ref</span>=<span class="string">&quot;writeDataSource&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;read&quot;</span> <span class="attr">value-ref</span>=<span class="string">&quot;readDataSource&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultTargetDataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;writeDataSource&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;methodType&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span> <span class="attr">key-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;read&quot;</span> <span class="attr">value</span>=<span class="string">&quot;,get,select,count,list,query,find&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;write&quot;</span> <span class="attr">value</span>=<span class="string">&quot;,add,create,update,delete,remove,insert&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ChooseDataSource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChooseDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; METHOD_TYPE_MAP = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现父类中的抽象方法，获取数据源名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceHandler.getDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置方法名前缀对应的数据源</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMethodType</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            List&lt;String&gt; v = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            String[] types = map.get(key).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String type : types) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.isEmpty(type)) &#123;</span><br><span class="line">                    v.add(type);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            METHOD_TYPE_MAP.put(key, v);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;METHOD_TYPE_MAP : &quot;</span>+METHOD_TYPE_MAP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataSourceHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据源名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; holder = <span class="keyword">new</span> ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在项目启动的时候将配置的读、写数据源加到holder中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putDataSource</span><span class="params">(String datasource)</span> </span>&#123;</span><br><span class="line">        holder.set(datasource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从holer中获取数据源字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> holder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataSourceAspect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(-9999)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置前置通知,使用在方法aspect()上注册的切入点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* cn.itcast.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="meta">@Order(-9999)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint point)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        String className = point.getTarget().getClass().getName();</span><br><span class="line">        String method = point.getSignature().getName();</span><br><span class="line">        logger.info(className + <span class="string">&quot;.&quot;</span> + method + <span class="string">&quot;(&quot;</span> + Arrays.asList(point.getArgs())+ <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String key : ChooseDataSource.METHOD_TYPE_MAP.keySet()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String type : ChooseDataSource.METHOD_TYPE_MAP.get(key)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (method.startsWith(type)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;key : &quot;</span> + key);</span><br><span class="line">                        DataSourceHandler.putDataSource(key);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 @Order(-9999) 注解来控制事务管理器，与该通知类的加载顺序，需要让通知类，先加载，来判定使用哪个数据源。</p>
<h5 id="3、验证"><a href="#3、验证" class="headerlink" title="3、验证"></a>3、验证</h5><p>在主库和从库中，执行如下SQL语句，来查看是否读的时候，从从库中读取；写入操作的时候，是否写入到主库。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">&#x27;Innodb_rows_%&#x27;</span> ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/1555235982584.png" alt="1555235982584"> </p>
<h5 id="4、原理"><a href="#4、原理" class="headerlink" title="4、原理"></a>4、原理</h5><p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/aop-datasource.png" alt="1555235982584"></p>
<h4 id="12、性能优化-应用优化"><a href="#12、性能优化-应用优化" class="headerlink" title="12、性能优化 - 应用优化"></a>12、性能优化 - 应用优化</h4><h5 id="1、缓存"><a href="#1、缓存" class="headerlink" title="1、缓存"></a>1、缓存</h5><p>可以在业务系统中使用==redis==或者==框架本身的一级二级缓存==来做缓存，缓存一些基础性的数据，来降低关系型数据库的压力，提高访问效率。</p>
<h5 id="2、全文检索"><a href="#2、全文检索" class="headerlink" title="2、全文检索"></a>2、全文检索</h5><p>如果业务系统中的数据量比较大（达到千万级别），这个时候，如果再对数据库进行查询，特别是进行分页查询，速度将变得很慢（因为在分页时首先需要count求合计数），为了提高访问效率，这个时候，可以考虑加入==Solr== 或者 ==ElasticSearch==<strong>全文检索服务</strong>，来提高访问效率。</p>
<h5 id="3、非关系数据库"><a href="#3、非关系数据库" class="headerlink" title="3、非关系数据库"></a>3、非关系数据库</h5><p>也可以考虑将<strong>非核心（重要）数据</strong>，存在 ==MongoDB== 中，这样可以提高插入以及查询的效率。</p>
<hr>
<h3 id="0、在Linux系统安装Mysql"><a href="#0、在Linux系统安装Mysql" class="headerlink" title="0、在Linux系统安装Mysql"></a>0、在Linux系统安装Mysql</h3><h4 id="1、下载Linux-安装包"><a href="#1、下载Linux-安装包" class="headerlink" title="1、下载Linux 安装包"></a>1、下载Linux 安装包</h4><p>在<a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/mysql/5.7.html#downloads">官网</a>下载mysql的安装包</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/image-20210901003856739.png" alt="image-20210901003856739"></p>
<h4 id="2、安装MySQL"><a href="#2、安装MySQL" class="headerlink" title="2、安装MySQL"></a>2、安装MySQL</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-- 卸载 Linux 中预安装的 mysql</span><br><span class="line">rpm -qa | grep -i mysql</span><br><span class="line">rpm -e mysql-libs-5.1.71-1.el6.x86_64 --nodeps</span><br><span class="line"></span><br><span class="line">-- 上传 mysql 的安装包</span><br><span class="line">alt + p -- 切换到ftp模式</span><br><span class="line">put  E:/<span class="built_in">test</span>/MySQL-5.6.22-1.el6.i686.rpm-bundle.tar</span><br><span class="line"></span><br><span class="line">-- 解压 mysql 的安装包</span><br><span class="line">mkdir mysql</span><br><span class="line">tar -xvf MySQL-5.6.22-1.el6.i686.rpm-bundle.tar -C /root/mysql</span><br><span class="line"></span><br><span class="line">-- 安装依赖包</span><br><span class="line">yum -y install libaio.so.1 libgcc_s.so.1 libstdc++.so.6 libncurses.so.5 --<span class="built_in">setopt</span>=protected_multilib=<span class="literal">false</span></span><br><span class="line">yum  update libstdc++-4.4.7-4.el6.x86_64</span><br><span class="line"></span><br><span class="line">-- 安装 mysql-client</span><br><span class="line">rpm -ivh MySQL-client-5.6.22-1.el6.i686.rpm</span><br><span class="line"></span><br><span class="line">-- 安装 mysql-server</span><br><span class="line">rpm -ivh MySQL-server-5.6.22-1.el6.i686.rpm</span><br></pre></td></tr></table></figure>



<h4 id="3、启动-MySQL-服务"><a href="#3、启动-MySQL-服务" class="headerlink" title="3、启动 MySQL 服务"></a>3、启动 MySQL 服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 开启mysql服务</span><br><span class="line">service mysql start</span><br><span class="line"></span><br><span class="line">-- 停止mysql服务</span><br><span class="line">service mysql stop</span><br><span class="line"></span><br><span class="line">-- 查看mysql的状态</span><br><span class="line">service mysql status</span><br><span class="line"></span><br><span class="line">-- 重启mysql</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>



<h4 id="4、登录MySQL"><a href="#4、登录MySQL" class="headerlink" title="4、登录MySQL"></a>4、登录MySQL</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- mysql 安装完成之后, 会自动生成一个随机的密码, 并且保存在一个密码文件中 : /root/.mysql_secret</span><br><span class="line"><span class="built_in">cd</span> /root/.mysql_secret</span><br><span class="line">cat</span><br><span class="line"></span><br><span class="line">-- 登陆mysql</span><br><span class="line">mysql -u root -p </span><br><span class="line"></span><br><span class="line">-- 登录之后, 修改密码</span><br><span class="line"><span class="built_in">set</span> password = password(<span class="string">&#x27;your password&#x27;</span>);</span><br><span class="line"></span><br><span class="line">-- 授权远程访问</span><br><span class="line">grant all privileges on *.* to <span class="string">&#x27;root&#x27;</span> @<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;your password&#x27;</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>



<h4 id="5、Mysql-的用户与权限管理"><a href="#5、Mysql-的用户与权限管理" class="headerlink" title="5、Mysql 的用户与权限管理"></a>5、Mysql 的用户与权限管理</h4><h5 id="1、MySQL的用户管理"><a href="#1、MySQL的用户管理" class="headerlink" title="1、MySQL的用户管理"></a>1、MySQL的用户管理</h5><h6 id="1、创建用户"><a href="#1、创建用户" class="headerlink" title="1、创建用户"></a>1、创建用户</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> zhang3 <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;123123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>表示创建名称为zhang3的用户，密码设为123123；</p>
<h6 id="2、查看用户"><a href="#2、查看用户" class="headerlink" title="2、查看用户"></a>2、查看用户</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> host,<span class="keyword">user</span>,<span class="keyword">password</span>,select_priv,insert_priv,drop_priv <span class="keyword">from</span> mysql.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span>\G;</span><br></pre></td></tr></table></figure>

<p>将 user 中的数据以行的形式显示出来(针对列很长的表可以采用这个方法 )</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/09DF557C-9B94-4314-9A1D-D9C8F59E0F23.png" alt="img"></p>
<ul>
<li>host：表示连接类型<ul>
<li>% 表示所有远程通过 TCP方式的连接</li>
<li>IP 地址 如 (192.168.1.2,127.0.0.1) 通过制定ip地址进行的TCP方式的连接</li>
<li>::1  IPv6的本地ip地址 等同于IPv4的 127.0.0.1</li>
<li>localhost 本地方式通过命令行方式的连接 ，比如mysql -u xxx -p 123xxx 方式的连接。</li>
</ul>
</li>
<li>user：表示用户名<ul>
<li>同一用户通过不同方式链接的权限是不一样的。</li>
</ul>
</li>
<li>password：密码<ul>
<li>所有密码串通过 password(明文字符串) 生成的密文字符串。加密算法为<code>MYSQLSHA1</code> ，不可逆 。</li>
<li>mysql 5.7 的密码保存到 <code>authentication_string</code>，字段中不再使用password 字段。</li>
</ul>
</li>
<li>select_priv , insert_priv等 <ul>
<li>为该用户所拥有的权限。</li>
</ul>
</li>
</ul>
<h6 id="3、设置密码"><a href="#3、设置密码" class="headerlink" title="3、设置密码"></a>3、设置密码</h6><p>修改当前用户的密码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">password</span> =<span class="keyword">password</span>(<span class="string">&#x27;123456&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>修改某个用户的密码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">&#x27;123456&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">&#x27;li4&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 所有通过user表的修改，必须用该命令才能生效。</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<h6 id="4、修改用户"><a href="#4、修改用户" class="headerlink" title="4、修改用户"></a>4、修改用户</h6><p>修改用户名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> <span class="keyword">user</span>=<span class="string">&#x27;li4&#x27;</span> <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">&#x27;wang5&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 所有通过user表的修改，必须用该命令才能生效。</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/59C3022F-A6AD-434C-95E1-BB9555E2C0B0.png" alt="img"> </p>
<h6 id="5、删除用户"><a href="#5、删除用户" class="headerlink" title="5、删除用户"></a>5、删除用户</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> li4 ;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/0F314194-D9B1-4B48-BACF-A46BE2066E83.png" alt="img"> </p>
<p><strong>不要通过delete from user u where user=’li4’ 进行删除，系统会有残留信息保留。</strong></p>
<h5 id="2、权限管理"><a href="#2、权限管理" class="headerlink" title="2、权限管理"></a>2、权限管理</h5><h6 id="1、授予权限"><a href="#1、授予权限" class="headerlink" title="1、授予权限"></a>1、授予权限</h6><p>授权命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,…权限n <span class="keyword">on</span> 数据库名称.表名称 <span class="keyword">to</span> 用户名@用户地址 <span class="keyword">identified</span> <span class="keyword">by</span> ‘连接口令’;</span><br></pre></td></tr></table></figure>

<p>该权限如果发现没有该用户，则会直接新建一个用户。</p>
<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 给li4用户用本地命令行方式下，授予atguigudb这个库下的所有表的插删改查的权限。</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">delete</span>,<span class="keyword">drop</span> <span class="keyword">on</span> atguigudb.* <span class="keyword">to</span> li4@localhost ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予通过网络方式登录的的joe用户 ，对所有库所有表的全部权限，密码设为123.</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> joe@<span class="string">&#x27;%&#x27;</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p><strong>就算 all privileges 了所有权限，grant_priv 权限也只有 root 才能拥有。</strong></p>
<p>给 root 赋连接口令 <code>grant all privileges on *.* to root@&#39;%&#39; ;</code>后新建的连接没有密码，需要设置密码才能远程连接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">&#x27;root&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> host=<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h6 id="2、收回权限"><a href="#2、收回权限" class="headerlink" title="2、收回权限"></a>2、收回权限</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 收回权限命令：</span></span><br><span class="line"><span class="keyword">revoke</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,…权限n <span class="keyword">on</span> 数据库名称.表名称 <span class="keyword">from</span> 用户名@用户地址 ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 若赋的全库的表就 收回全库全表的所有权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> mysql.* <span class="keyword">FROM</span> joe@localhost;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 收回mysql库下的所有表的插删改查权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span> <span class="keyword">ON</span> mysql.* <span class="keyword">FROM</span> joe@localhost;</span><br></pre></td></tr></table></figure>

<p> 对比赋予权限的方法：必须用户重新登录后才能生效</p>
<h6 id="3、查看权限"><a href="#3、查看权限" class="headerlink" title="3、查看权限"></a>3、查看权限</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前用户权限</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">grants</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看某用户的全局权限</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看某用户的某库的权限</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span>  db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看某用户的某个表的权限</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tables_priv;</span><br></pre></td></tr></table></figure>

<h5 id="3、通过工具远程访问"><a href="#3、通过工具远程访问" class="headerlink" title="3、通过工具远程访问"></a>3、通过工具远程访问</h5><ol>
<li><p>先 ping 一下数据库服务器的ip 地址确认网络畅通。</p>
</li>
<li><p>关闭数据库服务的防火墙</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables <span class="keyword">stop</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>确认Mysql中已经有可以通过远程登录的账户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">&#x27;li4&#x27;</span> <span class="keyword">and</span> host=<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>如果没有用户，先执行如下命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> li4@<span class="string">&#x27;%&#x27;</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;123123&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试连接：</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/40FADB12-0946-4567-A47E-9FEC56226FCA.png" alt="img"></p>
</li>
</ol>
<h4 id="6、修改字符集问题"><a href="#6、修改字符集问题" class="headerlink" title="6、修改字符集问题"></a>6、修改字符集问题</h4><h5 id="1、查看字符集"><a href="#1、查看字符集" class="headerlink" title="1、查看字符集"></a>1、查看字符集</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;character%&#x27;</span>; </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%char%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>默认的是客户端和服务器都用了<code>latin1</code>，所以会乱码。</p>
<h5 id="2、修改my-cnf"><a href="#2、修改my-cnf" class="headerlink" title="2、修改my.cnf"></a>2、修改my.cnf</h5><p>在/usr/share/mysql/ 中找到my.cnf的配置文件，</p>
<p>拷贝其中的my-huge.cnf 到 /etc/ 并命名为my.cnf </p>
<p>mysql 优先选中 /etc/ 下的配置文件</p>
<p>然后修改my.cnf：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"></span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">character_set_server&#x3D;utf8</span><br><span class="line"></span><br><span class="line">character_set_client&#x3D;utf8</span><br><span class="line"></span><br><span class="line">collation-server&#x3D;utf8_general_ci</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">default-character-set&#x3D;utf8</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/6EAA3D86-4B7E-4BF8-A6C7-F1D649723294.png" alt="img"> </p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/5CCB9E57-60DF-41F6-AA55-E8BDB1411846.png" alt="img"></p>
<h5 id="3、重新启动mysql"><a href="#3、重新启动mysql" class="headerlink" title="3、重新启动mysql"></a>3、重新启动mysql</h5><p><strong>但是原库的设定不会发生变化，参数修改之对新建的数据库生效</strong></p>
<h5 id="4、已生成的库表字符集如何变更"><a href="#4、已生成的库表字符集如何变更" class="headerlink" title="4、已生成的库表字符集如何变更"></a>4、已生成的库表字符集如何变更</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改数据库的字符集</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> mytest <span class="built_in">character</span> <span class="keyword">set</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改数据表的字符集</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">convert</span> <span class="keyword">to</span>  <span class="built_in">character</span> <span class="keyword">set</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>但是原有的数据如果是用非’utf8’编码的话，数据本身不会发生改变。</p>
<h4 id="7、Mysql的一些杂项配置"><a href="#7、Mysql的一些杂项配置" class="headerlink" title="7、Mysql的一些杂项配置"></a>7、Mysql的一些杂项配置</h4><h5 id="1、大小写问题"><a href="#1、大小写问题" class="headerlink" title="1、大小写问题"></a>1、大小写问题</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%lower_case_table_names%&#x27;</span> </span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/F49D3CE6-B08B-4968-8F8C-29F6C5EB09D8.png" alt="img"> </p>
<p>windows系统默认大小写不敏感，但是linux系统是大小写敏感的</p>
<ul>
<li>默认为0，大小写敏感。</li>
<li>设置1，大小写不敏感。创建的表，数据库都是以小写形式存放在磁盘上，对于sql语句都是转换为小写对表和DB进行查找。</li>
<li>设置2，创建的表和DB依据语句上格式存放，凡是查找都是转换为小写进行。 </li>
</ul>
<p><strong>设置变量常采用 setlower_case_table_names = 1； 的方式，但此变量是只读权限，所以需要在配置文件中改。</strong></p>
<p>当想设置为大小写不敏感时，要在my.cnf这个配置文件 [mysqld] 中加入 lower_case_table_names = 1 ，然后重启服务器。</p>
<p>但是要在重启数据库实例之前就需要将原来的数据库和表转换为小写，否则更改后将找不到数据库名。</p>
<p>在进行数据库参数设置之前，需要掌握这个参数带来的影响，切不可盲目设置。</p>
<h5 id="2、-生产环境-sql-mode"><a href="#2、-生产环境-sql-mode" class="headerlink" title="2、(生产环境)sql_mode"></a>2、(生产环境)sql_mode</h5><p>MySQL的sql_mode合理设置</p>
<p>sql_mode是个很容易被忽视的变量，默认值是空值，在这种设置下是可以允许一些非法操作的，比如允许一些非法数据的插入。在生产环境必须将这个值设置为严格模式，所以开发、测试环境的数据库也必须要设置，这样在开发测试阶段就可以发现问题。</p>
<p><img src="/2021/08/30/mysql%E9%AB%98%E7%BA%A7/2D7109F6-A943-4A2E-9A38-3BE019D79F30.png" alt="img"> </p>
<p>使用 set sql_mode=ONLY_FULL_GROUP_BY; 的方式设置会将之前的设置覆盖掉ONLY_FULL_GROUP_BY; 的方式设置会将之前的设置覆盖掉</p>
<p>同时设置多个限制：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_mode=<span class="string">&#x27;ONLY_FULL_GROUP_BY,NO_AUTO_VALUE_ON_ZERO&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>sql_mode常用值如下： </p>
<ul>
<li>ONLY_FULL_GROUP_BY：<ul>
<li>对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中</li>
</ul>
</li>
<li>NO_AUTO_VALUE_ON_ZERO：<ul>
<li>该值影响自增长列的插入。默认设置下，插入0或NULL代表生成下一个自增长值。如果用户希望插入的值为0，而该列又是自增长的，那么这个选项就有用了。</li>
</ul>
</li>
<li>STRICT_TRANS_TABLES：<ul>
<li>在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做限制</li>
</ul>
</li>
<li>NO_ZERO_IN_DATE：<ul>
<li>在严格模式下，不允许日期和月份为零</li>
</ul>
</li>
<li>NO_ZERO_DATE：<ul>
<li>设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</li>
</ul>
</li>
<li>ERROR_FOR_DIVISION_BY_ZERO：<ul>
<li>在INSERT或UPDATE过程中，如果数据被零除，则产生错误而非警告。如 果未给出该模式，那么数据被零除时MySQL返回NULL</li>
</ul>
</li>
<li>NO_AUTO_CREATE_USER：<ul>
<li>禁止GRANT创建密码为空的用户</li>
</ul>
</li>
<li>NO_ENGINE_SUBSTITUTION：<ul>
<li>如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</li>
</ul>
</li>
<li>PIPES_AS_CONCAT：<ul>
<li>将”||”视为字符串的连接操作符而非或运算符，这和Oracle数据库是一样的，也和字符串的拼接函数Concat相类似</li>
</ul>
</li>
<li>ANSI_QUOTES：<ul>
<li>启用ANSI_QUOTES后，不能用双引号来引用字符串，因为它被解释为识别符</li>
</ul>
</li>
<li>ORACLE：<ul>
<li>设置等同：PIPES_AS_CONCAT, ANSI_QUOTES, IGNORE_SPACE, NO_KEY_OPTIONS, NO_TABLE_OPTIONS, NO_FIELD_OPTIONS, NO_AUTO_CREATE_USER.</li>
</ul>
</li>
</ul>
<h5 id="3、查看当前系统的性能状态"><a href="#3、查看当前系统的性能状态" class="headerlink" title="3、查看当前系统的性能状态"></a>3、查看当前系统的性能状态</h5><p>服务器硬件的性能瓶颈：<code>top</code>、<code>free</code>、<code>iostat</code>和<code>vmstat</code>来查看系统的性能状态</p>
<hr>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.51cto.com/art/201910/604054.htm">InnoDB到底支不支持哈希索引，为啥不同的人说的不一样？</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1zJ411M7TB">黑马程序员MySQL全套教程，超详细的MySQL数据库优化，MySQL面试热点必考</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1541265">聚簇索引与非聚簇索引（也叫二级索引）–最清楚的一篇讲解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43934104/article/details/105847463?ops_request_misc=&request_id=&biz_id=102&utm_term=%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-105847463.pc_search_result_hbase_insert&spm=1018.2226.3001.4187">一文搞懂数据库隔离级别及解决方案</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039097849">京东面试官问我：“聊聊MySql事务,MVCC？”</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_20597727/article/details/87308709">深入了解mysql–gap locks,Next-Key Locks</a></p>
<p><a target="_blank" rel="noopener" href="http://pomit.cn/tr/3718605322652161">Mysql的行锁、表锁、间隙锁、意向锁</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>XGH_little-star
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://xgh-user.github.io/2021/08/30/mysql%E9%AB%98%E7%BA%A7/" title="mysql高级">http://xgh-user.github.io/2021/08/30/mysql高级/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/15/java%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="prev" title="java网络编程">
      <i class="fa fa-chevron-left"></i> java网络编程
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/04/redis%E9%AB%98%E7%BA%A7/" rel="next" title="redis高级">
      redis高级 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql-%E9%AB%98%E7%BA%A7%E7%AF%87"><span class="nav-number">1.</span> <span class="nav-text">Mysql 高级篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">1、索引（Index）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">1、索引概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8A%BF%E5%8A%A3%E5%8A%BF"><span class="nav-number">1.1.2.</span> <span class="nav-text">2、索引优势劣势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.3.</span> <span class="nav-text">3、索引结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81InnoDB%E7%9A%84%E8%87%AA%E8%B0%83%E4%BC%98"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">1、InnoDB的自调优</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81BTREE%EF%BC%88B%E6%A0%91%EF%BC%89%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">2、BTREE（B树）结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81B-TREE%EF%BC%88B-%E6%A0%91%EF%BC%89%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">3、B+TREE（B+树）结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81MySQL%E4%B8%AD%E7%9A%84B-Tree"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">4、MySQL中的B+Tree</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%E4%B8%8E%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.1.3.5.</span> <span class="nav-text">5、聚簇索引与非聚簇索引（了解）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6%E3%80%81full-text%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.3.6.</span> <span class="nav-text">6、full-text全文索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7%E3%80%81Hash%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.3.7.</span> <span class="nav-text">7、Hash索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8%E3%80%81R-Tree%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.3.8.</span> <span class="nav-text">8、R-Tree索引</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="nav-number">1.1.4.</span> <span class="nav-text">4、索引分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E7%B4%A2%E5%BC%95%E8%AF%AD%E6%B3%95"><span class="nav-number">1.1.5.</span> <span class="nav-text">5、索引语法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">1、创建索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">2、查看索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">3、删除索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81ALTER%E5%91%BD%E4%BB%A4%EF%BC%88%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">4、ALTER命令（添加索引）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">1.1.6.</span> <span class="nav-text">6、索引设计原则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81-%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE"><span class="nav-number">1.1.7.</span> <span class="nav-text">3、 查看视图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="nav-number">1.1.8.</span> <span class="nav-text">4、删除视图</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%88Procedure%EF%BC%89%E5%92%8C%E5%87%BD%E6%95%B0%EF%BC%88Function%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">3、存储过程（Procedure）和函数（Function）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%87%BD%E6%95%B0%E6%A6%82%E8%BF%B0"><span class="nav-number">1.2.1.</span> <span class="nav-text">1、存储过程和函数概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">2、存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">1、创建存储过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2、调用存储过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E7%9C%8B%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">3、查看存储过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">4、删除存储过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E5%9C%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84sql%E5%BD%93%E4%B8%AD%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="nav-number">1.2.2.5.</span> <span class="nav-text">5、在存储过程的sql当中的语法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.2.5.1.</span> <span class="nav-text">1、变量</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0"><span class="nav-number">1.2.2.5.2.</span> <span class="nav-text">3、传递参数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81case%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.5.3.</span> <span class="nav-text">4、case结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81while%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.2.2.5.4.</span> <span class="nav-text">5、while循环</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6%E3%80%81repeat%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.5.5.</span> <span class="nav-text">6、repeat结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7%E3%80%81loop%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.2.2.5.6.</span> <span class="nav-text">7、loop语句</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8%E3%80%81leave%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.2.2.5.7.</span> <span class="nav-text">8、leave语句</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9%E3%80%81%E6%B8%B8%E6%A0%87-%E5%85%89%E6%A0%87%EF%BC%88Cursor%EF%BC%89"><span class="nav-number">1.2.2.5.8.</span> <span class="nav-text">9、游标&#x2F;光标（Cursor）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.</span> <span class="nav-text">3、存储函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%EF%BC%88Trigger%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">4、触发器（Trigger）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.3.1.</span> <span class="nav-text">1、介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">1.3.2.</span> <span class="nav-text">2、创建触发器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">1.3.3.</span> <span class="nav-text">3、删除触发器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%9F%A5%E7%9C%8B%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">1.3.4.</span> <span class="nav-text">4、查看触发器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81Mysql%E7%9A%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">1.4.</span> <span class="nav-text">5、Mysql的体系结构概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-number">1.5.</span> <span class="nav-text">6、存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%A6%82%E8%BF%B0"><span class="nav-number">1.5.1.</span> <span class="nav-text">1、存储引擎概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%90%84%E7%A7%8D%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%89%B9%E6%80%A7"><span class="nav-number">1.5.2.</span> <span class="nav-text">2、各种存储引擎特性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81InnoDB"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">1、InnoDB</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81MyISAM"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">2、MyISAM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81MEMORY"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">3、MEMORY</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81MERGE"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">4、MERGE</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">1.5.3.</span> <span class="nav-text">3、存储引擎的选择</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E3%80%81%E4%BC%98%E5%8C%96SQL%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.6.</span> <span class="nav-text">7、优化SQL步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E6%9F%A5%E7%9C%8BSQL%E6%89%A7%E8%A1%8C%E9%A2%91%E7%8E%87"><span class="nav-number">1.6.1.</span> <span class="nav-text">1、查看SQL执行频率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%AE%9A%E4%BD%8D%E4%BD%8E%E6%95%88%E7%8E%87%E6%89%A7%E8%A1%8CSQL"><span class="nav-number">1.6.2.</span> <span class="nav-text">2、定位低效率执行SQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81explain%E5%88%86%E6%9E%90%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="nav-number">1.6.3.</span> <span class="nav-text">3、explain分析执行计划</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">1、环境准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81explain-%E4%B9%8B-id"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">2、explain 之 id</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81explain-%E4%B9%8B-select-type"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">3、explain 之 select_type</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81select-type-%E4%B9%8B-SIMPLE"><span class="nav-number">1.6.3.3.1.</span> <span class="nav-text">1、select_type 之 SIMPLE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81select-type-%E4%B9%8B-PRIMARY"><span class="nav-number">1.6.3.3.2.</span> <span class="nav-text">2、select_type 之 PRIMARY</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81select-type-%E4%B9%8B-SUBQUERY"><span class="nav-number">1.6.3.3.3.</span> <span class="nav-text">3、select_type 之 SUBQUERY</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81select-type-%E4%B9%8B-DERIVED"><span class="nav-number">1.6.3.3.4.</span> <span class="nav-text">4、select_type 之 DERIVED</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81select-type-%E4%B9%8B-UNION"><span class="nav-number">1.6.3.3.5.</span> <span class="nav-text">5、select_type 之 UNION</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6%E3%80%81select-type-%E4%B9%8B-UNION-RESULT"><span class="nav-number">1.6.3.3.6.</span> <span class="nav-text">6、select_type 之 UNION RESULT</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7%E3%80%81%E5%85%B6%E4%BB%96%E4%B8%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%9Aselect-type-%E4%B9%8B-DEPENDENT-SUBQUERY"><span class="nav-number">1.6.3.3.7.</span> <span class="nav-text">7、其他不常见的类型：select_type 之 DEPENDENT SUBQUERY</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8%E3%80%81%E5%85%B6%E4%BB%96%E4%B8%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%9Aselect-type-%E4%B9%8B-UNCACHEABLE-SUBQUREY"><span class="nav-number">1.6.3.3.8.</span> <span class="nav-text">8、其他不常见的类型：select_type 之 UNCACHEABLE SUBQUREY</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81explain-%E4%B9%8B-table"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">4、explain 之 table</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81explain-%E4%B9%8B-type"><span class="nav-number">1.6.3.5.</span> <span class="nav-text">5、explain 之 type</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81type-%E4%B9%8B-NULL"><span class="nav-number">1.6.3.5.1.</span> <span class="nav-text">1、type 之 NULL</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81type-%E4%B9%8B-system"><span class="nav-number">1.6.3.5.2.</span> <span class="nav-text">2、type 之 system</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81type-%E4%B9%8B-const"><span class="nav-number">1.6.3.5.3.</span> <span class="nav-text">3、type 之 const</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81type-%E4%B9%8B-eq-ref"><span class="nav-number">1.6.3.5.4.</span> <span class="nav-text">4、type 之 eq_ref</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81type-%E4%B9%8B-ref"><span class="nav-number">1.6.3.5.5.</span> <span class="nav-text">5、type 之 ref</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6%E3%80%81type-%E4%B9%8B-range"><span class="nav-number">1.6.3.5.6.</span> <span class="nav-text">6、type 之 range</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7%E3%80%81type-%E4%B9%8B-index"><span class="nav-number">1.6.3.5.7.</span> <span class="nav-text">7、type 之 index</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8%E3%80%81type-%E4%B9%8B-all"><span class="nav-number">1.6.3.5.8.</span> <span class="nav-text">8、type 之 all</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9%E3%80%81%E8%A1%A5%E5%85%85%EF%BC%9Atype-%E4%B9%8B-index-merge"><span class="nav-number">1.6.3.5.9.</span> <span class="nav-text">9、补充：type 之 index_merge</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10%E3%80%81%E8%A1%A5%E5%85%85%EF%BC%9Atype-%E4%B9%8B-ref-or-null"><span class="nav-number">1.6.3.5.10.</span> <span class="nav-text">10、补充：type 之 ref_or_null</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11%E3%80%81%E8%A1%A5%E5%85%85%EF%BC%9Atype-%E4%B9%8B-index-subquery"><span class="nav-number">1.6.3.5.11.</span> <span class="nav-text">11、补充：type 之 index_subquery</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#12%E3%80%81-%E8%A1%A5%E5%85%85%EF%BC%9Atype-%E4%B9%8B-unique-subquery"><span class="nav-number">1.6.3.5.12.</span> <span class="nav-text">12、 补充：type 之 unique_subquery</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6%E3%80%81explain-%E4%B9%8B-key"><span class="nav-number">1.6.3.6.</span> <span class="nav-text">6、explain 之  key</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81key-len%E7%9A%84%E9%95%BF%E5%BA%A6%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97"><span class="nav-number">1.6.3.6.1.</span> <span class="nav-text">1、key_len的长度如何计算</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7%E3%80%81explain-%E4%B9%8B-rows"><span class="nav-number">1.6.3.7.</span> <span class="nav-text">7、explain 之 rows</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8%E3%80%81explain-%E4%B9%8B-extra"><span class="nav-number">1.6.3.8.</span> <span class="nav-text">8、explain 之 extra</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81extra-%E4%B9%8B-using-filesort%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-number">1.6.3.8.1.</span> <span class="nav-text">1、extra 之 using  filesort（重要）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81extra-%E4%B9%8B-using-temporary%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-number">1.6.3.8.2.</span> <span class="nav-text">2、extra 之 using  temporary（重要）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81extra-%E4%B9%8B-using-index%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-number">1.6.3.8.3.</span> <span class="nav-text">3、extra 之 using  index（重要）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81extra-%E4%B9%8B-using-join-buffer%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.6.3.8.4.</span> <span class="nav-text">4、extra 之 using join buffer（了解）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81extra-%E4%B9%8B-impossible-where%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.6.3.8.5.</span> <span class="nav-text">5、extra 之 impossible where（了解）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81show-profile%E5%88%86%E6%9E%90SQL"><span class="nav-number">1.6.4.</span> <span class="nav-text">4、show profile分析SQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81trace%E5%88%86%E6%9E%90%E4%BC%98%E5%8C%96%E5%99%A8%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="nav-number">1.6.5.</span> <span class="nav-text">5、trace分析优化器执行计划</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.7.</span> <span class="nav-text">8、索引的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%AA%8C%E8%AF%81%E7%B4%A2%E5%BC%95%E6%8F%90%E5%8D%87%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87"><span class="nav-number">1.7.1.</span> <span class="nav-text">1、验证索引提升查询效率</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%A0%B9%E6%8D%AEID%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">1、根据ID查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%A0%B9%E6%8D%AE-title-%E8%BF%9B%E8%A1%8C%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">2、根据 title 进行精确查询</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.7.2.</span> <span class="nav-text">2、索引的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">1、准备环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E9%81%BF%E5%85%8D%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">2、避免索引失效</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D-%EF%BC%8C%E5%AF%B9%E7%B4%A2%E5%BC%95%E4%B8%AD%E6%89%80%E6%9C%89%E5%88%97%E9%83%BD%E6%8C%87%E5%AE%9A%E5%85%B7%E4%BD%93%E5%80%BC"><span class="nav-number">1.7.2.2.1.</span> <span class="nav-text">1、全值匹配 ，对索引中所有列都指定具体值</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99"><span class="nav-number">1.7.2.2.2.</span> <span class="nav-text">2、最左前缀法则</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%E5%8F%B3%E8%BE%B9%E7%9A%84%E5%88%97%EF%BC%8C%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="nav-number">1.7.2.2.3.</span> <span class="nav-text">3、范围查询右边的列，不能使用索引</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E4%B8%8D%E8%A6%81%E5%9C%A8%E7%B4%A2%E5%BC%95%E5%88%97%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%BF%90%E7%AE%97%E6%93%8D%E4%BD%9C%EF%BC%8C-%E7%B4%A2%E5%BC%95%E5%B0%86%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.4.</span> <span class="nav-text">4、不要在索引列上进行运算操作， 索引将失效</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8D%E5%8A%A0%E5%8D%95%E5%BC%95%E5%8F%B7%EF%BC%8C%E9%80%A0%E6%88%90%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.5.</span> <span class="nav-text">5、字符串不加单引号，造成索引失效</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6%E3%80%81%E5%B0%BD%E9%87%8F%E4%BD%BF%E7%94%A8%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%EF%BC%8C%E9%81%BF%E5%85%8Dselect"><span class="nav-number">1.7.2.2.6.</span> <span class="nav-text">6、尽量使用覆盖索引，避免select *</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7%E3%80%81%E7%94%A8or%E5%88%86%E5%89%B2%E5%BC%80%E7%9A%84%E6%9D%A1%E4%BB%B6%EF%BC%8C-%E5%A6%82%E6%9E%9Cor%E5%89%8D%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%88%97%E6%9C%89%E7%B4%A2%E5%BC%95%EF%BC%8C%E8%80%8C%E5%90%8E%E9%9D%A2%E7%9A%84%E5%88%97%E4%B8%AD%E6%B2%A1%E6%9C%89%E7%B4%A2%E5%BC%95%EF%BC%8C%E9%82%A3%E4%B9%88%E6%B6%89%E5%8F%8A%E7%9A%84%E7%B4%A2%E5%BC%95%E9%83%BD%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%94%A8%E5%88%B0"><span class="nav-number">1.7.2.2.7.</span> <span class="nav-text">7、用or分割开的条件， 如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8%E3%80%81%E4%BB%A5-%E5%BC%80%E5%A4%B4%E7%9A%84Like%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.8.</span> <span class="nav-text">8、以%开头的Like模糊查询，索引失效</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9%E3%80%81%E5%A6%82%E6%9E%9CMySQL%E8%AF%84%E4%BC%B0%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%AF%94%E5%85%A8%E8%A1%A8%E6%9B%B4%E6%85%A2%EF%BC%8C%E5%88%99%E4%B8%8D%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="nav-number">1.7.2.2.9.</span> <span class="nav-text">9、如果MySQL评估使用索引比全表更慢，则不使用索引</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10%E3%80%81is-NULL-%EF%BC%8C-is-NOT-NULL-%E6%9C%89%E6%97%B6%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.10.</span> <span class="nav-text">10、is  NULL ， is NOT NULL  有时索引失效</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11%E3%80%81in-%E8%B5%B0%E7%B4%A2%E5%BC%95%EF%BC%8C-not-in-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.7.2.2.11.</span> <span class="nav-text">11、in 走索引， not in 索引失效</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#12%E3%80%81-%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95%E5%92%8C%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95"><span class="nav-number">1.7.2.2.12.</span> <span class="nav-text">12、 单列索引和复合索引</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#13%E3%80%81mysql-%E5%9C%A8%E4%BD%BF%E7%94%A8%E4%B8%8D%E7%AD%89%E4%BA%8E-%E6%88%96%E8%80%85-lt-gt-%E7%9A%84%E6%97%B6%E5%80%99%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F"><span class="nav-number">1.7.2.2.13.</span> <span class="nav-text">13、mysql 在使用不等于(!&#x3D; 或者&lt;&gt;)的时候无法使用索引会导致全表扫描</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E4%B8%80%E8%88%AC%E6%80%A7%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.7.2.3.</span> <span class="nav-text">3、一般性建议</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="nav-number">1.7.2.4.</span> <span class="nav-text">4、查看索引使用情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9%E3%80%81SQL%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.</span> <span class="nav-text">9、SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%A4%A7%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.1.</span> <span class="nav-text">1、大批量插入数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%B8%BB%E9%94%AE%E9%A1%BA%E5%BA%8F%E6%8F%92%E5%85%A5"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">1、主键顺序插入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%85%B3%E9%97%AD%E5%94%AF%E4%B8%80%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">2、关闭唯一性校验</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">3、手动提交事务</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96-insert-%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.8.2.</span> <span class="nav-text">2、优化 insert 语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E4%BC%98%E5%8C%96-order-by-%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.8.3.</span> <span class="nav-text">3、优化 order by 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-1"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">1、环境准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E4%B8%A4%E7%A7%8D%E6%8E%92%E5%BA%8F%E6%96%B9%E5%BC%8F"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">2、两种排序方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81filesort-%E6%8E%92%E5%BA%8F"><span class="nav-number">1.8.3.2.1.</span> <span class="nav-text">1、filesort 排序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81using-index"><span class="nav-number">1.8.3.2.2.</span> <span class="nav-text">2、using index</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81Filesort-%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.3.3.</span> <span class="nav-text">3、Filesort 的优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E4%BC%98%E5%8C%96-group-by-%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.8.4.</span> <span class="nav-text">4、优化 group by 语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E4%BC%98%E5%8C%96%E5%B5%8C%E5%A5%97%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.8.5.</span> <span class="nav-text">5、优化嵌套查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8join%E6%9B%BF%E4%BB%A3%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.8.5.1.</span> <span class="nav-text">1、使用join替代子查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81where-%E4%B9%8B%E5%90%8E%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF-%E7%94%A8in-%E8%BF%98%E6%98%AF-exists"><span class="nav-number">1.8.5.2.</span> <span class="nav-text">2、where 之后使用的是 用in 还是 exists</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E5%AE%9E%E9%AA%8C"><span class="nav-number">1.8.5.2.1.</span> <span class="nav-text">1、实验</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E7%BB%93%E8%AE%BA"><span class="nav-number">1.8.5.2.2.</span> <span class="nav-text">3、结论</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E4%BC%98%E5%8C%96OR%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.8.6.</span> <span class="nav-text">6、优化OR条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%E3%80%81%E4%BC%98%E5%8C%96%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.8.7.</span> <span class="nav-text">7、优化分页查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%E4%B8%80"><span class="nav-number">1.8.7.1.</span> <span class="nav-text">1、优化思路一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%E4%BA%8C"><span class="nav-number">1.8.7.2.</span> <span class="nav-text">2、优化思路二</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8%E3%80%81%E4%BC%98%E5%8C%96%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.8.8.</span> <span class="nav-text">8、优化单表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8SQL"><span class="nav-number">1.8.8.1.</span> <span class="nav-text">1、建表SQL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%A1%88%E4%BE%8B"><span class="nav-number">1.8.8.2.</span> <span class="nav-text">2、案例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9%E3%80%81%E4%BC%98%E5%8C%96%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.8.9.</span> <span class="nav-text">9、优化关联查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8SQL-1"><span class="nav-number">1.8.9.1.</span> <span class="nav-text">1、建表SQL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%A1%88%E4%BE%8B-1"><span class="nav-number">1.8.9.2.</span> <span class="nav-text">2、案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.9.3.</span> <span class="nav-text">3、建议</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8%E3%80%81%E4%BD%BF%E7%94%A8SQL%E6%8F%90%E7%A4%BA"><span class="nav-number">1.8.10.</span> <span class="nav-text">8、使用SQL提示</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81USE-INDEX"><span class="nav-number">1.8.10.1.</span> <span class="nav-text">1、USE INDEX</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81IGNORE-INDEX"><span class="nav-number">1.8.10.2.</span> <span class="nav-text">2、IGNORE INDEX</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81FORCE-INDEX"><span class="nav-number">1.8.10.3.</span> <span class="nav-text">3、FORCE INDEX</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10%E3%80%81%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96"><span class="nav-number">1.9.</span> <span class="nav-text">10、应用优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-number">1.9.1.</span> <span class="nav-text">1、使用连接池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%87%8F%E5%B0%91%E5%AF%B9MySQL%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="nav-number">1.9.2.</span> <span class="nav-text">2、减少对MySQL的访问</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E9%81%BF%E5%85%8D%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E9%87%8D%E5%A4%8D%E6%A3%80%E7%B4%A2"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">1、避免对数据进行重复检索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%A2%9E%E5%8A%A0cache%E5%B1%82"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">2、增加cache层</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.9.3.</span> <span class="nav-text">3、负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%88%A9%E7%94%A8MySQL%E5%A4%8D%E5%88%B6%E5%88%86%E6%B5%81%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.9.3.1.</span> <span class="nav-text">1、利用MySQL复制分流查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E9%87%87%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84"><span class="nav-number">1.9.3.2.</span> <span class="nav-text">2、采用分布式数据库架构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11%E3%80%81Mysql%E4%B8%AD%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-number">1.10.</span> <span class="nav-text">11、Mysql中查询缓存优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-number">1.10.1.</span> <span class="nav-text">1、概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.10.2.</span> <span class="nav-text">2、操作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.3.</span> <span class="nav-text">3、查询缓存配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%BC%80%E5%90%AF%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="nav-number">1.10.4.</span> <span class="nav-text">4、开启查询缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98SELECT%E9%80%89%E9%A1%B9"><span class="nav-number">1.10.5.</span> <span class="nav-text">5、查询缓存SELECT选项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.10.6.</span> <span class="nav-text">6、查询缓存失效的情况</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81SQL-%E8%AF%AD%E5%8F%A5%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C-%E8%A6%81%E6%83%B3%E5%91%BD%E4%B8%AD%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%EF%BC%8C%E6%9F%A5%E8%AF%A2%E7%9A%84SQL%E8%AF%AD%E5%8F%A5%E5%BF%85%E9%A1%BB%E4%B8%80%E8%87%B4"><span class="nav-number">1.10.6.1.</span> <span class="nav-text">1、SQL 语句不一致的情况， 要想命中查询缓存，查询的SQL语句必须一致</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%BD%93%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E4%B8%AD%E6%9C%89%E4%B8%80%E4%BA%9B%E4%B8%8D%E7%A1%AE%E5%AE%9A%E7%9A%84%E6%97%B6%EF%BC%8C%E5%88%99%E4%B8%8D%E4%BC%9A%E7%BC%93%E5%AD%98"><span class="nav-number">1.10.6.2.</span> <span class="nav-text">2、当查询语句中有一些不确定的时，则不会缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E4%B8%8D%E4%BD%BF%E7%94%A8%E4%BB%BB%E4%BD%95%E8%A1%A8%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.10.6.3.</span> <span class="nav-text">3、不使用任何表查询语句</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E6%9F%A5%E8%AF%A2-mysql%EF%BC%8C-information-schema%E6%88%96-performance-schema-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8%E6%97%B6%EF%BC%8C%E4%B8%8D%E4%BC%9A%E8%B5%B0%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="nav-number">1.10.6.4.</span> <span class="nav-text">4、查询 mysql， information_schema或  performance_schema 数据库中的表时，不会走查询缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E5%9C%A8%E5%AD%98%E5%82%A8%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%8C%E8%A7%A6%E5%8F%91%E5%99%A8%E6%88%96%E4%BA%8B%E4%BB%B6%E7%9A%84%E4%B8%BB%E4%BD%93%E5%86%85%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.6.5.</span> <span class="nav-text">5、在存储的函数，触发器或事件的主体内执行的查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6%E3%80%81%E5%A6%82%E6%9E%9C%E8%A1%A8%E6%9B%B4%E6%94%B9%EF%BC%8C%E5%88%99%E4%BD%BF%E7%94%A8%E8%AF%A5%E8%A1%A8%E7%9A%84%E6%89%80%E6%9C%89%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E6%9F%A5%E8%AF%A2%E9%83%BD%E5%B0%86%E5%8F%98%E4%B8%BA%E6%97%A0%E6%95%88%E5%B9%B6%E4%BB%8E%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E4%B8%AD%E5%88%A0%E9%99%A4"><span class="nav-number">1.10.6.6.</span> <span class="nav-text">6、如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12%E3%80%81Mysql%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8F%8A%E4%BC%98%E5%8C%96"><span class="nav-number">1.11.</span> <span class="nav-text">12、Mysql内存管理及优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%8E%9F%E5%88%99"><span class="nav-number">1.11.1.</span> <span class="nav-text">1、内存优化原则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81MyISAM-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-number">1.11.2.</span> <span class="nav-text">2、MyISAM 内存优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81key-buffer-size"><span class="nav-number">1.11.2.1.</span> <span class="nav-text">1、key_buffer_size</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81read-buffer-size"><span class="nav-number">1.11.2.2.</span> <span class="nav-text">2、read_buffer_size</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81read-rnd-buffer-size"><span class="nav-number">1.11.2.3.</span> <span class="nav-text">3、read_rnd_buffer_size</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81InnoDB-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-number">1.11.3.</span> <span class="nav-text">3、InnoDB 内存优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81innodb-buffer-pool-size"><span class="nav-number">1.11.3.1.</span> <span class="nav-text">1、innodb_buffer_pool_size</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81innodb-log-buffer-size"><span class="nav-number">1.11.3.2.</span> <span class="nav-text">2、innodb_log_buffer_size</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13%E3%80%81Mysql%E5%B9%B6%E5%8F%91%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4"><span class="nav-number">1.12.</span> <span class="nav-text">13、Mysql并发参数调整</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81max-connections"><span class="nav-number">1.12.1.</span> <span class="nav-text">1、max_connections</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81back-log"><span class="nav-number">1.12.2.</span> <span class="nav-text">2、back_log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81table-open-cache"><span class="nav-number">1.12.3.</span> <span class="nav-text">3、table_open_cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81thread-cache-size"><span class="nav-number">1.12.4.</span> <span class="nav-text">4、thread_cache_size</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81innodb-lock-wait-timeout"><span class="nav-number">1.12.5.</span> <span class="nav-text">5、innodb_lock_wait_timeout</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14%E3%80%81Mysql%E9%94%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.13.</span> <span class="nav-text">14、Mysql锁问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%94%81%E6%A6%82%E8%BF%B0"><span class="nav-number">1.13.1.</span> <span class="nav-text">1、锁概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E9%94%81%E5%88%86%E7%B1%BB"><span class="nav-number">1.13.2.</span> <span class="nav-text">2、锁分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E8%A1%8C%E9%94%81%EF%BC%9A%E8%AE%B0%E5%BD%95%E9%94%81-Record-Locks"><span class="nav-number">1.13.3.</span> <span class="nav-text">3、行锁：记录锁(Record Locks)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E8%A1%8C%E9%94%81%EF%BC%9A%E9%97%B4%E9%9A%99%E9%94%81-Gap-Locks"><span class="nav-number">1.13.4.</span> <span class="nav-text">4、行锁：间隙锁(Gap Locks)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E8%A1%8C%E9%94%81%EF%BC%9A%E4%B8%B4%E9%94%AE%E9%94%81-Next-Key-Locks"><span class="nav-number">1.13.5.</span> <span class="nav-text">5、行锁：临键锁(Next-Key Locks)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E8%A1%A8%E9%94%81%EF%BC%9A%E6%84%8F%E5%90%91%E9%94%81"><span class="nav-number">1.13.6.</span> <span class="nav-text">6、表锁：意向锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81Mysql-%E9%94%81"><span class="nav-number">1.13.7.</span> <span class="nav-text">3、Mysql 锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81MyISAM-%E8%A1%A8%E9%94%81"><span class="nav-number">1.13.8.</span> <span class="nav-text">4、MyISAM 表锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%A6%82%E4%BD%95%E5%8A%A0%E8%A1%A8%E9%94%81"><span class="nav-number">1.13.8.1.</span> <span class="nav-text">1、如何加表锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E8%AF%BB%E9%94%81%E6%A1%88%E4%BE%8B"><span class="nav-number">1.13.8.2.</span> <span class="nav-text">2、读锁案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E5%86%99%E9%94%81%E6%A1%88%E4%BE%8B"><span class="nav-number">1.13.8.3.</span> <span class="nav-text">3、写锁案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E7%BB%93%E8%AE%BA"><span class="nav-number">1.13.8.4.</span> <span class="nav-text">4、结论</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E6%9F%A5%E7%9C%8B%E9%94%81%E7%9A%84%E4%BA%89%E7%94%A8%E6%83%85%E5%86%B5"><span class="nav-number">1.13.8.5.</span> <span class="nav-text">5、查看锁的争用情况</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81InnoDB-%E8%A1%8C%E9%94%81"><span class="nav-number">1.13.9.</span> <span class="nav-text">5、InnoDB 行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E8%A1%8C%E9%94%81%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.13.9.1.</span> <span class="nav-text">1、行锁介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-number">1.13.9.2.</span> <span class="nav-text">2、背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E4%BA%8B%E5%8A%A1%E5%8F%8A%E5%85%B6ACID%E5%B1%9E%E6%80%A7"><span class="nav-number">1.13.9.2.1.</span> <span class="nav-text">1、事务及其ACID属性</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.13.9.2.2.</span> <span class="nav-text">2、并发事务处理带来的问题</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">1.13.9.2.3.</span> <span class="nav-text">3、事务隔离级别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E8%A7%A3%E6%9E%90"><span class="nav-number">1.13.9.2.4.</span> <span class="nav-text">4、解决方案解析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81InnoDB-%E7%9A%84%E8%A1%8C%E9%94%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.13.9.3.</span> <span class="nav-text">3、InnoDB 的行锁模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E6%A1%88%E4%BE%8B%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.13.9.4.</span> <span class="nav-text">4、案例准备工作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E8%A1%8C%E9%94%81%E5%9F%BA%E6%9C%AC%E6%BC%94%E7%A4%BA"><span class="nav-number">1.13.9.5.</span> <span class="nav-text">5、行锁基本演示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6%E3%80%81%E6%97%A0%E7%B4%A2%E5%BC%95%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81"><span class="nav-number">1.13.9.6.</span> <span class="nav-text">6、无索引行锁升级为表锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7%E3%80%81%E9%97%B4%E9%9A%99%E9%94%81%E5%8D%B1%E5%AE%B3"><span class="nav-number">1.13.9.7.</span> <span class="nav-text">7、间隙锁危害</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8%E3%80%81InnoDB-%E8%A1%8C%E9%94%81%E4%BA%89%E7%94%A8%E6%83%85%E5%86%B5"><span class="nav-number">1.13.9.8.</span> <span class="nav-text">8、InnoDB 行锁争用情况</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.13.9.9.</span> <span class="nav-text">9、总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15%E3%80%81Mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.14.</span> <span class="nav-text">15、Mysql 事务隔离的底层实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81MVCC%EF%BC%88Multi-Version-Concurrency-Control%EF%BC%89%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-number">1.14.1.</span> <span class="nav-text">1、MVCC（Multi-Version Concurrency Control）多版本并发控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFMVCC%EF%BC%9F"><span class="nav-number">1.14.1.1.</span> <span class="nav-text">1、什么是MVCC？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81MVCC%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94%E7%89%88%E6%9C%AC%E9%93%BE%E5%92%8C%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%86%E5%9B%BE"><span class="nav-number">1.14.1.2.</span> <span class="nav-text">2、MVCC的底层原理——版本链和一致性视图</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E7%89%88%E6%9C%AC%E9%93%BE"><span class="nav-number">1.14.1.2.1.</span> <span class="nav-text">1、版本链</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%86%E5%9B%BE%EF%BC%88ReadView%EF%BC%89"><span class="nav-number">1.14.1.2.2.</span> <span class="nav-text">2、一致性视图（ReadView）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E5%AF%B9%E4%BA%8ERR%EF%BC%88%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%EF%BC%89%E5%92%8CRC%EF%BC%88%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4%EF%BC%89%E5%9C%A8%E7%94%9F%E6%88%90%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%86%E5%9B%BE%E6%97%B6%E6%9C%BA%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.14.1.2.3.</span> <span class="nav-text">3、对于RR（可重复读）和RC（读已提交）在生成一致性视图时机的区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%85%B3%E4%BA%8E%E9%97%B4%E9%9A%99%E9%94%81%E4%B8%8ENext-Key-Lock"><span class="nav-number">1.14.2.</span> <span class="nav-text">2、关于间隙锁与Next-Key Lock</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="nav-number">1.14.2.1.</span> <span class="nav-text">1、简介</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E9%82%A3%E4%B9%88gap%E9%94%81%E5%88%B0%E5%BA%95%E6%98%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E9%94%81%E7%9A%84%E5%91%A2%EF%BC%9F"><span class="nav-number">1.14.2.2.</span> <span class="nav-text">2、那么gap锁到底是如何加锁的呢？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E7%9B%B8%E5%85%B3%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.14.2.3.</span> <span class="nav-text">3、相关实例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8"><span class="nav-number">1.14.2.3.1.</span> <span class="nav-text">1、建表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%97%A0gap%E9%94%81"><span class="nav-number">1.14.2.3.2.</span> <span class="nav-text">2、无gap锁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E7%AD%89%E5%80%BC%E6%A3%80%E7%B4%A2gap%E9%94%81"><span class="nav-number">1.14.2.3.3.</span> <span class="nav-text">3、非唯一索引等值检索gap锁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%EF%BC%88%E4%B8%BB%E9%94%AE%EF%BC%89%E8%8C%83%E5%9B%B4%E6%A3%80%E7%B4%A2gap%E9%94%81"><span class="nav-number">1.14.2.3.4.</span> <span class="nav-text">4、唯一索引（主键）范围检索gap锁</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81gap%E9%94%81%E6%98%AF%E5%A6%82%E4%BD%95%E9%94%81%E5%8C%BA%E9%97%B4%EF%BC%9F"><span class="nav-number">1.14.2.4.</span> <span class="nav-text">4、gap锁是如何锁区间？</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95gap%E9%94%81%E5%8E%9F%E5%88%99%E5%88%86%E6%9E%90"><span class="nav-number">1.14.2.4.1.</span> <span class="nav-text">1、非唯一索引gap锁原则分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.14.2.4.2.</span> <span class="nav-text">1、总结</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E6%88%96%E8%80%85%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E8%8C%83%E5%9B%B4%E6%A3%80%E7%B4%A2gap%E9%94%81%E5%8E%9F%E5%88%99%E5%88%86%E6%9E%90"><span class="nav-number">1.14.2.4.3.</span> <span class="nav-text">2、唯一索引或者非唯一索引范围检索gap锁原则分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.14.2.4.4.</span> <span class="nav-text">2、总结</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E6%80%9D%E8%80%83%EF%BC%88%E5%9C%A8session1%E6%89%A7%E8%A1%8Cfor-update%E8%AF%AD%E5%8F%A5%EF%BC%89"><span class="nav-number">1.14.2.4.5.</span> <span class="nav-text">3、思考（在session1执行for update语句）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.14.2.4.6.</span> <span class="nav-text">4、总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16%E3%80%81%E5%B8%B8%E7%94%A8SQL%E6%8A%80%E5%B7%A7"><span class="nav-number">1.15.</span> <span class="nav-text">16、常用SQL技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%B8%B8%E8%A7%81%E9%80%9A%E7%94%A8%E7%9A%84Join%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.15.1.</span> <span class="nav-text">1、常见通用的Join查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81SQL%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.15.1.1.</span> <span class="nav-text">1、SQL执行顺序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81Join%E5%9B%BE"><span class="nav-number">1.15.1.2.</span> <span class="nav-text">2、Join图</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E6%A1%88%E4%BE%8B%E5%87%86%E5%A4%87"><span class="nav-number">1.15.1.2.1.</span> <span class="nav-text">1、案例准备</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%817%E7%A7%8DJOIN"><span class="nav-number">1.15.1.2.2.</span> <span class="nav-text">2、7种JOIN</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%B8%8Ejoin%E4%B8%A4%E8%80%85%E5%8C%BA%E5%88%AB"><span class="nav-number">1.15.1.2.3.</span> <span class="nav-text">3、子查询与join两者区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BD%BF%E7%94%A8"><span class="nav-number">1.15.2.</span> <span class="nav-text">2、正则表达式使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81MySQL-%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">1.15.3.</span> <span class="nav-text">3、MySQL 常用函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17%E3%80%81MySql%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">1.16.</span> <span class="nav-text">17、MySql中常用工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81mysql"><span class="nav-number">1.16.1.</span> <span class="nav-text">1、mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9"><span class="nav-number">1.16.1.1.</span> <span class="nav-text">1、连接选项</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%89%A7%E8%A1%8C%E9%80%89%E9%A1%B9"><span class="nav-number">1.16.1.2.</span> <span class="nav-text">2、执行选项</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81mysqladmin"><span class="nav-number">1.16.2.</span> <span class="nav-text">2、mysqladmin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81mysqlbinlog"><span class="nav-number">1.16.3.</span> <span class="nav-text">3、mysqlbinlog</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81mysqldump"><span class="nav-number">1.16.4.</span> <span class="nav-text">4、mysqldump</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9-1"><span class="nav-number">1.16.4.1.</span> <span class="nav-text">1、连接选项</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E8%BE%93%E5%87%BA%E5%86%85%E5%AE%B9%E9%80%89%E9%A1%B9"><span class="nav-number">1.16.4.2.</span> <span class="nav-text">2、输出内容选项</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81mysqlimport-source"><span class="nav-number">1.16.5.</span> <span class="nav-text">5、mysqlimport&#x2F;source</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81mysqlshow"><span class="nav-number">1.16.6.</span> <span class="nav-text">6、mysqlshow</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18%E3%80%81Mysql-%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.</span> <span class="nav-text">18、Mysql 日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.1.</span> <span class="nav-text">1、错误日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.2.</span> <span class="nav-text">2、二进制日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-1"><span class="nav-number">1.17.2.1.</span> <span class="nav-text">1、概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="nav-number">1.17.2.2.</span> <span class="nav-text">2、日志格式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81STATEMENT"><span class="nav-number">1.17.2.2.1.</span> <span class="nav-text">1、STATEMENT</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81ROW"><span class="nav-number">1.17.2.2.2.</span> <span class="nav-text">2、ROW</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81MIXED"><span class="nav-number">1.17.2.2.3.</span> <span class="nav-text">3、MIXED</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%97%A5%E5%BF%97%E8%AF%BB%E5%8F%96"><span class="nav-number">1.17.2.3.</span> <span class="nav-text">3、日志读取</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E6%9F%A5%E7%9C%8BSTATEMENT%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.2.3.1.</span> <span class="nav-text">1、查看STATEMENT格式日志</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8BROW%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.2.3.2.</span> <span class="nav-text">2、查看ROW格式日志</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4"><span class="nav-number">1.17.2.4.</span> <span class="nav-text">4、日志删除</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9AReset-Master"><span class="nav-number">1.17.2.4.1.</span> <span class="nav-text">1、方式一：Reset Master</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9Apurge-master-logs-to-%E2%80%98mysqlbin-%E2%80%99"><span class="nav-number">1.17.2.4.2.</span> <span class="nav-text">2、方式二：purge  master logs to ‘mysqlbin.*’</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9Apurge-master-logs-before-%E2%80%98yyyy-mm-dd-hh24-mi-ss%E2%80%99"><span class="nav-number">1.17.2.4.3.</span> <span class="nav-text">3、方式三：purge master logs before ‘yyyy-mm-dd hh24:mi:ss’</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E6%96%B9%E5%BC%8F%E5%9B%9B%EF%BC%9A%E2%80%93expire-logs-days"><span class="nav-number">1.17.2.4.4.</span> <span class="nav-text">4、方式四：–expire_logs_days&#x3D;#</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.3.</span> <span class="nav-text">3、查询日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number">1.17.4.</span> <span class="nav-text">4、慢查询日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%92%8C%E6%A0%BC%E5%BC%8F"><span class="nav-number">1.17.4.1.</span> <span class="nav-text">1、文件位置和格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%97%A5%E5%BF%97%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="nav-number">1.17.4.2.</span> <span class="nav-text">2、日志的读取</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19%E3%80%81Mysql%E5%A4%8D%E5%88%B6"><span class="nav-number">1.18.</span> <span class="nav-text">19、Mysql复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%A4%8D%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="nav-number">1.18.1.</span> <span class="nav-text">1、复制概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="nav-number">1.18.2.</span> <span class="nav-text">2、复制原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%A4%8D%E5%88%B6%E4%BC%98%E5%8A%BF"><span class="nav-number">1.18.3.</span> <span class="nav-text">3、复制优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.18.4.</span> <span class="nav-text">4、搭建步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81master"><span class="nav-number">1.18.4.1.</span> <span class="nav-text">1、master</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81slave"><span class="nav-number">1.18.4.2.</span> <span class="nav-text">2、slave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E9%AA%8C%E8%AF%81%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C"><span class="nav-number">1.18.4.3.</span> <span class="nav-text">3、验证同步操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20%E3%80%81%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="nav-number">1.19.</span> <span class="nav-text">20、综合案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">1.19.1.</span> <span class="nav-text">1、需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%90%AD%E5%BB%BA%E6%A1%88%E4%BE%8B%E7%8E%AF%E5%A2%83"><span class="nav-number">1.19.2.</span> <span class="nav-text">2、搭建案例环境</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="nav-number">1.19.2.1.</span> <span class="nav-text">1、数据库表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81pom-xml"><span class="nav-number">1.19.2.2.</span> <span class="nav-text">2、pom.xml</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E9%80%9A%E8%BF%87AOP%E8%AE%B0%E5%BD%95%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97"><span class="nav-number">1.19.3.</span> <span class="nav-text">3、通过AOP记录操作日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.19.3.1.</span> <span class="nav-text">1、自定义注解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%AE%9A%E4%B9%89%E9%80%9A%E7%9F%A5%E7%B1%BB"><span class="nav-number">1.19.3.2.</span> <span class="nav-text">2、定义通知类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%96%B9%E6%B3%95%E4%B8%8A%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.19.3.3.</span> <span class="nav-text">3、方法上加注解</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.19.4.</span> <span class="nav-text">4、日志查询后端代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81Mapper%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.19.4.1.</span> <span class="nav-text">1、Mapper接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81Mapper-xml-%E6%98%A0%E5%B0%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.19.4.2.</span> <span class="nav-text">2、Mapper.xml 映射配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81Service"><span class="nav-number">1.19.4.3.</span> <span class="nav-text">3、Service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81Controller"><span class="nav-number">1.19.4.4.</span> <span class="nav-text">4、Controller</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.19.5.</span> <span class="nav-text">5、日志查询前端代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81js"><span class="nav-number">1.19.5.1.</span> <span class="nav-text">1、js</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%88%97%E8%A1%A8%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA"><span class="nav-number">1.19.5.2.</span> <span class="nav-text">2、列表数据展示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="nav-number">1.19.5.3.</span> <span class="nav-text">3、分页插件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E8%81%94%E8%B0%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.19.6.</span> <span class="nav-text">6、联调测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%E3%80%81%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">1.19.7.</span> <span class="nav-text">7、分析性能问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.19.7.1.</span> <span class="nav-text">1、分页查询优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.19.7.2.</span> <span class="nav-text">2、条件查询优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">1.19.7.3.</span> <span class="nav-text">3、读写分离</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%98%E5%8C%96"><span class="nav-number">1.19.7.4.</span> <span class="nav-text">4、MySQL服务器优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5%E3%80%81%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96"><span class="nav-number">1.19.7.5.</span> <span class="nav-text">5、应用优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%88%86%E9%A1%B5"><span class="nav-number">1.19.8.</span> <span class="nav-text">8、性能优化 - 分页</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%BC%98%E5%8C%96count"><span class="nav-number">1.19.8.1.</span> <span class="nav-text">1、优化count</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96-limit"><span class="nav-number">1.19.8.2.</span> <span class="nav-text">2、优化 limit</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95"><span class="nav-number">1.19.9.</span> <span class="nav-text">9、性能优化 - 索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E6%8E%92%E5%BA%8F"><span class="nav-number">1.19.10.</span> <span class="nav-text">10、性能优化 - 排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">1.19.11.</span> <span class="nav-text">11、性能优化 - 读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-2"><span class="nav-number">1.19.11.1.</span> <span class="nav-text">1、概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">1.19.11.2.</span> <span class="nav-text">2、实现方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E9%AA%8C%E8%AF%81"><span class="nav-number">1.19.11.3.</span> <span class="nav-text">3、验证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E5%8E%9F%E7%90%86"><span class="nav-number">1.19.11.4.</span> <span class="nav-text">4、原理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96"><span class="nav-number">1.19.12.</span> <span class="nav-text">12、性能优化 - 应用优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E7%BC%93%E5%AD%98"><span class="nav-number">1.19.12.1.</span> <span class="nav-text">1、缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">1.19.12.2.</span> <span class="nav-text">2、全文检索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E9%9D%9E%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.19.12.3.</span> <span class="nav-text">3、非关系数据库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0%E3%80%81%E5%9C%A8Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85Mysql"><span class="nav-number">1.20.</span> <span class="nav-text">0、在Linux系统安装Mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BDLinux-%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">1.20.1.</span> <span class="nav-text">1、下载Linux 安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%AE%89%E8%A3%85MySQL"><span class="nav-number">1.20.2.</span> <span class="nav-text">2、安装MySQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%90%AF%E5%8A%A8-MySQL-%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.20.3.</span> <span class="nav-text">3、启动 MySQL 服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E7%99%BB%E5%BD%95MySQL"><span class="nav-number">1.20.4.</span> <span class="nav-text">4、登录MySQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81Mysql-%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-number">1.20.5.</span> <span class="nav-text">5、Mysql 的用户与权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81MySQL%E7%9A%84%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-number">1.20.5.1.</span> <span class="nav-text">1、MySQL的用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-number">1.20.5.1.1.</span> <span class="nav-text">1、创建用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8B%E7%94%A8%E6%88%B7"><span class="nav-number">1.20.5.1.2.</span> <span class="nav-text">2、查看用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="nav-number">1.20.5.1.3.</span> <span class="nav-text">3、设置密码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4%E3%80%81%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7"><span class="nav-number">1.20.5.1.4.</span> <span class="nav-text">4、修改用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5%E3%80%81%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="nav-number">1.20.5.1.5.</span> <span class="nav-text">5、删除用户</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-number">1.20.5.2.</span> <span class="nav-text">2、权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1%E3%80%81%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90"><span class="nav-number">1.20.5.2.1.</span> <span class="nav-text">1、授予权限</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E3%80%81%E6%94%B6%E5%9B%9E%E6%9D%83%E9%99%90"><span class="nav-number">1.20.5.2.2.</span> <span class="nav-text">2、收回权限</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E7%9C%8B%E6%9D%83%E9%99%90"><span class="nav-number">1.20.5.2.3.</span> <span class="nav-text">3、查看权限</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E9%80%9A%E8%BF%87%E5%B7%A5%E5%85%B7%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE"><span class="nav-number">1.20.5.3.</span> <span class="nav-text">3、通过工具远程访问</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86%E9%97%AE%E9%A2%98"><span class="nav-number">1.20.6.</span> <span class="nav-text">6、修改字符集问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%9F%A5%E7%9C%8B%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="nav-number">1.20.6.1.</span> <span class="nav-text">1、查看字符集</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E4%BF%AE%E6%94%B9my-cnf"><span class="nav-number">1.20.6.2.</span> <span class="nav-text">2、修改my.cnf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8mysql"><span class="nav-number">1.20.6.3.</span> <span class="nav-text">3、重新启动mysql</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%E3%80%81%E5%B7%B2%E7%94%9F%E6%88%90%E7%9A%84%E5%BA%93%E8%A1%A8%E5%AD%97%E7%AC%A6%E9%9B%86%E5%A6%82%E4%BD%95%E5%8F%98%E6%9B%B4"><span class="nav-number">1.20.6.4.</span> <span class="nav-text">4、已生成的库表字符集如何变更</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%E3%80%81Mysql%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9D%82%E9%A1%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">1.20.7.</span> <span class="nav-text">7、Mysql的一些杂项配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E5%A4%A7%E5%B0%8F%E5%86%99%E9%97%AE%E9%A2%98"><span class="nav-number">1.20.7.1.</span> <span class="nav-text">1、大小写问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-sql-mode"><span class="nav-number">1.20.7.2.</span> <span class="nav-text">2、(生产环境)sql_mode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%80%A7%E8%83%BD%E7%8A%B6%E6%80%81"><span class="nav-number">1.20.7.3.</span> <span class="nav-text">3、查看当前系统的性能状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="nav-number">1.21.</span> <span class="nav-text">相关资料</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">_little-star_</p>
  <div class="site-description" itemprop="description">记录个人在平时学习的过程中的一些笔记、感受与遇到的坑,例如：java、计算机考研四件套等等。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">_little-star_</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
